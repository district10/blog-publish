<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="pandoc" />
  <meta name="author" content="TANG ZhiXiong; dvorak4tzx; district10" />
  <meta name="date" content="2016-07-22" />
  <title>&#38271;&#27801;&#39033;&#30446;&#24635;&#32467; 4</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="jquery-ui.css" type="text/css" />
  <link rel="stylesheet" href="font-awesome.min.css" type="text/css" />
  <link rel="stylesheet" href="main.css" type="text/css" />
</head>
<body>
<div id="header">
<h1 class="title">&#38271;&#27801;&#39033;&#30446;&#24635;&#32467; 4</h1>
<h3 class="date">2016-07-22</h3>
</div>
<div id="tocbox" class="pokerface">
    <div id="tocboxheader">&#xf03b;</div>
    <div id="tocboxbody">
        <ul>
        <li><a href="#&#38271;&#27801;&#39033;&#30446;&#24635;&#32467;-4-&#20256;&#24863;&#22120;&#27169;&#22359;&#36873;&#35762;lms-&#21644;-imu-&#21644;-ur">&#38271;&#27801;&#39033;&#30446;&#24635;&#32467; 4 &#8211; &#20256;&#24863;&#22120;&#27169;&#22359;&#36873;&#35762;&#65288;LMS &#21644; IMU &#21644; UR&#65289;</a><ul>
        <li><a href="#lms">LMS</a></li>
        <li><a href="#imu">IMU</a></li>
        <li><a href="#ur">UR</a></li>
        </ul></li>
        </ul>
    </div>
</div>
<div id="navigator" class="pokerface"><a id="gotoindex" href="index.html" title="&#25353;&#19979;&#12304;h&#12305;&#33719;&#21462;&#39029;&#38754;&#24110;&#21161;&#12290;">&#xf015;</a></div>
<h1 id="&#38271;&#27801;&#39033;&#30446;&#24635;&#32467;-4-&#20256;&#24863;&#22120;&#27169;&#22359;&#36873;&#35762;lms-&#21644;-imu-&#21644;-ur">&#38271;&#27801;&#39033;&#30446;&#24635;&#32467; 4 &#8211; &#20256;&#24863;&#22120;&#27169;&#22359;&#36873;&#35762;&#65288;LMS &#21644; IMU &#21644; UR&#65289;</h1>
<p><a href="post-0113-changsha-review.html" style="font-size:80%; color: red;" title="post-0113-changsha-review.md">&#12304;&#22238;&#21040;&#30446;&#24405;&#12305;</a></p>
<blockquote>
<p>&#31616;&#20171;&#22914;&#20309;&#20889;&#19968;&#20010;&#20256;&#24863;&#22120;&#20195;&#30721;&#65292;&#20026;&#31639;&#27861;&#27169;&#22359;&#25552;&#20379;&#25509;&#21475;&#65307;</p>
</blockquote>
<h2 id="lms">LMS</h2>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/lms_illus.png" class="w13" align="right" />

</div>
<p>&#22312;&#38405;&#35835;&#20102; <a href="http://gnat-tang-archive.qiniudn.com/lms.pdf">LMS &#35828;&#26126;&#25991;&#26723;</a> &#65292;&#26126;&#30333; LMS &#25968;&#25454;&#37319;&#38598;&#21644;&#23384;&#20648;&#22522;&#26412;&#21407;&#29702;&#21518;&#65292;LMS &#26159;&#25105;&#23436;&#25104;&#30340;&#31532;&#19968;&#20010;&#20256;&#24863;&#22120;&#27169;&#22359;&#12290;</p>
<p>&#20195;&#30721;&#23454;&#29616;&#19978;&#65292;&#20027;&#35201;&#25991;&#20214;&#26377;</p>
<ul>
<li>lmsreader.h</li>
<li>lmsreader.cpp</li>
<li>lmsreaderconfig.h</li>
<li>lmsreaderconfig.cpp</li>
<li>lmsreaderconfig.ui</li>
</ul>
<p>&#20854;&#20013; <code>lmsreader{.h, .cpp}</code> &#26159;&#23454;&#29616; LMS &#21151;&#33021;&#30340;&#31867;&#65292; <code>lmsreaderconfig{.h, .cpp, .ui}</code> &#26159;&#23545; LMS &#36827;&#34892;&#35774;&#32622;&#30340;&#30028;&#38754;&#12290;&#22522;&#20110;&#12304;&#30028;&#38754;&#65288;&#30456;&#24403;&#20110;&#19968;&#20010;&#20195;&#29702;&#65289;&#21644;&#31867;&#65288;&#23454;&#38469;&#24178;&#27963;&#30340;&#20154;&#65289;&#24212;&#24403;&#20302;&#32806;&#21512;&#12305;&#30340;&#21407;&#21017;&#65292; lmsreaderconfig &#30028;&#38754;&#21482;&#20570;&#31616;&#21333;&#30340; validation, confinement&#65292;&#23558;&#25353;&#38062;&#23545;&#24212;&#30456;&#24212;&#30340;&#20989;&#25968;&#65292;&#20869;&#37096;&#37117;&#26159;&#22312;&#35843;&#29992; lmsreader &#30340;&#20989;&#25968;&#12290;&#65288;&#20851;&#20110;&#20302;&#32806;&#21512;&#65292;&#35814;&#32454;&#35265;&#25105;&#20204;&#20043;&#21069;&#30340;&#25991;&#26723;&#65306; <a href="https://github.com/district10/changsha/blob/master/doc/modulize.md">changsha/modulize.md at master &#183; district10/changsha</a>&#65289;</p>
<p>LMS &#25552;&#20379;&#30340;&#22522;&#30784;&#21151;&#33021;&#26377;</p>
<ul>
<li><code>QString getAddress()</code>, &#33719;&#24471; LMS &#30340; IP &#22320;&#22336;</li>
<li><code>quint16 getPort()</code>, &#31471;&#21475;</li>
<li><code>void turnOnReading()</code>, &#24320;&#22987;&#35835;&#21462;</li>
<li><code>void turnOffReading()</code>, &#20572;&#27490;&#35835;&#21462;&#24182;&#20445;&#23384;</li>
<li><code>void getAngleStartEnd()</code>, &#35831;&#27714; LMS &#35774;&#32622;: &#25195;&#25551;&#36215;&#22987;&#35282;</li>
<li><code>void getFrequencyAngleresolution()</code>, &#35831;&#27714; LMS &#35774;&#32622;: &#25195;&#25551;&#39057;&#29575;, &#35282;&#24230;&#20998;&#36776;&#29575;</li>
</ul>
<p>&#25193;&#23637;&#21151;&#33021;&#65288;&#20854;&#23454;&#36825;&#20123;&#20195;&#30721;&#21482;&#35201;&#36816;&#34892;&#36807;&#19968;&#27425;&#23601;&#22909;&#65292;&#22240;&#20026; LMS &#30340;&#35774;&#23450;&#37117;&#35201;&#22266;&#23450;&#65292;&#19981;&#38656;&#35201;&#38543;&#26102;&#35843;&#25972;&#65289;</p>
<ul>
<li><code>void authorize()</code>, authorize &#21518;&#25165;&#33021;&#35774;&#32622;&#25195;&#25551;&#35282;&#24230;&#20998;&#36776;&#29575;, &#24674;&#22797;&#20986;&#21378;&#35774;&#32622;, etc</li>
<li><code>void setFactoryDefault()</code>, &#24674;&#22797;&#20986;&#21378;&#35774;&#32622;</li>
<li><code>void saveSettings()</code>, &#20445;&#23384;&#35774;&#32622;</li>
</ul>
<p>Signals (public)</p>
<ul>
<li><code>void angle_start_end(int beg, int end)</code>, &#25195;&#25551;&#35282;&#24230;&#33539;&#22260;</li>
<li><code>void frequency_angleresolution(int freq, double res)</code>, &#39057;&#29575;,&#35282;&#24230;&#20998;&#36776;&#29575;</li>
<li><code>void authorization_passed(bool auth)</code></li>
<li><code>void scanning(int i, int freq)</code>, for showing 1/50~50/50 or 1/25~25/25</li>
</ul>
<p>&#19979;&#38754;&#30452;&#25509;&#30475;&#20195;&#30721;&#12290;</p>
<p>&#39318;&#20808;&#25105;&#20204;&#23450;&#20041;&#20102;&#19968;&#20123;&#26631;&#24535;&#20301;&#65292;&#26041;&#20415; LMS &#22312;&#19981;&#21516;&#26465;&#20214;&#19979;&#24037;&#20316;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#ifndef LMSREADER_H</span>
<span class="ot">#define LMSREADER_H</span>

<span class="ot">#define LMS_USE_THREAD              (  true   )</span>
<span class="ot">#define LMS_PARSE_ON_THE_FLY        (  true   )  </span><span class="co">// on the fly: slightly slower</span>
<span class="ot">#define LMS_PRINT_SCAN_BUF          (  false  )  </span><span class="co">// flags for debugging</span>
...
<span class="ot">#define LMS_PROFILE_SIZE            (  50*60*5 )</span>
<span class="ot">#define LMS_DEFAULT_ADDRESS         ( &quot;192.168.0.1&quot; )</span>
<span class="ot">#define LMS_DEFAULT_PORT            ( 2111 )</span>
<span class="ot">#define LMS_PROFILE_POINTS_NUM      ( 541 )</span>
...

<span class="ot">#define M_PI (3.14159265358979323846)</span>

<span class="ot">#include &quot;datastruct.h&quot;</span>
<span class="ot">#include &quot;utils.h&quot;</span>
<span class="ot">#include &quot;logger.h&quot;</span>
<span class="ot">#include &lt;QStringList&gt;</span>
<span class="ot">#include &lt;QTcpSocket&gt;   </span><span class="co">// &#25552;&#20379; TCP &#32593;&#32476;&#21151;&#33021;</span>
<span class="ot">#include &lt;QHash&gt;</span>
<span class="ot">#include &lt;string&gt;</span>

<span class="ot">#ifndef Q_MOC_RUN</span>
<span class="ot">#include &lt;boost/thread.hpp&gt;</span>
<span class="ot">#include &lt;boost/thread/mutex.hpp&gt;</span>
<span class="ot">#include &lt;boost/thread/condition.hpp&gt;</span>
<span class="ot">#include &lt;boost/chrono/chrono.hpp&gt;</span>
<span class="ot">#endif</span></code></pre></div>
<p>&#20854;&#20013;&#26368;&#37325;&#35201;&#30340;&#26159; <code>#define LMS_PARSE_ON_THE_FLY</code>&#65292;&#23427;&#20915;&#23450;&#20102; LMS &#37319;&#38598;&#21040;&#30340;&#25968;&#25454;&#35201;&#19981;&#35201;&#22312;&#32447;&#36716;&#21270;&#20026;&#22352;&#26631;&#28857;&#12290;&#36825;&#37324;&#29992;&#30340;&#26159;&#23439;&#32780;&#19981;&#26159; enum hack&#65292;&#20027;&#35201;&#32771;&#34385;&#30340;&#26159;&#36825;&#20123;&#21464;&#37327;&#36824;&#35201;&#34987;&#31639;&#27861;&#27169;&#22359;&#29992;&#21040;&#65292;enum hack &#26377;&#20316;&#29992;&#22495;&#65292;&#22312;&#22806;&#37096;&#20351;&#29992;&#36215;&#26469;&#27809;&#26377;&#23439;&#26041;&#20415;&#12290;&#37027;&#20010; <code>M_PI</code> &#26159;&#20174; math.h &#25335;&#36125;&#26469;&#30340;&#65288;&#37027;&#20960;&#20010; <code>USE_MATH_DEFINITIONS</code> &#20043;&#31867;&#30340;&#20960;&#20010;&#30772;&#23439;&#30495;&#26159;&#22826;&#40635;&#28902;&#20102;&#65292;&#25152;&#20197;&#25105;&#32034;&#24615;&#32473;&#23427;&#25335;&#36125;&#36807;&#26469;&#20102;&#65289;&#12290;</p>
<p>&#36824;&#29992;&#21040;&#20102; boost &#24211;&#30340;&#22810;&#32447;&#31243;&#65292;&#25152;&#20197;&#21152;&#19978;&#20102;&#23427;&#30340;&#22836;&#25991;&#20214;&#12290;<code>boost/chrono/chrono.hpp</code> &#21407;&#26412;&#26159;&#35201;&#20570;&#26102;&#38388;&#25139;&#65292;&#20294;&#21518;&#26469;&#25105;&#20204;&#29992;&#20102; Qt &#30340; QDateTime&#65292;&#25152;&#20197;&#20854;&#23454;&#24050;&#32463;&#34987;&#24223;&#32622;&#20102;&#12290;</p>
<p>&#33267;&#20110;&#37027;&#20010; <code>#ifndef Q_MOC_RUN</code>&#65292;&#25105;&#20204;&#26159;&#30896;&#21040;&#20102;&#38382;&#39064;&#25165;&#21152;&#19978;&#30340;&#12290;&#35828;&#26159;&#8220;&#25105;&#20204;&#19981;&#24076;&#26395; Qt &#30340; <code class="sourceCode bash"><span class="kw">moc</span></code> &#23545; Boost &#30340;&#22836;&#25991;&#20214;&#36827;&#34892; moc&#65292;&#25152;&#20197;&#21482;&#22312; moc &#21069; include&#12290;&#8221;&#65292;&#20294;&#25105;&#20854;&#23454;&#19981;&#25026;&#65292;&#20026;&#20160;&#20040; moc &#35201;&#22788;&#29702; boost &#30340;&#20195;&#30721;&#65311;&#8230;&#8230;</p>
<p>LMSReader &#36890;&#36807; TCP &#21644; LMS &#36830;&#25509;&#65292;&#36827;&#34892;&#36890;&#20449;&#65292;&#23427;&#39318;&#20808;&#38598;&#25104;&#33267; QTcpSocket &#31867;&#12290;&#36825;&#20010;&#31867;&#20027;&#35201;&#25552;&#20379;&#65306;</p>
<ul>
<li><code>readyReady</code> &#20449;&#21495;&#65292;&#24403;&#25968;&#25454;&#26469;&#20102;&#30340;&#26102;&#20505;&#65292;&#36825;&#20010;&#20449;&#21495;&#34987; emit&#65307;</li>
<li><code>read</code> &#20989;&#25968;&#65292;&#21487;&#20197;&#35835;&#21462;&#32593;&#32476;&#25968;&#25454;&#65292;&#31867;&#20284;&#30340;&#36824;&#26377; <code>readAll</code> &#20989;&#25968;&#65292;&#31561;&#31561;&#65292;&#23427;&#20204;&#36820;&#22238;&#30340;&#37117;&#26159; <code>QByteArray</code> &#31867;&#22411;&#30340;&#25968;&#25454;&#65307;</li>
<li><code>write</code> &#20989;&#25968;&#65292;&#21487;&#20197;&#20889;&#20986;&#25968;&#25454;&#12290;</li>
</ul>
<p>&#19979;&#38754;&#26159;&#20027;&#35201;&#20195;&#30721;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">class</span> LMSReader : <span class="kw">public</span> <span class="ot">QTcpSocket</span>
{
    <span class="kw">Q_OBJECT</span>

<span class="kw">private</span>:
    <span class="kw">enum</span> LMSAction { GET_FREQ_ANGRES, SET_FREQ_ANGRES, GET_ANGBEG_ANGEND, SET_ANGBEG_ANGEND, ...  };
    <span class="kw">typedef</span> <span class="ot">QHash</span>&lt;LMSAction, <span class="ot">QString</span>&gt; ActionType;
    <span class="dt">const</span> <span class="dt">static</span> ActionType actions;
    <span class="co">// &#36825;&#26159;&#36807;&#24230;&#24037;&#31243;&#30340;&#36951;&#36857;</span>
    <span class="dt">static</span> ActionType configureActions( );

    <span class="kw">enum</span> LMSAuth {
        AUTH_MAINTENANCE          = <span class="bn">0x02</span>,
        AUTH_AUTHEDCLIENT         = <span class="bn">0x03</span>,
        AUTH_SERVICELEVEL         = <span class="bn">0x04</span>,
    };
    <span class="kw">typedef</span> <span class="ot">QHash</span>&lt;LMSAuth, <span class="ot">QString</span>&gt; AuthType;
    <span class="dt">const</span> <span class="dt">static</span> AuthType auths;
    <span class="co">// &#36825;&#20063;&#26159;&#36807;&#24230;&#24037;&#31243;&#30340;&#36951;&#36857;</span>
    <span class="dt">static</span> AuthType configureAuthLevels( );

    <span class="co">// &#20889;&#36807;&#20960;&#27425;&#20195;&#30721;&#65292;&#20320;&#23601;&#35760;&#20303;&#20102; static &#23545;&#35937;&#65292;&#12304;&#21482;&#12305;&#26377; int &#22411;&#21487;&#20197;&#22312;&#22768;&#26126;&#30340;&#26102;&#20505;&#23601;&#21021;&#22987;&#21270;&#12290;</span>
    <span class="co">// &#65288;&#20063;&#19981;&#29992;&#20877;&#22312;&#31867;&#22806;&#20877;&#23450;&#20041;&#65289;</span>
    <span class="dt">const</span> <span class="dt">static</span> <span class="dt">int</span> lmsAngleMin  = <span class="dv">-45</span>;
    <span class="dt">const</span> <span class="dt">static</span> <span class="dt">int</span> lmsAngleMax  = <span class="dv">225</span>;

    <span class="kw">enum</span> LMSUserLevel {
        MAINTENANCE               = <span class="bn">0x02</span>,
        AUTHORIZED_CLIENT         = <span class="bn">0x03</span>,
        SERVICE                   = <span class="bn">0x04</span>,
    };

    <span class="kw">enum</span> {
        <span class="co">// STX, ETX &#36825;&#20004;&#20010; ASCII &#23383;&#31526;&#20102;&#35299;&#19968;&#19979;&#26159;&#19981;&#38169;&#30340;&#65292;&#21069;&#32773;&#26159;</span>
        <span class="co">// STX: start of text&#65292;&#21518;&#32773;&#26159;</span>
        <span class="co">// ETX: end   of text</span>
        STX                       = <span class="bn">0x02</span>,
        ETX                       = <span class="bn">0x03</span>,
        AUTHORIZATION_SUCCESS     = <span class="dv">1</span>,
        AUTHORIZATION_FAULURE     = <span class="dv">0</span>,
        ANGLE_SCALE_FACTOR        = <span class="dv">10000</span>,          <span class="co">/* 1/10000 Hz   */</span>
        FREQUENCY_SCALE_FACTOR    = <span class="dv">100</span>,            <span class="co">/* 1/100 Degree */</span>
    };

    <span class="ot">QString</span> address;            <span class="co">// LMS &#30340; ip &#22320;&#22336;</span>
    <span class="dt">quint16</span> port;               <span class="co">// LMS &#30340;&#31471;&#21475;&#65292;&#40664;&#35748; 2111&#65292;LMS &#30456;&#24403;&#20110;&#19968;&#20010;&#26381;&#21153;&#22120;&#65292;</span>
                                <span class="co">// &#23427;&#20250;&#32473;&#27599;&#19968;&#20010;&#36830;&#25509;&#21457;&#36865;&#25968;&#25454;&#65288;&#35201;&#20808;&#35831;&#27714; LMS &#21457;&#36865;&#25968;&#25454;&#65289;</span>
    <span class="ot">QByteArray</span> lmsBA;
<span class="ot">#ifdef LMS_PRINT_PROFILE_SAMPLE</span>
    <span class="ot">QByteArray</span> zgBA;
<span class="ot">#endif</span>

    <span class="dt">int</span> lmsFrequency;           <span class="co">// &#19968;&#20123;&#21464;&#37327;</span>
    <span class="dt">double</span> lmsAngleRes;
    <span class="dt">double</span> lmsAngleBeg;
    <span class="dt">double</span> lmsAngleEnd;
    size_t lmsCount;

<span class="kw">public</span>:
    <span class="dt">bool</span> isRun;
    <span class="dt">bool</span> connected;
    <span class="dt">int</span> profileCur;
    boost::mutex mutex;
    vector&lt;<span class="ot">QStringList</span>&gt; profiles_raw;
    profile_t profilesX[ LMS_PROFILE_SIZE ];
    ...</code></pre></div>
<p>&#36825;&#37324;&#20540;&#24471;&#19968;&#25552;&#30340;&#26159; profilesX&#65292;&#23427;&#21407;&#26469;&#20063;&#26159;&#29992;&#30340; vector&#65292;&#20294;&#26159;&#32769;&#20986;&#38382;&#39064;&#65292;&#21518;&#26469;&#21457;&#29616;&#21407;&#26469;&#26159; <code>push_back</code> &#22826;&#22810;&#21518;&#65292; vector &#30340;&#39318;&#22320;&#22336;&#23601;&#25442;&#20102;&#20301;&#32622;&#65288;&#21407;&#26469;&#30340;&#22320;&#26041;&#25918;&#19981;&#19979;&#65292;&#20110;&#26159;&#23427;&#37325;&#26032;&#20998;&#37197;&#20102;&#19968;&#20010;&#36830;&#32493;&#31354;&#38388;&#65289;&#65292;&#20110;&#26159;&#25105;&#20204;&#20889;&#27515;&#20102;&#22823;&#23567;&#65292;&#25442;&#25104;&#20102;&#25968;&#32452;&#12290;</p>
<p>&#19981;&#36807;&#29616;&#22312;&#30693;&#36947;&#65292;vector &#20063;&#21487;&#20197;&#39044;&#30041;&#22823;&#23567;==&#65292;&#23450;&#20041;&#30340;&#26102;&#20505;&#30452;&#25509;&#29992; <code>vector&lt;T&gt; v(t, a_big_number)</code> &#23601;&#21487;&#20197;&#20102;&#21834;&#12290;</p>
<p>&#21478;&#22806;&#20540;&#24471;&#19968;&#25552;&#30340;&#26159;&#37027;&#20010; <code>bool isRun</code>&#65292;&#21407;&#26469;&#25105;&#20204;&#20351;&#29992;&#30340;&#26159;&#20989;&#25968;&#20869;&#30340;&#38745;&#24577;&#25104;&#21592;&#65292;&#20294;&#23454;&#38469;&#29992;&#20102;&#25165;&#21457;&#29616;&#25105;&#20204;&#30340;&#20004;&#20010; LMS &#20940;&#20081;&#20102;&#65292;&#22240;&#20026;&#20004;&#20010;&#25104;&#21592; lms1 &#21644; lms2 &#23621;&#28982;&#20351;&#29992;&#20102;&#19968;&#20010; <code>isRun</code>&#65292;&#20294;&#23427;&#20204;&#24212;&#24403;&#26159;&#29420;&#31435;&#30340;&#12290;&#36825;&#20063;&#26159;&#23454;&#36341;&#36807;&#31243;&#20013;&#30896;&#21040;&#30340;&#19968;&#20010;&#22823;&#22353;&#12290;</p>
<p>&#25509;&#30528;&#19978;&#38754;&#30340;&#20195;&#30721;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// class LMSReader() {</span>
    ...

<span class="kw">public</span>:
    <span class="kw">explicit</span> LMSReader( );
    ~ LMSReader( );

    <span class="co">// &#22825;&#30693;&#36947;&#25105;&#33457;&#20102;&#22810;&#23569;&#26102;&#38388;&#20889;&#36825;&#20123;&#26080;&#32842;&#30340; getter&#12289;setter &#20989;&#25968;</span>
    <span class="co">//!</span> configure LMS address &amp; port
    <span class="dt">void</span> setAddressPort( <span class="dt">const</span> <span class="ot">QString</span> &amp;address, <span class="dt">const</span> <span class="dt">quint16</span> &amp;port );
    <span class="dt">void</span> resetAddressPort( );
    <span class="ot">QString</span> getAddress( ) { <span class="kw">return</span> address; }
    <span class="dt">quint16</span> getPort( ) { <span class="kw">return</span> port; }

    <span class="co">//!</span> set basedir of output
    <span class="co">// &#27627;&#26080;&#24517;&#35201;&#30340;&#37325;&#36733;&#65292;&#24403;&#26102;&#24212;&#35813;&#22312;&#39033;&#30446;&#32452;&#37324;&#25512; QString&#65292;&#20294;&#26159;&#22823;&#23478;&#20284;&#20046;&#37117;&#21916;&#27426; std::string&#65292;</span>
    <span class="co">// &#25105;&#20498;&#26159;&#35273;&#24471; QString &#22909;&#29992;&#24471;&#22810;&#22826;&#22810;&#12290;</span>
    <span class="dt">void</span> setBasedir( <span class="dt">const</span> string &amp;bd )  { basedir = <span class="ot">QString</span>( bd.c_str() ); }
    <span class="dt">void</span> setBasedir( <span class="dt">const</span> <span class="dt">char</span> *bd )    { basedir = <span class="ot">QString</span>( bd ); }
    <span class="dt">void</span> setBasedir( <span class="dt">const</span> <span class="ot">QString</span> &amp;bd ) { basedir = bd; }

    <span class="dt">void</span> postparse( );
    <span class="dt">void</span> start( <span class="dt">qint64</span> ts = <span class="dv">0</span> );
    <span class="dt">void</span> stop( );
    <span class="dt">void</span> closeConnection( );

    <span class="dt">void</span> pollingOne( );
    <span class="dt">void</span> turnOnReadingInLazyMode( );
    <span class="dt">void</span> turnOnReading( );
    <span class="dt">void</span> turnOffReading( );
    <span class="co">// &#36825;&#37324;&#21024;&#25481;&#20102;&#24456;&#22810;&#20989;&#25968;&#22768;&#26126;&#65292;&#22240;&#20026;&#23427;&#20204;&#27809;&#24517;&#35201;&#22312;&#36825;&#37324;&#25552;&#21040;</span>

<span class="kw">private</span>:
    <span class="ot">QString</span> basedir;
    <span class="dt">void</span> writeLMS( <span class="dt">const</span> <span class="ot">QString</span> &amp;msg );
    <span class="dt">void</span> parse( <span class="dt">const</span> <span class="ot">QStringList</span> &amp;bufstrlist );
    <span class="dt">void</span> postparse( <span class="ot">QStringList</span> &amp;bufstrlist, profile_t &amp;profile );
    ...</code></pre></div>
<p>&#19979;&#38754;&#26159;&#19968;&#20123; signal/slots&#65288;&#20449;&#21495;&#21644;&#27133;&#65289;&#65292;&#20027;&#35201;&#29992;&#20110;&#21578;&#35785;&#20027;&#30028;&#38754;&#65292;LMS &#37197;&#32622;&#22909;&#20102;&#65292;&#21487;&#20197;&#36827;&#34892;&#20989;&#25968;&#22238;&#35843;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// class LMSReader() {</span>
    ...

<span class="kw">signals</span>:
    <span class="dt">void</span> angle_begin_end( <span class="dt">int</span> beg, <span class="dt">int</span> end );
    <span class="dt">void</span> frequency_angleresolution( <span class="dt">int</span> freq, <span class="dt">double</span> res );
    <span class="dt">void</span> authorization_passed( <span class="dt">bool</span> auth );
    <span class="dt">void</span> scanning( <span class="dt">int</span> i, <span class="dt">int</span> freq );
    <span class="dt">void</span> lmsConnected( <span class="dt">bool</span> on );

<span class="kw">public</span> <span class="kw">slots</span>:
    <span class="dt">void</span> connectToLMS( );
    <span class="dt">void</span> connectToLMS( <span class="ot">QString</span> addr, <span class="dt">quint16</span> port );
    <span class="dt">void</span> readLMS( );
    <span class="dt">void</span> lmsConnectionError( <span class="ot">QAbstractSocket::</span>SocketError );
    <span class="dt">void</span> onStateChanged( <span class="ot">QAbstractSocket::</span>SocketState state );
};</code></pre></div>
<p>&#20174; LMS &#30340;&#35828;&#26126;&#25991;&#26723;&#37324;&#65292;&#25105;&#30693;&#36947;&#27599;&#20010;&#23545; LMS &#30340;&#25805;&#20316;&#65292;&#20854;&#23454;&#37117;&#26159;&#21521; LMS &#21457;&#36865;&#19968;&#20010;&#29305;&#23450;&#30340;&#23383;&#31526;&#20018;&#12290;&#20110;&#26159;&#25105;&#36807;&#24230;&#24037;&#31243;&#22320;&#65288;&#20026;&#20160;&#20040;&#21448;&#26159;&#36807;&#24230;&#24037;&#31243;==&#65289;&#25226;&#36825;&#20123;&#23383;&#31526;&#20018;&#36215;&#20102;&#21517;&#23383;&#65292;&#36824;&#29992;&#20102; QHash&#65306;</p>
<pre><code>enum LMSAction {
    GET_FREQ_ANGRES,
    SET_FREQ_ANGRES,
    GET_ANGBEG_ANGEND,
    SET_ANGBEG_ANGEND,
    ...
};
typedef QHash&lt;LMSAction, QString&gt; ActionType;
const static ActionType actions;
static ActionType configureActions( );</code></pre>
<p>&#29616;&#22312;&#24819;&#24819;&#30495;&#26159;&#27627;&#19981;&#24517;&#35201;&#12290;</p>
<p>lmsreader.cpp &#37324;&#30340;&#23454;&#29616;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">const</span> LMSReader::ActionType LMSReader::actions = LMSReader::configureActions( );
<span class="co">// &#23454;&#29616;&#26159;&#65306;</span>
<span class="co">//  LMSReader::ActionType LMSReader::configureActions( )</span>
<span class="co">//  {</span>
<span class="co">//      LMSReader::ActionType actions;</span>
<span class="co">//      actions[  GET_FREQ_ANGRES    ] = &quot;sRN LMPscancfg&quot;;</span>
<span class="co">//      actions[  SET_FREQ_ANGRES    ] = &quot;sMN mLMPsetscancfg&quot;;</span>
<span class="co">//      actions[  GET_ANGBEG_ANGEND  ] = &quot;sRN LMPoutputRange&quot;;</span>
<span class="co">//      ...</span>
<span class="co">//      return actions;</span>
<span class="co">//  }</span>

<span class="dt">const</span> LMSReader::AuthType LMSReader::auths = LMSReader::configureAuthLevels( );
<span class="co">// &#23454;&#29616;&#26159;&#65306;</span>
<span class="co">//  LMSReader::AuthType LMSReader::configureAuthLevels( )</span>
<span class="co">//  {</span>
<span class="co">//      LMSReader::AuthType authLevels;</span>

<span class="co">//      authLevels[  AUTH_MAINTENANCE   ] = &quot;B21ACE26&quot;;</span>
<span class="co">//      authLevels[  AUTH_AUTHEDCLIENT  ] = &quot;F4724744&quot;;</span>
<span class="co">//      authLevels[  AUTH_SERVICELEVEL  ] = &quot;81BE23AA&quot;;</span>

<span class="co">//      // Logger::log( BCD::LMS::CONFIG_AUTH_LEVELS );</span>
<span class="co">//      return authLevels;</span>
<span class="co">//  }</span></code></pre></div>
<p>&#27627;&#26080;&#30097;&#38382;&#65292;&#36825;&#20004;&#20010; hash &#27627;&#26080;&#24517;&#35201;&#12290;&#24403;&#26102;&#25105;&#36824;&#25554;&#20102;&#65292;&#35828;&#26159; QHash &#21644; QMap &#30340;&#25509;&#21475;&#20960;&#20046;&#19968;&#26679;&#65292;&#20294;&#26159; QHash &#25928;&#29575;&#39640;&#19968;&#28857;&#65292;&#25152;&#20197;&#36825;&#37324;&#29992;&#30340;&#26159; QHash&#12290;&#20294;&#65292;&#25105;&#20204;&#30340;&#23454;&#38469;&#65292;&#29992;&#21738;&#20010;&#20854;&#23454;&#37117;&#19968;&#26679;&#65292;&#26368;&#22909;&#19981;&#35201;&#29992;==&#12290;</p>
<p>&#22312; LMS &#30340;&#26500;&#36896;&#20989;&#25968;&#37324;&#65292;&#35201;&#38142;&#25509;&#19968;&#20123;&#27133;&#20989;&#25968;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(readyRead() ),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(readLMS()) );
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectToLMS()) );
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(error(<span class="ot">QAbstractSocket::</span>SocketError)),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(lmsConnectionError(<span class="ot">QAbstractSocket::</span>SocketError)) );
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(stateChanged(<span class="ot">QAbstractSocket::</span>SocketState)),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(onStateChanged(<span class="ot">QAbstractSocket::</span>SocketState)) ); <span class="co">// &#36825;&#20010;&#20989;&#25968;&#20250;&#25552;&#31034;&#30028;&#38754; LMS &#26159;&#21542;&#8220;&#25481;&#32447;&#8221;</span>

<span class="co">// &#36825;&#26159;&#26085;&#24535;&#32426;&#24405;&#65292;&#21518;&#38754;&#30340; Logger::log &#20043;&#31867;&#20195;&#30721;&#25105;&#23601;&#21435;&#25481;&#20102;&#12290;</span>
Logger::log( BCD::LMS::CONSTRUCT );</code></pre></div>
<p>&#36825;&#20010; lmsConnectionError &#26159;&#19968;&#20010;&#26080;&#32842;&#30340;&#20989;&#25968;&#65292;&#35201;&#26159;&#26377; C++11&#65292;&#35841;&#36824;&#19987;&#38376;&#20889;&#19968;&#20010;&#36825;&#20989;&#25968;&#21834;&#65281;&#29992; lambda &#20989;&#25968;&#19981;&#23601;&#22909;&#20102;&#12290;&#25105;&#20204;&#21487;&#20197;&#25226;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(error(<span class="ot">QAbstractSocket::</span>SocketError)),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(lmsConnectionError(<span class="ot">QAbstractSocket::</span>SocketError)) ); <span class="co">// &#36830;&#25509;&#21040;&#36825;&#20010;&#27133;</span>
...
<span class="co">// &#23454;&#29616;&#23427;</span>
<span class="dt">void</span> LMSReader::lmsConnectionError( <span class="ot">QAbstractSocket::</span>SocketError err )
{
    Logger::log (  BCD::LMS::CONNECTION_ERROR, <span class="ot">QString</span>( err ) );
}</code></pre></div>
<p>&#25913;&#25104;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(error(<span class="ot">QAbstractSocket::</span>SocketError)),
         <span class="kw">this</span>, [=](<span class="ot">QAbstractSocket::</span>SocketError err) {  <span class="co">// &#30452;&#25509;&#22312;&#36825;&#37324;&#23454;&#29616;</span>
            Logger::log (  BCD::LMS::CONNECTION_ERROR, <span class="ot">QString</span>( err ) );
        } );</code></pre></div>
<p>&#22909;&#30475;&#22810;&#20102;&#65292;&#26159;&#21543;~</p>
<p>&#26512;&#26500;&#30340;&#26102;&#20505;&#65292;&#20808;&#20851;&#38381;&#32593;&#32476;&#36830;&#25509;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">LMSReader::~LMSReader( )
{
    closeConnection();
    Logger::log( BCD::LMS::DESTRUCT );
}

<span class="co">// &#36825;&#26159;&#23454;&#29616;&#20195;&#30721;</span>
<span class="dt">void</span> LMSReader::closeConnection( )
{
    <span class="kw">if</span> ( isOpen() ) {
        close();
        Logger::log (  BCD::LMS::DISCONNECT );
    }
}</code></pre></div>
<p>&#25353;&#29031;&#32422;&#23450; LMS &#21457;&#36865;&#30340;&#25968;&#25454;&#24212;&#35813;&#28385;&#36275;&#26684;&#24335;&#65306;<code>STX + &#25968;&#25454;&#23383;&#33410; + ETX</code>&#65292; STX &#21644; ETX &#26631;&#24535;&#20102;&#25968;&#25454;&#30340;&#19968;&#24103;&#12290;&#19968;&#24103;&#25968;&#25454;&#23601;&#26159;&#19968;&#27425;&#25195;&#25551;&#65292;&#22823;&#27010;&#26377; 550 &#20010;&#25195;&#25551;&#28857;&#65288;&#20855;&#20307;&#22312;&#12304;LMS &#30340;&#25968;&#25454;&#37327;&#12305;&#37324;&#21487;&#20197;&#30475;&#21040;&#65289;&#65292;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::writeLMS( <span class="dt">const</span> <span class="ot">QString</span> &amp;data )
{
    <span class="ot">QByteArray</span> ba;
    ba.append( <span class="bn">0x02</span> ); <span class="co">// &lt;STX&gt;, start of text&#65292;&#23601;&#35828;&#20102;&#20043;&#21069;&#30340;&#37027;&#20010; enum hack &#37324;&#30340;</span>
                       <span class="co">// STX&#65292;ETX &#26159;&#36807;&#24230;&#24037;&#31243;&#65292;&#22240;&#20026;&#21482;&#26377;&#25105;&#33258;&#24049;&#29992;&#36825;&#20004;&#20010;&#21464;&#37327;&#65292;&#25105;&#21448;&#27809;&#26377;&#29992;&#65281;</span>
    ba.append( data );
    ba.append( <span class="bn">0x03</span> ); <span class="co">// &lt;ETX&gt;, end of text</span>
    write( ba );
}</code></pre></div>
<p>&#20854;&#20013;&#30340; <code>write</code> &#20989;&#25968;&#26159; QTcpSocket &#25552;&#20379;&#30340;&#12290;&#20854;&#23454; <code>ba.append( data )</code> &#21487;&#20197;&#26356;&#26041;&#20415;&#22320;&#20889;&#25104; <code>ba &lt;&lt; data</code>&#65292;&#20294;&#26159;&#25105;&#20889;&#20064;&#24815;&#20102;&#65292;&#25152;&#20197;&#20960;&#20046;&#27809;&#26377;&#29992;&#36807; <code>operator&lt;&lt;</code>==&#12290;</p>
<p>&#36824;&#26377;&#22914;&#19979;&#30340;&#19968;&#20123;&#20989;&#25968;&#65292;&#23384;&#22312;&#26377;&#24847;&#20041;&#65292;&#20294;&#26159;&#20960;&#20046;&#22312;&#25105;&#20889;&#23436;&#21518;&#65292;&#21482;&#35774;&#32622;&#20102;&#19968;&#36941;&#65292;&#23601;&#19981;&#38656;&#35201;&#20877;&#20351;&#29992;&#20102;==&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#22240;&#20026;&#25105;&#20204;&#21482;&#35201; authorize &#19968;&#27425;&#65292;&#23601;&#33021;&#35774;&#23450; LMS &#30340;&#36215;&#22987;&#25195;&#25551;&#35282;&#24230;&#12289;&#25195;&#25551;&#30340;&#35282;&#24230;&#20998;&#36776;&#29575;&#12289;&#39057;&#29575;</span>
<span class="co">// &#28982;&#21518;&#23427;&#23601;&#22266;&#23450;&#19979;&#26469;&#20102;</span>
<span class="dt">void</span> LMSReader::authorize( )
{
    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;</span><span class="ch">%s</span><span class="st"> </span><span class="ch">%2d</span><span class="st"> </span><span class="ch">%s</span><span class="st">&quot;</span>,
                 <span class="fu">qPrintable</span>(actions.value( AUTHORIZE )),
                 AUTH_AUTHEDCLIENT,
                 <span class="fu">qPrintable</span>(auths.value( AUTH_AUTHEDCLIENT )) );
    writeLMS( str );

    Logger::log( BCD::LMS::AUTHORIZE );
}

<span class="co">// &#20063;&#27809;&#26377;&#24517;&#35201;&#20877;&#27425;&#33719;&#21462;&#36215;&#22987;&#25195;&#25551;&#35282;&#24230;&#65292;&#35282;&#24230;&#20998;&#36776;&#29575;&#31561;&#20102;</span>
<span class="dt">void</span> LMSReader::getAngleStartEnd( )
{
    writeLMS( actions[ GET_ANGBEG_ANGEND ] );

    Logger::log( BCD::LMS::ASK_SCANNING_ANGLE_START_END );
}

<span class="dt">void</span> LMSReader::getFrequencyAngleresolution( ) { ... }
<span class="dt">void</span> LMSReader::setFrequencyAngleresolution( <span class="dt">const</span> <span class="dt">int</span> &amp;freq,
                                             <span class="dt">const</span> <span class="dt">double</span> &amp;angres )
{
    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;</span><span class="ch">%s</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%d</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st">&quot;</span>,
                 <span class="fu">qPrintable</span>( actions[ SET_FREQ_ANGRES ] ),
                 FREQUENCY_SCALE_FACTOR * (freq),         <span class="co">// 25 or 50 Hz</span>
                 <span class="dv">1</span>,                                       <span class="co">// reserved</span>
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * (angres)),   <span class="co">// 0.25 or 0.5 degree</span>
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * (<span class="dv">-45</span> + <span class="dv">0</span>)),  <span class="co">// place holder</span>
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * (<span class="dv">225</span> - <span class="dv">0</span>))   <span class="co">// place holder</span>
               );
    writeLMS( str );

    Logger::log ( BCD::LMS::SET_SCANNING_FREQ_ANGRES,
                  <span class="ot">QString</span>( <span class="st">&quot;freq: %1, angres: %2&quot;</span> ).arg( freq ).arg( angres ) );
}

<span class="dt">void</span> LMSReader::setAngleStartEnd( <span class="dt">double</span> start, <span class="dt">double</span> end )
{
    <span class="kw">if</span> ( start  &gt; end )         { <span class="kw">return</span>; }
    <span class="kw">if</span> ( start  &lt; lmsAngleMin ) { start = lmsAngleMin; }
    <span class="kw">if</span> ( end    &gt; lmsAngleMax ) { end = lmsAngleMax; }

    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;</span><span class="ch">%s</span><span class="st"> </span><span class="ch">%d</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st">&quot;</span>,
                 <span class="fu">qPrintable</span>( actions[ SET_ANGBEG_ANGEND ] ),
                 <span class="dv">1</span>,                                  <span class="co">// status code</span>
                 FREQUENCY_SCALE_FACTOR * (<span class="dv">25</span>),      <span class="co">// place holder</span>
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * start),
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * end) );
    writeLMS( str );

    Logger::log ( BCD::LMS::SET_SCANNING_ANGLE_START_END,
                  <span class="ot">QString</span>( <span class="st">&quot;start: %1, end: %2&quot;</span> ).arg( start ).arg( end ) );
}


<span class="dt">void</span> LMSReader::setTimestamp( <span class="dt">quint16</span> year        <span class="co">/* = 2015 */</span>
                            , <span class="dt">quint8</span> month        <span class="co">/* =    1 */</span>
                            , <span class="dt">quint8</span> day          <span class="co">/* =    1 */</span>
                            , <span class="dt">quint8</span> hour         <span class="co">/* =    0 */</span>
                            , <span class="dt">quint8</span> minute       <span class="co">/* =    0 */</span>
                            , <span class="dt">quint8</span> second       <span class="co">/* =    0 */</span>
                            , <span class="dt">quint8</span> microsecond  <span class="co">/* =    0 */</span> )
{
    <span class="ot">QString</span> str;
    <span class="co">//               Y  M  D  H  M  S MS</span>
    str.sprintf( <span class="st">&quot;</span><span class="ch">%s</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st">&quot;</span>,
                 <span class="fu">qPrintable</span>( actions[SET_TIMESTAMP] ),
                 year, month, day,
                 hour, minute, second,
                 microsecond );
    writeLMS( str );

    Logger::log( BCD::LMS::SET_TIMESTAMP,
                 <span class="ot">QString</span>( <span class="st">&quot;</span><span class="ch">%1/%</span><span class="st">2/</span><span class="ch">%3-%</span><span class="st">4:</span><span class="ch">%5:%</span><span class="st">6.%7&quot;</span> )
                 .arg( year )
                 .arg( month )
                 .arg( day )
                 .arg( hour )
                 .arg( minute )
                 .arg( second )
                 .arg( microsecond ) );
}

<span class="co">// &#36824;&#26377;&#19968;&#20123;&#31867;&#20284;&#30340;&#20195;&#30721;&#65292;&#23601;&#19981;&#19968;&#19968;&#36148;&#22312;&#36825;&#37324;&#20102;</span>
<span class="dt">void</span> LMSReader::setFactoryDefault( ) { ... }
<span class="dt">void</span> LMSReader::setFactoryDefault( ) { ... }
<span class="dt">void</span> LMSReader::getTimestamp( ) { ... }
<span class="dt">void</span> LMSReader::logout( ) { ... }
<span class="dt">void</span> LMSReader::startMeasure( ) { ... }
<span class="dt">void</span> LMSReader::stopMeasure( ) { ... }
<span class="dt">void</span> LMSReader::reboot( ) { ... }
<span class="dt">void</span> LMSReader::pollingOne( ) { ... }
<span class="dt">void</span> LMSReader::connectToLMS( ) { ... }
<span class="dt">void</span> LMSReader::connectToLMS( <span class="ot">QString</span> addr, <span class="dt">quint16</span> port ) { ... }</code></pre></div>
<p>LMS &#30340;&#25968;&#25454;&#24212;&#35813;&#20445;&#23384;&#20986;&#26469;&#65292;&#20294;&#26159;&#27809;&#24517;&#35201;&#23384;&#21040; log &#37324;&#65292;&#25152;&#20197;&#23427;&#27599;&#27425; start&#12289;stop &#36816;&#34892;&#21518;&#65292;&#23601;&#20250;&#20445;&#23384;&#20986;&#19968;&#20010;&#28857;&#20113;&#25968;&#25454;&#65292;&#21487;&#20197;&#29992; CloudStudio &#30452;&#25509;&#25171;&#24320;&#65288;&#31532;&#20108;&#21015;&#21363; y &#36724;&#30340;&#25289;&#20280;&#35201;&#25226;&#25569;&#22909;&#25165;&#22909;&#30475;&#65289;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::genNewPath( )
{
    <span class="dt">quint64</span> dt = <span class="ot">QDateTime::</span>currentMSecsSinceEpoch();
    lmsOutputPath.sprintf( <span class="st">&quot;</span><span class="ch">%lld</span><span class="st">-LMS-XYZ.txt&quot;</span>, dt );

    Logger::log( BCD::LMS::GEN_NEW_PATH, lmsOutputPath );
}
<span class="co">/*</span>
<span class="co"> * &#20445;&#23384;&#20986;&#26469;&#30340;&#25991;&#20214;&#22823;&#27010;&#26159;&#36825;&#26679;&#65306;</span>

<span class="co">      124.4507934888                  1437721968720      -124.4507934888</span>
<span class="co">      116.2598232121                  1437721968720      -114.2482100809</span>
<span class="co">      145.3066396684                  1437721968720      -140.3209908327</span>
<span class="co">      155.2301153966                  1437721968720      -147.3078791985</span>
<span class="co">      139.6885570093                  1437721968720      -130.2616867719</span>
<span class="co">      134.9217526363                  1437721968720      -123.6330079937</span>
<span class="co">      163.4918616050                  1437721968720      -147.2087333989</span>
<span class="co">      232.1762734446                  1437721968720      -205.4122149469</span>

<span class="co">**/</span></code></pre></div>
<p>&#26368;&#21518;&#65292;LMS &#26368;&#26680;&#24515;&#30340;&#19968;&#37096;&#20998;&#65292;&#26159;&#23545;&#25910;&#21040;&#30340; LMS &#25968;&#25454;&#36827;&#34892;&#35299;&#26512;&#65292;&#19979;&#38754;&#25105;&#20204;&#19968;&#28857;&#28857;&#20998;&#26512;&#36825;&#20010;&#20989;&#25968;&#12290;</p>
<p>&#39318;&#20808;&#65292;&#24403;&#32593;&#32476;&#20013;&#26377;&#25968;&#25454;&#26102;&#65292;&#20449;&#21495; <code>readyRead</code> &#23601;&#34987; emit&#65292;&#23601;&#20250;&#35843;&#29992; <code>readLMS()</code> &#20989;&#25968;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//  connect( this, SIGNAL(readyRead() ),</span>
<span class="co">//           this, SLOT(readLMS()) );</span>
<span class="dt">void</span> LMSReader::readLMS( )
{
    ...
}</code></pre></div>
<p>&#22312; <code>readLMS</code> &#20989;&#25968;&#37324;&#65292;&#23427;&#20808;&#25226;&#25152;&#26377;&#30340;&#25968;&#25454;&#35835;&#21462;&#21040;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">QByteArray</span> ba = readAll();
lmsBA.append( ba );

<span class="co">// read until &lt;ETX&gt; (end of one scan)</span>
<span class="kw">if</span> ( ba.at(ba.length() <span class="dv">-1</span>) != ETX ) {
    <span class="kw">return</span>;
}</code></pre></div>
<p>&#19978;&#38754;&#30340; <code>ba.at(ba.length()-1 != ETX)</code> &#26159;&#19968;&#20010;&#20445;&#25252;&#24615;&#36136;&#30340;&#25805;&#20316;&#65292;&#20063;&#26159;&#25105;&#20204;&#22312;&#23454;&#38469;&#20889;&#20195;&#30721;&#21518;&#21457;&#29616;&#20102;&#38382;&#39064;&#65292;&#25165;&#25913;&#36827;&#30340;&#12290;&#22240;&#20026; LMS &#19968;&#20010; profile &#30340;&#32593;&#32476;&#25968;&#25454;&#21487;&#33021;&#20250;&#20998;&#25104;&#22810;&#27425;&#20256;&#32473;&#30005;&#33041;&#65292;&#30005;&#33041;&#19981;&#24212;&#35813;&#22312;&#25910;&#21040;&#25968;&#25454;&#23601;&#36827;&#34892;&#22788;&#29702;&#65292;&#23427;&#35201;&#20808;&#21028;&#26029;&#65292;&#36825;&#20010; profile &#26159;&#21542;&#23436;&#25972;&#65292;&#22914;&#26524;&#23436;&#25972;&#20102;&#65288;&#25910;&#21040;&#20102; <code>ETX</code>&#65289;&#65292;&#25165;&#22788;&#29702;&#20043;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">    <span class="ot">QString</span> bufstr( lmsBA );

<span class="ot">#ifdef LMS_PRINT_PROFILE_SAMPLE</span>
    zgBA = lmsBA;
<span class="ot">#endif</span>

    lmsBA.clear();</code></pre></div>
<p>LMS &#27599;&#25910;&#21040;&#19968;&#32452;&#25968;&#25454;&#65292;&#23601; emit &#19968;&#20010;&#20449;&#21495;&#65292;&#35753;&#30028;&#38754;&#26174;&#31034;&#36827;&#24230;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// emit progress, 1/50 ~ 50/50 or 1/25 ~ 25/25</span>
<span class="dt">static</span> <span class="dt">int</span> f = <span class="dv">0</span>;
f = (++f) % lmsFrequency;
<span class="kw">emit</span> scanning( f<span class="dv">+1</span>, lmsFrequency );</code></pre></div>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// not run, so no need to parse</span>
<span class="co">// &#22914;&#26524;&#27809;&#26377;&#25171;&#24320;&#35835;&#21462;&#65288;turnOnReading&#65289;&#65292;&#23601;&#19981;&#22788;&#29702;&#25910;&#21040;&#30340;&#25968;&#25454;</span>
<span class="kw">if</span> ( !isRun ) {
    <span class="co">// qDebug() &lt;&lt; &quot;Hit! But drop it.&quot;;</span>
    <span class="kw">return</span>;
}

<span class="co">// &#36825;&#26159; debug &#30340;&#26102;&#20505;&#29992;&#21040;&#30340;&#65292;&#21487;&#20197;&#25226;&#25910;&#21040;&#30340;&#20869;&#23481;&#25171;&#21360;&#22312;&#25511;&#21046;&#21488;</span>
<span class="kw">if</span>( LMS_PRINT_SCAN_BUF ) {
    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Bufstr: &quot;</span> &lt;&lt; bufstr;
}

<span class="co">// do it now!</span>
<span class="ot">QStringList</span> bufstrlist = bufstr.split(<span class="st">&quot; &quot;</span>);</code></pre></div>
<p>&#28982;&#21518;&#23545;&#25910;&#21040;&#30340;&#25968;&#25454;&#36827;&#34892;&#20998;&#21457;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">    <span class="co">// dispatch</span>
    <span class="kw">if</span>( <span class="kw">false</span> ) {
        <span class="co">// &#25105;&#36890;&#24120;&#37117;&#21916;&#27426;&#20808;&#20889;&#19968;&#20010; if(false)&#65292;&#20320;&#36896;&#20026;&#20160;&#20040;&#21527;&#65311;</span>
    } <span class="kw">else</span> <span class="kw">if</span>( bufstrlist.at(<span class="dv">1</span>) == actions[TURN_ON].split(<span class="st">&quot; &quot;</span>).at(<span class="dv">1</span>) ) {
        <span class="kw">if</span> ( LMS_PARSE_SCAN ) {
            <span class="co">// &#36825;&#37324;&#26159;&#26368;&#32456;&#30340;&#19968;&#37096;&#20998;&#65281;&#65281;</span>
            parse( bufstrlist );
            <span class="kw">return</span>;
        }
    } <span class="kw">else</span> <span class="kw">if</span>( bufstrlist.at(<span class="dv">1</span>) == actions[GET_ANGBEG_ANGEND].split(<span class="st">&quot; &quot;</span>).at(<span class="dv">1</span>) ) {
        <span class="co">// &#36825;&#26159;&#35774;&#32622; LMS &#25110;&#32773;&#33719;&#21462; LMS &#21442;&#25968;&#30340;&#26102;&#20505;&#65292;LMS &#30340;&#36820;&#22238;&#24773;&#20917;&#65306;</span>
        <span class="co">// sRA LMPoutputRange 1 1388 FFF92230 225510</span>
        <span class="co">// &#25105;&#20204;&#35201;&#25226;&#25343;&#21040;&#30340;&#25968;&#25454;&#35299;&#26512;&#20986;&#26469;&#65292;&#28982;&#21518;&#35774;&#32622;&#21040;&#33258;&#24049;&#30340;&#21464;&#37327;&#37324;</span>
        <span class="dt">int</span> angbeg, angend;
        sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">4</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;angbeg );
        sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">5</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;angend );
        lmsAngleBeg = angbeg / ANGLE_SCALE_FACTOR;
        lmsAngleEnd = angend / ANGLE_SCALE_FACTOR;
        <span class="kw">emit</span> angle_begin_end( lmsAngleBeg, lmsAngleEnd );
        Logger::log (  BCD::LMS::GOT_SCANNING_ANGLE_START_END,
                       <span class="ot">QString</span>(<span class="st">&quot;[</span><span class="ch">%1-%</span><span class="st">2]&quot;</span>).arg(lmsAngleBeg).arg(lmsAngleEnd) );
        <span class="kw">return</span>;
    } <span class="kw">else</span> <span class="kw">if</span>( bufstrlist.at(<span class="dv">1</span>) == actions[GET_FREQ_ANGRES].split(<span class="st">&quot; &quot;</span>).at(<span class="dv">1</span>) ) {
        <span class="co">// &#21644;&#19978;&#38754;&#31867;&#20284;&#65292;&#23601;&#19981;&#36148;&#20195;&#30721;&#20102;</span>
        <span class="co">// ...</span>
        <span class="kw">return</span>;
    } <span class="kw">else</span> <span class="kw">if</span>( bufstrlist.at(<span class="dv">1</span>) == actions[AUTHORIZE].split(<span class="st">&quot; &quot;</span>).at(<span class="dv">1</span>) ) {
        <span class="co">// ...</span>
    } <span class="kw">else</span> {
        <span class="co">// &#26368;&#21518;&#25105;&#36824;&#35201;&#20889;&#19968;&#20010; else&#65292;&#34429;&#28982;&#24456;&#21487;&#33021;&#36825;&#37324;&#20174;&#26469;&#27809;&#26377;&#19996;&#35199;&#65292;&#20320;&#36896;&#20026;&#20160;&#20040;&#21527;&#65311;</span>
    }
}</code></pre></div>
<p>&#29616;&#22312;&#23601;&#24046;&#37027;&#20010; <code>parse( bufstrlist )</code> &#19981;&#30693;&#36947;&#26159;&#21861;&#20102;&#12290;&#20808;&#21028;&#26029;&#26159;&#21542;&#26159;&#25968;&#25454;&#24103;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::parse( <span class="dt">const</span> <span class="ot">QStringList</span> &amp;bufstrlist )
{
    <span class="co">// &#39318;&#20808;&#21028;&#26029;&#20102;&#26159;&#21542;&#26159; LMS &#30340;&#25968;&#25454;&#24103;</span>
    <span class="co">// already &quot;LMDscandata&quot; data</span>
    <span class="co">// No: &quot;sEA LMDscandata 0&quot;, Yes: &quot;sSN LMDscandata 1&quot; or &quot;sRA LMDscandata&quot;</span>
    string ct = bufstrlist.at(<span class="dv">0</span>).toStdString().erase(<span class="dv">0</span>, <span class="dv">1</span>); <span class="co">// command type</span>
    <span class="kw">if</span> ( <span class="st">&quot;sSN&quot;</span> != ct &amp;&amp; <span class="st">&quot;sRA&quot;</span> != ct ) {
        <span class="co">// cerr &lt;&lt; &quot;sEA data, not LMS scan.\n&quot;;</span>
        <span class="kw">return</span>;
    }</code></pre></div>
<p>&#38656;&#35201;&#25171;&#21360;&#65311;&#28982;&#21518;&#23601;&#25171;&#21360;&#19968;&#20010;&#24103;&#30340;&#21407;&#22987;&#25968;&#25454;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#ifdef LMS_PRINT_PROFILE_SAMPLE</span>
    <span class="dt">static</span> <span class="dt">bool</span> first = <span class="kw">true</span>;
    <span class="kw">if</span> ( first ) {
        Logger::log( BCD::LMS::LMS, <span class="ot">QString</span>( <span class="st">&quot;LMS data (%1 bytes): %2&quot;</span> ).arg( zgBA.length() )
                                                                        .arg( ba2hexstr( zgBA ) ) );
        first = <span class="kw">false</span>;
    }
<span class="ot">#endif</span></code></pre></div>
<p>&#20854;&#23454;&#19978;&#25991;&#37027;&#20010;&#12304;LMS &#25968;&#25454;&#37327;&#12305;&#37324;&#38754;&#30340; &#8220;LMS data (6429 bytes): 0x02 0x73 0x53 0x4e&#8230;&#8221;&#23601;&#26159;&#22312;&#36825;&#37324;&#25171;&#21360;&#20986;&#26469;&#30340;&#12290;&#27809;&#24819;&#21040;&#25105;&#25171;&#21360;&#23436;&#36825;&#20010;&#26085;&#24535;&#23621;&#28982;&#25226;&#20195;&#30721;&#36824;&#30041;&#30528;&#20102;&#65292;&#36825;&#31181;&#19968;&#27425;&#24615;&#20195;&#30721;&#29702;&#24212;&#21024;&#25481;&#30340;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">    <span class="co">// parse data</span>
    profiles_raw.push_back( bufstrlist );               <span class="co">// &#20445;&#23384;&#20102;&#21407;&#22987;&#25968;&#25454;&#65292;&#22914;&#26524;&#19981;&#22312;&#32447;&#22788;&#29702;</span>
                                                        <span class="co">// profiles_raw &#23601;&#20250;&#22312;&#31163;&#32447;&#22788;&#29702;&#30340;&#26102;&#20505;&#34987;&#29992;&#21040;</span>
    <span class="co">// &#27599;&#20010;&#25968;&#25454;&#24103;&#65292;&#26377; 550 &#24038;&#21491;&#20010;&#28857;&#65292;&#26102;&#38388;&#25139;&#37117;&#25171;&#25104;&#19968;&#26679;&#30340;&#65288;&#34429;&#28982;&#25195;&#25551;&#26377;&#20808;&#21518;&#65289;</span>
    profilesX[profileCur].timestamp =  <span class="ot">QDateTime::</span>currentMSecsSinceEpoch();

    <span class="kw">if</span> ( !LMS_PARSE_ON_THE_FLY ) { <span class="co">// do not process, just return</span>
        {
        <span class="co">// &#25105;&#31361;&#28982;&#22312;&#24819;&#36825;&#20010; scope &#37324;&#30340; lock &#20160;&#20040;&#26102;&#20505;&#26512;&#26500;&#8230;&#8230;&#24212;&#35813;&#22312;&#36825;&#20010;&#20013;&#25324;&#21495;&#21518;&#23601;&#26512;</span>
        <span class="co">// &#26500;&#65292;&#20294;&#24635;&#24863;&#35273;&#23427;&#8220;&#27515;&#30340;&#8221;&#20063;&#22826;&#26089;&#20102;&#65292;&#21738;&#22825;&#26377;&#31354;&#27979;&#35797;&#19968;&#20123;</span>
            boost::mutex::scoped_lock lock( mutex );
            ++profileCur;
        }
        <span class="kw">return</span>;
    }

    <span class="co">// Parse it on the fly</span>
    postparse( profiles_raw.at( profiles_raw.size()<span class="dv">-1</span> ),
               profilesX[profileCur] );
    {
        boost::mutex::scoped_lock lock( mutex );
        ++profileCur;
    }
}</code></pre></div>
<p>&#19978;&#38754;&#30340; postpares &#22788;&#29702;&#20102;&#24403;&#21069;&#24103;&#65292;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::postparse( <span class="ot">QStringList</span> &amp;bufstrlist, profile_t &amp;profile )
{
    <span class="co">// emit progress, 1/50 ~ 50/50 or 1/25 ~ 25/25</span>
    <span class="co">// &#39318;&#20808;&#23450;&#20041;&#19968;&#20123;&#21464;&#37327;</span>
    <span class="dt">int</span> scannednum = <span class="dv">0</span>;
    <span class="dt">int</span> distance = <span class="dv">0</span>;
    <span class="dt">double</span> anglebeg = <span class="fl">0.0</span>, angleres = <span class="fl">0.0</span>, anglecur = <span class="fl">0.0</span>;
    <span class="dt">double</span> x = <span class="fl">0.0</span>, z = <span class="fl">0.0</span>;
    <span class="dt">int</span> tmp = <span class="dv">0</span>;

    <span class="co">// start angle&#65292;&#36215;&#22987;&#25195;&#25551;&#35282;</span>
    sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">23</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;tmp );
    anglebeg = (<span class="dt">double</span>) tmp / ANGLE_SCALE_FACTOR;

    <span class="co">// angle resolution&#65292;&#35282;&#24230;&#20998;&#36776;&#29575;</span>
    sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">24</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;tmp );
    angleres = (<span class="dt">double</span>) tmp / ANGLE_SCALE_FACTOR;

    <span class="co">// num of points in this scan&#65292;&#24403;&#21069;&#24103;&#30340;&#28857;&#25968;&#65292;&#22823;&#27010; 550 &#20010;</span>
    sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">25</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;scannednum );

    <span class="dt">int</span> cnt = <span class="dv">0</span>; <span class="co">// check for possible lost of points</span>
    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; scannednum; ++i ) {
        ++cnt;
        <span class="co">// scan distance, metric: mm&#65292;&#21333;&#20301;&#26159;&#27627;&#31186;</span>
        <span class="co">// &#20808;&#20174;&#23383;&#31526;&#20013;&#25195;&#25551;&#20986;&#36317;&#31163;&#20540;</span>
        sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(i + <span class="dv">26</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;distance );
        <span class="co">// &#28982;&#21518;&#26681;&#25454;&#28857;&#30340; index&#65292;&#35745;&#31639;&#28857;&#30340;&#35282;&#24230;</span>
        anglecur = (anglebeg + i * angleres) / <span class="fl">180.0</span> * M_PI;
        <span class="co">// &#26368;&#21518;&#65292;&#26681;&#25454;&#35282;&#24230;&#21644;&#36317;&#31163;&#65292;&#25226;&#28857;&#30340;&#20301;&#32622;&#35745;&#31639;&#20986;&#26469;</span>
        profile.pts[i].x = cos(anglecur) * distance;
        profile.pts[i].z = sin(anglecur) * distance;
        <span class="co">// pt.x &#21644; pt.z &#20998;&#21035;&#23384;&#20102;&#20004;&#20010;&#22352;&#26631;&#65292;pt.y &#23384;&#20102;&#26102;&#38388;&#25139;&#65288;&#20294;&#23454;&#38469;&#19978;&#25105;&#20204;&#21482;&#35201;&#22312;&#19968;</span>
        <span class="co">// &#20010; profile &#37324;&#23384;&#19968;&#20010;&#26102;&#38388;&#25139;&#23601;&#21487;&#20197;&#20102;&#65289;</span>
    }

    Logger::log( BCD::LMS::PARSE_PROFILE );
}</code></pre></div>
<p>&#24403;&#20851;&#38381;&#35835;&#25968;&#21518;&#65292;LMS &#20250;&#33258;&#21160;&#20445;&#23384;&#25968;&#25454;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::saveprofiles( )
{
    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Save LMS data(&quot;</span> &lt;&lt; profiles_raw.size() &lt;&lt; <span class="st">&quot; profiles) ... to &quot;</span>;
    <span class="kw">if</span> ( !LMS_PARSE_ON_THE_FLY ) { <span class="co">// if not on the fly, we need to parse it now</span>
        <span class="co">// &#22914;&#26524;&#27809;&#26377;&#22312;&#32447;&#22788;&#29702;&#65292;&#37027;&#23601;&#29992; profiles_raw &#30340;&#25968;&#25454;&#65292;&#26469; parse &#20986;&#21508;&#20010;&#25968;&#25454;&#28857;</span>
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Save Profiles, Parsing...&quot;</span>;
        <span class="co">// parse</span>
        <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; profiles_raw.size(); ++i ) {
            postparse( profiles_raw[i], profilesX[i] );
        }
        {
            boost::mutex::scoped_lock lock( mutex );
            profileCur = profiles_raw.size();
        }
    } <span class="kw">else</span> {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Save Profiles, no need to parse.&quot;</span>;
    }

    <span class="kw">if</span> ( lmsOutputPath.isEmpty() ) { genNewPath(); }
    FILE *fp = fopen( <span class="fu">qPrintable</span>( <span class="ot">QString</span>( <span class="st">&quot;</span><span class="ch">%1/%</span><span class="st">2&quot;</span> ).arg( basedir )
                                                    .arg( lmsOutputPath ) ), <span class="st">&quot;a+&quot;</span> );
    <span class="kw">if</span> ( NULL == fp ) {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;err, cant open file.&quot;</span>;
        <span class="kw">return</span>;
    }

    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Save Profiles, saving...&quot;</span>;
    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; profiles_raw.size(); ++i ) {
        <span class="kw">for</span> ( <span class="dt">int</span> j = <span class="dv">0</span>; j &lt; LMS_PROFILE_POINTS_NUM; ++j ) {
            fprintf( fp, <span class="st">&quot;</span><span class="ch">%20.10f</span><span class="st"> </span><span class="ch">%30lld</span><span class="st"> </span><span class="ch">%20.10f\n</span><span class="st">&quot;</span>
                    , profilesX[i].pts[j].x
                    , profilesX[i].timestamp
                    , profilesX[i].pts[j].z );
        }
    }
    fclose( fp );

    Logger::log( BCD::LMS::SAVE_PROFILES );
}</code></pre></div>
<p>&#19978;&#38754;&#24050;&#32463;&#25552;&#36807;&#65292;&#20445;&#23384;&#20986;&#26469;&#30340;&#25968;&#25454;&#22823;&#27010;&#36825;&#26679;&#65306;</p>
<pre><code>      145.3066396684                  1437721968720      -140.3209908327
      155.2301153966                  1437721968720      -147.3078791985
      139.6885570093                  1437721968720      -130.2616867719</code></pre>
<p>&#25171;&#24320;&#12289;&#20851;&#38381; LMS &#25968;&#25454;&#30340;&#35835;&#21462;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::turnOnReading( )
{
    isRun = <span class="kw">true</span>;
    {
        boost::mutex::scoped_lock lock( mutex );
        profileCur = <span class="dv">0</span>;
    }
    profiles_raw.clear();
}

<span class="dt">void</span> LMSReader::turnOffReading( )
{
    isRun = <span class="kw">false</span>;
    <span class="co">// parse &amp; save</span>
    saveprofiles();
}

<span class="dt">void</span> LMSReader::start( <span class="dt">qint64</span> ts <span class="co">/* = 0 */</span> )
{
    <span class="dt">qint64</span> dt = (ts == <span class="dv">0</span>)
              ? <span class="ot">QDateTime::</span>currentMSecsSinceEpoch()
              : (<span class="dt">qint64</span>)ts;
    <span class="co">// &#27599;&#27425; start &#37117;&#35201;&#20135;&#29983;&#26032;&#30340;&#36755;&#20986;&#36335;&#24452;&#65292;&#36825;&#26679;&#23601;&#19981;&#20250;&#35206;&#30422;&#21407;&#26469;&#20445;&#23384;&#19979;&#26469;&#30340;&#25968;&#25454;&#20102;</span>
    genNewPath( dt );
    turnOnReading();
}

<span class="dt">void</span> LMSReader::stop( )
{
    turnOffReading();
}</code></pre></div>
<p>&#22312;&#25105;&#30475; LMS &#20195;&#30721;&#30340;&#26102;&#20505;&#65292;&#25105;&#30475;&#21040;&#20102;&#33258;&#24049;&#26368;&#24320;&#22987;&#30340;&#27880;&#37322;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">/*</span>
<span class="co"> *</span>
<span class="co"> *   // Fog Filter</span>
<span class="co"> *   // &lt;-- &quot;sWN MSsuppmode 1&quot;; // 0: glitch, 1: fog</span>
<span class="co"> *   // --&gt; &quot;sWA MSsuppmode&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // n-Pulse to 1-Pulse Filter</span>
<span class="co"> *   // &lt;-- &quot;sWN LFPnto1filter 1&quot;; // 1: active, 0: inactive</span>
<span class="co"> *   // --&gt; &quot;sWA LFPnto1filter&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Mean Filter</span>
<span class="co"> *   // &lt;-- &quot;sWN LFPmeanfilter 1 +10 0&quot;; // 0: inactive, 1: active. number of scans: +2..+100. 0</span>
<span class="co"> *   // --&gt; &quot;sWA LFPmeanfilter&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Configure the data content for the scan</span>
<span class="co"> *   // QString str = &quot;sWN LMDscandatacfg&quot;;</span>
<span class="co"> *   // channel: c1: 1, c2: 2, c1+c2: 3</span>
<span class="co"> *   // Remission data output: 0: no, 1: yes</span>
<span class="co"> *   // Resolution of Remission Data: 0: 8bit, 1: 16bit</span>
<span class="co"> *   // Unit of Remission Data:</span>
<span class="co"> *   // double AngRes = 2.0 / round(2.0 / GivenAngRes);</span>
<span class="co"> *</span>
<span class="co"> *   // Function Front Panel</span>
<span class="co"> *   // &lt;-- &quot;sWN LMLfpFcn 1 0 1&quot;; // 1: reserved, 0-2: Q1/Q2, 0-2: Okay/Stop, 0-1: display function</span>
<span class="co"> *   // 0: no function, 1: application, 2: command</span>
<span class="co"> *   // 0: application, 1: command</span>
<span class="co"> *   // --&gt; &quot;sFA 8&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Synchronization Phase</span>
<span class="co"> *   // &lt;-- &quot;sWN SYPhase +90&quot;;</span>
<span class="co"> *   // --&gt; &quot;sWA SYPhase&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Set factory defaults</span>
<span class="co"> *   // &lt;-- &quot;sMN mSCloadfacdef&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Set IP-Address</span>
<span class="co"> *   // &lt;-- &quot;sWN EIIpAddr C0 A8 0 1&quot;;</span>
<span class="co"> *   // --&gt; &quot;sWA EIIpAddr&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Power On Counter</span>
<span class="co"> *   // &lt;-- &quot;sRN ODpwrc&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA ODpwrc A7&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Operating hours</span>
<span class="co"> *   // &lt;-- &quot;sRN ODoprh&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA ODoprh 4F4&quot;, 4F4 * 1/10h = 126.8 hours</span>
<span class="co"> *</span>
<span class="co"> *   // Ask Device Name</span>
<span class="co"> *   // &lt;-- &quot;sRN LocationName&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA LocationName B not defined&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Device State</span>
<span class="co"> *   // &lt;-- &quot;sRN SCdevicestate&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA SCdevicestate 1&quot;, 0: busy, 1: ready, 2: error</span>
<span class="co"> *</span>
<span class="co"> *   // Device Ident</span>
<span class="co"> *   // &lt;-- &quot;sRN DeviceIdent/sRI 0&quot;;</span>
<span class="co"> *   // --&gt; &quot;sFA 3&quot;?</span>
<span class="co"> *</span>
<span class="co"> *   // Reset output counter</span>
<span class="co"> *   // &lt;-- &quot;sMN LIDrstoutpcnt&quot;;</span>
<span class="co"> *   // --&gt; &quot;sAN LIDrstoutpcnt 0&quot;, 0: success</span>
<span class="co"> *</span>
<span class="co"> *   // Set output state</span>
<span class="co"> *   // &lt;-- &quot;sMN mDOSetOutput 1 1&quot;; // output number: 1-3, output state: 0:inactive / 1:active</span>
<span class="co"> *   // &quot;sAN mDOSetOutput 0&quot;, 0: err, 1: success</span>
<span class="co"> *</span>
<span class="co"> *   // Ask state of the outputs</span>
<span class="co"> *   // &lt;-- &quot;sRN LIDoutputstate&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA LIDoutputstate 1 E88CDA0F 1 A 1 A 1 A 2 0 2 0 2 0 2 0 2 0 2 0 2 0 2 0 1 7DD 1 1 0 1D 3B 5B8D8&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Ask speed threshold</span>
<span class="co"> *   // &quot;sRN LICSpTh&quot;;</span>
<span class="co"> *   // &quot;sRA LICSpTh 5&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Fixed speed</span>
<span class="co"> *   // &lt;-- &quot;sWN LICFixVel +5&quot;; // +0.001..+10</span>
<span class="co"> *   // --&gt; &quot;sWA LICFixVel&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Encoder resolution</span>
<span class="co"> *   // QString str = &quot;sWN LICencres +1000&quot;; // +0.001..+2000</span>
<span class="co"> *   // &quot;sWA LICencres&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Encoder Settings</span>
<span class="co"> *      0 = Off</span>
<span class="co"> *      1 = single Increment/INC1</span>
<span class="co"> *      2 = Direction recognition (phase)</span>
<span class="co"> *      3 = Direction recognition (level)</span>
<span class="co"> *</span>
<span class="co"> *   // &lt;-- &quot;sWN LICencset 2&quot;</span>
<span class="co"> *   // --&gt; &quot;sWA LICencset&quot;</span>

<span class="co"> *   // Increment source</span>
<span class="co"> *   // &lt;-- &quot;sWN LICsrc 1&quot;); // 0: fixed speed, 1: encoder</span>
<span class="co"> *   // --&gt; &quot;sWA LICsrc&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN LMCstartmeas&quot;;</span>
<span class="co"> *   // &quot;sAN LMCstartmeas 0&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN LMCstandby&quot;; // cant turn on, but can poll one</span>
<span class="co"> *   // &quot;sAN LMCstandby 0&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN LMCstopmeas&quot;;</span>
<span class="co"> *   // &quot;&quot;sAN LMCstopmeas 0&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN mSCreboot&quot;;</span>
<span class="co"> *   // &quot;sAN mSCreboot&quot;</span>

<span class="co"> *   // &lt;-- &quot;sRN STlms&quot;;</span>
<span class="co"> *   // &quot;sRA STlms 7 0 8 00:34:19 A 01.01.1970 0 0 0&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN LSPsetdatetime&quot;;</span>
<span class="co"> *   // &quot;sAN LSPsetdatetime 1&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN mEEwriteall&quot;;</span>
<span class="co"> *   // &quot;sAN mEEwriteall 1&quot;</span>
<span class="co"> *</span>
<span class="co">**/</span></code></pre></div>
<p>&#21487;&#20197;&#30475;&#21040; LMS &#36824;&#25552;&#20379;&#24456;&#22810;&#21151;&#33021;&#65292;&#21482;&#19981;&#36807;&#25105;&#20204;&#27809;&#29992;&#29992;&#36807;&#65292;&#32780;&#24050;&#12290;</p>
<p><code>lmsreaderconfig{.h, .cpp, .ui}</code> &#20869;&#23481;&#27809;&#26377;&#22810;&#23569;&#65292;&#23427;&#21482;&#26159;&#19968;&#20010;&#23553;&#35013;&#12290;&#25152;&#26377;&#30340;&#20195;&#30721;&#22823;&#27010;&#37117;&#26159;&#36825;&#26679;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> on_pushButton_ip_port_clicked( ) {

    <span class="ot">QString</span> address   = ui-&gt;lineEdit_ip-&gt;text().simplified();
    <span class="dt">quint16</span> port      = ui-&gt;lineEdit_port-&gt;text().toInt();
    lmsReader-&gt;setAddressPort( address, port );

}</code></pre></div>
<p>.ui &#20854;&#23454;&#26159;&#19968;&#20010; xml &#25991;&#20214;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;<span class="kw">?&gt;</span>
<span class="kw">&lt;ui</span><span class="ot"> version=</span><span class="st">&quot;4.0&quot;</span><span class="kw">&gt;</span>
 <span class="kw">&lt;class&gt;</span>lmsreaderconfig<span class="kw">&lt;/class&gt;</span>
 <span class="kw">&lt;widget</span><span class="ot"> class=</span><span class="st">&quot;QWidget&quot;</span><span class="ot"> name=</span><span class="st">&quot;lmsreaderconfig&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;geometry&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;rect&gt;</span>
    <span class="kw">&lt;x&gt;</span>0<span class="kw">&lt;/x&gt;</span>
    <span class="kw">&lt;y&gt;</span>0<span class="kw">&lt;/y&gt;</span>
    <span class="kw">&lt;width&gt;</span>901<span class="kw">&lt;/width&gt;</span>
    <span class="kw">&lt;height&gt;</span>429<span class="kw">&lt;/height&gt;</span>
   <span class="kw">&lt;/rect&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;windowTitle&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;string&gt;</span>lmsreaderconfig<span class="kw">&lt;/string&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
  <span class="kw">&lt;layout</span><span class="ot"> class=</span><span class="st">&quot;QGridLayout&quot;</span><span class="ot"> name=</span><span class="st">&quot;gridLayout&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;item</span><span class="ot"> row=</span><span class="st">&quot;0&quot;</span><span class="ot"> column=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;</span>
   ...</code></pre></div>
<p>&#29992; Qt &#30340; <code class="sourceCode bash"><span class="kw">uic</span></code> &#36716;&#20026; cpp &#25991;&#20214;&#19968;&#36215;&#32534;&#35793;&#65292;&#23601;&#29983;&#25104;&#25104;&#20102;&#30028;&#38754;&#31243;&#24207;&#12290;</p>
<p>LMS &#23601;&#36825;&#26679;&#35762;&#23436;&#20102;&#12290;&#35762;&#24471;&#27604;&#36739;&#32454;&#33268;&#65292;&#22240;&#20026;&#23427;&#26159;&#25105;&#20889;&#30340;&#31532;&#19968;&#20010;&#20256;&#24863;&#22120;&#31243;&#24207;&#65292;&#21518;&#38754;&#30340; IMU &#21644; UR &#23601;&#35201;&#35762;&#24471;&#31961;&#19968;&#28857;&#65292;&#24555;&#19968;&#28857;&#20102;&#12290;</p>
<h2 id="imu">IMU</h2>
<p>IMU&#65288;Inertial measurement unit&#65292;&#24815;&#24615;&#27979;&#37327;&#21333;&#20803;&#65292;&#20439;&#31216;&#20439;&#31216;&#24815;&#23548;&#65292;&#25110;&#24815;&#24615;&#23548;&#33322;&#65289;&#26159;&#27979;&#37327;&#29289;&#20307;&#19977;&#36724;&#23039;&#24577;&#35282;&#65288;&#25110;&#35282;&#36895;&#29575;&#65289;&#20197;&#21450;&#21152;&#36895;&#24230;&#30340;&#35013;&#32622;&#12290;IMU &#35013;&#22312; MCU&#65288;Micro Controller Unit&#65292;&#24494;&#25511;&#21046;&#22120;&#65289;&#19978;&#65292;&#21644;&#30005;&#33041;&#36890;&#36807;&#20018;&#21475;&#65288;COM&#65289;&#36830;&#25509;&#65288;&#29992; Modbus &#20018;&#21475;&#21327;&#35758;&#65289;&#12290;</p>
<p>&#20351;&#29992;&#21040;&#20102;&#31532;&#19977;&#26041;&#24211; <a href="https://github.com/qextserialport/qextserialport">QExtSerialPort</a>&#65292;&#36825;&#20010;&#24211;&#32473; Qt4 &#25552;&#20379;&#20102;&#20018;&#21475;&#36890;&#20449;&#30340;&#21151;&#33021;&#65288;Qt5 &#20013;&#24050;&#32463;&#38598;&#25104;&#20102;&#36825;&#20010;&#21151;&#33021;&#65289;&#12290;&#25105;&#20204;&#30896;&#21040;&#30340;&#31532;&#19968;&#20010;&#38382;&#39064;&#26159;&#65292;&#24590;&#20040;&#25226; Qt &#31243;&#24207;&#65292;&#31227;&#26893;&#21040; VS &#37324;&#65311;</p>
<p>&#20854;&#23454;&#25105;&#20204;&#30340; Qt &#20063;&#26159;&#29992;&#30340; VS &#30340;&#32534;&#35793;&#22120;&#12290;&#25152;&#20197;&#26174;&#31034;&#25226;&#21407;&#26469; Qt &#24037;&#31243;&#30340;&#37027;&#20123; dll &#21644; lib &#25991;&#20214;&#24324;&#21040; CMake &#24037;&#31243;&#26159;&#21487;&#34892;&#30340;&#12290;&#24223;&#20102;&#22909;&#20960;&#22825;&#30340;&#21151;&#22827;&#65288;&#37027;&#26102;&#20505;&#25105;&#20204; CMake &#20063;&#19981;&#29087;&#65289;&#65292;&#25105;&#32456;&#20110;&#25630;&#23450;&#20102;&#65292;&#22823;&#27010;&#30340; CMakeLists.txt &#25991;&#20214;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span class="co"># &#39318;&#20808;&#21152;&#19978; include &#36335;&#24452;</span>
<span class="kw">include_directories</span>( <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle )

<span class="co"># &#28304;&#30721;&#35201;&#19968;&#36215;&#32534;&#35793;</span>
<span class="kw">set</span>( QEXTSERIALPORT_SOURCES
     <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/qextserialport.cpp
     <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/qextserialenumerator.cpp
     <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/qextserialenumerator_win.cpp
     <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/qextserialport_win.cpp )

<span class="co"># link &#30340;&#30446;&#24405;&#21644; link &#30340; lib &#25991;&#20214;</span>
<span class="kw">link_directories</span>( <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/lib )
<span class="kw">set</span>( QEXTSERIALPORT_LIBS <span class="st">&quot;setupapi;advapi32;user32;qextserialport1;qextserialportd1;&quot;</span> )

<span class="kw">file</span>( <span class="ot">GLOB</span> QEXTSERIALPORT_HEADERS <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/*.h )
<span class="kw">add_library</span>( <span class="dv">${PROJECT_NAME}</span> <span class="ot">STATIC</span>
    <span class="dv">${SRCS_FILES}</span>
    <span class="dv">${UI_FILES}</span> <span class="dv">${HDRS_FILES}</span> <span class="dv">${MOC_SRCS}</span> <span class="dv">${UI_HDRS}</span> <span class="dv">${RSC_SRCS}</span> <span class="dv">${CD_FILES}</span>
    <span class="dv">${QEXTSERIALPORT_HEADERS}</span> <span class="dv">${QEXTSERIALPORT_SOURCES}</span> )
<span class="kw">target_link_libraries</span>( <span class="dv">${PROJECT_NAME}</span> <span class="dv">${QT_LIBRARIES}</span> <span class="dv">${QEXTSERIALPORT_LIBS}</span> Utils )</code></pre></div>
<p>IMU &#27809;&#26377;&#20687; LMS &#19968;&#26679;&#32487;&#25215;&#21035;&#20154;&#65292;&#32780;&#26159;&#25226;&#25552;&#20379;&#20102;&#20018;&#21475;&#21151;&#33021;&#30340; QextSerialPort &#20316;&#20026;&#33258;&#24049;&#30340;&#19968;&#20010;&#25104;&#21592;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">private</span>:
    QextSerialPort *imuCom;
    QextSerialEnumerator *imuSerialeEnumerator;</code></pre></div>
<p>&#37027;&#20010; QextSerialEnumerator &#21487;&#20197;&#26174;&#31034;&#30005;&#33041;&#24320;&#21551;&#30340; COM &#25509;&#21475;&#65292;&#22312; Qt creator &#37324;&#21487;&#20197;&#27491;&#24120;&#24037;&#20316;&#65292;&#20294;&#22312; VS &#37324;&#21364;&#27809;&#29992;&#12290;&#25152;&#20197;&#36825;&#26679;&#30340;&#20195;&#30721;&#26159;&#26080;&#25928;&#30340;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">foreach</span> ( <span class="dt">const</span> QextPortInfo &amp;info, QextSerialEnumerator::getPorts() ) {
    ports &lt;&lt; info.portName; <span class="co">// &quot;COM1&quot;, &quot;COM3&quot;, ...</span>
    portsInfo &lt;&lt; info;
}</code></pre></div>
<p>&#30524;&#23574;&#30340;&#20320;&#65292;&#21487;&#33021;&#21457;&#29616;&#20102; <code>getPorts</code> &#20989;&#25968;&#26159;&#38745;&#24577;&#30340;&#65292;&#35273;&#24471;&#27809;&#24517;&#35201;&#24324;&#19968;&#20010;&#25104;&#21592;&#12290;&#20294;&#20854;&#23454;&#25105;&#20204;&#21482;&#26159;&#35201;&#22312;&#20018;&#21475;&#21495;&#26377;&#26356;&#26032;&#30340;&#26102;&#20505;&#33021;&#22815;&#33258;&#21160;&#21453;&#39304;&#19968;&#19979;&#32780;&#24050;&#65292;&#25152;&#20197;&#25165;&#38656;&#35201;&#19968;&#20010;&#25104;&#21592;&#26469;&#36830;&#25509;&#27133;&#20989;&#25968;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="fu">connect</span>(imuSerialeEnumerator, <span class="kw">SIGNAL</span>(deviceDiscovered(QextPortInfo)),
        <span class="kw">this</span>, <span class="kw">SLOT</span>(onPortAddedOrRemoved()));
<span class="fu">connect</span>(imuSerialeEnumerator, <span class="kw">SIGNAL</span>(deviceRemoved(QextPortInfo)),
        <span class="kw">this</span>, <span class="kw">SLOT</span>(onPortAddedOrRemoved()));</code></pre></div>
<p>Anyway&#65292;&#22240;&#20026; enumerate &#20018;&#21475;&#21495;&#30340;&#21151;&#33021;&#30340;&#22833;&#25928;&#65292;&#25105;&#20204;&#26159;&#22312;&#30028;&#38754;&#37324;&#33258;&#21160;&#29983;&#25104; 20 &#20010;&#20018;&#21475;&#30340;&#36873;&#39033;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> IMUReaderConfig::loadPorts( <span class="ot">QStringList</span> ports )
{
    <span class="co">// &#22914;&#26524;&#19981;&#26159; VS &#37324;&#65292;&#23601;&#21487;&#20197;&#29992; loadPorts( ports ) &#30452;&#25509;&#21152;&#36733;&#12290;</span>
    <span class="co">// &#20854;&#20013;&#30340; ports &#23601;&#26159;&#20174;&#19978;&#38754;&#30340;&#8220;ports &lt;&lt; info.portName; // &quot;COM1&quot;, &quot;COM3&quot;, ...&#8221;&#32780;&#26469;&#12290;</span>
<span class="ot">#ifndef _WIN64</span>
    ui-&gt;comboBox_port-&gt;clear();
    <span class="kw">if</span> ( ports.length() == <span class="dv">0</span> ) { <span class="kw">return</span>; }

    <span class="dt">int</span> i = <span class="dv">0</span>;
    <span class="dt">int</span> ci = <span class="dv">0</span>;
    <span class="dt">bool</span> newPort = <span class="kw">true</span>;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;port, ports ) {
        ui-&gt;comboBox_port-&gt;addItem( port );
        <span class="kw">if</span> ( port == arm-&gt;getCurPort() ) {
            ci = i;
            newPort = <span class="kw">false</span>;
        }
        ++i;
    }

    <span class="kw">if</span> ( newPort ) {
        ui-&gt;comboBox_port-&gt;setCurrentIndex( <span class="dv">0</span> );
        arm-&gt;setCurPort( ports.at(<span class="dv">0</span>) );
    } <span class="kw">else</span> {
        ui-&gt;comboBox_port-&gt;setCurrentIndex( ci );
    }
<span class="ot">#else</span>
    <span class="co">// VS &#30340;&#35805;&#65292;&#23601;&#30452;&#25509;&#29983;&#25104; 20 &#20010; COM &#21475;&#12290;</span>
    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">20</span>; ++i ) {
        <span class="dt">static</span> <span class="ot">QString</span> str;
        str.sprintf( <span class="st">&quot;COM</span><span class="ch">%d</span><span class="st">&quot;</span>, i<span class="dv">+1</span> );
        ui-&gt;comboBox_port-&gt;addItem( str );
    }
<span class="ot">#endif</span>
}</code></pre></div>
<p>&#37197;&#32622;&#30028;&#38754;&#24377;&#20986;&#30340;&#26102;&#20505;&#65292;&#25105;&#20204;&#36824;&#35201;&#36733;&#20837;&#21407;&#26469;&#30340;&#35774;&#32622;&#65292;&#36825;&#37324;&#36824;&#20250;&#33258;&#21160;&#30340;&#25226; combo box &#30340;&#36873;&#20013;&#33258;&#21160;&#20999;&#25442;&#21040;&#30456;&#24212;&#30340; index&#65288;&#22914;&#26524;&#22312;&#36873;&#39033;&#20013;&#30340;&#35805;&#65288;&#22914;&#26524;&#19981;&#22312;&#65292;&#23601;&#28155;&#21152;&#19968;&#20010;&#65292;&#28982;&#21518;&#20999;&#25442;&#36807;&#21435;&#65289;&#65289;&#65292;&#20195;&#30721;&#30053;&#22797;&#26434;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> IMUReaderConfig::loadConfigs( )
{
    <span class="co">// load ports</span>
    loadPorts( arm-&gt;getPorts() );

    <span class="co">// baud rate, etc</span>
    <span class="co">// clear</span>
    ui-&gt;comboBox_baudrate-&gt;clear();
    ui-&gt;comboBox_databits-&gt;clear();
    ui-&gt;comboBox_parity-&gt;clear();
    ui-&gt;comboBox_stopbits-&gt;clear();

    <span class="co">// load and select</span>
    <span class="dt">int</span> i = <span class="dv">0</span>; <span class="co">// index</span>
    <span class="dt">int</span> ci = <span class="dv">0</span>; <span class="co">// current index</span>
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;brt, arm-&gt;getBRTs().keys() ) {
        ui-&gt;comboBox_baudrate-&gt;addItem( brt );
        <span class="kw">if</span> ( brt == arm-&gt;getBRTs().key(arm-&gt;getBRT()) ) {
            ci = i;
        }
        ++i;
    }
    ui-&gt;comboBox_baudrate-&gt;setCurrentIndex( ci );

    i = ci = <span class="dv">0</span>;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;dbt, arm-&gt;getDBTs().keys() ) {
        ui-&gt;comboBox_databits-&gt;addItem( dbt );
        <span class="kw">if</span> ( dbt == arm-&gt;getDBTs().key(arm-&gt;getDBT()) ) {
            ci = i;
        }
        ++i;
    }
    ui-&gt;comboBox_databits-&gt;setCurrentIndex( ci );

    i = ci = <span class="dv">0</span>;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;pt, arm-&gt;getPTs().keys() ) {
        ui-&gt;comboBox_parity-&gt;addItem( pt );
        <span class="kw">if</span> ( pt == arm-&gt;getPTs().key(arm-&gt;getPT()) ) {
            ci = i;
        }
        ++i;
    }
    ui-&gt;comboBox_parity-&gt;setCurrentIndex( ci );

    i = ci = <span class="dv">0</span>;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;sbt, arm-&gt;getSBTs().keys() ) {
        ui-&gt;comboBox_stopbits-&gt;addItem( sbt );
        <span class="kw">if</span> ( sbt == arm-&gt;getSBTs().key(arm-&gt;getSBT()) ) {
            ci = i;
        }
        ++i;
    }
    ui-&gt;comboBox_stopbits-&gt;setCurrentIndex( ci );

    <span class="co">// disable set buttons</span>
    ui-&gt;pushButton_set-&gt;setEnabled( <span class="kw">false</span> );
    ui-&gt;pushButton_wheel_fb-&gt;setEnabled( <span class="kw">false</span> );
    ui-&gt;pushButton_arm3_fb-&gt;setEnabled( <span class="kw">false</span> );
    ui-&gt;pushButton_arm3_fb_2-&gt;setEnabled( <span class="kw">false</span> );
}</code></pre></div>
<p>&#36825;&#37324;&#30340; SBT&#65292;DBT &#20043;&#31867;&#65292;&#29087;&#24713;&#20018;&#21475;&#30340;&#26379;&#21451;&#24212;&#35813;&#37117;&#30693;&#36947;&#65292;&#36825;&#37324;&#31616;&#35201;&#35828;&#26126;&#19968;&#19979;&#12290;&#27604;&#22914; BRT&#65292;&#20854;&#23454;&#23601;&#26159; baud rate&#65288;&#27874;&#29305;&#29575;&#65289;&#65292;&#26377;&#20851;&#25968;&#25454;&#20256;&#36755;&#30340;&#36895;&#29575;&#12290;&#24120;&#29992;&#30340;&#27874;&#29305;&#29575;&#26377; 9600, 19200, 38400 &#31561;&#31561;&#65292;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">const</span> IMUReader::BRT IMUReader::brts = IMUReader::initBRTs();
<span class="co">//  IMUReader::BRT IMUReader::initBRTs( )</span>
<span class="co">//  {</span>
<span class="co">//      BRT brts;</span>
<span class="co">//      brts[    &quot;9600&quot;  ] = BAUD9600;</span>
<span class="co">//      brts[   &quot;19200&quot;  ] = BAUD19200;</span>
<span class="co">//      brts[   &quot;38400&quot;  ] = BAUD38400;</span>
<span class="co">//      brts[  &quot;115200&quot;  ] = BAUD115200;</span>
<span class="co">//      brts[  &quot;256000&quot;  ] = BAUD256000;</span>
<span class="co">//      return brts;</span>
<span class="co">//  }</span></code></pre></div>
<p>DBT &#25351;&#30340;&#26159; data bits&#65288;&#25968;&#25454;&#20301;&#65289;&#65292;&#20505;&#36873;&#39033;&#26377; <code>DATA_7</code>&#65292;<code>DATA_8</code>&#12290; SBT &#25351;&#30340;&#26159; stop bits&#65288;&#20572;&#27490;&#20301;&#65289;&#65292;&#20505;&#36873;&#39033;&#26377; <code>STOP_1</code>&#65292;<code>STOP_2</code>&#12290; PT &#25351;&#30340;&#26159; parity type&#65288;&#26657;&#39564;&#20301;&#31867;&#22411;&#65289;&#65292;&#20505;&#36873;&#39033;&#26377; <code>PAR_NONE</code>&#65288;&#26080;&#26657;&#39564;&#65289;&#65292; <code>PAR_ODD</code>&#65288;&#22855;&#26657;&#39564;&#65289;&#65292;<code>PAR_EVEN</code>&#65288;&#20598;&#26657;&#39564;&#65289;&#65292;&#21487;&#33021;&#36824;&#35201;&#35774;&#32622; FlowControl&#65292;&#23427;&#30340;&#20505;&#36873;&#39033;&#26377; <code>FLOW_ON</code>&#65292;<code>FLOW_OFF</code>&#12290;</p>
<p>IMU &#22312;&#26500;&#36896;&#30340;&#26102;&#20505;&#65292;&#23601;&#35201;&#25226;&#40664;&#35748;&#24471;&#37197;&#32622;&#35774;&#32622;&#22909;&#65288;&#21542;&#21017;&#36830;&#25509;&#20102;&#65292;&#25968;&#25454;&#35835;&#21040;&#30340;&#20063;&#26159;&#26377;&#38382;&#39064;&#30340;&#65289;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// default configs</span>
imuBRT  = BAUD256000;
imuDBT  = DATA_8;
imuPT   = PAR_NONE;
imuSBT  = STOP_1;</code></pre></div>
<p>&#36830;&#25509;&#20018;&#21475;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> IMUReader::openIMU(<span class="ot">QString</span> com <span class="co">/*=QString()*/</span>) <span class="co">// com &#30340;&#20540;&#21487;&#33021;&#26159; &quot;COM1&quot;&#65292;&quot;COM2&quot;&#65292;&#31561;&#31561;</span>
{
    <span class="co">// &#22914;&#26524;&#25552;&#20379;&#20102;&#20018;&#21475;&#21495;&#65292;&#23601;&#23581;&#35797;&#25171;&#24320;</span>
    <span class="kw">if</span> (!com.isEmpty()) {
        imuCom = <span class="kw">new</span> QextSerialPort(com, QextSerialPort::EventDriven);
        imuCom -&gt;open(<span class="ot">QIODevice::</span>ReadWrite);
    } <span class="kw">else</span> {
    <span class="co">// &#22914;&#26524;&#27809;&#26377;&#25552;&#20379;&#20018;&#21475;&#21495;&#65292;&#23601;&#19968;&#20010;&#20010;&#35797;&#65292;&#30452;&#21040;&#25171;&#24320;&#19968;&#20010;</span>
        <span class="ot">QString</span> str;
        <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">10</span>; ++i) {
            com = str.sprintf(<span class="st">&quot;COM</span><span class="ch">%d</span><span class="st">&quot;</span>, i<span class="dv">+1</span>);
            imuCom = <span class="kw">new</span> QextSerialPort(com, QextSerialPort::EventDriven);
            imuCom -&gt;open(<span class="ot">QIODevice::</span>ReadWrite);
            <span class="kw">if</span> (imuCom-&gt;isOpen()) {
                <span class="kw">break</span>;
            }
        }
    }

    <span class="kw">if</span> (!imuCom-&gt;isOpen()) {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Not open&quot;</span>;
        <span class="kw">emit</span> comState(<span class="kw">false</span>);
        <span class="kw">return</span>;
    }

    <span class="kw">emit</span> comState(<span class="kw">true</span>);
    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Connected to &quot;</span> &lt;&lt; com;

    imuCom-&gt;setBaudRate(imuBRT);
    imuCom-&gt;setDataBits(imuDBT);
    imuCom-&gt;setParity(imuPT);
    imuCom-&gt;setStopBits(imuSBT);
    imuCom-&gt;setFlowControl(FLOW_OFF);
    imuCom-&gt;setTimeout(<span class="dv">10</span>);

    <span class="co">// imu</span>
    <span class="fu">connect</span>(imuCom, <span class="kw">SIGNAL</span>(readyRead()),
                  <span class="kw">this</span>, <span class="kw">SLOT</span>(readIMU()));
}</code></pre></div>
<p>&#26377;&#25968;&#25454;&#26469;&#30340;&#26102;&#20505;&#65292;&#23601;&#35835;&#21462;&#20043;&#65292;&#36825;&#37324;&#21482;&#26159;&#31616;&#21333;&#22320;&#25226;&#25968;&#25454; dump &#20986;&#26469;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> IMUReader::readIMU()
{
    <span class="ot">QByteArray</span> ba = imuCom-&gt;readAll();
    <span class="ot">QString</span> str(ba);
    <span class="kw">emit</span> imuData(str);

    <span class="kw">if</span> (imuOutputPath.isEmpty()) { genNewOutputPath(); }
    FILE *fp = fopen(imuOutputPath.toAscii().data(), <span class="st">&quot;a+&quot;</span>);
    <span class="kw">if</span> (NULL == fp) {
        <span class="kw">return</span>;
    }
    fprintf(fp, <span class="st">&quot;</span><span class="ch">%s</span><span class="st">&quot;</span>, str.toAscii().data());
    fclose(fp);
}</code></pre></div>
<p>IMU &#21644; LMS &#22823;&#22823;&#19981;&#21516;&#30340;&#22320;&#26041;&#26159;&#65292;IMU &#26159;&#34987;&#21160;&#30340;&#38656;&#35201;&#20320;&#20027;&#21160;&#21435;&#35831;&#27714;&#25968;&#25454;&#12290;&#32780; LMS &#26159;&#20027;&#21160;&#22320;&#65292;&#20320;&#35831;&#27714;&#19968;&#27425;&#21518;&#65292;&#25968;&#25454;&#23601;&#20250;&#25345;&#32493;&#20256;&#36807;&#26469;&#12290;&#30001;&#20110; IMU &#30340;&#34987;&#21160;&#24615;&#36136;&#65292;&#25105;&#20204;&#21482;&#33021;&#23450;&#26102;&#21435;&#35831;&#27714; IMU &#30340;&#23039;&#24577;&#65292;&#38656;&#35201;&#20351;&#29992;&#19968;&#20010;&#23450;&#26102;&#22120;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// QTimer t;</span>
t.setInterval(<span class="dv">100</span>);
<span class="fu">connect</span>( &amp;t, <span class="kw">SIGNAL</span>(timeout() ),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(printPorts()) );</code></pre></div>
<p>IMU &#23601;&#35762;&#21040;&#36825;&#37324;&#12290;&#20854;&#23454; IMU &#26159;&#26368;&#38590;&#26368;&#22797;&#26434;&#30340;&#19968;&#20010;&#20256;&#24863;&#22120;&#27169;&#22359;&#65292;&#36825;&#37324;&#35762;&#24471;&#22914;&#27492;&#31616;&#21333;&#65292;&#26159;&#22240;&#20026;&#36825;&#26159;&#26089;&#26399;&#30340;&#19968;&#20010; IMU &#23454;&#29616;&#12290;&#21518;&#26469;&#25105;&#20204;&#25152;&#26377;&#30340;&#20018;&#21475;&#65292;&#37117;&#38598;&#20013;&#21040;&#20102; MCU &#27169;&#22359;&#65292;<code>class MCUController</code> &#19981;&#20165;&#21487;&#20197;&#29983;&#25104;&#19968;&#20010; IMU &#23454;&#20363;&#65292;&#36824;&#21487;&#20197;&#26159;&#35302;&#21457;&#22120;&#65288;&#21487;&#20197;&#35302;&#21457;&#28608;&#20809;&#22120;&#21644;&#38754;&#20809;&#28304;&#65289;&#65292;&#32534;&#30721;&#22120;&#65288;&#29992;&#26469;&#27979;&#37327;&#34892;&#36208;&#36718;&#34892;&#36208;&#30340;&#36317;&#31163;&#65289;&#12290;&#21482;&#35201;&#22312;&#26500;&#36896;&#30340;&#26102;&#20505;&#20256;&#20837;&#30456;&#24212;&#30340;&#21442;&#25968;&#21363;&#21487;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">namespace</span> DeviceType {
<span class="kw">enum</span> DeviceAddress {
    TRIGGER = <span class="bn">0x01</span>,     <span class="co">// COM1&#65292;&#24403;&#26102;&#65292;&#25105;&#20204;&#30340;&#35302;&#21457;&#22120;&#40664;&#35748;&#25509;&#32447;&#22312; COM1&#65292;&#29992;&#26469;&#35302;&#21457; C2</span>
                        <span class="co">// &#21644; SP20000C &#30456;&#26426;&#30340;&#37319;&#38598;&#39057;&#29575;&#65292;&#20197;&#21450;&#28608;&#20809;&#22120;&#21644;&#38754;&#20809;&#28304;&#30340;&#25171;&#24320;&#21644;&#20851;&#38381;</span>
    LMS_IMU = <span class="bn">0x02</span>,     <span class="co">// COM2</span>
    ENCODER = <span class="bn">0x03</span>,     <span class="co">// COM3</span>
    ENCODER2 = <span class="bn">0x04</span>,    <span class="co">// COM4</span>
};
}

<span class="kw">class</span> MCUController : <span class="kw">public</span> <span class="ot">QObject</span>
{
    <span class="kw">Q_OBJECT</span></code></pre></div>
<p>&#36825;&#37096;&#20998;&#35762; IMU&#65292;&#20294;&#26159;&#24182;&#27809;&#26377;&#28041;&#21450; IMU &#25968;&#25454;&#30340;&#35299;&#26512;&#65292;&#22240;&#20026;&#23427;&#22826;&#22797;&#26434;&#12290;&#22312;&#35299;&#26512;&#25968;&#25454;&#20043;&#21069;&#35201;&#35762;&#20018;&#21475;&#36890;&#20449;&#30340;&#23492;&#23384;&#22120;&#30340;&#35835;&#21644;&#20889;&#65292;&#35201;&#35762;&#20160;&#20040;&#26159; holding registers&#65292;&#20160;&#20040;&#26159; coils &#31561;&#31561;&#27010;&#24565;&#12290;&#32780; IMU &#21518;&#26469;&#25972;&#21512;&#21040; MCU &#21518;&#65292;&#21464;&#24471;&#26356;&#21152;&#22797;&#26434;&#65292; mcu.h &#21644; mcu.cpp &#30340;&#28304;&#30721;&#21152;&#36215;&#26469;&#23558;&#36817; 2500 &#34892;&#12290;&#36825;&#37324;&#36148;&#19968;&#20123;&#22836;&#25991;&#20214;&#65292;&#24863;&#21463;&#19979;&#20854;&#20013;&#36923;&#36753;&#30340;&#22797;&#26434;&#24615;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#24213;&#23618;&#30340;&#25968;&#25454;&#35835;&#21462;&#65292;&#21313;&#20998;&#24863;&#35874;&#38271;&#27801;&#26426;&#26800;&#22242;&#38431;&#27809;&#26377;&#35774;&#32622; coils&#65292;&#20840;&#37096;&#29992;&#20102; resgisters &#26469;&#23384;&#37197;&#32622;</span>
<span class="kw">enum</span> MCUFunctionCodes {
    READ_HOLDING_REGISTERS    = <span class="bn">0x03</span>,  <span class="co">// read output registers</span>
    WRITE_MULTIPLE_REGISTERS  = <span class="bn">0x10</span>,  <span class="co">// write multiple output registers</span>
};
<span class="dt">void</span> readHoldingRegisters( <span class="dt">const</span> <span class="dt">quint16</span> &amp;addr,
                           <span class="dt">const</span> <span class="dt">quint16</span> &amp;length );
<span class="dt">void</span> writeMultipleRegisters( <span class="dt">const</span> <span class="dt">quint16</span> &amp;addr,
                             <span class="dt">const</span> <span class="dt">quint16</span> &amp;length,
                             <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );

<span class="co">// &#32534;&#30721;&#22120;</span>
<span class="dt">void</span> mcuEncoders( <span class="dt">double</span> e1, <span class="dt">double</span> e2 );

<span class="co">// C2 &#30456;&#26426;&#21644; SP20000C &#30340;&#35302;&#21457;&#39057;&#29575;&#20063;&#26377;&#29992;&#25105;&#20204;&#30340;&#31243;&#24207;&#26469;&#25511;&#21046;</span>
<span class="dt">void</span> mcuC2Frequency( <span class="dt">quint16</span> c2f );
<span class="dt">void</span> mcuSP20000CFrequency( <span class="dt">quint16</span> sp20000cf );

<span class="co">// &#36710;&#20307;&#21608;&#22260;&#26377;&#20116;&#20010;&#36229;&#22768;&#27874;&#65292;&#20182;&#20204;&#30340;&#27979;&#36317;&#20063;&#35201;&#23454;&#26102;&#35299;&#26512;&#20986;&#26469;</span>
<span class="dt">void</span> mcuRange1to5( <span class="dt">quint16</span> r1,
                   <span class="dt">quint16</span> r2,
                   <span class="dt">quint16</span> r3,
                   <span class="dt">quint16</span> r4,
                   <span class="dt">quint16</span> r5 );

<span class="co">// &#26368;&#22797;&#26434;&#30340;&#65292;&#36824;&#26159;&#32534;&#30721;&#22120;&#65292;&#26377;&#24456;&#22810;&#21464;&#37327;&#26377;&#20132;&#26367;&#33719;&#21462;</span>
<span class="co">// &#20063;&#26377;&#24456;&#22810;&#35745;&#31639;&#65288;&#35745;&#31639;&#30001;&#31639;&#27861;&#27169;&#22359;&#25552;&#20379;&#65289;</span>
<span class="dt">void</span>   getQuaternion( );
<span class="dt">void</span> parseQuaternion( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="co">// &#23454;&#29616;&#20195;&#30721;&#65306;</span>
<span class="co">//              void MCUController::parseQuaternion( const QByteArray &amp;ba )</span>
<span class="co">//              {</span>
<span class="co">//                  // 0: devAddr, 1: fc, 2: num</span>
<span class="co">//                  if ( ba.length() != 3+8+2 || ba.at(2) != 8 ) {</span>
<span class="co">//                      return;</span>
<span class="co">//                  }</span>
<span class="co">//</span>
<span class="co">//                  quint8 c = 3; // cursor</span>
<span class="co">//                  mcuInfo.quaternion[0] = us2s( parse2BytesToUInt16( ba, c ) ); c += 2;</span>
<span class="co">//                  mcuInfo.quaternion[1] = us2s( parse2BytesToUInt16( ba, c ) ); c += 2;</span>
<span class="co">//                  mcuInfo.quaternion[2] = us2s( parse2BytesToUInt16( ba, c ) ); c += 2;</span>
<span class="co">//                  mcuInfo.quaternion[3] = us2s( parse2BytesToUInt16( ba, c ) ); c += 2;</span>
<span class="co">//</span>
<span class="co">//                  emit mcuQuaternion( mcuInfo.quaternion[0],</span>
<span class="co">//                                      mcuInfo.quaternion[1],</span>
<span class="co">//                                      mcuInfo.quaternion[2],</span>
<span class="co">//                                      mcuInfo.quaternion[3] );</span>
<span class="co">//                  Logger::log( BCD::MCU::GOT_QUATERNION,</span>
<span class="co">//                               QString( &quot;[ %1, %2, %3, %4 ]&quot; ).arg( mcuInfo.quaternion[0] )</span>
<span class="co">//                                                              .arg( mcuInfo.quaternion[1] )</span>
<span class="co">//                                                              .arg( mcuInfo.quaternion[2] )</span>
<span class="co">//                                                              .arg( mcuInfo.quaternion[3] ) );</span>
<span class="co">//              }</span>
<span class="co">//</span>
<span class="dt">void</span>   getRollPitchYaw( );
<span class="dt">void</span> parseRollPitchYaw( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getAcceleration( );
<span class="dt">void</span> parseAcceleration( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getGyroScope( );
<span class="dt">void</span> parseGyroScope( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getMagnetometer( );
<span class="dt">void</span> parseMagnetometer( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getRotation( );
<span class="dt">void</span> parseRotation( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getEkf( );
<span class="dt">void</span> parseEkf( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="co">// &#22788;&#29702;&#22909;&#30340;&#25968;&#25454;&#65292;&#20063;&#35201;&#20445;&#23384;&#36215;&#26469;&#65288;&#30452;&#25509;&#29992; Logger::log &#23384;&#26085;&#24535;&#37324;&#23601;&#21487;&#20197;&#65289;</span>
<span class="dt">void</span> savedata( <span class="dt">const</span> <span class="dt">qint64</span> &amp;dt, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d0
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;d1, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d2, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d3
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;d4, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d5, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d6
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;d7, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d8, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d9
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;da, <span class="dt">const</span> <span class="dt">qint16</span> &amp;db, <span class="dt">const</span> <span class="dt">qint16</span> &amp;dc
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;dx, <span class="dt">const</span> <span class="dt">qint16</span> &amp;dy, <span class="dt">const</span> <span class="dt">qint16</span> &amp;dz);
<span class="co">// &#20027;&#30028;&#38754;&#36824;&#35201;&#26174;&#31034;&#20986;&#26469;&#65292;&#36825;&#26159;&#19968;&#20123;&#20449;&#21495;</span>
<span class="dt">void</span> mcuQuaternion( <span class="dt">qint16</span> q0,
                    <span class="dt">qint16</span> q1,
                    <span class="dt">qint16</span> q2,
                    <span class="dt">qint16</span> q3 );
<span class="dt">void</span> mcuAdisRequireData( <span class="dt">qint16</span> d1, <span class="dt">qint16</span> d2, <span class="dt">qint16</span> d3,
                         <span class="dt">qint16</span> d4, <span class="dt">qint16</span> d5, <span class="dt">qint16</span> d6,
                         <span class="dt">qint16</span> d7, <span class="dt">qint16</span> d8, <span class="dt">qint16</span> d9,
                         <span class="dt">qint16</span> da, <span class="dt">qint16</span> db, <span class="dt">qint16</span> dc );
<span class="dt">void</span> mcuRollPitchYaw( <span class="dt">qint16</span> r,
                      <span class="dt">qint16</span> p,
                      <span class="dt">qint16</span> y );
<span class="dt">void</span> mcuAcc( <span class="dt">qint16</span> x,
             <span class="dt">qint16</span> y,
             <span class="dt">qint16</span> z );
<span class="dt">void</span> mcuGyro( <span class="dt">qint16</span> gyro_x,
              <span class="dt">qint16</span> gyro_y,
              <span class="dt">qint16</span> gyro_z );
<span class="dt">void</span> mcuMag( <span class="dt">qint16</span> mag_x,
             <span class="dt">qint16</span> mag_y,
             <span class="dt">qint16</span> mag_z );
<span class="dt">void</span> mcuRefMatrix( <span class="dt">qint16</span> r1, <span class="dt">qint16</span> r2, <span class="dt">qint16</span> r3,
                   <span class="dt">qint16</span> r4, <span class="dt">qint16</span> r5, <span class="dt">qint16</span> r6,
                   <span class="dt">qint16</span> r7, <span class="dt">qint16</span> r8, <span class="dt">qint16</span> r9 );</code></pre></div>
<p>&#35835;&#21462; MCU &#25968;&#25454;&#21518;&#65292;&#20063;&#35201; dispatch&#65292;&#32780;&#19988;&#36824;&#35201;&#21028;&#26029;&#35835;&#21462;&#26159;&#21542;&#26377;&#8220;&#20132;&#38169;&#8221;&#65292;&#22240;&#20026;&#25968;&#25454;&#35835;&#21462;&#24448;&#24448;&#26159;&#21521;&#22810;&#20010;&#23492;&#23384;&#22120;&#36827;&#34892;&#30340;&#65292;&#24182;&#19981;&#33021;&#20551;&#23450;&#35831;&#27714;&#21644;&#25910;&#21040;&#30340;&#25968;&#25454;&#23601;&#26159;&#19968;&#19968;&#21305;&#37197;&#30340;&#65292;MCU &#30340;&#35835;&#21462;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> MCUController::readMCU( )
{
    <span class="ot">QByteArray</span> ba = mcuCom-&gt;readAll();

    <span class="co">// chop garbage values</span>
    <span class="dt">int</span> i = <span class="dv">0</span>;
    <span class="kw">while</span> ( i &lt; ba.length() &amp;&amp; ba.at(i) != devAddr ) {
        ++i;
    }
    ba.remove( <span class="dv">0</span>, i );

    <span class="kw">if</span> ( ba.length() &lt; <span class="dv">2</span> ) {      <span class="co">// at least 2 bytes: devAddr, function code</span>
        <span class="kw">return</span>;
    }

    <span class="ot">QString</span> str( ba );
    <span class="ot">QString</span> hexstr = ba2hexstr( ba );
    <span class="kw">emit</span> mcuData( str );
   <span class="co">// emit mcuHexData( hexstr );</span>
    <span class="kw">if</span> ( SHOW_READ ) {
        Logger::log( BCD::MCU::MCU, <span class="ot">QString</span>( <span class="st">&quot;MCU%1 Received %2 bytes: %3&quot;</span> ).arg( id ).arg( ba.length() ).arg( hexstr ) );
    }

    <span class="dt">quint8</span> fc = ba.at( <span class="dv">1</span> ); <span class="co">// function code</span>
    <span class="kw">if</span> ( fc != functionCode ) {
        <span class="co">// function code is the &lt;write data&gt;&#39;s status,</span>
        <span class="co">// it must equal the &lt;received data&gt;&#39;s status</span>
        Logger::log( BCD::MCU::CONVOLUTED_TX_RX );
        <span class="kw">return</span>;
    }

    <span class="co">// dispatch</span>
    <span class="kw">if</span> ( <span class="kw">false</span> ) {
    } <span class="kw">else</span> <span class="kw">if</span> ( READ_HOLDING_REGISTERS == fc ) {
        <span class="co">// &#37324;&#38754;&#36824;&#35201;&#21028;&#26029;&#35835;&#21040;&#30340;&#22320;&#22336;&#21644;&#33258;&#24049;&#19978;&#27425;&#35831;&#27714;&#30340;&#22320;&#22336;&#26159;&#21542;&#19968;&#33268;&#12290;</span>
        onReadHoldingRegisters( ba );
    }

    <span class="kw">if</span> ( !crc16Passed( ba ) ) {
        Logger::log( BCD::MCU::MCU, <span class="st">&quot;err crc16 failed&quot;</span> );
        <span class="kw">return</span>;
    }
}

<span class="dt">void</span> MCUController::onReadHoldingRegisters( <span class="ot">QByteArray</span> &amp;ba )
{
    <span class="kw">switch</span> ( currentMode ) {
    <span class="kw">case</span> GET_TIME_STAMP:                 parseTimestamp( ba );              <span class="kw">break</span>;
    <span class="kw">case</span> GET_RANGE_1_TO_5:               parseRange1to5( ba );              <span class="kw">break</span>;
<span class="co">/*  case GET_ADIS_REQUIRE_DATA:          parseADISRequiredata( ba );        break; // only one scan */</span>
    <span class="kw">case</span> GET_ADIS_REQUIRE_DATA:          parseADISScans( ba );              <span class="kw">break</span>; <span class="co">// multiple scans</span>
<span class="co">/*  case GET_ADIS_REQUIRE_DATA:          threadParseADIS( ba );             break; */</span>
    <span class="kw">case</span> GET_QUATERNION:                 parseQuaternion( ba );             <span class="kw">break</span>;
    <span class="kw">case</span> GET_ROLL_PITCH_YALL:            parseRollPitchYaw( ba );           <span class="kw">break</span>;
    <span class="kw">case</span> GET_ACCEL_XYZ:                   parseAcceleration( ba );          <span class="kw">break</span>;
    <span class="kw">case</span> GET_GYRO_XYZ:                   parseGyroScope( ba );              <span class="kw">break</span>;
    <span class="kw">case</span> GET_MAG_XYZ:                    parseMagnetometer( ba );           <span class="kw">break</span>;
<span class="co">/*  case GET_H_MOTOR_NUM:                parseHMotorNum( ba );              break; */</span>
    <span class="kw">case</span> GET_HORIZONTAL_MOTORNUM:        parseHorizontalMotornum( ba );     <span class="kw">break</span>;
    <span class="kw">case</span> GET_ROTATION_XYZ:               parseRotation( ba );               <span class="kw">break</span>;
    <span class="kw">case</span> GET_ENCODERS:                   parseEncoders( ba );               <span class="kw">break</span>;
    <span class="kw">case</span> GET_EKF:                        parseEkf( ba );                    <span class="kw">break</span>;
    <span class="kw">default</span>:                             Logger::log( BCD::MCU::MCU, <span class="st">&quot;mcuFC not match.&quot;</span> );
    }
}</code></pre></div>
<p>IMU &#29992;&#26469;&#27979;&#37327;&#23039;&#24577;&#21644;&#21152;&#36895;&#24230;&#65292;&#22914;&#26524;&#19968;&#30452;&#20351;&#29992;&#31934;&#24230;&#23601;&#20250;&#24456;&#24046;&#65292;&#25152;&#20197;&#38656;&#35201;&#19981;&#26102;&#22320; tare&#65288;&#32622;&#38646;&#65289;&#19968;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> MCUController::doTare( )
{
    <span class="ot">QByteArray</span> tx;
    tx.append( <span class="st">&#39;</span><span class="ch">\0</span><span class="st">&#39;</span> );
    tx.append(  <span class="dv">13</span>  );
    writeMultipleRegisters( mcuAddr.value( ON_OFF_ADDR ), <span class="dv">1</span>, tx );
    Logger::log( BCD::MCU::TARE );
}</code></pre></div>
<p>&#20174; <code>writeMultipleRegisters( mcuAddr.value( ON_OFF_ADDR ), 1, tx )</code> &#21487;&#20197;&#30475;&#20986;&#65292;&#25105;&#20381;&#26087;&#26159;&#25226;&#25152;&#26377;&#30340;&#20989;&#25968;&#22320;&#22336;&#23384;&#22312;&#20102;&#19968;&#20010; map &#37324;&#12290;&#36825;&#26679;&#29992;&#36215;&#26469;&#27604;&#36739;&#26041;&#20415;&#65288;&#34429;&#28982;&#26377;&#36807;&#24230;&#24037;&#31243;&#30340;&#23244;&#30097;&#65289;&#12290;</p>
<p>&#37027;&#20010; <code>tx.append( '\0' )</code> &#21017;&#26159;&#26080;&#22856;&#20043;&#20030;&#65292;&#22240;&#20026;&#25105;&#35797;&#20102; <code>tx.append( 0 )</code> &#21644; <code>tx.append( char(0) )</code>&#65292;&#37117;&#19981;&#21487;&#20197;&#12290;&#36824;&#22909;&#32456;&#20110;&#25104;&#21151;&#20102;==&#12290;</p>
<p>&#65288;By the way&#65292;&#36825;&#21487;&#33021;&#26159;&#26089;&#26399;&#30340;&#20195;&#30721;&#65292;&#22240;&#20026;&#29616;&#22312;&#19968;&#30475;&#23601;&#24212;&#35813;&#29992; <code>quint16 highlow( const quint8 &amp;high, const quint8 &amp;low )</code> &#21834;&#12290;&#65289;</p>
<p>IMU &#27169;&#22359;&#23601;&#21040;&#36825;&#37324;&#12290;&#19979;&#38754;&#35762; UR &#27169;&#22359;&#12290;</p>
<h2 id="ur">UR</h2>
<p>&#22312;&#25105;&#36824;&#22312;&#32769;&#24072;&#30340;&#20844;&#21496;&#20570;&#26412;&#31185;&#27605;&#35774;&#30340;&#26102;&#20505;&#65292;&#25105;&#23601;&#30475;&#21040;&#20102; UR10&#12290;&#27809;&#24819;&#21040;&#21518;&#26469;&#23427;&#30340;&#25511;&#21046;&#31243;&#24207;&#36824;&#26159;&#25105;&#20889;&#30340;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-20-05.png" alt="&#25918;&#22312;&#20844;&#21496;&#20108;&#27004;&#30340; UR10 &#26426;&#26800;&#33218;" align="right" />
<p class="caption">&#25918;&#22312;&#20844;&#21496;&#20108;&#27004;&#30340; UR10 &#26426;&#26800;&#33218;</p>
</div>
<p>&#20808;&#31616;&#35201;&#20171;&#32461;&#19968;&#19979;&#23427;&#65306;</p>
<blockquote>
<p>UR&#65288;Universal Robot&#65289;&#26159;&#19968;&#20010;&#26426;&#26800;&#33218;&#65292;&#20301;&#20110;&#36710;&#26426;&#26800;&#33218;&#26411;&#31471;&#65292;&#25645;&#36733;&#20102;&#20840;&#37096;&#20256;&#24863;&#22120;&#12290; &#20849; 6 &#20010;&#20851;&#33410;&#65292;&#22343;&#21487; 360 &#24230;&#26059;&#36716;&#65292;&#21487;&#23450;&#28857;&#31227;&#21160;&#12290;</p>
</blockquote>
<p>&#30456;&#27604; LMS &#20351;&#29992; TCP&#65292;IMU &#20351;&#29992;&#20018;&#21475; Modbus &#21327;&#35758;&#65292;UR10 &#25552;&#20379;&#20102;&#26356;&#20840;&#38754;&#20415;&#25463;&#30340;&#20132;&#20114;&#25509;&#21475;&#65306;&#20320;&#21487;&#20197;&#20351;&#29992; TCP&#65292;&#20063;&#21487;&#20197;&#26159;&#29992; Modbus&#65288;&#32780;&#19988;&#26159; Modbus TCP&#65292;&#27604; IMU &#30340;&#20018;&#21475; Modbus &#22909;&#29992;&#24471;&#22810;&#65289;&#12290;</p>
<p>&#22240;&#20026; TCP &#20351;&#29992;&#36215;&#26469;&#26041;&#20415;&#24471;&#22810;&#65292;&#25105;&#20204;&#20351;&#29992;&#20102; TCP<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>&#65292;&#23427;&#25552;&#20379;&#22235;&#20010;&#31471;&#21475;&#65292;&#25152;&#20197;&#25105;&#20204;&#30340; URController &#31867;&#37324;&#26377;&#22235;&#20010;&#25104;&#21592;&#21464;&#37327;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">QTcpSocket</span> urDashboardAgent;
<span class="ot">QTcpSocket</span> urClient1;
<span class="ot">QTcpSocket</span> urClient2;
<span class="ot">QTcpSocket</span> urStatusAgent;</code></pre></div>
<p>&#36825;&#26159;&#19968;&#20123;&#26377;&#29992;&#30340;&#21464;&#37327;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">enum</span> {
    UR_ModbusTCPPort          = <span class="dv">502</span>,    <span class="co">// UR &#25552;&#20379;&#30340; ModbusTCP &#31471;&#21475;&#65292;&#19981;&#22909;&#29992;&#65292;&#25152;&#20197;&#27809;&#29992;&#20102;</span>
    UR_DashboardPort          = <span class="dv">29999</span>,
    UR_Client1Port            = <span class="dv">30001</span>,  <span class="co">// controller</span>
    UR_Client2Port            = <span class="dv">30002</span>,
    UR_StatusPort             = <span class="dv">30003</span>,  <span class="co">// UR status, 100Hz</span>
};</code></pre></div>
<p>&#22914;&#19979;&#22270;&#65292;urClient1 &#36830;&#25509;&#21040;&#31471;&#21475; 30001&#65292;&#29992;&#26469;&#25511;&#21046; UR &#30340;&#31227;&#21160;&#65292;&#20351;&#29992;&#30340;&#26159; UR &#25991;&#26723;&#20013;&#35828;&#21040;&#30340; UScript &#33050;&#26412;&#12290; urStatusAgent &#36830;&#25509;&#21040;&#31471;&#21475; 30003&#65292;&#29992;&#26469;&#33719;&#21462; UR &#24403;&#21069;&#30340;&#20301;&#23039;&#21644;&#29366;&#24577;&#65292;&#25968;&#25454;&#39057;&#29575;&#26159; 100 Hz&#65292;&#27599;&#27425; 1440 &#20010;&#23383;&#33410;&#30340;&#25968;&#25454;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/ur-conn-UR.png" />

</div>
<p>&#19978;&#22270;&#21407;&#26159;&#25105;&#30011;&#22312; processingon &#19978;&#30340;&#65292;&#38142;&#25509;&#22312;&#36825;&#37324;&#65306;<a href="https://www.processon.com/view/link/56ee186de4b0881f9ac2e009" class="uri">https://www.processon.com/view/link/56ee186de4b0881f9ac2e009</a>&#12290;</p>
<p>UR &#26368;&#37325;&#35201;&#30340;&#65292;&#26159;&#23427;&#30340;&#24403;&#21069;&#23039;&#24577;&#65292;&#25105;&#20204;&#25226;&#23427;&#23384;&#22312;&#20102;&#19968;&#36215;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">struct</span> URStatus {
    <span class="dt">quint32</span> size;
    <span class="dt">double</span> time;
    <span class="dt">double</span> q_target[<span class="dv">6</span>];                 <span class="co">// joint target, rad</span>
    <span class="dt">double</span> qd_target[<span class="dv">6</span>];                <span class="co">// rad/s</span>
    <span class="dt">double</span> qdd_target[<span class="dv">6</span>];               <span class="co">// rad/s^2</span>
    <span class="dt">double</span> i_target[<span class="dv">6</span>];                 <span class="co">// target current, A</span>
    <span class="dt">double</span> m_target[<span class="dv">6</span>];                 <span class="co">// torque, in Nm</span>

    <span class="dt">double</span> q_actual[<span class="dv">6</span>];                 <span class="co">// rad</span>
    <span class="dt">double</span> qd_actual[<span class="dv">6</span>];                <span class="co">// rad/s</span>
    <span class="dt">double</span> i_actual[<span class="dv">6</span>];                 <span class="co">// needed current, A</span>
    <span class="dt">double</span> i_control[<span class="dv">6</span>];                <span class="co">// supplied current, A</span>

    <span class="dt">double</span> tcp_vector_actual[<span class="dv">6</span>];        <span class="co">// m, rad</span>
    <span class="dt">double</span> tcp_speed_actual[<span class="dv">6</span>];         <span class="co">// m/s, rad/s</span>
    <span class="dt">double</span> tcp_force_actual[<span class="dv">6</span>];         <span class="co">// N, Nm</span>
    <span class="dt">double</span> tcp_vector_target[<span class="dv">6</span>];        <span class="co">// m, rad</span>
    <span class="dt">double</span> tcp_speed_target[<span class="dv">6</span>];         <span class="co">// m/s, rad/s</span>

    <span class="dt">double</span> digital_input_bits;
    <span class="dt">double</span> motor_temperatures[<span class="dv">6</span>];       <span class="co">// temperature(&#176;C) of six joints</span>

    <span class="dt">double</span> controller_timer;
    <span class="dt">double</span> reverved_value;
    <span class="dt">double</span> robot_mode;
    <span class="dt">double</span> joint_modes[<span class="dv">6</span>];
    <span class="dt">double</span> safety_mode;

    <span class="dt">double</span> ur_only1[<span class="dv">6</span>];
    <span class="dt">double</span> tool_accelerometer_values[<span class="dv">3</span>];
    <span class="dt">double</span> ur_only2[<span class="dv">6</span>];

    <span class="dt">double</span> speed_scaling;
    <span class="dt">double</span> linear_momentum_norm;
    <span class="dt">double</span> ur_only3;
    <span class="dt">double</span> ur_only4;

    <span class="dt">double</span> v_main;                      <span class="co">// V</span>
    <span class="dt">double</span> v_robot;                     <span class="co">// V</span>
    <span class="dt">double</span> i_robot;                     <span class="co">// A</span>
    <span class="dt">double</span> v_actual[<span class="dv">6</span>];
} ust;</code></pre></div>
<p>&#37324;&#38754;&#30340; tcp &#21487;&#19981;&#26159;&#32593;&#32476;&#36890;&#20449;&#30340; tcp&#65292;&#32780;&#26159; tool center point&#65292;&#20063;&#23601;&#26159; UR10 &#26411;&#31471;&#65288;&#26368;&#36828;&#31471;&#65289;&#12290;</p>
<p>&#22312; UR &#30340;&#26500;&#36896;&#20989;&#25968;&#37324;&#65292;&#38656;&#35201;&#36830;&#25509;&#20960;&#20010;&#27133;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#26377;&#25968;&#25454;&#23601;&#35835;&#25968;&#25454;</span>
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(readUR()) );
<span class="fu">connect</span>( &amp;urClient1, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(parseURAgent1()) );
<span class="fu">connect</span>( &amp;urClient2, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(parseURAgent2()) );
<span class="fu">connect</span>( &amp;urDashboardAgent, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(parseURDashboard()) );
<span class="fu">connect</span>( &amp;urStatusAgent, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(parseURStatus()) );

<span class="co">// &#25481;&#32447;&#23601;&#33258;&#21160;&#37325;&#36830;</span>
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectUR()) );
<span class="fu">connect</span>( &amp;urDashboardAgent, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectDashboard()) );
<span class="fu">connect</span>( &amp;urClient1, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectClient1()) );
<span class="fu">connect</span>( &amp;urClient2, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectClient2()) );
<span class="fu">connect</span>( &amp;urStatusAgent, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectStatusAgent()) );
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(stateChanged(<span class="ot">QAbstractSocket::</span>SocketState)),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(urStateChanged(<span class="ot">QAbstractSocket::</span>SocketState)) );</code></pre></div>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> URController::dashboardWrite( <span class="ot">QByteArray</span> &amp;ba )
{
    ba.append( <span class="st">&quot;</span><span class="ch">\r\n</span><span class="st">&quot;</span> );
    urDashboardAgent.write( ba, ba.length() );
    Logger::log( BCD::UR::DASHBOARD_WRITE );
}

<span class="dt">void</span> URController::client1Write( <span class="ot">QByteArray</span> &amp;ba ) { ... }
<span class="dt">void</span> URController::client2Write( <span class="ot">QByteArray</span> &amp;ba ) { ... }</code></pre></div>
<p>UR &#26368;&#37325;&#35201;&#30340;&#26159;&#33719;&#21462; UR &#30340;&#24403;&#21069;&#23039;&#24577;&#65292;&#32780;&#19988;&#25105;&#20204;&#21482; parse &#25105;&#20204;&#38656;&#35201;&#30340;&#25968;&#25454;&#65306;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/ur-decode-status.png" />

</div>
<p>&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> URController::parseURStatus( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba )
{
    <span class="kw">if</span> ( ba.length() != <span class="dv">2</span> * UR_STATUS_BUF_LENGTH ) { <span class="kw">return</span>; }

    <span class="co">// then we parse the 1044 bytes</span>
    <span class="dt">bool</span> t = <span class="kw">true</span>, f = <span class="kw">false</span>;     <span class="co">// flag to determine Parsing or Not</span>
    <span class="dt">quint16</span> c = <span class="dv">0</span>;                <span class="co">// cursor</span>

    ust.size                         = parse4Bytes2Int4UR( ba, c ); c += <span class="dv">4</span>;
    <span class="kw">if</span> (ust.size != UR_STATUS_BUF_LENGTH) {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;oops: &quot;</span> &lt;&lt; ust.size;
        <span class="kw">return</span>;
    }

<span class="ot">#define PARSE_TO_DOUBLE parse8BytesToDouble</span>
<span class="co">// #define PARSE_TO_DOUBLE parse8Bytes2Double4UR</span>
    ust.time                         = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// q target&#65292;&#36825;&#20123;&#19996;&#35199;&#19981;&#37325;&#35201;&#65292;&#25152;&#20197;&#20256;&#20837;&#8220;f&#8221;&#65292;&#21363;&#65306;&#12304;&#19981;&#22788;&#29702;&#12305;</span>
    ust.q_target[<span class="dv">0</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.q_target[<span class="dv">5</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// q target differential</span>
    ust.qd_target[<span class="dv">0</span>]                 = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.qd_target[<span class="dv">5</span>]                 = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// qdd</span>
    ust.qdd_target[<span class="dv">0</span>]                = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.qdd_target[<span class="dv">5</span>]                = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// I</span>
    ust.i_target[<span class="dv">0</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.i_target[<span class="dv">5</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// M</span>
    ust.m_target[<span class="dv">0</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.m_target[<span class="dv">5</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// q actual&#65292;&#20851;&#33410;&#30340;&#35282;&#24230;&#12290;&#36825;&#26159;&#25105;&#20204;&#20851;&#24515;&#30340;&#20869;&#23481;&#65292;&#25152;&#20197;&#20256;&#20837;&#8220;t&#8221;&#65292;&#34920;&#31034;&#12304;&#38656;&#35201; parse&#12305;</span>
    ust.q_actual[<span class="dv">0</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">1</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">2</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">3</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">4</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">5</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    <span class="co">// &#35299;&#26512;&#24471;&#21040;&#30340;&#25968;&#25454;&#31435;&#39532; emit &#20986;&#21435;&#65292;&#20027;&#30028;&#38754;&#33719;&#24471;&#20102;&#65292;&#21487;&#20197;&#23454;&#26102;&#26174;&#31034;&#20986;&#26469;</span>
    <span class="kw">emit</span> ustJ0toJ5( rad2deg( ust.q_actual[<span class="dv">0</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">1</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">2</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">3</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">4</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">5</span>] ) );
    <span class="co">// qd&#65292;&#36825;&#26159;&#21152;&#36895;&#24230;&#12290;</span>
    ust.qd_actual[<span class="dv">0</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">1</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">2</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">3</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">4</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">5</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    <span class="kw">emit</span> ustJ0toJ5d( rad2deg( ust.qd_actual[<span class="dv">0</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">1</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">2</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">3</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">4</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">5</span>] ) );
    ...

    <span class="co">// TCP&#65292;&#26411;&#31471;&#24471;&#20301;&#32622;</span>
    ust.tcp_vector_actual[<span class="dv">0</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">1</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">2</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">3</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">4</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">5</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    <span class="kw">emit</span> ustXYZRxRyRz( ust.tcp_vector_actual[<span class="dv">0</span>],
                       ust.tcp_vector_actual[<span class="dv">1</span>],
                       ust.tcp_vector_actual[<span class="dv">2</span>],
                       ust.tcp_vector_actual[<span class="dv">3</span>],
                       ust.tcp_vector_actual[<span class="dv">4</span>],
                       ust.tcp_vector_actual[<span class="dv">5</span>] );

    <span class="co">// tcp speed actual</span>
    ust.tcp_speed_actual[<span class="dv">0</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.tcp_speed_actual[<span class="dv">5</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;

    <span class="co">// tcp force</span>
    ust.tcp_force_actual[<span class="dv">0</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.tcp_force_actual[<span class="dv">5</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;

    <span class="co">// tcp target</span>
    ust.tcp_vector_target[<span class="dv">0</span>]         = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.tcp_vector_target[<span class="dv">5</span>]         = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;

    <span class="co">// tcp speed target</span>
    ust.tcp_speed_target[<span class="dv">0</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.tcp_speed_target[<span class="dv">5</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...

<span class="ot">#undef PARSE_TO_DOUBLE</span>
    <span class="co">// parsed c=1044 bytes now.</span>
}</code></pre></div>
<p>UR &#27169;&#22359;&#36824;&#21487;&#20197;&#25511;&#21046; UR &#20845;&#20010;&#26426;&#26800;&#33218;&#30340;&#31227;&#21160;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#31227;&#21160;&#21040;&#26576;&#20010;&#35282;&#24230;</span>
<span class="dt">void</span> URController::moveJ( <span class="dt">const</span> <span class="dt">double</span> &amp;x1,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x2,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x3,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x4,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x5,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x6 )
{
    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;movej([</span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">]&quot;</span>
                 <span class="st">&quot;,a=</span><span class="ch">%.2lf</span><span class="st">, v=</span><span class="ch">%.2lf</span><span class="st">, t=</span><span class="ch">%.2lf</span><span class="st">, r=</span><span class="ch">%.2lf</span><span class="st">)&quot;</span>,
                  x1, x2, x3, x4, x5, x6,
                  urConf.qAcceleration,
                  urConf.qVelocity,          <span class="co">// velocity</span>
                  urConf.time,               <span class="co">// time</span>
                  urConf.blendRadius );      <span class="co">// blend radius</span>
    <span class="ot">QByteArray</span> ba;
    ba.append( str );
    client1Write( ba );
    Logger::log( BCD::UR::UR, <span class="ot">QString</span>( <span class="st">&quot;UR moveJ&#65306; %1&quot;</span>).arg( str ) );
}

<span class="co">// &#31227;&#21160;&#26576;&#20010;&#35282;&#24230;</span>
<span class="dt">void</span> URController::moveJDiff( <span class="dt">const</span> <span class="dt">double</span> &amp;x1,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x2,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x3,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x4,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x5,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x6 )
{
    <span class="dt">double</span> j[<span class="dv">6</span>] = { ust.q_actual[<span class="dv">0</span>],
                    ust.q_actual[<span class="dv">1</span>],
                    ust.q_actual[<span class="dv">2</span>],
                    ust.q_actual[<span class="dv">3</span>],
                    ust.q_actual[<span class="dv">4</span>],
                    ust.q_actual[<span class="dv">5</span>] };
    Logger::log( BCD::UR::UR,
        <span class="ot">QString</span>( <span class="st">&quot;UR moveJDiff&#65306; delta=[%1, %2, %3, %4, %5, %6]&quot;</span>).arg( x1 ).arg( x2 ).arg( x3 ).arg( x4 ).arg( x5 ).arg( x6 ) );
    moveJ( j[<span class="dv">0</span>] + x1
         , j[<span class="dv">1</span>] + x2
         , j[<span class="dv">2</span>] + x3
         , j[<span class="dv">3</span>] + x4
         , j[<span class="dv">4</span>] + x5
         , j[<span class="dv">5</span>] + x6 );
}</code></pre></div>
<p>&#37324;&#38754;&#29992;&#30340;&#26159; UR &#25552;&#20379;&#30340;&#33050;&#26412;&#12290;UR10 &#30340;&#35828;&#26126;&#25991;&#26723;&#37324;&#26377;&#19968;&#26412; UScript 1.0&#65292;&#37324;&#38754;&#23545;&#27492;&#26377;&#25152;&#35828;&#26126;&#12290;&#25105;&#20204;&#38656;&#35201;&#30340;&#21482;&#26159;&#31227;&#21160;&#20851;&#33410;&#12289;&#31227;&#21160;&#21040;&#26576;&#19968;&#20010;&#20301;&#32622;&#12290;&#25152;&#20197;&#36824;&#19981;&#31639;&#22826;&#22797;&#26434;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/ur-process.png" />

</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/ur-old.png" alt="&#36825;&#26159;&#26089;&#26399;&#30340;&#19968;&#20010;&#25130;&#22270;" />
<p class="caption">&#36825;&#26159;&#26089;&#26399;&#30340;&#19968;&#20010;&#25130;&#22270;</p>
</div>
<p>UR &#23601;&#35762;&#21040;&#36825;&#12290;</p>
<p>&#20256;&#24863;&#22120;&#27169;&#22359;&#20063;&#23601;&#21040;&#24213;&#20026;&#27490;&#20102;&#12290;</p>
<hr />
<p><a href="post-0118-changsha-review-5.html" style="font-size:80%; color: red;" title="post-0118-changsha-review-5.md">&#12304;&#19979;&#19968;&#33410;&#65306;&#38271;&#27801;&#39033;&#30446;&#24635;&#32467; 5 &#8211; &#36890;&#20449;&#27169;&#22359;&#65306;Wrappers &#21644; Moderator&#12305;</a></p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>&#24320;&#22987;&#25105;&#24182;&#19981;&#30693;&#36947;&#21487;&#20197;&#29992; TCP&#65292;&#36824;&#22312;&#23581;&#35797;&#29992; Modbus &#35831;&#27714;&#30340;&#26041;&#24335;&#19968;&#20010;&#20010;&#35835;&#21462; register&#65292;&#21518;&#26469;&#24778;&#29616;&#21407;&#26469;&#21487;&#20197;&#29992; TCP&#65292;&#20110;&#26159;&#36825;&#20123;&#19996;&#35199;&#32479;&#32479;&#37117;&#29992;&#19981;&#30528;&#20102;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">enum</span> URFunctionCodes {
    READ_COILS                = <span class="bn">0x01</span>,  <span class="co">// read output bits</span>
    READ_DISCRETE_INPUTS      = <span class="bn">0x02</span>,  <span class="co">// read input bits</span>
    READ_HOLDING_REGISTERS    = <span class="bn">0x03</span>,  <span class="co">// read output registers</span>
    READ_INPUT_REGISTERS      = <span class="bn">0x04</span>,  <span class="co">// read input registers</span>
    WRITE_SINGLE_COIL         = <span class="bn">0x05</span>,  <span class="co">// write output bit, turn ON/OFF</span>
    WRITE_SINGLE_REGISTER     = <span class="bn">0x06</span>,  <span class="co">// write output register</span>
    WRITE_MULTIPLE_COILS      = <span class="bn">0x0f</span>,  <span class="co">// write multiple output bits</span>
    WRITE_MULTIPLE_REGISTERS  = <span class="bn">0x10</span>,  <span class="co">// write multiple output registers</span>
};</code></pre></div>
<a href="#fnref1">&#8617;</a></li>
</ol>
</div>
<ul class="tzx-tags-group">
<li><a class="tzx-tag" href="tags.html/#review">review</a></li>
<li><a class="tzx-tag" href="tags.html/#project">project</a></li>
</ul>

<div class="tzx-changes"><select id="tzx-changes" title="&#21382;&#21490;&#29256;&#26412;">
<option value="https://raw.githubusercontent.com/district10/blog/8b3aa6e124806cbe8f73d3ec40c867ee50e7ff9b/_posts/post-0117-changsha-review-4.md" title="2 insertions(+), 1 deletions(-)">1491145416</option>
<option value="https://raw.githubusercontent.com/district10/blog/5a7d1f7d62a5cd8a23e9aaa6609f69393870e372/_posts/post-0117-changsha-review-4.md" title="3 insertions(+), 1 deletions(-)">1480428507</option>
<option value="https://raw.githubusercontent.com/district10/blog/b08a696f534c650b0d7fccc3b0b1d7d0d68c6d3d/_posts/post-0117-changsha-review-4.md" title="1804 insertions(+), 0 deletions(-)">1480083296</option>
</select></div>

<script>
var tzxFilename = "_posts/post-0117-changsha-review-4.md";
var tzxChanges = [
    {
        hash: "8b3aa6e124806cbe8f73d3ec40c867ee50e7ff9b",
        datetime: "1491145416",
        insertions: 2,
        deletions: 1
    },
    {
        hash: "5a7d1f7d62a5cd8a23e9aaa6609f69393870e372",
        datetime: "1480428507",
        insertions: 3,
        deletions: 1
    },
    {
        hash: "b08a696f534c650b0d7fccc3b0b1d7d0d68c6d3d",
        datetime: "1480083296",
        insertions: 1804,
        deletions: 0
    },
];
</script>

<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="jquery-ui.min.js"></script>
<script type="text/javascript" src="clappr.min.js"></script>
<script type="text/javascript" src="lazyload.min.js"></script>
<script type="text/javascript" src="egg.min.js"></script>
<script type="text/javascript" src="moment.min.js"></script>
<script type="text/javascript" src="clipboard.min.js"></script>
<script type="text/javascript" src="main.js"></script>
<hr style="color: #9ddcff;"/>
<div id="copyright">TANG ZhiXiong, 2017.  Generated by Pandoc on Travis CI. <a  href="https://github.com/district10/blog">Fork Me on GitHub.</a></div>
<div id="comments" class="comments-area">
    <div><span id="showDisqus" title="&#27426;&#36814;&#20132;&#27969;">&#12300;Load Disqus | &#21152;&#36733;&#35780;&#35770;&#12301;</span></div>
    <div id="disqus_thread"></div>
</div>
</body>
</html>
