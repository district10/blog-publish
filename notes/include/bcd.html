<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="author" content="district10" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="../github-markdown.css" type="text/css" />
    <link rel="stylesheet" href="../highlight.css" type="text/css" />
    <link rel="stylesheet" href="../notes.css" type="text/css" />
</head>
<body class="markdown-body">
<div id="navigator">
    <a id="gotoindex" href="index.html" title="&#12304;&#22238;&#21040;&#31508;&#35760;&#32034;&#24341; | Back to Index&#12305;">&#9763;</a></div>
<div id="main-body">
<p>&#12304;BCD &#39033;&#30446;&#24635;&#32467;&#65292;&#33609;&#31295;&#65281;&#12305;</p>
<p><a href="http://cvrs.whu.edu.cn/index.php?m=content&amp;c=index&amp;a=show&amp;catid=99&amp;id=50">CVRS &#21442;&#21152;&#31532;&#20108;&#23626;&#26477;&#24030;&#26426;&#22120;&#20154;&#35199;&#28246;&#35770;&#22363; - &#20844;&#21578; - &#27494;&#27721;&#22823;&#23398;&#35745;&#31639;&#26426;&#35270;&#35273;&#19982;&#36965;&#24863;&#23454;&#39564;&#23460;&#65288;CVRS Lab&#65289;</a></p>
<blockquote>
<p>2016 &#24180; 5 &#26376; 22 &#26085;&#65292;&#30001;&#27494;&#27721;&#22823;&#23398;&#35745;&#31639;&#26426;&#35270;&#35273;&#19982;&#36965;&#24863;&#23454;&#39564;&#23460;&#65288;WHU-CVRS Lab&#65289;&#23002;&#21073;&#25945;&#25480;&#36127;&#36131;&#30740;&#21046;&#30340;&#12298;&#26725;&#26753;&#26234;&#33021;&#26816;&#27979;&#26426;&#22120;&#20154;&#31995;&#32479;&#12299;&#65292;&#21327;&#21516;&#21512;&#20316;&#21333;&#20301; - &#28246;&#21335;&#26725;&#24247;&#26234;&#33021;&#31185;&#25216;&#26377;&#38480;&#20844;&#21496;&#22242;&#38431;&#21442;&#21152;&#31532;&#20108;&#23626;&#26477;&#24030;&#26426;&#22120;&#20154;&#35199;&#28246;&#35770;&#22363;&#65292;&#21442;&#19982;&#20102;&#22823;&#20250;&#32452;&#32455;&#30340;&#39033;&#30446;&#36335;&#28436;&#65292;&#20174;&#26368;&#21021;&#30340; 100 &#22810;&#20010;&#39033;&#30446;&#20013;&#31579;&#36873;&#20986; 10 &#20010;&#36827;&#20837;&#36335;&#28436;&#20915;&#36187;&#65292;&#26368;&#21518;&#21462;&#24471;&#20102;&#31532;&#19977;&#21517;&#30340;&#22909;&#25104;&#32489;&#12290;</p>
</blockquote>
<p>BirX &#26725;&#26753;&#26816;&#27979;&#26426;&#22120;&#20154;&#39033;&#30446;&#26159;&#30740;&#31350;&#29983;&#20197;&#26469;&#33258;&#24049;&#21442;&#19982;&#30340;&#31532;&#19968;&#20010;&#39033;&#30446;<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>&#12290;&#36825;&#20010;&#12304;&#39033;&#30446;&#24635;&#32467;&#12305;&#21482;&#38024;&#23545;&#33258;&#24049;&#21442;&#19982;&#30340;&#37096;&#20998;&#65292;&#20027;&#35201;&#26159;&#23545;&#21508;&#20010;&#20256;&#24863;&#22120;&#27169;&#22359;&#12289;&#26085;&#24535;&#27169;&#22359;&#12289;&#36890;&#20449;&#27169;&#22359;&#21644;&#31995;&#32479;&#26550;&#26500;&#36827;&#34892;&#26694;&#26550;&#21644;&#20195;&#30721;&#19978;&#30340;&#24635;&#32467;&#20998;&#26512;&#12290;&#65288;&#20195;&#30721;&#19981;&#26041;&#20415;&#20844;&#24320;&#65292;&#25152;&#20197;&#36825;&#37324;&#30340;&#36148;&#30340;&#26159;&#31934;&#31616;&#21644;&#35843;&#25972;&#36807;&#30340;&#31034;&#20363;&#20195;&#30721;&#29255;&#27573;&#12290;&#65289;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/system-architecture.png" alt="&#25105;&#20027;&#35201;&#36127;&#36131;&#25972;&#20307;&#26694;&#26550;&#12289;&#21508;&#20256;&#24863;&#22120;&#27169;&#22359;&#12289;&#26085;&#24535;&#21644;&#36890;&#20449;&#27169;&#22359;&#65292;&#31639;&#27861;&#27169;&#22359;&#30001;&#21508;&#24072;&#20804;&#36127;&#36131;&#12290;" />
<p class="caption">&#25105;&#20027;&#35201;&#36127;&#36131;&#25972;&#20307;&#26694;&#26550;&#12289;&#21508;&#20256;&#24863;&#22120;&#27169;&#22359;&#12289;&#26085;&#24535;&#21644;&#36890;&#20449;&#27169;&#22359;&#65292;&#31639;&#27861;&#27169;&#22359;&#30001;&#21508;&#24072;&#20804;&#36127;&#36131;&#12290;</p>
</div>
<p>&#22240;&#20026;&#31687;&#24133;&#36739;&#22823;&#65292;&#25152;&#20197;&#35745;&#21010;&#20998;&#25104;&#22914;&#19979;&#20845;&#20010;&#20027;&#39064;&#20998;&#21035;&#35762;&#36848;&#65306;</p>
<ul>
<li><ol style="list-style-type: decimal">
<li>&#30828;&#20214;&#31995;&#32479;&#65306;&#31616;&#20171;&#25105;&#20204;&#30340;&#26725;&#26753;&#35010;&#32541;&#26816;&#27979;&#36710;&#20197;&#21450;&#19978;&#38754;&#30340;&#20256;&#24863;&#22120;&#12290;</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>&#31995;&#32479;&#26550;&#26500;&#65306;&#31616;&#20171;&#39640;&#24615;&#33021;&#35745;&#31639;&#26426;&#21644;&#24037;&#25511;&#26426;&#30340;&#21508;&#33258;&#32844;&#36131;&#21644;&#21508;&#20256;&#24863;&#22120;&#65307;</li>
</ol></li>
<li><ol start="3" style="list-style-type: decimal">
<li>Logger&#65288;&#26085;&#24535;&#65289;&#27169;&#22359;&#21644; Utils &#27169;&#22359;&#65306;&#36825;&#26159;&#25972;&#20010;&#36719;&#20214;&#31995;&#32479;&#36890;&#29992;&#30340;&#37096;&#20998;&#65307;</li>
</ol></li>
<li><ol start="4" style="list-style-type: decimal">
<li>&#20256;&#24863;&#22120;&#27169;&#22359;&#36873;&#35762;&#65288;LMS &#21644; IMU &#21644; UR&#65289;&#65306;&#31616;&#20171;&#22914;&#20309;&#20889;&#19968;&#20010;&#20256;&#24863;&#22120;&#20195;&#30721;&#65292;&#20026;&#31639;&#27861;&#27169;&#22359;&#25552;&#20379;&#25509;&#21475;&#65307;</li>
</ol></li>
<li><ol start="5" style="list-style-type: decimal">
<li>&#36890;&#20449;&#27169;&#22359;&#65306;Wrappers &#21644; Moderator&#65306;&#31616;&#20171;&#36328;&#30005;&#33041; IPC&#65292;&#36827;&#34892;&#20989;&#25968;&#35843;&#29992;&#65307;</li>
</ol></li>
<li><ol start="6" style="list-style-type: decimal">
<li>&#24635;&#32467;&#65306;&#25910;&#33719;&#19982;&#19981;&#36275;</li>
</ol></li>
</ul>
<h1 id="&#30828;&#20214;&#31995;&#32479;">1. &#30828;&#20214;&#31995;&#32479;</h1>
<blockquote>
<p>&#31616;&#20171;&#25105;&#20204;&#30340;&#26725;&#26753;&#35010;&#32541;&#26816;&#27979;&#36710;&#20197;&#21450;&#19978;&#38754;&#30340;&#20256;&#24863;&#22120;&#12290;</p>
</blockquote>
<p>&#39318;&#20808;&#65292;BriX &#26725;&#26753;&#26816;&#27979;&#26426;&#22120;&#20154;&#39033;&#30446;&#30340;&#20027;&#35201;&#30446;&#26631;&#26159;&#23454;&#29616;&#23545;&#26725;&#26753;&#35010;&#32541;&#30340;&#33258;&#21160;&#35782;&#21035;&#21644;&#25552;&#21462;&#12290;</p>
<p>&#29616;&#38454;&#27573;&#65292;&#26725;&#26753;&#35010;&#32541;&#30340;&#35782;&#21035;&#65292;&#20027;&#35201;&#38752;&#20154;&#24037;&#65288;&#23601;&#26159;&#20154;&#36305;&#21040;&#26725;&#24213;&#29992;&#30524;&#30555;&#30475;&#65292;&#29992;&#23610;&#23376;&#37327;&#65289;&#65292;&#20027;&#35201;&#38382;&#39064;&#26159;&#65306; 1&#65289;&#25928;&#29575;&#20302;&#65307;2&#65289;&#19981;&#31283;&#23450;&#65288;&#20154;&#30340;&#20027;&#35266;&#24615;&#23545;&#26816;&#27979;&#32467;&#26524;&#26377;&#24178;&#25200;&#65289;&#12290;&#22270; 1 &#26159;&#19968;&#20123;&#25913;&#36827;&#26041;&#26696;&#65292;&#20294;&#20182;&#20204;&#37117;&#25110;&#22810;&#25110;&#23569;&#23384;&#22312;&#36866;&#29992;&#24615;&#24046;&#12289;&#25928;&#29575;&#20302;&#12289;&#35774;&#35745;&#24471;&#36807;&#20110;&#22797;&#26434;&#31561;&#38382;&#39064;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/wpp_2016-07-26_10-53-03.png" alt="&#22270; 1" />
<p class="caption">&#22270; 1</p>
</div>
<p>&#24038;&#19979;&#35282;&#30340;&#26041;&#26696;&#26469;&#33258;&#38889;&#22269;&#27721;&#38451;&#22823;&#23398;&#65292;&#37319;&#29992;&#30340;&#26159;&#26725;&#26753;&#26816;&#27979;&#36710;&#12290;&#26089;&#26399;&#30340;&#26725;&#26753;&#26816;&#27979;&#36710;&#35774;&#35745;&#31895;&#31961;&#65288;&#24448;&#24448;&#21482;&#26159;&#22312;&#26222;&#36890;&#36135;&#36710;&#19978;&#21152;&#19968;&#20010;&#25903;&#26550;&#65289;&#65292;&#36824;&#26159;&#20381;&#36182;&#20154;&#24037;&#65292;&#22914;&#22270; 2&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/wps_2016-07-26_10-43-13.png" alt="&#22270; 2. &#31532;&#19968;&#20195;&#26725;&#26753;&#26816;&#27979;&#36710;" />
<p class="caption">&#22270; 2. &#31532;&#19968;&#20195;&#26725;&#26753;&#26816;&#27979;&#36710;</p>
</div>
<p>&#36825;&#31361;&#28982;&#35753;&#25105;&#24819;&#21040;&#20102;&#20892;&#19994;&#33258;&#21160;&#21270;&#27700;&#24179;&#39640;&#21040;&#20196;&#20154;&#21497;&#20026;&#35266;&#27490;&#30340;&#24503;&#22269;&#65292;&#30340;&#8230;&#8230;&#33426;&#26524;&#25910;&#21106;&#26426;&#65306;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_13-35-57.gif" alt="Lemon Harvesting Machine" />
<p class="caption">Lemon Harvesting Machine</p>
</div>
<p>&#21704;&#21704;&#21704;&#21704;&#12290;&#36825;&#8220;&#21514;&#31726;&#24335;&#8221;&#30495;&#26159;&#22826;&#36887;&#21862;&#12290;&#19981;&#36807;&#26725;&#26753;&#26816;&#27979;&#36710;&#26159;&#30456;&#23545;&#31616;&#21333;&#12289;&#32463;&#27982;&#12289;&#21487;&#34892;&#30340;&#35299;&#20915;&#26041;&#26696;&#65292;&#25105;&#20204;&#30340;&#31995;&#32479;&#36208;&#30340;&#20063;&#26159;&#36825;&#26465;&#36335;&#12290;&#36825;&#26159;&#24037;&#20316;&#31034;&#24847;&#22270;&#65306;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-23-56.png" />

</div>
<p>&#39318;&#20808;&#65292;&#26816;&#27979;&#36710;&#36208;&#21040;&#26725;&#38754;&#19978;&#65292;&#28982;&#21518;&#20280;&#20986;&#26426;&#26800;&#33218;&#65292;&#25226;&#20256;&#24863;&#22120;&#25918;&#21040;&#26725;&#24213;&#21512;&#36866;&#30340;&#20301;&#32622;&#65292;&#28982;&#21518;&#29992;&#21069;&#36827;&#21518;&#36864;&#65292;&#23545;&#26725;&#24213;&#36827;&#34892;&#26816;&#27979;&#20998;&#26512;&#12290;&#19979;&#38754;&#20004;&#24352;&#22270;&#26159;&#25105;&#20204;&#23454;&#38469;&#25928;&#26524;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/wpp_2016-07-26_10-57-54.png" alt="&#22270; 3. &#23637;&#33218;&#65306;&#25226;&#20256;&#24863;&#22120;&#25918;&#21040;&#21512;&#36866;&#30340;&#20301;&#32622;" />
<p class="caption">&#22270; 3. &#23637;&#33218;&#65306;&#25226;&#20256;&#24863;&#22120;&#25918;&#21040;&#21512;&#36866;&#30340;&#20301;&#32622;</p>
</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/wpp_2016-07-26_10-58-57.png" alt="&#22270; 4. &#34892;&#36208;&#65306;&#29992;&#20256;&#24863;&#22120;&#37319;&#38598;&#26725;&#24213;&#24433;&#20687;&#25968;&#25454;" />
<p class="caption">&#22270; 4. &#34892;&#36208;&#65306;&#29992;&#20256;&#24863;&#22120;&#37319;&#38598;&#26725;&#24213;&#24433;&#20687;&#25968;&#25454;</p>
</div>
<p>&#19979;&#38754;&#26159;&#39550;&#39542;&#23460;&#30340;&#25511;&#21046;&#21488;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-21-57.png" alt="&#22270; 5." />
<p class="caption">&#22270; 5.</p>
</div>
<p>&#21487;&#20197;&#30475;&#21040;&#25511;&#21046;&#21488;&#19978;&#26377;&#20004;&#21488;&#30005;&#33041;&#65292;&#19968;&#21488;&#39640;&#24615;&#33021;&#35745;&#31639;&#26426;&#12289;&#19968;&#21488;&#24037;&#25511;&#26426;&#65292;&#21487;&#20197;&#23545;&#36710;&#36742;&#21644;&#20256;&#24863;&#22120;&#36827;&#34892;&#30417;&#25511;&#21644;&#35843;&#24230;&#12290;</p>
<p>&#39640;&#24615;&#33021;&#35745;&#31639;&#26426;&#20027;&#35201;&#29305;&#24449;&#26159;&#24615;&#33021;&#24378;&#21170;&#65292;&#23427;&#26377; 2 &#20010; CPU&#65306;&#33521;&#29305;&#23572;&#33267;&#24378;&#22788;&#29702;&#22120; E5-2680 v2 (10&#26680; 2.8GHz Turbo, 25 MB)&#65292;&#20869;&#23384;&#39640;&#36798; 128GB&#65288;8x16GB&#65289;&#65292;&#20027;&#35201;&#29992;&#26469;&#23545;&#37319;&#38598;&#30340;&#20256;&#24863;&#22120;&#25968;&#25454;&#65288;&#23588;&#20854;&#26159;&#30456;&#26426;&#24433;&#20687;&#25968;&#25454;&#65289;&#36827;&#34892;&#22312;&#32447;&#22788;&#29702;&#12290;&#24037;&#25511;&#26426;&#30340;&#20027;&#35201;&#29305;&#24449;&#26159;&#25554;&#23380;&#22810;&#65292;&#33021;&#22815;&#36830;&#25509;&#22810;&#31181;&#20256;&#24863;&#22120;&#12290;</p>
<p>&#26816;&#27979;&#36710;&#30340;&#26426;&#26800;&#33218;&#26411;&#31471;&#65292;&#20197;&#21450;&#36710;&#20307;&#21608;&#22260;&#65292;&#21547;&#22810;&#31181;&#20256;&#24863;&#22120;&#65288;&#22914;&#22270; 6&#12289;7&#65289;&#65306;</p>
<ul>
<li>3D &#30456;&#26426;&#65306;<a href="http://at.fsinet.com/C2-2040-GigE.htm">C2</a>&#65292;&#22312;&#28608;&#20809;&#22120;&#30340;&#21327;&#21161;&#19979;&#24471;&#21040;&#26725;&#38754;&#28857;&#20113;&#65307;</li>
<li>&#38754;&#38453;&#30456;&#26426;&#65306;<a href="http://www.jai.com/en/products/sp-20000-pmcl">SP-20000C</a>&#65288;&#23454;&#38469;&#19978;&#26159;&#12304;&#24425;&#33394;&#36880;&#34892;&#25195;&#25551;&#30456;&#26426;&#12305;&#65289;&#65307;</li>
<li>&#23567;&#26426;&#26800;&#33218;&#65288;&#30456;&#23545;&#22823;&#26426;&#26800;&#33218;&#32780;&#35328;&#65289;&#65306;<a href="http://www.universal-robots.com/products/ur10-robot/">UR10</a>&#65292;&#29992;&#26469;&#24494;&#35843;&#26411;&#31471;&#20301;&#32622;&#65292;&#23558;&#20256;&#24863;&#22120;&#25918;&#32622;&#21040;&#21512;&#36866;&#30340;&#20301;&#32622;&#21644;&#23039;&#24577;&#65307;</li>
<li>&#20809;&#28304;&#65306;LED &#38754;&#38453;&#20809;&#28304;&#65307;</li>
<li>&#36229;&#22768;&#27874;&#65306;&#29992;&#26469;&#26816;&#27979;&#21508;&#26426;&#26800;&#33218;&#21644;&#26725;&#20307;&#30340;&#36317;&#31163;&#65288;&#38450;&#27490;&#30896;&#25758;&#65289;&#65307;</li>
<li>&#28608;&#20809;&#22120;&#65306;&#21327;&#21161; C2 &#30456;&#26426;&#65307;</li>
<li>&#24815;&#23548;&#65306;&#23545; LMS &#30340;&#20256;&#24863;&#22120;&#24179;&#21488;&#36827;&#34892;&#20301;&#23039;&#30417;&#25511;&#65307;</li>
<li>&#32534;&#30721;&#22120;&#65306;&#27979;&#37327;&#36710;&#36742;&#34892;&#36208;&#36317;&#31163;&#65288;&#26816;&#27979;&#36710;&#24037;&#20316;&#26102;&#65292;&#36890;&#36807;&#34892;&#36208;&#35770;&#21069;&#36827;&#21518;&#36864;&#65292;&#36890;&#36807;&#32534;&#30721;&#22120;&#33719;&#21462;&#34892;&#36208;&#30340;&#36317;&#31163;&#21644;&#26041;&#21521;&#65289;&#65307;</li>
</ul>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-17-24.png" alt="&#22270; 6" />
<p class="caption">&#22270; 6</p>
</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-17-31.png" alt="&#22270; 7" />
<p class="caption">&#22270; 7</p>
</div>
<p>&#39033;&#30446;&#21021;&#26399;&#65292;&#25105;&#20204;&#22312;&#38271;&#27801;&#34013;&#33394;&#24037;&#19994;&#22253;&#30340;&#21378;&#25151;&#20869;&#25645;&#24314;&#20102;&#19968;&#20010;&#27169;&#25311;&#30340;&#26725;&#24213;&#65292;&#29992;&#20110;&#27979;&#35797;&#12290;&#22914;&#22270; 8&#12289;9&#12289;10&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-18-18.png" alt="&#22270; 8. &#24037;&#22330;&#20869;&#26223;" />
<p class="caption">&#22270; 8. &#24037;&#22330;&#20869;&#26223;</p>
</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-20-41.png" alt="&#22270; 9. &#27979;&#35797;&#29992;&#30340;&#20551;&#26725;" />
<p class="caption">&#22270; 9. &#27979;&#35797;&#29992;&#30340;&#20551;&#26725;</p>
</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-20-51.png" alt="&#22270; 10. &#35013;&#22791;&#20102;&#20256;&#24863;&#22120;&#30340;&#27979;&#35797;&#24179;&#21488;" />
<p class="caption">&#22270; 10. &#35013;&#22791;&#20102;&#20256;&#24863;&#22120;&#30340;&#27979;&#35797;&#24179;&#21488;</p>
</div>
<h1 id="&#31995;&#32479;&#26550;&#26500;">2. &#31995;&#32479;&#26550;&#26500;</h1>
<blockquote>
<p>&#31616;&#20171;&#39640;&#24615;&#33021;&#35745;&#31639;&#26426;&#21644;&#24037;&#25511;&#26426;&#30340;&#21508;&#33258;&#32844;&#36131;&#21644;&#21508;&#20256;&#24863;&#22120;&#65307;</p>
</blockquote>
<p>&#39318;&#20808;&#65292;&#31995;&#32479;&#30340;&#36719;&#20214;&#37096;&#20998;&#20027;&#35201;&#36816;&#34892;&#22312;&#39640;&#24615;&#33021;&#35745;&#31639;&#26426;&#21644;&#20844;&#25511;&#26426;&#19978;&#12290;&#25972;&#20010;&#31995;&#32479;&#21487;&#20998;&#20026;&#22235;&#37096;&#20998;&#65306;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/system-architecture.png" alt="&#37319;&#38598;&#27169;&#22359;+&#36890;&#20449;&#27169;&#22359;+&#31639;&#27861;&#27169;&#22359;+&#23637;&#31034;&#27169;&#22359;&#65288;&#36825;&#37324;&#27809;&#26377;&#30011;&#20986;&#65289;" />
<p class="caption">&#37319;&#38598;&#27169;&#22359;+&#36890;&#20449;&#27169;&#22359;+&#31639;&#27861;&#27169;&#22359;+&#23637;&#31034;&#27169;&#22359;&#65288;&#36825;&#37324;&#27809;&#26377;&#30011;&#20986;&#65289;</p>
</div>
<p>&#37319;&#38598;&#27169;&#22359;&#21253;&#25324;&#20010;&#20256;&#24863;&#22120;&#65306;LMS&#12289;IMU&#12289;UR &#31561;&#65292;&#20256;&#24863;&#22120;&#20998;&#24067;&#22312;&#20004;&#21488;&#30005;&#33041;&#19978;&#65288;&#25351;&#39640;&#24615;&#33021;&#35745;&#31639;&#26426;&#21644;&#24037;&#25511;&#26426;&#65289;&#65292;&#20855;&#20307;&#36830;&#25509;&#24773;&#20917;&#35201;&#30475;&#24403;&#26102;&#30340;&#25509;&#32447;&#12290;&#36890;&#20449;&#27169;&#22359;&#25351;&#30340;&#26159;&#20004;&#21488;&#30005;&#33041;&#30452;&#25509;&#30340;&#20256;&#24863;&#22120;&#25968;&#25454;&#30340;&#20849;&#20139;&#65292;&#20197;&#21450;&#20004;&#32773;&#38388;&#30340; IPC&#65292;&#20989;&#25968;&#35843;&#29992;&#12290;&#31639;&#27861;&#27169;&#22359;&#20027;&#35201;&#26159;&#23545;&#20256;&#24863;&#22120;&#23450;&#20301;&#23450;&#23039;&#65292;&#23545;&#37319;&#38598;&#30340;&#24433;&#20687;&#25968;&#25454;&#25340;&#25509;&#21512;&#24182;&#65292;&#22810;&#31181;&#20256;&#24863;&#22120;&#25968;&#25454;&#30340;&#37197;&#20934;&#34701;&#21512;&#12290;</p>
<h2 id="&#37319;&#38598;&#27169;&#22359;">&#37319;&#38598;&#27169;&#22359;</h2>
<p>&#19979;&#38754;&#21482;&#20171;&#32461;&#39033;&#30446;&#20013;&#25105;&#25509;&#35302;&#21040;&#30340;&#20256;&#24863;&#22120;&#12290;&#22240;&#20026; C2 &#21644; SP20000C &#26377;&#23448;&#26041;&#25552;&#20379;&#30340; SDK&#65292;&#19981;&#38656;&#35201;&#25776;&#20889;&#25968;&#25454;&#33719;&#21462;&#31243;&#24207;&#65292;&#36825;&#37324;&#30053;&#36807;&#12290;</p>
<dl>
<dt>LMS</dt>
<dd><div class="figure">
<img src="http://gnat-tang-archive.qiniudn.com/lms.gif" align="right" />

</div>
<p>&#22312;&#25105; 2015 &#24180; 9 &#26376;&#30340;&#19968;&#31687; post&#65288;<a href="http://tangzx.qiniudn.com/post-0056-lms-chunk.html">LMS &#25968;&#25454;&#37327;</a>&#65289;&#65292;&#25105;&#20063;&#25552;&#36807; LMS&#12290;</p>
<p>LMS &#26159; SICK&#65288;&#24503;&#22269;&#35199;&#20811;&#65289; &#20844;&#21496;&#29983;&#20135;&#30340; Laser Measurement Sensor&#65288;&#28608;&#20809;&#27979;&#36317;&#20202;&#65289;&#12290;&#36890;&#36807;&#19968;&#26681;&#32593;&#32447;&#21487;&#20197;&#35835;&#21462; LMS &#37319;&#38598;&#30340;&#25968;&#25454;&#12290;&#22312;&#25105;&#20204;&#30340;&#35774;&#32622;&#19979;&#65292;&#23427;&#30340;&#25968;&#25454;&#37327;&#32422;&#20026; 0.3 Mb/s&#12290;</p>
</dd>
<dt>MUC, IMU</dt>
<dd><p>TODO</p>
</dd>
<dt>ARM</dt>
<dd><p>&#22823;&#26426;&#26800;&#33218;&#65292;TODO</p>
</dd>
<dt>UR 10</dt>
<dd><p>TODO</p>
</dd>
</dl>
<h2 id="&#36890;&#20449;&#27169;&#22359;">&#36890;&#20449;&#27169;&#22359;</h2>
<p>&#20256;&#24863;&#22120;&#21644;&#35745;&#31639;&#26426;&#20043;&#38388;&#36890;&#20449;&#20027;&#35201;&#26377; 1&#65289;TCP&#65288;LMS &#21644; UR10 &#31561;&#65289;&#65292;2&#65289;&#20018;&#21475;&#65288;UR 10&#12289;MCU&#12289;ARM &#31561;&#65289;&#65292;&#20004;&#21488;&#30005;&#33041;&#20043;&#38388;&#36890;&#20449;&#20063;&#26159;&#37319;&#29992;&#32593;&#32447;&#36830;&#25509;&#29992;&#30340;&#26159; TCP&#12290;</p>
<h2 id="&#31639;&#27861;&#27169;&#22359;">&#31639;&#27861;&#27169;&#22359;</h2>
<p>&#36825;&#37096;&#20998;&#25105;&#24182;&#19981;&#36127;&#36131;&#65292;&#21482;&#31616;&#21333;&#35828;&#26126;&#38656;&#35201;&#22788;&#29702;&#30340;&#37096;&#20998;&#38590;&#39064;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-33-57.png" alt="&#24433;&#20687;&#37197;&#20934;&#21644;&#25340;&#25509;" />
<p class="caption">&#24433;&#20687;&#37197;&#20934;&#21644;&#25340;&#25509;</p>
</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-33-46.png" alt="&#24433;&#20687;&#37197;&#20934;&#21644;&#25340;&#25509;" />
<p class="caption">&#24433;&#20687;&#37197;&#20934;&#21644;&#25340;&#25509;</p>
</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/wpp_2016-07-26_10-55-18.png" alt="&#24433;&#20687;&#21248;&#20809;&#21248;&#33394;" />
<p class="caption">&#24433;&#20687;&#21248;&#20809;&#21248;&#33394;</p>
</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/wps_2016-07-26_10-50-44.png" alt="&#28857;&#20113;&#37197;&#20934;&#25340;&#25509;" />
<p class="caption">&#28857;&#20113;&#37197;&#20934;&#25340;&#25509;</p>
</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/wps_2016-07-26_10-48-51.png" alt="&#28857;&#20113;&#38754;&#25552;&#21462;" />
<p class="caption">&#28857;&#20113;&#38754;&#25552;&#21462;</p>
</div>
<h2 id="&#23637;&#31034;&#27169;&#22359;">&#23637;&#31034;&#27169;&#22359;</h2>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-32-24.png" />

</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-32-31.png" />

</div>
<p>&#19977;&#32500;&#23637;&#31034;&#27169;&#22359;&#20027;&#35201;&#29992;&#30340;&#26159; OpenSceneGraph&#65292;&#25105;&#20063;&#21442;&#19982;&#20102;&#19968;&#28857;&#65288;&#20294;&#26159;&#24182;&#19981;&#23436;&#21892;&#65292;&#25152;&#20197;&#27809;&#26377;&#32435;&#20837;&#24635;&#32467;&#20013;&#65289;&#65292;&#35265; <a href="http://dvorak4tzx.lofter.com/post/1d4021c8_ac12379">&#22270;&#29255;-dvorak4tzx</a>&#12290;</p>
<h1 id="logger-&#27169;&#22359;&#21644;-utils-&#27169;&#22359;">3. Logger &#27169;&#22359;&#21644; Utils &#27169;&#22359;</h1>
<blockquote>
<p>&#36825;&#26159;&#25972;&#20010;&#36719;&#20214;&#31995;&#32479;&#36890;&#29992;&#30340;&#37096;&#20998;&#65307;</p>
</blockquote>
<h2 id="&#26085;&#24535;&#27169;&#22359;">&#26085;&#24535;&#27169;&#22359;</h2>
<p>&#26085;&#24535;&#65288;logger&#65289;&#27169;&#22359;&#26159;&#39033;&#30446;&#36827;&#34892;&#21040;&#19968;&#27573;&#26102;&#38388;&#21518;&#25165;&#24320;&#21457;&#30340;&#65292;&#20294;&#25105;&#36824;&#26159;&#35201;&#25918;&#21040;&#20854;&#20182;&#27169;&#22359;&#20043;&#21069;&#35762;&#12290;</p>
<p>&#31243;&#24207;&#22312;&#22810;&#32447;&#31243;&#12289;&#26377;&#32593;&#32476;&#36890;&#20449;&#26080;&#27861;&#29992;&#24120;&#35268;&#35774;&#32622;&#26029;&#28857;&#31561;&#26041;&#24335; debug &#30340;&#24773;&#20917;&#19979;&#65292;&#23454;&#29616;&#22810;&#20154;&#21442;&#19982;&#22810;&#27169;&#22359;&#30340;&#31995;&#32479;&#20195;&#30721;&#35843;&#35797;&#65292;&#21482;&#33021;&#36890;&#36807;&#26085;&#24535;&#27169;&#22359;&#12290;&#21482;&#26377;&#36825;&#31181;&#20302;&#32423;&#30340;&#25171;&#21360;&#26041;&#24335;&#25165;&#33021;&#21457;&#29616;&#31243;&#24207;&#36816;&#34892;&#20013;&#20986;&#29616;&#30340;&#38382;&#39064;&#12290;&#25105;&#20204;&#26159;&#36843;&#20110;&#26080;&#22856;&#65292;&#25165;&#35201;&#24324;&#36825;&#20040;&#19968;&#20010;&#26085;&#24535;&#27169;&#22359;&#65292;&#20889;&#24471;&#36807;&#31243;&#20013;&#30896;&#21040;&#35768;&#22810;&#40635;&#28902;&#65292;&#20294;&#32456;&#20110;&#26159;&#25630;&#23450;&#20102;~ &#65288;&#20294;&#29616;&#22312;&#25105;&#19981;&#20027;&#24352;&#33258;&#24049;&#20889; Logger &#27169;&#22359;&#12290;&#26377;&#27425;&#25105;&#30452;&#25509;&#20174; CloudCompare &#30340;&#28304;&#30721;&#37324;&#25187;&#23427;&#30340;&#26085;&#24535;&#27169;&#22359;&#65292;&#22823;&#27010;&#29992;&#20102;&#21322;&#23567;&#26102;&#23601;&#25630;&#23450;&#20102;==&#65292;&#23427;&#36824;&#26377;&#19968;&#20010;&#30028;&#38754;&#65292;&#36755;&#20986;&#25928;&#26524;&#20063;&#27604;&#36739;&#28385;&#24847;&#12290;&#65289;</p>
<p>&#23427;&#30340;&#20351;&#29992;&#26041;&#27861;&#26159;&#65306;</p>
<ul>
<li><code class="sourceCode cpp">Logger::log( ) &lt;&lt; <span class="dv">3</span> &lt;&lt; <span class="st">&quot;is three.&quot;</span>;</code>&#65292;&#30452;&#25509;&#36755;&#20986;&#26085;&#24535;&#65307;</li>
<li><code class="sourceCode cpp">Logger::log( <span class="dv">4</span> ) &lt;&lt; <span class="st">&quot;emphasized log.&quot;</span>; <span class="co">// 1..5</span></code>&#65292;&#35774;&#23450;&#26085;&#24535;&#31561;&#32423;&#65307;</li>
<li><code class="sourceCode cpp">Logger::log( BCD::LMS::CONNECT, <span class="ot">QString</span>(<span class="st">&quot;&lt;QString&gt; remarks&quot;</span>) );</code>&#65292;&#26576;&#19968;&#20010;&#27169;&#22359;&#26576;&#19968;&#20010;&#20989;&#25968;&#36755;&#20986;&#30340;&#26085;&#24535;&#65292;&#20256;&#20837; QString &#31867;&#22411;&#65307;</li>
<li><code class="sourceCode cpp">Logger::log( BCD::LMS::CONNECT, std::string(<span class="st">&quot;&lt;c++ string&gt; remarks&quot;</span>) );</code>&#65292;&#20256;&#20837; std::string &#31867;&#22411;&#65307;</li>
<li><code class="sourceCode cpp">Logger::log( BCD::LMS::CONNECT, <span class="st">&quot;&lt;c style string&gt; remarks&quot;</span> );</code>&#65292;&#20256;&#20837; char * &#31867;&#22411;&#12290;</li>
</ul>
<p>&#19978;&#38754;&#30340; BCD &#26159;&#25105;&#20204;&#39033;&#30446;&#30340; namespace&#65288;BCD &#30340;&#24847;&#24605;&#26159; Bridge Crack Detection&#65292;&#26725;&#26753;&#35010;&#32541;&#26816;&#27979;&#65289;&#12290; <code>BCD::LMS::CONNECT</code> &#21017;&#25351;&#30340;&#26159; LMS &#37319;&#38598;&#27169;&#22359;&#30340; <code>connect</code> &#20989;&#25968;&#65292;&#25105;&#20204;&#22312;&#26085;&#24535;&#27169;&#22359;&#25552;&#21069;&#27880;&#20876;&#20102;&#21508;&#20010;&#27169;&#22359;&#30340;&#20989;&#25968;&#65292;&#25152;&#20197;&#21487;&#20197;&#30452;&#25509;&#36825;&#20040;&#29992;&#12290;&#20854;&#23454;&#21487;&#20197;&#30452;&#25509;&#20351;&#29992; C &#35821;&#35328;&#25552;&#20379;&#30340; <code>__FILE__</code> &#21644; <code>__FUNCTION__</code> &#26469;&#36827;&#34892;&#26085;&#24535;&#65292;&#25105;&#20204;&#25226;&#36825;&#20123;&#19996;&#35199;&#37117;&#25552;&#21069;&#23450;&#20041;&#22909;&#65292;&#26159;&#20026;&#20102;&#22312;&#20351;&#29992;&#30340;&#26102;&#20505;&#26041;&#20415;&#28857;&#65288;&#27605;&#31455; VS &#25552;&#20379;&#30340;&#20195;&#30721;&#34917;&#20840;&#21487;&#20197;&#35753;&#25105;&#20204;&#22312;&#20889; <code>BCD::LMS::</code> &#30340;&#26102;&#20505;&#23601;&#24377;&#20986;&#25152;&#26377;&#30340;&#20505;&#36873;&#39033;&#30446;&#65289;&#12290;</p>
<p>&#26085;&#24535;&#27169;&#22359;&#26159;&#19968;&#20010;&#31867;&#65292;&#20351;&#29992;&#20102;&#35774;&#35745;&#27169;&#24335;&#20013;&#30340;<strong>&#21333;&#20363;&#27169;&#24335;</strong>&#12290;&#20026;&#20102;&#26174;&#31034;&#26041;&#20415;&#65292;&#25105;&#20204;&#30340;&#26085;&#24535;&#27169;&#22359;&#36755;&#20986;&#30340;&#26159; markdown &#26684;&#24335;&#30340;&#34920;&#26684;&#12290;&#19978;&#38754;&#25552;&#21040;&#30340; <a href="http://tangzx.qiniudn.com/post-0056-lms-chunk.html">LMS &#25968;&#25454;&#37327;</a> &#36825;&#31687;&#25991;&#31456;&#37324;&#30340;&#34920;&#26684;&#65292;&#20854;&#23454;&#23601;&#26159;&#25105;&#30452;&#25509;&#20174;&#26085;&#24535;&#25335;&#36125;&#36807;&#21435;&#65288;&#19968;&#34892;&#37117;&#27809;&#26377;&#20462;&#25913;&#65289;&#30340;&#26174;&#31034;&#25928;&#26524;&#12290;&#19979;&#38754;&#25226;&#25105;&#30340;&#23454;&#29616;&#36148;&#19968;&#19979;&#12290;</p>
<p>&#39318;&#20808;&#65292;<strong>&#26085;&#24535;&#26159;&#20998;&#32423;&#30340;&#65292;&#25105;&#39044;&#35774;&#37324; 5 &#20010;&#31561;&#32423;&#65292;&#20174; 1 &#21040; 5 &#32039;&#35201;&#31243;&#24230;&#20197;&#27492;&#38477;&#20302;</strong>&#12290;&#40664;&#35748;&#26085;&#24535;&#31561;&#32423;&#26159; 3&#65288;<code>BCD::ActionInfo::LEVEL3</code>&#65289;&#65292;&#26085;&#24535;&#27169;&#22359;&#22312;&#30028;&#38754;&#19978;&#21644;&#25511;&#21046;&#21488;&#26174;&#31034;&#30340;&#26102;&#20505;&#21487;&#20197;&#40664;&#35748;&#36807;&#28388;&#25481;&#19968;&#20123;&#31561;&#32423;&#19981;&#22815;&#30340; log&#65288;&#34429;&#28982;&#25105;&#36825;&#37324;&#24182;&#27809;&#26377;&#36807;&#28388;&#65289;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#define LOG_FILTER_CONSOLE (  BCD::ActionInfo::LEVEL3  )</span>
<span class="ot">#define LOG_FILTER_GUIVIEW (  BCD::ActionInfo::LEVEL5  )</span>
<span class="ot">#define LOG_FILTER_ARCHIVE (  BCD::ActionInfo::LEVEL5  )</span></code></pre></div>
<p>&#29992; <code>#define</code> &#23450;&#20041;&#24120;&#37327;&#22826; naive &#20102;&#65292;&#29992; const int &#23450;&#20041;&#24120;&#37327;&#22826;&#19981;&#24069;&#65292;&#25152;&#20197;&#25105;&#29992;&#20102;&#20256;&#35828;&#20013;&#30340; enum hack&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">enum</span> LOG_CONFIGS {
    WIDTH_INDEX            =  <span class="dv">10</span>,
    WIDTH_TYPE             =  <span class="dv">10</span>,
    WIDTH_LEVEL            =   <span class="dv">5</span>,
    WIDTH_REMARKS          =  <span class="dv">40</span>,
    LOG_LEVEL_MAX          =   <span class="dv">9</span>,
    LOG_LEVEL_MIN          =   <span class="dv">0</span>,
    LOG_LEVEL_STEP         =   <span class="dv">5</span>,
    LOG_LEVEL_DEFAULT      =   <span class="dv">4</span>,
    LOG_ENTRY_OFFSET       =   <span class="dv">8</span>, <span class="co">// at most 2^8 actions of each type</span>
};</code></pre></div>
<p>&#25152;&#26377;&#30340;&#20989;&#25968;&#37117;&#35201;&#27880;&#20876;&#65292;&#20840;&#37096;&#20889;&#27515;&#22312;&#20195;&#30721;&#37324;&#12290;&#65288;&#24403;&#26102;&#21644;&#32452;&#20869;&#25104;&#21592;&#27807;&#36890;&#20102;&#22909;&#20037;==&#25165;&#25226;&#25152;&#26377;&#20154;&#30340;&#20989;&#25968;&#21517;&#25970;&#23450;&#19979;&#26469;&#12290;==&#65289;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">namespace</span> BCD {
<span class="co">// types</span>
<span class="kw">enum</span> TypeID {
    TYPE_ARM,       <span class="co">// &#23545;&#24212; BCD::ARM::...</span>
    TYPE_IMU,       <span class="co">// &#23545;&#24212; BCD::IUM::...</span>
    TYPE_LMS,       <span class="co">// ...</span>
    TYPE_MCU,
    TYPE_UR,
    ...
};
...

<span class="co">// actions</span>
<span class="kw">typedef</span> <span class="dt">int</span> ActionID;
<span class="kw">typedef</span> <span class="kw">struct</span> {                  <span class="co">// &#31561;&#32423;&#21487;&#20197;&#29992;&#26469;&#36807;&#28388;</span>
    <span class="kw">enum</span> Level {
        LEVEL1,                   <span class="co">// fatal error</span>
        LEVEL2,                   <span class="co">// important</span>
        LEVEL3,                   <span class="co">// average</span>
        LEVEL4,                   <span class="co">// below average</span>
        LEVEL5                    <span class="co">// least significant</span>
    } level;
    <span class="ot">QString</span> info;
} ActionInfo;

<span class="co">// LMS</span>
<span class="kw">namespace</span> LMS {
<span class="kw">enum</span> Action {
    LMS                           = TYPE_LMS&lt;&lt;LOG_ENTRY_OFFSET,
    CONSTRUCT,

    CONFIG_ADDRESS_PORT,
    CONFIG_ACTIONS,

    TURN_ON_READING,
    TURN_OFF_READING,

    ...
};
}  <span class="co">// namespace LMS</span>
}  <span class="co">// namespace BCD</span></code></pre></div>
<p>&#19978;&#38754;&#30340; <code class="sourceCode cpp">LMS = TYPE_LMS&lt;&lt;LOG_ENTRY_OFFSET,</code> &#30340;&#24847;&#24605;&#26159;&#27599;&#20010;&#27169;&#22359;&#37324;&#26368;&#22810;&#21487;&#20197;&#27880;&#20876; LOG_ENTRY_OFFSET &#20010;&#20989;&#25968;&#12290;&#26377;&#28857;&#38590;&#20197;&#35299;&#37322;&#65292;&#25152;&#20197;&#25105;&#19981;&#35299;&#37322;&#20855;&#20307;&#26159;&#21861;&#24847;&#24605;&#21862;&#128516;&#65292;&#25026; enum &#21644;&#20301;&#25805;&#20316;&#30340;&#20154;&#37117;&#25026;&#25105;&#21861;&#24847;&#24605;==&#12290;</p>
<p>&#19979;&#38754;&#21040;&#20102;&#37325;&#28857;&#12290;<strong>&#27599;&#19968;&#26465;&#26085;&#24535;&#37117;&#26159; Log &#31867;&#30340;&#19968;&#20010;&#23454;&#20363;&#12290;</strong>&#37324;&#38754;&#21253;&#21547; log &#30340;&#31867;&#22411;&#65288;type&#65289;&#65292;id &#21495;&#65288;action&#65289;&#65292;&#22791;&#27880;&#20449;&#24687;&#65288;message&#65289;&#65292;&#26102;&#38388;&#25139;&#65288;timestamp&#65289;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">class</span> Log
{
<span class="kw">private</span>:
    <span class="dt">static</span> size_t               counter;

<span class="kw">public</span>:
    BCD::TypeID                 type;
    BCD::ActionID               action;
    <span class="ot">QString</span>                     message;
    <span class="dt">qint64</span>                      timestamp;

<span class="kw">public</span>:
    Log( ) {
        type            =       BCD::TYPE_META;
        action          =       (BCD::ActionID)<span class="dv">0</span>;
        message         =       <span class="ot">QString</span>();
        timestamp       =       <span class="dv">0</span>;
    }

    Log( BCD::TypeID tid, BCD::ActionID aid, <span class="ot">QString</span> msg=<span class="st">&quot;&quot;</span>, <span class="dt">qint64</span> ts=<span class="dv">0</span> )
      : type( tid )
      , action( aid )
      , message( msg )
      , timestamp( <span class="dv">0</span> == ts ? <span class="ot">QDateTime::</span>currentMSecsSinceEpoch() : ts ) { ++counter; }

    <span class="dt">const</span> Log &amp;show( ) <span class="dt">const</span>;
};</code></pre></div>
<p>&#29616;&#22312;&#30475;&#36215;&#26469;&#36825;&#20010; Log &#24456;&#26126;&#26174;&#19981;&#24212;&#35813;&#32500;&#25252;&#19968;&#20010; <code>static size_t counter</code>&#65292;&#20294;&#29616;&#22312;&#25105;&#20204;&#19981;&#35752;&#35770;&#20854;&#20013;&#30340;&#19981;&#36275;&#65288;&#36825;&#37096;&#20998;&#30041;&#21040;&#26368;&#21518;&#19968;&#31687;&#24635;&#32467;&#65289;&#12290;</p>
<p>&#20026;&#20102;&#35753; Log &#21487;&#20197;&#20351;&#29992; C++ &#30340;&#8220;&#27969;&#25805;&#20316;&#8221;&#65292;&#25105;&#37325;&#36733;&#20102;&#20004;&#20010;&#25805;&#20316;&#31526;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">QDataStream</span> &amp;<span class="kw">operator</span>&lt;&lt;( <span class="ot">QDataStream</span> &amp;out, <span class="dt">const</span> Log &amp;log )
{
    out &lt;&lt; (<span class="dt">int</span>)log.type
        &lt;&lt; (<span class="dt">int</span>)log.action
        &lt;&lt; log.message
        &lt;&lt; log.timestamp;
    <span class="kw">return</span> out;
}

<span class="ot">QDataStream</span> &amp;<span class="kw">operator</span>&gt;&gt;( <span class="ot">QDataStream</span>  &amp;in, Log &amp;log )
{
    <span class="dt">int</span> type, action;
    in  &gt;&gt; type
        &gt;&gt; action
        &gt;&gt; log.message
        &gt;&gt; log.timestamp;
    log.type = (BCD::TypeID)type;
    log.action = (BCD::ActionID)action;
    <span class="kw">return</span> in;
}</code></pre></div>
<p>Logger &#29992;&#26469;&#29983;&#25104;&#21644;&#31649;&#29702; Log &#25104;&#21592;&#12290;&#22312;&#26085;&#24535;&#30340;&#36807;&#31243;&#20013;&#65292;&#24517;&#39035;&#19978;&#38145;&#65292;&#25152;&#20197;&#29992;&#20102; Qt &#30340; <code>QMutex</code>&#65292;&#26085;&#24535;&#20840;&#37096;&#23384;&#22312;&#19968;&#20010;&#38745;&#24577;&#30340; <code>QList&lt;Log&gt;</code> &#37324;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">namespace</span> BCD { <span class="kw">typedef</span> <span class="ot">QString</span> TypeInfo; }
<span class="kw">class</span> Logger
{
<span class="kw">private</span>:
    <span class="dt">static</span> <span class="ot">QMutex</span>           mutex;
    <span class="dt">static</span> <span class="ot">QList</span>&lt;Log&gt;       logs;
    <span class="dt">const</span> <span class="dt">static</span> <span class="ot">QString</span>    logPath;

<span class="kw">private</span>:
    <span class="kw">typedef</span> <span class="ot">QHash</span>&lt;BCD::TypeID, BCD::TypeInfo&gt; Type;
    <span class="kw">typedef</span> <span class="ot">QHash</span>&lt;BCD::ActionID, BCD::ActionInfo&gt; Action;

    <span class="co">// &#36825;&#19977;&#20010;&#38745;&#24577;&#20989;&#25968;&#26159;&#19968;&#20010;&#35774;&#35745;&#19978;&#30340;&#22833;&#35823;</span>
    <span class="dt">static</span> <span class="dt">int</span> initActionInfoWidth( );
    <span class="dt">static</span> Type initTypes( );
    <span class="dt">static</span> Action initActions( );

    <span class="dt">static</span> <span class="ot">QList</span>&lt;Log&gt; refresh( );
    <span class="dt">static</span> <span class="dt">void</span> saveLogs( <span class="ot">QList</span>&lt;Log&gt; &amp;logs,
                          BCD::ActionInfo::Level level );

<span class="kw">public</span>:
    <span class="dt">const</span> <span class="dt">static</span> <span class="dt">int</span> widthActionInfo;
    <span class="dt">const</span> <span class="dt">static</span> Type types;
    <span class="dt">const</span> <span class="dt">static</span> Action actions;

<span class="kw">public</span>:
    Logger( ) { <span class="co">/* Empty Logger Constructor */</span> }
    ...
}; <span class="co">// class Logger</span></code></pre></div>
<p>QMutex &#20351;&#29992;&#30340;&#26102;&#20505;&#65292;&#21487;&#20197;&#29992; QMutexLocker &#26469;&#31616;&#20415;&#36825;&#20010;&#36807;&#31243;&#65288;&#36825;&#26679;&#20063;&#26356;&#19981;&#23481;&#26131;&#20986;&#38169;&#65289;&#12290;&#19968;&#33324;&#30340; mutex &#31867;&#24211;&#37117;&#25552;&#20379;&#36825;&#26679;&#19968;&#20010;&#21151;&#33021;&#65292;&#27604;&#22914; Boost &#37324;&#20063;&#26377; <code>boost::mutex::scoped_lock</code>&#65292;&#21644; Qt &#36825;&#20010; QMutexLocker &#23601;&#26159;&#31867;&#20284;&#23545;&#31561;&#30340;&#12290;&#25105;&#20204;&#20195;&#30721;&#37324;&#30340;&#23454;&#20363;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#36824;&#22312; class Logger &#37324;</span>
<span class="dt">static</span> Log &amp;log( Log &amp;log )
{
    <span class="ot">QMutexLocker</span> locker( &amp;mutex );
    logs.append( log.show() );
    <span class="kw">return</span> log;
}</code></pre></div>
<p>&#20026;&#20160;&#20040; Qt &#36825; <code>QMutexLocker</code> &#25110;&#32773;&#35828; <code>boost::mutex::scoped_lock</code> &#33021;&#22815;&#33258;&#21160;&#38145;&#20303;&#21644;&#37322;&#25918; mutex &#21602;&#65311;&#20854;&#23454;&#24456;&#31616;&#21333;&#65292;&#22240;&#20026;&#23427;&#26159;&#19968;&#20010;&#23616;&#37096;&#21464;&#37327;&#65292;&#22312;&#26500;&#36896;&#30340;&#26102;&#20505;&#25343;&#20102; mutex &#30340;&#25351;&#38024;&#65292;&#26469;&#38145;&#20303;&#23427;&#65307;&#22312;&#26512;&#26500;&#30340;&#26102;&#20505;&#23601;&#20250;&#33258;&#21160;&#37322;&#25918;&#23427;&#12290;</p>
<p>&#22240;&#20026;&#24456;&#22810;&#20195;&#30721;&#37117;&#26159;&#37325;&#22797;&#30340;&#65292;&#25105;&#36824;&#29992;&#20102;&#24456;&#22810;&#23439;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">    <span class="co">// generic log (meta programming, saved a lot of typing...)</span>
<span class="ot">#define GENERIC_LOG_QSTRING(TYPE) </span>\
<span class="ot">    static Log log( BCD::##TYPE::Action action, QString message = &quot;&quot; ) </span>\
<span class="ot">    { </span>\
<span class="ot">        QMutexLocker locker( &amp;mutex ); </span>\
<span class="ot">        Log log( BCD::TYPE_##TYPE, action, message ); </span>\
<span class="ot">        logs.append( log.show() ); </span>\
<span class="ot">        return log; </span>\
<span class="ot">    }</span>

<span class="ot">#define GENERIC_LOG_STRING(TYPE) </span>\
<span class="ot">       static Log log( BCD::##TYPE::Action action, std::string message ) </span>\
<span class="ot">       { return log( action, QString( message.c_str() ) ); }</span>

<span class="ot">#define GENERIC_LOG_CSTR(TYPE) </span>\
<span class="ot">       static Log log( BCD::##TYPE::Action action, char *message ) </span>\
<span class="ot">       { return log( action, QString( message ) ); }</span>

       GENERIC_LOG_QSTRING(  LMS                    )
       GENERIC_LOG_QSTRING(  MCU                    )
       GENERIC_LOG_QSTRING(  UR                     )
       ...

       GENERIC_LOG_STRING(  LMS                    )
       GENERIC_LOG_STRING(  MCU                    )
       GENERIC_LOG_STRING(  UR                     )
       ...

       GENERIC_LOG_CSTR(  LMS                    )
       GENERIC_LOG_CSTR(  MCU                    )
       GENERIC_LOG_CSTR(  UR                     )
       ...

<span class="ot">#undef GENERIC_LOG_QSTRING</span>
<span class="ot">#undef GENERIC_LOG_STRING</span>
<span class="ot">#undef GENERIC_LOG_CSTR</span></code></pre></div>
<p>&#20197;&#19978;&#26159;&#22836;&#25991;&#20214; logger.h&#65292;&#22312; logger.cpp &#37324;&#65292;&#25105;&#20204;&#39318;&#20808;&#35201;&#23454;&#20363;&#21270;&#37027;&#20123; static &#21464;&#37327;&#65288;&#22240;&#20026;&#20043;&#21069;&#27809;&#26377;&#29992;&#36807; static &#25104;&#21592;&#65292;&#21018;&#24320;&#22987;&#20889;&#36825;&#37096;&#20998;&#30340;&#26102;&#20505;&#65292;&#29359;&#20102;&#24456;&#22810;&#38169;&#35823;&#12290;&#22238;&#22836;&#26469;&#30475;&#65292;&#37027;&#30495;&#26159;&#22826;&#34850;&#20102;&#65289;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">using</span> <span class="kw">namespace</span> BCD;

<span class="dt">const</span> Logger::Type Logger::types = Logger::initTypes();
<span class="dt">const</span> Logger::Action Logger::actions = Logger::initActions();
<span class="dt">const</span> <span class="ot">QString</span> Logger::logPath = <span class="ot">QString</span>().sprintf( LOG_OUTPATH_FORMAT,
                                                   Util::ts( ) );
<span class="dt">const</span> <span class="dt">int</span> Logger::widthActionInfo = Logger::initActionInfoWidth( );
<span class="co">// &#20854;&#20013; initInfoWidth &#21482;&#26159;&#33719;&#24471;&#23383;&#31526;&#20018;&#30340;&#26368;&#22823;&#23485;&#24230;&#65292;&#20415;&#20110;&#23545;&#40784;&#65292;&#23454;&#29616;&#22914;&#19979;&#65306;</span>
<span class="co">//  int Logger::initActionInfoWidth( )</span>
<span class="co">//  {</span>
<span class="co">//      int width = 0;</span>
<span class="co">//      foreach ( const ActionInfo &amp;ai, actions.values() ) {</span>
<span class="co">//          if ( ai.info.length() &gt; width ) {</span>
<span class="co">//              width = ai.info.length();</span>
<span class="co">//          }</span>
<span class="co">//      }</span>
<span class="co">//      return width;</span>
<span class="co">//  }</span>

size_t Log::counter = <span class="dv">0</span>;
<span class="ot">QMutex</span> Logger::mutex;
<span class="ot">QList</span>&lt;Log&gt; Logger::logs;</code></pre></div>
<p>&#20854;&#23454;&#36825;&#37324;&#20063;&#26377;&#36807;&#24230;&#24037;&#31243;&#30340;&#23244;&#30097;&#65292;&#22240;&#20026; <code>initTypes()</code> &#31561;&#20989;&#25968;&#21482;&#29992;&#20102;&#19968;&#27425;&#65292;&#23436;&#20840;&#27809;&#26377;&#24517;&#35201;&#25918;&#21040; Logger &#31867;&#37324;&#38754;&#21435;&#65288;&#34429;&#28982;&#35774;&#32622;&#20102;&#36825;&#20123;&#20989;&#25968;&#20026; private &#38450;&#27490;&#20854;&#20182;&#20154;&#35843;&#29992;&#65289;&#65292;&#21482;&#35201;&#22312; cpp &#25991;&#20214;&#37324;&#29992;&#25991;&#20214;&#20316;&#29992;&#22495;&#30340; static &#20989;&#25968;&#23601;&#21487;&#20197;&#20102;&#12290;&#21363;&#25226;</p>
<pre><code>// logger.cpp
Logger::Type Logger::initTypes( )
{
    Type types;

    types[  TYPE_ARM                   ] = QObject::tr(  &quot;ARM&quot;          );
    types[  TYPE_IMU                   ] = QObject::tr(  &quot;IMU&quot;          );
    types[  TYPE_LMS                   ] = QObject::tr(  &quot;LMS&quot;          );
    types[  TYPE_MCU                   ] = QObject::tr(  &quot;MCU&quot;          );
    types[  TYPE_UR                    ] = QObject::tr(  &quot;UR&quot;           );
    ...

    return types;
}</code></pre>
<p>&#25913;&#25104;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// logger.cpp</span>
<span class="dt">static</span> Logger::Type initTypes( )
{
    Logger::Type types;

    types[  TYPE_ARM                   ] = <span class="ot">QObject::</span>tr(  <span class="st">&quot;ARM&quot;</span>          );
    types[  TYPE_IMU                   ] = <span class="ot">QObject::</span>tr(  <span class="st">&quot;IMU&quot;</span>          );
    types[  TYPE_LMS                   ] = <span class="ot">QObject::</span>tr(  <span class="st">&quot;LMS&quot;</span>          );
    types[  TYPE_MCU                   ] = <span class="ot">QObject::</span>tr(  <span class="st">&quot;MCU&quot;</span>          );
    types[  TYPE_UR                    ] = <span class="ot">QObject::</span>tr(  <span class="st">&quot;UR&quot;</span>           );
    ...

    <span class="kw">return</span> types;
}</code></pre></div>
<p>&#21363;&#21487;&#12290;</p>
<p>initActions &#20989;&#25968;&#27880;&#20876;&#20102;&#25152;&#26377; logger &#21487;&#20197;&#30452;&#25509;&#20351;&#29992;&#30340;&#20989;&#25968;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// logger.cpp</span>
Logger::Action Logger::initActions( )
{
    Action actions;
<span class="ot">#define ACTION(aid, level, info) </span>\
<span class="ot">    actions[(int)aid]=actionInfo(ActionInfo::LEVEL##level,QObject::tr(info));</span>

    <span class="co">/*</span>
<span class="co">     * -- L M S --</span>
<span class="co">     */</span>
    ACTION( LMS::LMS,                               <span class="dv">1</span>, <span class="st">&quot;LMS generic&quot;</span> );
    ACTION( LMS::CONSTRUCT,                         <span class="dv">1</span>, <span class="st">&quot;construct&quot;</span> );
    ACTION( LMS::GEN_NEW_PATH,                      <span class="dv">1</span>, <span class="st">&quot;gen new path&quot;</span> );

    ACTION( LMS::CONFIG_ADDRESS_PORT,               <span class="dv">1</span>, <span class="st">&quot;configure ip, port&quot;</span> );
    ACTION( LMS::CONFIG_ACTIONS,                    <span class="dv">1</span>, <span class="st">&quot;configure actions&quot;</span> );
    ACTION( LMS::CONFIG_AUTH_LEVELS,                <span class="dv">1</span>, <span class="st">&quot;configure auth levels&quot;</span> );
    ACTION( LMS::CREATE_THREAD,                     <span class="dv">1</span>, <span class="st">&quot;create thread&quot;</span> );
    ACTION( LMS::DETACH_THREAD,                     <span class="dv">1</span>, <span class="st">&quot;detach thread&quot;</span> );

    ACTION( LMS::TURN_ON_READING,                   <span class="dv">1</span>, <span class="st">&quot;turn on READING&quot;</span> );
    ACTION( LMS::TURN_OFF_READING,                  <span class="dv">1</span>, <span class="st">&quot;turn off READING&quot;</span> );
    ACTION( LMS::POLLING_ONE,                       <span class="dv">1</span>, <span class="st">&quot;just polling one&quot;</span> );

    ACTION( LMS::PARSE_PROFILE,                     <span class="dv">1</span>, <span class="st">&quot;parse profiles&quot;</span> );
    ACTION( LMS::SAVE_PROFILES,                     <span class="dv">1</span>, <span class="st">&quot;save profiles&quot;</span> );
    ACTION( LMS::CONFIG_BASEDIR,                    <span class="dv">1</span>, <span class="st">&quot;configure output base dir&quot;</span> );

    ...

<span class="ot">#undef ACTION</span>

    <span class="kw">return</span> actions;
}</code></pre></div>
<p>&#26085;&#24535;&#22312;&#20445;&#23384;&#30340;&#26102;&#20505;&#65292;&#21487;&#33021;&#23384;&#22312;&#26102;&#38388;&#25139;&#30340;&#28151;&#20081;&#65288;&#20004;&#21488;&#30005;&#33041;&#30340;&#26085;&#24535;&#20998;&#21035;&#35760;&#24405;&#65292;&#20182;&#20204;&#30340;&#26102;&#38388;&#35774;&#23450;&#21487;&#33021;&#23384;&#22312;&#35823;&#24046;&#65292;&#24453;&#31243;&#24207;&#32467;&#26463;&#30340;&#26102;&#20505;&#65292;&#24037;&#25511;&#26426;&#30340;&#26085;&#24535;&#38500;&#20102;&#26412;&#22320;&#20445;&#23384;&#65292;&#36824;&#20250;&#36890;&#36807; TCP &#22238;&#20256;&#32473;&#39640;&#24615;&#33021;&#12290;&#39640;&#24615;&#33021;&#20250;&#20445;&#23384;&#25152;&#26377;&#26085;&#24535;&#65289;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#25353;&#29031;&#26102;&#38388;&#25139;&#25490;&#24207;</span>
<span class="dt">bool</span> compare( <span class="dt">const</span> Log &amp;log1, <span class="dt">const</span> Log &amp;log2 ) {
    <span class="kw">return</span> log1.timestamp &lt; log2.timestamp;
}

<span class="dt">void</span> Logger::saveLogs( <span class="ot">QList</span>&lt;Log&gt; &amp;logs, ActionInfo::Level level )
{
    <span class="kw">if</span> ( logs.isEmpty() ) { <span class="kw">return</span>; }

    <span class="co">// &#19981;&#36807;&#25105;&#20204;&#23454;&#38469;&#20351;&#29992;&#20013;&#24182;&#27809;&#26377;&#25490;&#24207;&#65292;&#22240;&#20026;&#23427;&#19981;&#37027;&#20040;&#24517;&#35201;</span>
    <span class="co">// qSort( logs.begin(), logs.end(), compare );</span>

    <span class="co">// &#20250;&#20445;&#23384;&#25104; UTF-8 without BOM &#26684;&#24335;</span>
    FILE *fp = fopen( <span class="fu">qPrintable</span>(logPath), <span class="st">&quot;a+&quot;</span> );
    <span class="co">// &#36825;&#37324;&#26412;&#26469;&#26377;&#19968;&#20123; Debug &#20449;&#24687;&#65292;&#20294;&#26159;&#25918;&#21040;&#36825;&#37324;&#25105;&#25226;&#23427;&#20204;&#21435;&#25481;&#20102;</span>
    <span class="kw">if</span> ( NULL == fp ) { <span class="kw">return</span>; }

    <span class="dt">int</span> widthTimestamp = Util::ts2YYYYMMDD_HHMMSS_MS().length();
    <span class="dt">static</span> size_t i = <span class="dv">0</span>;
    <span class="kw">if</span> ( <span class="dv">0</span> == i ) {
        <span class="co">// Markdown &#26684;&#24335;&#30340;&#34920;&#26684;&#30340;&#34920;&#26684;&#22836;&#65292;&#22240;&#20026;&#25105;&#24819;&#35753;&#34920;&#26684;&#22909;&#30475;&#28857;&#65292;&#25152;&#20197;&#35201;&#23545;&#34920;&#26684;&#36827;&#34892;</span>
        <span class="co">// &#23545;&#40784;&#65292;&#36824;&#33457;&#20102;&#19981;&#23569;&#21151;&#22827;==</span>
        <span class="co">// &#21407;&#35845;&#25105;&#22788;&#22899;&#24231;&#24378;&#36843;&#30151;&#12290;</span>
<span class="ot">#define H(header, width) </span>\
<span class="ot">     arg(&quot;&quot;, (##width-QObject::tr(##header).length())/2, &#39; &#39;) </span>\
<span class="ot">    .arg(QObject::tr(##header)) </span>\
<span class="ot">    .arg(&quot;&quot;, ##width-QObject::tr(##header).length()-(##width-QObject::tr(##header).length())/2, &#39; &#39;)</span>

    <span class="co">// &#19978;&#38754;&#36825;&#19968;&#20010;&#34507;&#30140;&#30340;&#23439;&#65292;&#23601;&#26159;&#20026;&#20102;&#23454;&#29616; C &#35821;&#35328;&#23383;&#31526;&#20018;&#26684;&#24335;&#21270;&#20013;&#24212;&#35813;&#26377;&#32780;&#27809;&#26377;&#30340;&#23621;&#20013;&#23545;&#40784;</span>

        fputs( <span class="fu">qPrintable</span>( <span class="ot">QString</span>( <span class="st">&quot;| </span><span class="ch">%1%</span><span class="st">2%3 &quot;</span>          <span class="co">// index</span>
                                    <span class="st">&quot;| </span><span class="ch">%4%</span><span class="st">5%6 &quot;</span>          <span class="co">// timestamp</span>
                                    <span class="st">&quot;| </span><span class="ch">%7%</span><span class="st">8%9 &quot;</span>          <span class="co">// log level</span>
                                    <span class="st">&quot;| </span><span class="ch">%10%</span><span class="st">11%12 &quot;</span>       <span class="co">// type</span>
                                    <span class="st">&quot;| </span><span class="ch">%13%</span><span class="st">14%15 &quot;</span>       <span class="co">// action</span>
                                    <span class="st">&quot;| </span><span class="ch">%16%</span><span class="st">17%18 |</span><span class="ch">\n</span><span class="st">&quot;</span> )  <span class="co">// remarks</span>
                                    .H( <span class="st">&quot;INDEX&quot;</span>,        WIDTH_INDEX )
                                    .H( <span class="st">&quot;TIMESTAMP&quot;</span>, widthTimestamp )
                                    .H( <span class="st">&quot;LEVEL&quot;</span>,        WIDTH_LEVEL )
                                    .H( <span class="st">&quot;TYPE&quot;</span>,          WIDTH_TYPE )
                                    .H( <span class="st">&quot;ACTION&quot;</span>,   widthActionInfo )
                                    .H( <span class="st">&quot;REMARKS&quot;</span>,    WIDTH_REMARKS ) ), fp );

<span class="ot">#undef H</span>
        <span class="co">// &#26684;&#24335;&#23601;&#26159;&#36825;&#26679;&#65306;| idx | timestamp | level | type | action | remarks |</span>
        fputs( <span class="ot">QString</span>( <span class="st">&quot;| :%1: | :%2: | :%3: | :%4: | :%5: | :%6: |</span><span class="ch">\n</span><span class="st">&quot;</span> )
                        .arg( <span class="st">&quot;&quot;</span>, WIDTH_INDEX<span class="dv">-2</span>,     <span class="st">&#39;-&#39;</span> )
                        .arg( <span class="st">&quot;&quot;</span>, widthTimestamp<span class="dv">-2</span>,  <span class="st">&#39;-&#39;</span> )
                        .arg( <span class="st">&quot;&quot;</span>, WIDTH_LEVEL<span class="dv">-2</span>,     <span class="st">&#39;-&#39;</span> )
                        .arg( <span class="st">&quot;&quot;</span>, WIDTH_TYPE<span class="dv">-2</span>,      <span class="st">&#39;-&#39;</span> )
                        .arg( <span class="st">&quot;&quot;</span>, widthActionInfo<span class="dv">-2</span>, <span class="st">&#39;-&#39;</span> )
                        .arg( <span class="st">&quot;&quot;</span>, WIDTH_REMARKS<span class="dv">-2</span>,   <span class="st">&#39;-&#39;</span> )
                        .toStdString().c_str(), fp );
    }  <span class="co">// header</span>

    <span class="dt">int</span> i0 = i;
    <span class="kw">foreach</span> ( <span class="dt">const</span> Log &amp;log, logs ) {
        <span class="co">// current level</span>
        ActionInfo::Level cl = actions.value(log.action).level;
        <span class="kw">if</span> ( <span class="kw">true</span> || cl &lt;= level ) {
            <span class="dt">int</span> len = strlen( <span class="fu">qPrintable</span>( types.value(log.type) ) );
            fprintf( fp,
                     <span class="st">&quot;| </span><span class="ch">%*i</span><span class="st"> &quot;</span>              <span class="co">// index</span>
                     <span class="st">&quot;| </span><span class="ch">%*s</span><span class="st"> &quot;</span>              <span class="co">// timestamp</span>
                     <span class="st">&quot;| </span><span class="ch">%*s%d%*s</span><span class="st"> &quot;</span>         <span class="co">// log level</span>
                     <span class="st">&quot;| </span><span class="ch">%*s%s%*s</span><span class="st"> &quot;</span>         <span class="co">// type (aligned to center)</span>
                     <span class="st">&quot;| </span><span class="ch">%-*s</span><span class="st"> &quot;</span>             <span class="co">// action</span>
                     <span class="st">&quot;| </span><span class="ch">%*s</span><span class="st"> |</span><span class="ch">\n</span><span class="st">&quot;</span>,          <span class="co">// message</span>
   <span class="co">/* index     */</span>   WIDTH_INDEX, ++i,
   <span class="co">/* timestamp */</span>   widthTimestamp, <span class="fu">qPrintable</span>(Util::ts2YYYYMMDD_HHMMSS_MS(log.timestamp)),
   <span class="co">/* log level */</span>   (WIDTH_LEVEL<span class="dv">-1</span>)/<span class="dv">2</span>, <span class="st">&quot;&quot;</span>, (<span class="dt">int</span>)actions.value(log.action).level<span class="dv">+1</span>, WIDTH_LEVEL-(WIDTH_LEVEL<span class="dv">-1</span>)/<span class="dv">2-1</span>, <span class="st">&quot;&quot;</span>,
   <span class="co">/* type      */</span>   (WIDTH_TYPE-len)/<span class="dv">2</span>, <span class="st">&quot;&quot;</span>, <span class="fu">qPrintable</span>(types.value(log.type)), WIDTH_TYPE-len-(WIDTH_TYPE-len)/<span class="dv">2</span>, <span class="st">&quot;&quot;</span>,
   <span class="co">/* action    */</span>   widthActionInfo, <span class="fu">qPrintable</span>(actions.value(log.action).info),
   <span class="co">/* message   */</span>   WIDTH_REMARKS, log.message.isEmpty() ? <span class="st">&quot;&quot;</span> : <span class="fu">qPrintable</span>(log.message) );
        }
    }  <span class="co">// foreach</span>

    fclose( fp );
    log() &lt;&lt; <span class="st">&quot;Saving logs... done. (&quot;</span>
          &lt;&lt; (i-i0) &lt;&lt; <span class="st">&quot;out of &quot;</span>
          &lt;&lt; logs.size() &lt;&lt; <span class="st">&quot;logs )&quot;</span>;
}

<span class="ot">QList</span>&lt;Log&gt; Logger::refresh( )
{
    <span class="ot">QList</span>&lt;Log&gt; copy;

    <span class="ot">QMutexLocker</span> locker( &amp;mutex );
    <span class="kw">foreach</span> ( <span class="dt">const</span> Log &amp;log, logs ) {
        copy.append( log );
    }
    logs.clear();

    <span class="kw">return</span> copy;
}

<span class="co">// &#36824;&#35201;&#25353;&#29031;&#31561;&#32423;&#20445;&#23384;&#65292;&#21487;&#33021;&#19968;&#20123;&#20020;&#26102;&#30340;&#32423;&#21035;&#29305;&#21035;&#20302;&#30340;&#35843;&#35797;&#20449;&#24687;&#23601;&#19981;&#20445;&#23384;&#20102;&#12290;</span>
<span class="dt">void</span> Logger::save( ActionInfo::Level level )
{
    <span class="ot">QList</span>&lt;Log&gt; &amp;logs = refresh();

    <span class="kw">if</span> ( !Bundle::activated() ) {
        saveLogs( logs, level );
    } <span class="kw">else</span> {
        <span class="co">// &#24037;&#25511;&#26426;&#35201;&#25226;&#26085;&#24535;&#22238;&#20256;&#32473;&#39640;&#24615;&#33021;&#35745;&#31639;&#26426;</span>
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Sending&quot;</span> &lt;&lt; logs.length() &lt;&lt; <span class="st">&quot;logs to MASTER...&quot;</span>;
        <span class="ot">QByteArray</span> tx;
        <span class="ot">QDataStream</span> out( &amp;tx, <span class="ot">QIODevice::</span>WriteOnly );
        out.setVersion( <span class="ot">QDataStream::</span>Qt_4_8 );
        out &lt;&lt; (<span class="dt">int</span>)Moderator::META__SAVE_LOG__VOID;
        out &lt;&lt; logs.length();
        <span class="kw">foreach</span> ( <span class="dt">const</span> Log &amp;log, logs ) {
            out &lt;&lt; log;
        }
        Bundle::send( tx );
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Sending&quot;</span> &lt;&lt; logs.length() &lt;&lt; <span class="st">&quot;logs to MASTER... done.&quot;</span>;
    }
}

<span class="dt">void</span> Logger::lazySave()
{
    <span class="ot">QList</span>&lt;Log&gt; logs = refresh();
    saveLogs( logs, LOG_FILTER_ARCHIVE );
}</code></pre></div>
<h2 id="utils-&#27169;&#22359;">Utils &#27169;&#22359;</h2>
<p>&#22240;&#20026;&#26377;&#24456;&#22810;&#32593;&#32476;&#25968;&#25454;&#38656;&#35201;&#22788;&#29702;&#65292;&#25152;&#20197;&#24314;&#20102;&#19968;&#20010; utils &#27169;&#22359;&#65292;&#25918;&#32622;&#19968;&#20123;&#36890;&#29992;&#30340;&#23383;&#33410;&#22788;&#29702;&#20989;&#25968;&#12290;</p>
<p>&#39318;&#20808;&#65292;&#24341;&#20837; Qt &#30340;&#22836;&#25991;&#20214;&#21644;&#26085;&#24535;&#27169;&#22359;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#ifndef BYTESUTILS</span>
<span class="ot">#define BYTESUTILS</span>
<span class="ot">#include &lt;QtCore&gt;</span>
<span class="ot">#include &quot;logger.h&quot;</span></code></pre></div>
<p>&#31532;&#19968;&#20010; util&#65292;&#26159;&#20174;&#23383;&#31526;&#20018;&#35835;&#21462;&#23383;&#33410;&#20316;&#20026;&#21407;&#22987;&#25968;&#25454;&#12290;&#19968;&#33324;&#30340; COM &#20018;&#21475;&#21161;&#25163;&#37117;&#26377;&#31867;&#20284;&#30340;&#21151;&#33021;&#65292;&#25105;&#20204;&#21457;&#29616;&#27809;&#26377;&#36825;&#20010;&#20989;&#25968;&#24456;&#22810;&#26102;&#20505;&#35843;&#35797;&#36215;&#26469;&#24456;&#40635;&#28902;&#65292;&#25152;&#20197;&#38656;&#35201;&#36825;&#20040;&#19968;&#20010;&#20989;&#25968;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> e.g. <span class="st">&quot;0x34 0x48&quot;</span><span class="co"> </span>==&gt; <span class="bn">0x34</span> <span class="bn">0x48</span>
<span class="ot">QByteArray</span> parseHexString( <span class="dt">const</span> <span class="ot">QString</span> &amp;hexstr )
{
    <span class="ot">QStringList</span> sl = hexstr.split(<span class="st">&quot; &quot;</span><span class="co">)</span>;
    <span class="ot">QByteArray</span> ba;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;str, sl ) {
        <span class="dt">int</span> i = <span class="dv">0</span>;
        sscanf_s( <span class="fu">qPrintable</span>( str ), <span class="st">&quot;0x</span><span class="ch">%x</span><span class="st">&quot;</span><span class="co">,</span> &amp;i );
        ba.append((<span class="dt">quint8</span>)i);
    }

    <span class="kw">return</span> ba;
}</code></pre></div>
<p>&#36825;&#37324;&#30340; <code>qPrintable</code> &#23439;&#30495;&#26159;&#35814;&#35265;&#24680;&#26202;&#65281;&#22240;&#20026;&#21435;&#38271;&#27801;&#21442;&#19982;&#36825;&#20010;&#39033;&#30446;&#21069;&#23545; Qt &#24182;&#19981;&#29087;&#24713;&#65292;&#21018;&#24320;&#22987;&#25105;&#20204;&#20351;&#29992;&#30340;&#26159; <code>qstr.toStdString().c_str()</code>&#65292;&#20351;&#29992;&#36215;&#26469;&#30495;&#26159;&#40635;&#28902;&#12290;&#21518;&#26469;&#25165;&#21457;&#29616; Qt &#25552;&#20379;&#20102;&#36825;&#20040;&#19968;&#20010;&#23439;&#12290;</p>
<p>&#26377;&#26102;&#20505;&#65292;&#36824;&#35201;&#25226;&#21407;&#22987;&#25968;&#25454;&#25171;&#21360;&#25104;&#21487;&#20197;&#30475;&#21040;&#30340;&#23383;&#31526;&#65292;&#23601;&#20889;&#20102; ba2hexstr &#20989;&#25968;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> <span class="ot">QByteArray</span> to Hex String, e.g. <span class="bn">0x34</span> <span class="bn">0x45</span> ==&gt; <span class="st">&quot;0x 34 0x45&quot;</span>
<span class="ot">QString</span> ba2hexstr( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba,
                   <span class="ot">QString</span> prefix <span class="co">/* = &quot;0x&quot; */</span>,
                   <span class="ot">QString</span> postfix <span class="co">/* = &quot;&quot; */</span> )
{
    <span class="ot">QString</span> str;
    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; ba.length(); ++i ) {
        str.append( <span class="ot">QString</span>().sprintf( <span class="st">&quot;</span><span class="ch">%s%02x%s</span><span class="st">&quot;</span><span class="co">,</span>
                                       <span class="fu">qPrintable</span>( prefix ),
                                       (<span class="dt">uchar</span>)ba.at(i),
                                       <span class="fu">qPrintable</span>( postfix ) ) );
    }
    <span class="kw">return</span> str;
}</code></pre></div>
<p>&#19978;&#38754;&#30340; <a href="http://tangzx.qiniudn.com/post-0056-lms-chunk.html">LMS &#25968;&#25454;&#37327;</a> &#36825;&#31687;&#25991;&#31456;&#37324;&#25171;&#21360;&#30340; LMS &#25968;&#25454;&#30340;&#27599;&#20010;&#23383;&#33410;&#23601;&#26159;&#36825;&#20040;&#26174;&#31034;&#20986;&#26469;&#30340;&#12290;</p>
<p>&#26377;&#26102;&#20505;&#65292;&#25105;&#20204;&#35201;&#20687;&#20018;&#21475;&#21457;&#36865;&#19968;&#20010;&#25968;&#25454;&#65292;&#28982;&#21518;&#65292;&#31561;&#24453;&#22823;&#27010; 2 &#31186;&#38047;&#65292;&#31561;&#29616;&#26377;&#30340;&#25805;&#20316;&#23436;&#25104;&#21518;&#65292;&#20877;&#21457;&#36865;&#19979;&#19968;&#20010;&#20219;&#21153;&#12290;&#20030;&#20363;&#35828;&#65292;&#22914;&#19979;&#22270;&#65292;LMS &#19979;&#26041;&#26377;&#19968;&#20010;&#27493;&#36827;&#30005;&#26426;&#65288;&#32418;&#33394;&#26694;&#20986;&#26469;&#20102;&#65289;&#65292;LMS &#24037;&#20316;&#30340;&#26102;&#20505;&#65292;&#23601;&#38656;&#35201;&#36830;&#32493;&#20570;&#19977;&#20010;&#21160;&#20316;&#65292;&#28982;&#32780;&#27493;&#36827;&#30005;&#26426;&#19981;&#33021;&#21453;&#39304;&#35828;&#8220;&#36825;&#20010;&#21160;&#20316;&#25805;&#20316;&#23436;&#25104;&#20102;&#8221;&#65292;&#25105;&#20204;&#22909;&#36827;&#34892;&#22238;&#35843;&#25805;&#20316;&#12290;&#25152;&#20197;&#65292;&#25105;&#20204;&#21482;&#33021;&#20272;&#35745;&#19968;&#20010;&#26102;&#38388;&#38388;&#38548;&#65292;&#25554;&#20837;&#21040;&#36825;&#19977;&#20010;&#25805;&#20316;&#35843;&#29992;&#20043;&#38388;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-21-40.png" alt="&#20808;&#36870;&#26102;&#38024;&#36716; 15 &#24230;&#65292;&#20877;&#39034;&#26102;&#38024;&#36716; 120 &#24230;&#65292;&#20877;&#36870;&#26102;&#38024;&#36716; 15 &#24230;&#65292;&#20013;&#38388;&#37117;&#38656;&#35201;&#31561;&#24453;&#19978;&#19968;&#20010;&#25805;&#20316;&#23436;&#25104;&#65292;&#25165;&#33021;&#36827;&#34892;&#19979;&#19968;&#27493;&#12290;" />
<p class="caption">&#20808;&#36870;&#26102;&#38024;&#36716; 15 &#24230;&#65292;&#20877;&#39034;&#26102;&#38024;&#36716; 120 &#24230;&#65292;&#20877;&#36870;&#26102;&#38024;&#36716; 15 &#24230;&#65292;&#20013;&#38388;&#37117;&#38656;&#35201;&#31561;&#24453;&#19978;&#19968;&#20010;&#25805;&#20316;&#23436;&#25104;&#65292;&#25165;&#33021;&#36827;&#34892;&#19979;&#19968;&#27493;&#12290;</p>
</div>
<p>&#36825;&#23601;&#26159; <code>delay_ms</code> &#20989;&#25968;&#65292;&#23427;&#33021;&#23558;&#32447;&#31243;&#26242;&#20572;&#19968;&#23450;&#30340;&#27627;&#31186;&#25968;&#65292;&#32780;&#19981;&#24433;&#21709;&#20027;&#30028;&#38754;&#30340;&#28040;&#24687;&#24490;&#29615;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> delay msecs
<span class="dt">void</span> delay_ms( <span class="dt">const</span> <span class="dt">quint16</span> &amp;t )
{
    <span class="ot">QTime</span> dieTime = <span class="ot">QTime::</span>currentTime().addMSecs(t);
    <span class="kw">while</span>( <span class="ot">QTime::</span>currentTime() &lt; dieTime ) {
        <span class="ot">QCoreApplication::</span>processEvents( <span class="ot">QEventLoop::</span>AllEvents, <span class="dv">100</span> );
    }
}</code></pre></div>
<p>&#19979;&#38754;&#20004;&#20010;&#27604;&#36739;&#31616;&#21333;&#65292;&#23601;&#26159;&#35282;&#24230;&#21644;&#24359;&#24230;&#30340;&#36716;&#21270;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">double</span> rad2deg( <span class="dt">const</span> <span class="dt">double</span> &amp;r ) { <span class="kw">return</span> r / M_PI * <span class="fl">180.0</span>; }
<span class="dt">double</span> deg2rad( <span class="dt">const</span> <span class="dt">double</span> &amp;d ) { <span class="kw">return</span> d * M_PI / <span class="fl">180.0</span>; }</code></pre></div>
<p>&#19979;&#38754;&#26159;&#20960;&#20010;&#26102;&#38388;&#25139;&#20989;&#25968;&#12290;&#26102;&#38388;&#25139;&#25105;&#20204;&#20351;&#29992;&#30340;&#26159; Qt &#30340; <code>QDateTime::currentMSecsSinceEpoch()</code>&#65292;&#22240;&#20026;&#23427;&#33021;&#26126;&#30830;&#34920;&#31034;&#19968;&#20010;&#26102;&#38388;&#28857;&#65292;&#32780;&#19988;&#31934;&#24230;&#26159;&#27627;&#31186;&#65292;&#23427;&#23454;&#38469;&#19978;&#26159;&#19968;&#20010; int64_t &#25972;&#24418;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">QString</span> Util::ts2HHMMSS_MS( <span class="dt">qint64</span> ts<span class="co">/* =0 */</span> )
{
    <span class="ot">QDateTime</span> dt = ts2dt( ts );
    <span class="kw">return</span> <span class="ot">QString</span>().sprintf( <span class="st">&quot;</span><span class="ch">%02d</span><span class="st">:</span><span class="ch">%02d</span><span class="st">:</span><span class="ch">%02d</span><span class="st">.</span><span class="ch">%03d</span><span class="st">&quot;</span>  <span class="co">// e.g. 01:23:45.678</span>
                            , dt.time().hour()
                            , dt.time().minute()
                            , dt.time().second()
                            , dt.time().msec() );
}

<span class="ot">QString</span> Util::ts2YYYYMMDD_HHMMSS_MS( <span class="dt">qint64</span> ts<span class="co">/*=0*/</span>
    , <span class="dt">const</span> <span class="dt">char</span> *format<span class="co">/*=&quot;%4d/%02d/%02d %02d:%02d:%02d.%03d&quot;*/</span> )
{
    <span class="ot">QDateTime</span> dt = ts2dt( ts );
    <span class="kw">return</span> <span class="ot">QString</span>().sprintf( format
                            , dt.date().year()
                            , dt.date().month()
                            , dt.date().day()
                            , dt.time().hour()
                            , dt.time().minute()
                            , dt.time().second()
                            , dt.time().msec() );
}

<span class="dt">qint64</span> timestamp( )
{
    <span class="kw">return</span> <span class="ot">QDateTime::</span>currentMSecsSinceEpoch();
}

<span class="ot">QString</span> timestampstr( )
{
    <span class="dt">qint64</span> dt = <span class="ot">QDateTime::</span>currentMSecsSinceEpoch();
    <span class="kw">return</span> timestampstr( dt );
}

<span class="ot">QString</span> timestampstr( <span class="dt">const</span> <span class="dt">qint64</span> &amp;dt )
{
    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;</span><span class="ch">%lld</span><span class="st">&quot;</span>, dt );
    <span class="kw">return</span> str;
}</code></pre></div>
<p>&#20043;&#21069;&#25105;&#36824;&#23545;&#27604;&#36807; <code>clock_t</code>&#12289;<code>time_t</code>&#65292;&#21457;&#29616;&#36824;&#26159; Qt &#30340; <code>currentMSecsSinceEpoch</code> &#22909;&#65306; <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<ul>
<li><code>clock_t</code> &#26681;&#26412;&#19981;&#26159;&#26102;&#38388;&#25139;&#65292;&#26102;&#38388;&#30340; span &#22826;&#30701;&#65292;&#21482;&#33021;&#29992;&#26469;&#23545;&#27604;&#26102;&#38388;&#20808;&#21518;&#65292;&#32780;&#19981;&#26159;&#30495;&#27491;&#30340;&#8220;&#32426;&#24405;&#8221;&#26102;&#38388;&#65307;</li>
<li><code>time_t</code> &#21644; Linux &#19978;&#24120;&#29992;&#30340; <code>date +%s</code> &#24212;&#35813;&#31561;&#20215;&#65292;&#19981;&#36807;&#26102;&#38388;&#31934;&#24230;&#26159;&#31186;&#65292;&#19981;&#22815;&#31934;&#30830;&#65307;</li>
<li><code>QDateTime</code> &#21644; <code>time_t</code> &#31867;&#20284;&#65292;&#20294;&#26159;&#31934;&#24230;&#36798;&#21040;&#20102;&#27627;&#31186;&#65292;&#25152;&#20197;&#23427;&#26368;&#22909;&#12290;</li>
</ul>
<p>&#22312; COM &#32534;&#31243;&#65288;&#20018;&#21475;&#32534;&#31243;&#65289;&#20013;&#65292;&#32463;&#24120;&#38656;&#35201;&#22788;&#29702;&#19968;&#20010; word &#30340;&#25968;&#25454;&#65288;&#20004;&#20010;&#23383;&#33410;&#65289;&#65292;&#25152;&#20197;&#20889;&#20102;&#20960;&#20010;&#23383;&#33410;&#25805;&#20316;&#65292;&#29992;&#26469;&#33719;&#21462;&#39640;&#20301;&#12289;&#20302;&#20301;&#65292;&#25226;&#20004;&#20010;&#23383;&#33410;&#21512;&#24182;&#20026;&#19968;&#20010; word&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> get higher byte
<span class="dt">quint8</span> high( <span class="dt">const</span> <span class="dt">quint16</span> &amp;letter )
{
    <span class="kw">return</span> (<span class="dt">quint8</span>)(letter&gt;&gt;<span class="dv">8</span> &amp; <span class="bn">0xFF</span>);
}

<span class="co">//!</span> get lower byte
<span class="dt">quint8</span> low( <span class="dt">const</span> <span class="dt">quint16</span> &amp;letter )
{
    <span class="kw">return</span> (<span class="dt">quint8</span>)(letter &amp; <span class="bn">0xFF</span>);
}

<span class="co">//!</span> patch two bytes
<span class="dt">quint16</span> highlow( <span class="dt">const</span> <span class="dt">quint8</span> &amp;high, <span class="dt">const</span> <span class="dt">quint8</span> &amp;low )
{
    <span class="dt">quint16</span> hl = <span class="dv">0</span>;
    hl |= (<span class="dt">quint16</span>)high &lt;&lt; <span class="dv">8</span>;
    hl |= low;
    <span class="kw">return</span> hl;
}</code></pre></div>
<p>&#39640;&#20301;&#21644;&#20302;&#20301;&#25105;&#20063;&#26159;&#22312;&#38271;&#27801;&#25165; GET &#21040;&#30340;&#27010;&#24565;&#12290;&#37027;&#26102;&#20505;&#25105;&#36824;&#22312;&#30475; CSAPP&#65292;&#21018;&#30475;&#21040; two&#8217;s complement&#12290;&#20018;&#21475;&#25968;&#25454;&#32463;&#24120;&#20250;&#20940;&#20081;&#65292;&#25152;&#20197;&#36890;&#24120;&#37117;&#35201;&#26657;&#39564;&#65292;&#20018;&#21475;&#21161;&#25163;&#37324;&#65292;&#36890;&#24120;&#20063;&#26377;&#19968;&#20010;&#36873;&#39033;&#65292;&#38656;&#35201;&#20320;&#35774;&#32622;&#21040;&#24213;&#26657;&#39564;&#26159; CRC16 &#26657;&#39564;&#26159;&#12304;&#39640;&#20301;&#22312;&#21069;&#12305;&#65292;&#36824;&#26159;&#12304;&#20302;&#20301;&#22312;&#21069;&#12305;&#12290;&#33258;&#24049;&#21457;&#36865;&#20986;&#21435;&#30340;&#25968;&#25454;&#65292;&#20063;&#35201;&#21152;&#19978;&#26657;&#39564;&#30340;&#20004;&#20010;&#23383;&#33410;&#25165;&#21487;&#20197;&#12290; &#21542;&#21017;&#23545;&#26041;&#20063;&#20250;&#35748;&#20026;&#25968;&#25454;&#8220;&#24050;&#25439;&#22351;&#8221;&#12290;&#36825;&#20010;&#20195;&#30721;&#30001;&#38271;&#27801;&#22823;&#23398;&#30340;&#21016;&#21338;&#22763;&#25552;&#20379;&#30340; MFC &#31243;&#24207;&#20462;&#25913;&#32780;&#26469;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> generate CRC16 checksum
<span class="dt">quint16</span> genCRC16( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba, <span class="dt">int</span> length <span class="co">/* = -1 */</span> )
{
    <span class="dt">quint16</span> crc = <span class="bn">0xFFFF</span>;

    <span class="dt">int</span> len;
    <span class="kw">if</span> ( length &gt; ba.length() || ba.length() == <span class="dv">0</span> ) {
        <span class="kw">return</span> <span class="dv">0</span>;
    } <span class="kw">else</span> <span class="kw">if</span> ( <span class="dv">-1</span> == length ) {
        len = ba.length();
    } <span class="kw">else</span> {
        len = length;
    }

    <span class="kw">for</span> ( <span class="dt">int</span> cnt = <span class="dv">0</span>; cnt &lt; len; ++cnt ) {
        <span class="dt">int</span> i;
        crc ^= (<span class="dt">quint8</span>)ba.at(cnt);

        <span class="kw">for</span> ( i = <span class="dv">0</span>; i &lt; <span class="dv">8</span>; ++i ) {
            <span class="kw">if</span> ( crc &amp; <span class="bn">0x01</span> ) {
                crc &gt;&gt;= <span class="dv">1</span>;
                crc ^= <span class="bn">0xA001</span>;       <span class="co">// magical...</span>
            } <span class="kw">else</span> {
                crc &gt;&gt;= <span class="dv">1</span>;
            }
        }
    }

    <span class="kw">return</span> crc;
}</code></pre></div>
<p>&#39318;&#20808;&#33719;&#21462;&#25910;&#21040;&#30340;&#25968;&#25454;&#65288;&#25105;&#20204;&#25226;&#25152;&#26377;&#30340;&#21407;&#22987;&#25968;&#25454;&#37117;&#23384;&#22312; QByteArray &#37324;&#65292;&#32780;&#19981;&#26159; <code>char *</code> &#20160;&#20040;&#30340;&#37324;&#65289;&#30340;&#26368;&#21518;&#20004;&#20010;&#23383;&#33410;&#65292;&#28982;&#21518;&#25226;&#23427;&#25972;&#21512;&#25104;&#19968;&#20010; quint16&#65288;word&#65289;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> get last <span class="dv">2</span> bytes then patch to uint16
<span class="dt">quint16</span> getCRC16( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba )
{
    <span class="kw">if</span> ( ba.length() &lt; <span class="dv">2</span> ) {
        <span class="kw">return</span> <span class="dv">0</span>;
    }

    <span class="dt">quint8</span>  low  = ba.at( ba.length() - <span class="dv">2</span> ); <span class="co">// LSB first</span>
    <span class="dt">quint8</span>  high = ba.at( ba.length() - <span class="dv">1</span> );
    <span class="dt">quint16</span> hl = highlow( high, low );
    <span class="kw">return</span> hl;
}</code></pre></div>
<p>&#32473;&#33258;&#24049;&#35201;&#21457;&#36865;&#30340;&#25968;&#25454;&#21152;&#19978;&#26657;&#39564;&#23383;&#33410;&#65292;&#25105;&#20204;&#30340;&#32422;&#23450;&#26159;&#12304;&#20302;&#20301;&#22312;&#21069;&#12305;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> patch CRC16 tail
<span class="dt">void</span> patchCRC16Tail( <span class="ot">QByteArray</span> &amp;data )
{
    <span class="dt">quint16</span> crc = genCRC16( data );
    data.append( low(crc) );  <span class="co">// low first</span>
    data.append( high(crc) );
}</code></pre></div>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> check <span class="kw">if</span> crc16 passed
<span class="dt">bool</span> crc16Passed( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba )
{
    <span class="kw">if</span> ( getCRC16( ba ) == genCRC16(ba, ba.length()<span class="dv">-2</span>) ) {
        <span class="kw">return</span> <span class="kw">true</span>;
    } <span class="kw">else</span> {
        <span class="kw">return</span> <span class="kw">false</span>;
    }
}</code></pre></div>
<p>&#28982;&#21518;&#23601;&#26159;&#25226;&#24471;&#21040;&#30340;&#21407;&#22987;&#25968;&#25454;&#36716;&#21270;&#20026;&#30456;&#24212;&#30340; double&#65292;int &#31561;&#31867;&#22411;&#65292;&#36825;&#37096;&#20998;&#22312;&#32534;&#30721;&#22120;&#27169;&#22359;&#12289;UR &#27169;&#22359;&#37324;&#24212;&#29992;&#24456;&#22810;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">quint16</span> parse2BytesToUInt16( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba, <span class="dt">quint16</span> cursor, <span class="dt">bool</span> doit <span class="co">/* = true */</span> )
{
    <span class="kw">if</span> ( cursor + <span class="dv">1</span> &gt;= ba.length() ) {
        Logger::log( BCD::META::META, <span class="st">&quot;Error parse 2 bytes to Uint16&quot;</span> );
        <span class="kw">return</span> <span class="dv">0</span>;
    }

    <span class="kw">if</span> ( !doit ) {
        <span class="kw">return</span> <span class="dv">0</span>;
    }

    <span class="dt">quint16</span> num = <span class="dv">0</span>;
    num  = (<span class="dt">quint16</span>)(ba.at(cursor + <span class="dv">0</span>)) &lt;&lt; <span class="dv">8</span>; <span class="co">// MSB first</span>
    num |= (<span class="dt">quint8</span>)ba.at(cursor + <span class="dv">1</span>);
    <span class="kw">return</span> num;
}

<span class="dt">quint32</span> parse4BytesToUInt32( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba, <span class="dt">quint16</span> cursor )
{
    <span class="kw">if</span> ( cursor + <span class="dv">3</span> &gt;= ba.length() ) {
         Logger::log( BCD::META::META, <span class="st">&quot;Error parse 4 bytes to Uint32&quot;</span> );
         <span class="kw">return</span> <span class="dv">0</span>;
    }

    <span class="dt">quint32</span> num = <span class="dv">0</span>;
    <span class="dt">quint16</span> low  = parse2BytesToUInt16( ba, cursor + <span class="dv">0</span> );  <span class="co">// LSB first</span>
    <span class="dt">quint16</span> high = parse2BytesToUInt16( ba, cursor + <span class="dv">2</span> );
    num |= (<span class="dt">quint32</span>)low;
    num |= ((<span class="dt">quint32</span>)high &lt;&lt; <span class="dv">16</span>);

    <span class="co">//QByteArray tmp = ba.mid( 0, 4 );</span>
    <span class="co">//qDebug() &lt;&lt; ba2hexstr( tmp ) &lt;&lt; &quot; : &quot; &lt;&lt; num;</span>
    <span class="kw">return</span> num;
}

<span class="dt">quint64</span> parse8BytesToUInt64( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba, <span class="dt">quint16</span> cursor )
{
    <span class="kw">if</span> ( cursor + <span class="dv">7</span> &gt;= ba.length() ) {
        Logger::log( BCD::META::META, <span class="st">&quot;Error parse 8 bytes to uint64&quot;</span> );
        <span class="kw">return</span> <span class="dv">0</span>;
    }

    <span class="dt">quint64</span> i = <span class="dv">0</span>;
    i |= ba.at( cursor + <span class="dv">0</span> ) &lt;&lt; <span class="dv">56</span>;
    i |= ba.at( cursor + <span class="dv">1</span> ) &lt;&lt; <span class="dv">48</span>;
    i |= ba.at( cursor + <span class="dv">2</span> ) &lt;&lt; <span class="dv">40</span>;
    i |= ba.at( cursor + <span class="dv">3</span> ) &lt;&lt; <span class="dv">32</span>;
    i |= ba.at( cursor + <span class="dv">4</span> ) &lt;&lt; <span class="dv">24</span>;
    i |= ba.at( cursor + <span class="dv">5</span> ) &lt;&lt; <span class="dv">16</span>;
    i |= ba.at( cursor + <span class="dv">6</span> ) &lt;&lt;  <span class="dv">8</span>;
    i |= ba.at( cursor + <span class="dv">7</span> ) &lt;&lt;  <span class="dv">0</span>;
    <span class="kw">return</span> i;
}

<span class="dt">int</span> parse4Bytes2Int4UR( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba, <span class="dt">quint16</span> beg )
{
    <span class="kw">if</span> ( beg + <span class="dv">3</span> &gt;= ba.length() ) {
        Logger::log( BCD::META::META, <span class="st">&quot;Error parse 8 bytes to int 4ur&quot;</span> );
        <span class="kw">return</span> <span class="fl">0.0</span>;
    }

    <span class="dt">int</span> i = <span class="dv">0</span>;
    <span class="dt">char</span> *ii = (<span class="dt">char</span> *)&amp;i;
    *ii |= ba.at(beg + <span class="dv">3</span>); ++ii;
    *ii |= ba.at(beg + <span class="dv">2</span>); ++ii;
    *ii |= ba.at(beg + <span class="dv">1</span>); ++ii;
    *ii |= ba.at(beg + <span class="dv">0</span>);
    <span class="kw">return</span> i;
}

<span class="co">// &#20026;&#20102;&#35753; UR &#27169;&#22359;&#30340;&#20195;&#30721;&#22909;&#30475;&#28857;&#65292;&#28155;&#21152;&#20102;&#19968;&#20010;&#21442;&#25968;&#65292;&#24403;&#23427;&#20026; true &#30340;&#26102;&#20505;&#65292;&#21487;&#20197;&#8220;&#20599;&#25042;&#8221;&#19981; parse&#12290;</span>
<span class="dt">double</span> parse8Bytes2Double4UR( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba, <span class="dt">quint16</span> beg, <span class="dt">bool</span> parse )
{
    <span class="kw">if</span> ( beg + <span class="dv">7</span> &gt;= ba.length() ) {
        Logger::log( BCD::META::META, <span class="st">&quot;Error parse 8 bytes to double 4 ur&quot;</span> );
        <span class="kw">return</span> <span class="fl">0.0</span>;
    }

    <span class="kw">if</span> ( !parse ) { <span class="kw">return</span> <span class="fl">0.0</span>; }

    <span class="co">// &#21487;&#20197;&#30475;&#21040;&#20869;&#23384;&#37324;&#23383;&#33410;&#24207;&#21644;&#32593;&#32476;&#25910;&#21040;&#30340;&#23383;&#33410;&#24207;&#26159;&#19968;&#26679;&#30340;&#65292;</span>
    <span class="co">// &#37492;&#20110;&#22823;&#37096;&#20998;&#25805;&#20316;&#31995;&#32479;&#21253;&#25324; Windows &#37117;&#26159; small endian&#65292;</span>
    <span class="co">// &#37027;&#25105;&#20204;&#30340;&#32593;&#32476;&#23383;&#33410;&#24207;&#24212;&#35813;&#20063;&#26159; small endian</span>
    <span class="co">// &#65288;&#20294;&#25105;&#19981;&#20445;&#35777;&#21834;&#8230;&#8230;&#25105;&#26089;&#24536;&#35760;&#20102;==&#65289;</span>
    <span class="dt">double</span> d = <span class="fl">0.0</span>;
    <span class="dt">char</span> *dd = (<span class="dt">char</span> *)&amp;d;
    *dd |= ba.at(beg + <span class="dv">0</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">1</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">2</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">3</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">4</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">5</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">6</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">7</span>);
    <span class="kw">return</span> d;
}

<span class="dt">double</span> parse8BytesToDouble( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba, <span class="dt">quint16</span> beg, <span class="dt">bool</span> parse <span class="co">/*=true*/</span> )
{
    <span class="kw">if</span> ( beg + <span class="dv">7</span> &gt;= ba.length() ) {
        Logger::log( BCD::META::META, <span class="st">&quot;Error parse 8 bytes to double&quot;</span> );
        <span class="kw">return</span> <span class="fl">0.0</span>;
    }

    <span class="kw">if</span> ( !parse ) {
        <span class="kw">return</span> <span class="fl">0.0</span>;
    }

    <span class="dt">double</span> d = <span class="fl">0.0</span>;
    <span class="dt">char</span> *dd = (<span class="dt">char</span> *)&amp;d;
    *dd |= ba.at(beg + <span class="dv">7</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">6</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">5</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">4</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">3</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">2</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">1</span>); ++dd;
    *dd |= ba.at(beg + <span class="dv">0</span>);
    <span class="kw">return</span> d;
}

<span class="co">// &#29616;&#22312;&#30475;&#65292;&#25105;&#20063;&#19981;&#30693;&#36947;&#20026;&#20160;&#20040; unsigned &#36716;&#21270;&#25104; signed &#35201;&#33258;&#24049;&#21028;&#26029;&#65292;</span>
<span class="co">// &#20294;&#32943;&#23450;&#26159;&#26222;&#36890;&#30340; cast &#20986;&#20102;&#38382;&#39064;&#65292;&#25105;&#25165;&#36825;&#20040;&#8220;&#29609;&#8221;&#30340;&#12290;&#22810;&#20111;&#20102;&#24403;&#26102;&#33258;&#24049;</span>
<span class="co">// &#30475;&#20102; CSAPP&#12290;</span>
<span class="dt">qint16</span> us2s( <span class="dt">const</span> <span class="dt">quint16</span> &amp;us )
{
    <span class="dt">qint16</span> s = <span class="dv">0</span>;

    <span class="kw">if</span> ( us &gt; <span class="bn">0x7FFF</span> ) {          <span class="co">// neg&#65292;&#35753;&#25105;&#29616;&#22312;&#20889;&#25105;&#23601;&#25913;&#25104; us&gt;&gt;15 &amp; 0x1</span>
        s = us &amp; <span class="bn">0x7FFF</span> - <span class="bn">0x8000</span>;
    } <span class="kw">else</span> {                      <span class="co">// pos</span>
        s = us;
    }

    <span class="kw">return</span> s;
}</code></pre></div>
<p>&#19979;&#38754;&#36825;&#20010;&#32431;&#31929;&#26159;&#29992;&#26469;&#35843;&#35797;&#23383;&#33410;&#20102;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//!</span> pretty print bytes
<span class="ot">QString</span> bytes2bits( <span class="dt">char</span> *c, <span class="dt">quint8</span> n )
{
    <span class="dt">char</span> *w = c;
    <span class="ot">QString</span> str;

    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">8</span> * n; ++i ) {
       <span class="dt">int</span> j = i / <span class="dv">8</span>;
       <span class="dt">int</span> k = i % <span class="dv">8</span>;

       <span class="kw">if</span> ( (*(w+n<span class="dv">-1</span>-j)&gt;&gt;(<span class="dv">7</span>-k)) &amp; <span class="bn">0x01</span> == <span class="dv">1</span> ) {
           str.append(<span class="st">&quot;1&quot;</span><span class="co">)</span>;
       } <span class="kw">else</span> {
           str.append(<span class="st">&quot;0&quot;</span><span class="co">)</span>;
       }

       <span class="kw">if</span> ( k == <span class="dv">7</span> &amp;&amp; j != n<span class="dv">-1</span> ) {
           str.append(<span class="st">&quot;, &quot;</span><span class="co">)</span>;
       }
    }
    <span class="kw">return</span> str;
}

<span class="co">// &#21487;&#20197;&#30475;&#21040;&#36825;&#26159; big endian&#65292;&#36825;&#24212;&#35813;&#26159;&#20018;&#21475;&#36890;&#20449;&#29992;&#21040;&#30340;</span>
<span class="ot">QByteArray</span> word2ByteArray( <span class="dt">const</span> <span class="dt">qint16</span> &amp;data )
{
    <span class="ot">QByteArray</span> ba;
    ba.append( high(data) );
    ba.append( low(data) );
    <span class="kw">return</span> ba;
}

<span class="ot">QByteArray</span> patchAddrLength( <span class="dt">const</span> <span class="dt">quint16</span> &amp;addr, <span class="dt">const</span> <span class="dt">quint16</span> &amp;length )
{
    <span class="ot">QByteArray</span> ba;
    <span class="co">// addr</span>
    ba.append( high(addr) );
    ba.append( low(addr) );
    <span class="co">// length</span>
    ba.append( high(length) );
    ba.append( low(length) );

    <span class="kw">return</span> ba;
}

<span class="ot">QByteArray</span> bytes2Bits( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;bytes, <span class="dt">const</span> <span class="dt">quint16</span> &amp;bitNum )
{
    <span class="ot">QByteArray</span> bits;

    <span class="kw">if</span> ( bitNum &gt; <span class="dv">8</span> * bytes.length() ) {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;bytes2bits wrong.&quot;</span><span class="co">;</span>
        <span class="kw">return</span> bits;
    }

    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; bitNum; ++i ) {
        bits.append( (<span class="dt">quint8</span>)( <span class="bn">0x1</span> &amp; bytes.at((<span class="dt">quint16</span>)i/<span class="dv">8</span>) &gt;&gt; i%<span class="dv">8</span> ) );
    }

    <span class="kw">return</span> bits;
}

<span class="ot">QString</span> parseBits2String( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;bits )
{
    <span class="ot">QString</span> str;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="dt">quint8</span> &amp;c, bits ) {
        str.append( c == <span class="dv">0</span> ? <span class="st">&quot;0 &quot;</span> : <span class="st">&quot;1 &quot;</span> );
    }
    <span class="kw">return</span> str;
}</code></pre></div>
<h1 id="&#20256;&#24863;&#22120;&#27169;&#22359;&#36873;&#35762;lms-&#21644;-imu-&#21644;-ur">4. &#20256;&#24863;&#22120;&#27169;&#22359;&#36873;&#35762;&#65288;LMS &#21644; IMU &#21644; UR&#65289;</h1>
<blockquote>
<p>&#31616;&#20171;&#22914;&#20309;&#20889;&#19968;&#20010;&#20256;&#24863;&#22120;&#20195;&#30721;&#65292;&#20026;&#31639;&#27861;&#27169;&#22359;&#25552;&#20379;&#25509;&#21475;&#65307;</p>
</blockquote>
<h2 id="lms">LMS</h2>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/lms_illus.png" class="w13" align="right" />

</div>
<p>&#22312;&#38405;&#35835;&#20102; <a href="http://gnat-tang-archive.qiniudn.com/lms.pdf">LMS &#35828;&#26126;&#25991;&#26723;</a> &#65292;&#26126;&#30333; LMS &#25968;&#25454;&#37319;&#38598;&#21644;&#23384;&#20648;&#22522;&#26412;&#21407;&#29702;&#21518;&#65292;LMS &#26159;&#25105;&#23436;&#25104;&#30340;&#31532;&#19968;&#20010;&#20256;&#24863;&#22120;&#27169;&#22359;&#12290;</p>
<p>&#20195;&#30721;&#23454;&#29616;&#19978;&#65292;&#20027;&#35201;&#25991;&#20214;&#26377;</p>
<ul>
<li>lmsreader.h</li>
<li>lmsreader.cpp</li>
<li>lmsreaderconfig.h</li>
<li>lmsreaderconfig.cpp</li>
<li>lmsreaderconfig.ui</li>
</ul>
<p>&#20854;&#20013; <code>lmsreader{.h, .cpp}</code> &#26159;&#23454;&#29616; LMS &#21151;&#33021;&#30340;&#31867;&#65292; <code>lmsreaderconfig{.h, .cpp, .ui}</code> &#26159;&#23545; LMS &#36827;&#34892;&#35774;&#32622;&#30340;&#30028;&#38754;&#12290;&#22522;&#20110;&#12304;&#30028;&#38754;&#65288;&#30456;&#24403;&#20110;&#19968;&#20010;&#20195;&#29702;&#65289;&#21644;&#31867;&#65288;&#23454;&#38469;&#24178;&#27963;&#30340;&#20154;&#65289;&#24212;&#24403;&#20302;&#32806;&#21512;&#12305;&#30340;&#21407;&#21017;&#65292; lmsreaderconfig &#30028;&#38754;&#21482;&#20570;&#31616;&#21333;&#30340; validation, confinement&#65292;&#23558;&#25353;&#38062;&#23545;&#24212;&#30456;&#24212;&#30340;&#20989;&#25968;&#65292;&#20869;&#37096;&#37117;&#26159;&#22312;&#35843;&#29992; lmsreader &#30340;&#20989;&#25968;&#12290;&#65288;&#20851;&#20110;&#20302;&#32806;&#21512;&#65292;&#35814;&#32454;&#35265;&#25105;&#20204;&#20043;&#21069;&#30340;&#25991;&#26723;&#65306; <a href="https://github.com/district10/changsha/blob/master/doc/modulize.md">changsha/modulize.md at master &#183; district10/changsha</a>&#65289;</p>
<p>LMS &#25552;&#20379;&#30340;&#22522;&#30784;&#21151;&#33021;&#26377;</p>
<ul>
<li><code>QString getAddress()</code>, &#33719;&#24471; LMS &#30340; IP &#22320;&#22336;</li>
<li><code>quint16 getPort()</code>, &#31471;&#21475;</li>
<li><code>void turnOnReading()</code>, &#24320;&#22987;&#35835;&#21462;</li>
<li><code>void turnOffReading()</code>, &#20572;&#27490;&#35835;&#21462;&#24182;&#20445;&#23384;</li>
<li><code>void getAngleStartEnd()</code>, &#35831;&#27714; LMS &#35774;&#32622;: &#25195;&#25551;&#36215;&#22987;&#35282;</li>
<li><code>void getFrequencyAngleresolution()</code>, &#35831;&#27714; LMS &#35774;&#32622;: &#25195;&#25551;&#39057;&#29575;, &#35282;&#24230;&#20998;&#36776;&#29575;</li>
</ul>
<p>&#25193;&#23637;&#21151;&#33021;&#65288;&#20854;&#23454;&#36825;&#20123;&#20195;&#30721;&#21482;&#35201;&#36816;&#34892;&#36807;&#19968;&#27425;&#23601;&#22909;&#65292;&#22240;&#20026; LMS &#30340;&#35774;&#23450;&#37117;&#35201;&#22266;&#23450;&#65292;&#19981;&#38656;&#35201;&#38543;&#26102;&#35843;&#25972;&#65289;</p>
<ul>
<li><code>void authorize()</code>, authorize &#21518;&#25165;&#33021;&#35774;&#32622;&#25195;&#25551;&#35282;&#24230;&#20998;&#36776;&#29575;, &#24674;&#22797;&#20986;&#21378;&#35774;&#32622;, etc</li>
<li><code>void setFactoryDefault()</code>, &#24674;&#22797;&#20986;&#21378;&#35774;&#32622;</li>
<li><code>void saveSettings()</code>, &#20445;&#23384;&#35774;&#32622;</li>
</ul>
<p>Signals (public)</p>
<ul>
<li><code>void angle_start_end(int beg, int end)</code>, &#25195;&#25551;&#35282;&#24230;&#33539;&#22260;</li>
<li><code>void frequency_angleresolution(int freq, double res)</code>, &#39057;&#29575;,&#35282;&#24230;&#20998;&#36776;&#29575;</li>
<li><code>void authorization_passed(bool auth)</code></li>
<li><code>void scanning(int i, int freq)</code>, for showing 1/50~50/50 or 1/25~25/25</li>
</ul>
<p>&#19979;&#38754;&#30452;&#25509;&#30475;&#20195;&#30721;&#12290;</p>
<p>&#39318;&#20808;&#25105;&#20204;&#23450;&#20041;&#20102;&#19968;&#20123;&#26631;&#24535;&#20301;&#65292;&#26041;&#20415; LMS &#22312;&#19981;&#21516;&#26465;&#20214;&#19979;&#24037;&#20316;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#ifndef LMSREADER_H</span>
<span class="ot">#define LMSREADER_H</span>

<span class="ot">#define LMS_USE_THREAD              (  true   )</span>
<span class="ot">#define LMS_PARSE_ON_THE_FLY        (  true   )  </span><span class="co">// on the fly: slightly slower</span>
<span class="ot">#define LMS_PRINT_SCAN_BUF          (  false  )  </span><span class="co">// flags for debugging</span>
...
<span class="ot">#define LMS_PROFILE_SIZE            (  50*60*5 )</span>
<span class="ot">#define LMS_DEFAULT_ADDRESS         ( &quot;192.168.0.1&quot; )</span>
<span class="ot">#define LMS_DEFAULT_PORT            ( 2111 )</span>
<span class="ot">#define LMS_PROFILE_POINTS_NUM      ( 541 )</span>
...

<span class="ot">#define M_PI (3.14159265358979323846)</span>

<span class="ot">#include &quot;datastruct.h&quot;</span>
<span class="ot">#include &quot;utils.h&quot;</span>
<span class="ot">#include &quot;logger.h&quot;</span>
<span class="ot">#include &lt;QStringList&gt;</span>
<span class="ot">#include &lt;QTcpSocket&gt;   </span><span class="co">// &#25552;&#20379; TCP &#32593;&#32476;&#21151;&#33021;</span>
<span class="ot">#include &lt;QHash&gt;</span>
<span class="ot">#include &lt;string&gt;</span>

<span class="ot">#ifndef Q_MOC_RUN</span>
<span class="ot">#include &lt;boost/thread.hpp&gt;</span>
<span class="ot">#include &lt;boost/thread/mutex.hpp&gt;</span>
<span class="ot">#include &lt;boost/thread/condition.hpp&gt;</span>
<span class="ot">#include &lt;boost/chrono/chrono.hpp&gt;</span>
<span class="ot">#endif</span></code></pre></div>
<p>&#20854;&#20013;&#26368;&#37325;&#35201;&#30340;&#26159; <code>#define LMS_PARSE_ON_THE_FLY</code>&#65292;&#23427;&#20915;&#23450;&#20102; LMS &#37319;&#38598;&#21040;&#30340;&#25968;&#25454;&#35201;&#19981;&#35201;&#22312;&#32447;&#36716;&#21270;&#20026;&#22352;&#26631;&#28857;&#12290;&#36825;&#37324;&#29992;&#30340;&#26159;&#23439;&#32780;&#19981;&#26159; enum hack&#65292;&#20027;&#35201;&#32771;&#34385;&#30340;&#26159;&#36825;&#20123;&#21464;&#37327;&#36824;&#35201;&#34987;&#31639;&#27861;&#27169;&#22359;&#29992;&#21040;&#65292;enum hack &#26377;&#20316;&#29992;&#22495;&#65292;&#22312;&#22806;&#37096;&#20351;&#29992;&#36215;&#26469;&#27809;&#26377;&#23439;&#26041;&#20415;&#12290;&#37027;&#20010; <code>M_PI</code> &#26159;&#20174; math.h &#25335;&#36125;&#26469;&#30340;&#65288;&#37027;&#20960;&#20010; <code>USE_MATH_DEFINITIONS</code> &#20043;&#31867;&#30340;&#20960;&#20010;&#30772;&#23439;&#30495;&#26159;&#22826;&#40635;&#28902;&#20102;&#65292;&#25152;&#20197;&#25105;&#32034;&#24615;&#32473;&#23427;&#25335;&#36125;&#36807;&#26469;&#20102;&#65289;&#12290;</p>
<p>&#36824;&#29992;&#21040;&#20102; boost &#24211;&#30340;&#22810;&#32447;&#31243;&#65292;&#25152;&#20197;&#21152;&#19978;&#20102;&#23427;&#30340;&#22836;&#25991;&#20214;&#12290;<code>boost/chrono/chrono.hpp</code> &#21407;&#26412;&#26159;&#35201;&#20570;&#26102;&#38388;&#25139;&#65292;&#20294;&#21518;&#26469;&#25105;&#20204;&#29992;&#20102; Qt &#30340; QDateTime&#65292;&#25152;&#20197;&#20854;&#23454;&#24050;&#32463;&#34987;&#24223;&#32622;&#20102;&#12290;</p>
<p>&#33267;&#20110;&#37027;&#20010; <code>#ifndef Q_MOC_RUN</code>&#65292;&#25105;&#20204;&#26159;&#30896;&#21040;&#20102;&#38382;&#39064;&#25165;&#21152;&#19978;&#30340;&#12290;&#35828;&#26159;&#8220;&#25105;&#20204;&#19981;&#24076;&#26395; Qt &#30340; <code class="sourceCode bash"><span class="kw">moc</span></code> &#23545; Boost &#30340;&#22836;&#25991;&#20214;&#36827;&#34892; moc&#65292;&#25152;&#20197;&#21482;&#22312; moc &#21069; include&#12290;&#8221;&#65292;&#20294;&#25105;&#20854;&#23454;&#19981;&#25026;&#65292;&#20026;&#20160;&#20040; moc &#35201;&#22788;&#29702; boost &#30340;&#20195;&#30721;&#65311;&#8230;&#8230;</p>
<p>LMSReader &#36890;&#36807; TCP &#21644; LMS &#36830;&#25509;&#65292;&#36827;&#34892;&#36890;&#20449;&#65292;&#23427;&#39318;&#20808;&#38598;&#25104;&#33267; QTcpSocket &#31867;&#12290;&#36825;&#20010;&#31867;&#20027;&#35201;&#25552;&#20379;&#65306;</p>
<ul>
<li><code>readyReady</code> &#20449;&#21495;&#65292;&#24403;&#25968;&#25454;&#26469;&#20102;&#30340;&#26102;&#20505;&#65292;&#36825;&#20010;&#20449;&#21495;&#34987; emit&#65307;</li>
<li><code>read</code> &#20989;&#25968;&#65292;&#21487;&#20197;&#35835;&#21462;&#32593;&#32476;&#25968;&#25454;&#65292;&#31867;&#20284;&#30340;&#36824;&#26377; <code>readAll</code> &#20989;&#25968;&#65292;&#31561;&#31561;&#65292;&#23427;&#20204;&#36820;&#22238;&#30340;&#37117;&#26159; <code>QByteArray</code> &#31867;&#22411;&#30340;&#25968;&#25454;&#65307;</li>
<li><code>write</code> &#20989;&#25968;&#65292;&#21487;&#20197;&#20889;&#20986;&#25968;&#25454;&#12290;</li>
</ul>
<p>&#19979;&#38754;&#26159;&#20027;&#35201;&#20195;&#30721;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">class</span> LMSReader : <span class="kw">public</span> <span class="ot">QTcpSocket</span>
{
    <span class="kw">Q_OBJECT</span>

<span class="kw">private</span>:
    <span class="kw">enum</span> LMSAction { GET_FREQ_ANGRES, SET_FREQ_ANGRES, GET_ANGBEG_ANGEND, SET_ANGBEG_ANGEND, ...  };
    <span class="kw">typedef</span> <span class="ot">QHash</span>&lt;LMSAction, <span class="ot">QString</span>&gt; ActionType;
    <span class="dt">const</span> <span class="dt">static</span> ActionType actions;
    <span class="co">// &#36825;&#26159;&#36807;&#24230;&#24037;&#31243;&#30340;&#36951;&#36857;</span>
    <span class="dt">static</span> ActionType configureActions( );

    <span class="kw">enum</span> LMSAuth {
        AUTH_MAINTENANCE          = <span class="bn">0x02</span>,
        AUTH_AUTHEDCLIENT         = <span class="bn">0x03</span>,
        AUTH_SERVICELEVEL         = <span class="bn">0x04</span>,
    };
    <span class="kw">typedef</span> <span class="ot">QHash</span>&lt;LMSAuth, <span class="ot">QString</span>&gt; AuthType;
    <span class="dt">const</span> <span class="dt">static</span> AuthType auths;
    <span class="co">// &#36825;&#20063;&#26159;&#36807;&#24230;&#24037;&#31243;&#30340;&#36951;&#36857;</span>
    <span class="dt">static</span> AuthType configureAuthLevels( );

    <span class="co">// &#20889;&#36807;&#20960;&#27425;&#20195;&#30721;&#65292;&#20320;&#23601;&#35760;&#20303;&#20102; static &#23545;&#35937;&#65292;&#12304;&#21482;&#12305;&#26377; int &#22411;&#21487;&#20197;&#22312;&#22768;&#26126;&#30340;&#26102;&#20505;&#23601;&#21021;&#22987;&#21270;&#12290;</span>
    <span class="co">// &#65288;&#20063;&#19981;&#29992;&#20877;&#22312;&#31867;&#22806;&#20877;&#23450;&#20041;&#65289;</span>
    <span class="dt">const</span> <span class="dt">static</span> <span class="dt">int</span> lmsAngleMin  = <span class="dv">-45</span>;
    <span class="dt">const</span> <span class="dt">static</span> <span class="dt">int</span> lmsAngleMax  = <span class="dv">225</span>;

    <span class="kw">enum</span> LMSUserLevel {
        MAINTENANCE               = <span class="bn">0x02</span>,
        AUTHORIZED_CLIENT         = <span class="bn">0x03</span>,
        SERVICE                   = <span class="bn">0x04</span>,
    };

    <span class="kw">enum</span> {
        <span class="co">// STX, ETX &#36825;&#20004;&#20010; ASCII &#23383;&#31526;&#20102;&#35299;&#19968;&#19979;&#26159;&#19981;&#38169;&#30340;&#65292;&#21069;&#32773;&#26159;</span>
        <span class="co">// STX: start of text&#65292;&#21518;&#32773;&#26159;</span>
        <span class="co">// ETX: end   of text</span>
        STX                       = <span class="bn">0x02</span>,
        ETX                       = <span class="bn">0x03</span>,
        AUTHORIZATION_SUCCESS     = <span class="dv">1</span>,
        AUTHORIZATION_FAULURE     = <span class="dv">0</span>,
        ANGLE_SCALE_FACTOR        = <span class="dv">10000</span>,          <span class="co">/* 1/10000 Hz   */</span>
        FREQUENCY_SCALE_FACTOR    = <span class="dv">100</span>,            <span class="co">/* 1/100 Degree */</span>
    };

    <span class="ot">QString</span> address;            <span class="co">// LMS &#30340; ip &#22320;&#22336;</span>
    <span class="dt">quint16</span> port;               <span class="co">// LMS &#30340;&#31471;&#21475;&#65292;&#40664;&#35748; 2111&#65292;LMS &#30456;&#24403;&#20110;&#19968;&#20010;&#26381;&#21153;&#22120;&#65292;</span>
                                <span class="co">// &#23427;&#20250;&#32473;&#27599;&#19968;&#20010;&#36830;&#25509;&#21457;&#36865;&#25968;&#25454;&#65288;&#35201;&#20808;&#35831;&#27714; LMS &#21457;&#36865;&#25968;&#25454;&#65289;</span>
    <span class="ot">QByteArray</span> lmsBA;
<span class="ot">#ifdef LMS_PRINT_PROFILE_SAMPLE</span>
    <span class="ot">QByteArray</span> zgBA;
<span class="ot">#endif</span>

    <span class="dt">int</span> lmsFrequency;           <span class="co">// &#19968;&#20123;&#21464;&#37327;</span>
    <span class="dt">double</span> lmsAngleRes;
    <span class="dt">double</span> lmsAngleBeg;
    <span class="dt">double</span> lmsAngleEnd;
    size_t lmsCount;

<span class="kw">public</span>:
    <span class="dt">bool</span> isRun;
    <span class="dt">bool</span> connected;
    <span class="dt">int</span> profileCur;
    boost::mutex mutex;
    vector&lt;<span class="ot">QStringList</span>&gt; profiles_raw;
    profile_t profilesX[ LMS_PROFILE_SIZE ];
    ...</code></pre></div>
<p>&#36825;&#37324;&#20540;&#24471;&#19968;&#25552;&#30340;&#26159; profilesX&#65292;&#23427;&#21407;&#26469;&#20063;&#26159;&#29992;&#30340; vector&#65292;&#20294;&#26159;&#32769;&#20986;&#38382;&#39064;&#65292;&#21518;&#26469;&#21457;&#29616;&#21407;&#26469;&#26159; <code>push_back</code> &#22826;&#22810;&#21518;&#65292; vector &#30340;&#39318;&#22320;&#22336;&#23601;&#25442;&#20102;&#20301;&#32622;&#65288;&#21407;&#26469;&#30340;&#22320;&#26041;&#25918;&#19981;&#19979;&#65292;&#20110;&#26159;&#23427;&#37325;&#26032;&#20998;&#37197;&#20102;&#19968;&#20010;&#36830;&#32493;&#31354;&#38388;&#65289;&#65292;&#20110;&#26159;&#25105;&#20204;&#20889;&#27515;&#20102;&#22823;&#23567;&#65292;&#25442;&#25104;&#20102;&#25968;&#32452;&#12290;</p>
<p>&#19981;&#36807;&#29616;&#22312;&#30693;&#36947;&#65292;vector &#20063;&#21487;&#20197;&#39044;&#30041;&#22823;&#23567;==&#65292;&#23450;&#20041;&#30340;&#26102;&#20505;&#30452;&#25509;&#29992; <code>vector&lt;T&gt; v(t, a_big_number)</code> &#23601;&#21487;&#20197;&#20102;&#21834;&#12290;</p>
<p>&#21478;&#22806;&#20540;&#24471;&#19968;&#25552;&#30340;&#26159;&#37027;&#20010; <code>bool isRun</code>&#65292;&#21407;&#26469;&#25105;&#20204;&#20351;&#29992;&#30340;&#26159;&#20989;&#25968;&#20869;&#30340;&#38745;&#24577;&#25104;&#21592;&#65292;&#20294;&#23454;&#38469;&#29992;&#20102;&#25165;&#21457;&#29616;&#25105;&#20204;&#30340;&#20004;&#20010; LMS &#20940;&#20081;&#20102;&#65292;&#22240;&#20026;&#20004;&#20010;&#25104;&#21592; lms1 &#21644; lms2 &#23621;&#28982;&#20351;&#29992;&#20102;&#19968;&#20010; <code>isRun</code>&#65292;&#20294;&#23427;&#20204;&#24212;&#24403;&#26159;&#29420;&#31435;&#30340;&#12290;&#36825;&#20063;&#26159;&#23454;&#36341;&#36807;&#31243;&#20013;&#30896;&#21040;&#30340;&#19968;&#20010;&#22823;&#22353;&#12290;</p>
<p>&#25509;&#30528;&#19978;&#38754;&#30340;&#20195;&#30721;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// class LMSReader() {</span>
    ...

<span class="kw">public</span>:
    <span class="kw">explicit</span> LMSReader( );
    ~ LMSReader( );

    <span class="co">// &#22825;&#30693;&#36947;&#25105;&#33457;&#20102;&#22810;&#23569;&#26102;&#38388;&#20889;&#36825;&#20123;&#26080;&#32842;&#30340; getter&#12289;setter &#20989;&#25968;</span>
    <span class="co">//!</span> configure LMS address &amp; port
    <span class="dt">void</span> setAddressPort( <span class="dt">const</span> <span class="ot">QString</span> &amp;address, <span class="dt">const</span> <span class="dt">quint16</span> &amp;port );
    <span class="dt">void</span> resetAddressPort( );
    <span class="ot">QString</span> getAddress( ) { <span class="kw">return</span> address; }
    <span class="dt">quint16</span> getPort( ) { <span class="kw">return</span> port; }

    <span class="co">//!</span> set basedir of output
    <span class="co">// &#27627;&#26080;&#24517;&#35201;&#30340;&#37325;&#36733;&#65292;&#24403;&#26102;&#24212;&#35813;&#22312;&#39033;&#30446;&#32452;&#37324;&#25512; QString&#65292;&#20294;&#26159;&#22823;&#23478;&#20284;&#20046;&#37117;&#21916;&#27426; std::string&#65292;</span>
    <span class="co">// &#25105;&#20498;&#26159;&#35273;&#24471; QString &#22909;&#29992;&#24471;&#22810;&#22826;&#22810;&#12290;</span>
    <span class="dt">void</span> setBasedir( <span class="dt">const</span> string &amp;bd )  { basedir = <span class="ot">QString</span>( bd.c_str() ); }
    <span class="dt">void</span> setBasedir( <span class="dt">const</span> <span class="dt">char</span> *bd )    { basedir = <span class="ot">QString</span>( bd ); }
    <span class="dt">void</span> setBasedir( <span class="dt">const</span> <span class="ot">QString</span> &amp;bd ) { basedir = bd; }

    <span class="dt">void</span> postparse( );
    <span class="dt">void</span> start( <span class="dt">qint64</span> ts = <span class="dv">0</span> );
    <span class="dt">void</span> stop( );
    <span class="dt">void</span> closeConnection( );

    <span class="dt">void</span> pollingOne( );
    <span class="dt">void</span> turnOnReadingInLazyMode( );
    <span class="dt">void</span> turnOnReading( );
    <span class="dt">void</span> turnOffReading( );
    <span class="co">// &#36825;&#37324;&#21024;&#25481;&#20102;&#24456;&#22810;&#20989;&#25968;&#22768;&#26126;&#65292;&#22240;&#20026;&#23427;&#20204;&#27809;&#24517;&#35201;&#22312;&#36825;&#37324;&#25552;&#21040;</span>

<span class="kw">private</span>:
    <span class="ot">QString</span> basedir;
    <span class="dt">void</span> writeLMS( <span class="dt">const</span> <span class="ot">QString</span> &amp;msg );
    <span class="dt">void</span> parse( <span class="dt">const</span> <span class="ot">QStringList</span> &amp;bufstrlist );
    <span class="dt">void</span> postparse( <span class="ot">QStringList</span> &amp;bufstrlist, profile_t &amp;profile );
    ...</code></pre></div>
<p>&#19979;&#38754;&#26159;&#19968;&#20123; signal/slots&#65288;&#20449;&#21495;&#21644;&#27133;&#65289;&#65292;&#20027;&#35201;&#29992;&#20110;&#21578;&#35785;&#20027;&#30028;&#38754;&#65292;LMS &#37197;&#32622;&#22909;&#20102;&#65292;&#21487;&#20197;&#36827;&#34892;&#20989;&#25968;&#22238;&#35843;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// class LMSReader() {</span>
    ...

<span class="kw">signals</span>:
    <span class="dt">void</span> angle_begin_end( <span class="dt">int</span> beg, <span class="dt">int</span> end );
    <span class="dt">void</span> frequency_angleresolution( <span class="dt">int</span> freq, <span class="dt">double</span> res );
    <span class="dt">void</span> authorization_passed( <span class="dt">bool</span> auth );
    <span class="dt">void</span> scanning( <span class="dt">int</span> i, <span class="dt">int</span> freq );
    <span class="dt">void</span> lmsConnected( <span class="dt">bool</span> on );

<span class="kw">public</span> <span class="kw">slots</span>:
    <span class="dt">void</span> connectToLMS( );
    <span class="dt">void</span> connectToLMS( <span class="ot">QString</span> addr, <span class="dt">quint16</span> port );
    <span class="dt">void</span> readLMS( );
    <span class="dt">void</span> lmsConnectionError( <span class="ot">QAbstractSocket::</span>SocketError );
    <span class="dt">void</span> onStateChanged( <span class="ot">QAbstractSocket::</span>SocketState state );
};</code></pre></div>
<p>&#20174; LMS &#30340;&#35828;&#26126;&#25991;&#26723;&#37324;&#65292;&#25105;&#30693;&#36947;&#27599;&#20010;&#23545; LMS &#30340;&#25805;&#20316;&#65292;&#20854;&#23454;&#37117;&#26159;&#21521; LMS &#21457;&#36865;&#19968;&#20010;&#29305;&#23450;&#30340;&#23383;&#31526;&#20018;&#12290;&#20110;&#26159;&#25105;&#36807;&#24230;&#24037;&#31243;&#22320;&#65288;&#20026;&#20160;&#20040;&#21448;&#26159;&#36807;&#24230;&#24037;&#31243;==&#65289;&#25226;&#36825;&#20123;&#23383;&#31526;&#20018;&#36215;&#20102;&#21517;&#23383;&#65292;&#36824;&#29992;&#20102; QHash&#65306;</p>
<pre><code>enum LMSAction {
    GET_FREQ_ANGRES,
    SET_FREQ_ANGRES,
    GET_ANGBEG_ANGEND,
    SET_ANGBEG_ANGEND,
    ...
};
typedef QHash&lt;LMSAction, QString&gt; ActionType;
const static ActionType actions;
static ActionType configureActions( );</code></pre>
<p>&#29616;&#22312;&#24819;&#24819;&#30495;&#26159;&#27627;&#19981;&#24517;&#35201;&#12290;</p>
<p>lmsreader.cpp &#37324;&#30340;&#23454;&#29616;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">const</span> LMSReader::ActionType LMSReader::actions = LMSReader::configureActions( );
<span class="co">// &#23454;&#29616;&#26159;&#65306;</span>
<span class="co">//  LMSReader::ActionType LMSReader::configureActions( )</span>
<span class="co">//  {</span>
<span class="co">//      LMSReader::ActionType actions;</span>
<span class="co">//      actions[  GET_FREQ_ANGRES    ] = &quot;sRN LMPscancfg&quot;;</span>
<span class="co">//      actions[  SET_FREQ_ANGRES    ] = &quot;sMN mLMPsetscancfg&quot;;</span>
<span class="co">//      actions[  GET_ANGBEG_ANGEND  ] = &quot;sRN LMPoutputRange&quot;;</span>
<span class="co">//      ...</span>
<span class="co">//      return actions;</span>
<span class="co">//  }</span>

<span class="dt">const</span> LMSReader::AuthType LMSReader::auths = LMSReader::configureAuthLevels( );
<span class="co">// &#23454;&#29616;&#26159;&#65306;</span>
<span class="co">//  LMSReader::AuthType LMSReader::configureAuthLevels( )</span>
<span class="co">//  {</span>
<span class="co">//      LMSReader::AuthType authLevels;</span>

<span class="co">//      authLevels[  AUTH_MAINTENANCE   ] = &quot;B21ACE26&quot;;</span>
<span class="co">//      authLevels[  AUTH_AUTHEDCLIENT  ] = &quot;F4724744&quot;;</span>
<span class="co">//      authLevels[  AUTH_SERVICELEVEL  ] = &quot;81BE23AA&quot;;</span>

<span class="co">//      // Logger::log( BCD::LMS::CONFIG_AUTH_LEVELS );</span>
<span class="co">//      return authLevels;</span>
<span class="co">//  }</span></code></pre></div>
<p>&#27627;&#26080;&#30097;&#38382;&#65292;&#36825;&#20004;&#20010; hash &#27627;&#26080;&#24517;&#35201;&#12290;&#24403;&#26102;&#25105;&#36824;&#25554;&#20102;&#65292;&#35828;&#26159; QHash &#21644; QMap &#30340;&#25509;&#21475;&#20960;&#20046;&#19968;&#26679;&#65292;&#20294;&#26159; QHash &#25928;&#29575;&#39640;&#19968;&#28857;&#65292;&#25152;&#20197;&#36825;&#37324;&#29992;&#30340;&#26159; QHash&#12290;&#20294;&#65292;&#25105;&#20204;&#30340;&#23454;&#38469;&#65292;&#29992;&#21738;&#20010;&#20854;&#23454;&#37117;&#19968;&#26679;&#65292;&#26368;&#22909;&#19981;&#35201;&#29992;==&#12290;</p>
<p>&#22312; LMS &#30340;&#26500;&#36896;&#20989;&#25968;&#37324;&#65292;&#35201;&#38142;&#25509;&#19968;&#20123;&#27133;&#20989;&#25968;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(readyRead() ),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(readLMS()) );
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectToLMS()) );
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(error(<span class="ot">QAbstractSocket::</span>SocketError)),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(lmsConnectionError(<span class="ot">QAbstractSocket::</span>SocketError)) );
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(stateChanged(<span class="ot">QAbstractSocket::</span>SocketState)),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(onStateChanged(<span class="ot">QAbstractSocket::</span>SocketState)) ); <span class="co">// &#36825;&#20010;&#20989;&#25968;&#20250;&#25552;&#31034;&#30028;&#38754; LMS &#26159;&#21542;&#8220;&#25481;&#32447;&#8221;</span>

<span class="co">// &#36825;&#26159;&#26085;&#24535;&#32426;&#24405;&#65292;&#21518;&#38754;&#30340; Logger::log &#20043;&#31867;&#20195;&#30721;&#25105;&#23601;&#21435;&#25481;&#20102;&#12290;</span>
Logger::log( BCD::LMS::CONSTRUCT );</code></pre></div>
<p>&#36825;&#20010; lmsConnectionError &#26159;&#19968;&#20010;&#26080;&#32842;&#30340;&#20989;&#25968;&#65292;&#35201;&#26159;&#26377; C++11&#65292;&#35841;&#36824;&#19987;&#38376;&#20889;&#19968;&#20010;&#36825;&#20989;&#25968;&#21834;&#65281;&#29992; lambda &#20989;&#25968;&#19981;&#23601;&#22909;&#20102;&#12290;&#25105;&#20204;&#21487;&#20197;&#25226;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(error(<span class="ot">QAbstractSocket::</span>SocketError)),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(lmsConnectionError(<span class="ot">QAbstractSocket::</span>SocketError)) ); <span class="co">// &#36830;&#25509;&#21040;&#36825;&#20010;&#27133;</span>
...
<span class="co">// &#23454;&#29616;&#23427;</span>
<span class="dt">void</span> LMSReader::lmsConnectionError( <span class="ot">QAbstractSocket::</span>SocketError err )
{
    Logger::log (  BCD::LMS::CONNECTION_ERROR, <span class="ot">QString</span>( err ) );
}</code></pre></div>
<p>&#25913;&#25104;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(error(<span class="ot">QAbstractSocket::</span>SocketError)),
         <span class="kw">this</span>, [=](<span class="ot">QAbstractSocket::</span>SocketError err) {  <span class="co">// &#30452;&#25509;&#22312;&#36825;&#37324;&#23454;&#29616;</span>
            Logger::log (  BCD::LMS::CONNECTION_ERROR, <span class="ot">QString</span>( err ) );
        } );</code></pre></div>
<p>&#22909;&#30475;&#22810;&#20102;&#65292;&#26159;&#21543;~</p>
<p>&#26512;&#26500;&#30340;&#26102;&#20505;&#65292;&#20808;&#20851;&#38381;&#32593;&#32476;&#36830;&#25509;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">LMSReader::~LMSReader( )
{
    closeConnection();
    Logger::log( BCD::LMS::DESTRUCT );
}

<span class="co">// &#36825;&#26159;&#23454;&#29616;&#20195;&#30721;</span>
<span class="dt">void</span> LMSReader::closeConnection( )
{
    <span class="kw">if</span> ( isOpen() ) {
        close();
        Logger::log (  BCD::LMS::DISCONNECT );
    }
}</code></pre></div>
<p>&#25353;&#29031;&#32422;&#23450; LMS &#21457;&#36865;&#30340;&#25968;&#25454;&#24212;&#35813;&#28385;&#36275;&#26684;&#24335;&#65306;<code>STX + &#25968;&#25454;&#23383;&#33410; + ETX</code>&#65292; STX &#21644; ETX &#26631;&#24535;&#20102;&#25968;&#25454;&#30340;&#19968;&#24103;&#12290;&#19968;&#24103;&#25968;&#25454;&#23601;&#26159;&#19968;&#27425;&#25195;&#25551;&#65292;&#22823;&#27010;&#26377; 550 &#20010;&#25195;&#25551;&#28857;&#65288;&#20855;&#20307;&#22312;&#12304;LMS &#30340;&#25968;&#25454;&#37327;&#12305;&#37324;&#21487;&#20197;&#30475;&#21040;&#65289;&#65292;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::writeLMS( <span class="dt">const</span> <span class="ot">QString</span> &amp;data )
{
    <span class="ot">QByteArray</span> ba;
    ba.append( <span class="bn">0x02</span> ); <span class="co">// &lt;STX&gt;, start of text&#65292;&#23601;&#35828;&#20102;&#20043;&#21069;&#30340;&#37027;&#20010; enum hack &#37324;&#30340;</span>
                       <span class="co">// STX&#65292;ETX &#26159;&#36807;&#24230;&#24037;&#31243;&#65292;&#22240;&#20026;&#21482;&#26377;&#25105;&#33258;&#24049;&#29992;&#36825;&#20004;&#20010;&#21464;&#37327;&#65292;&#25105;&#21448;&#27809;&#26377;&#29992;&#65281;</span>
    ba.append( data );
    ba.append( <span class="bn">0x03</span> ); <span class="co">// &lt;ETX&gt;, end of text</span>
    write( ba );
}</code></pre></div>
<p>&#20854;&#20013;&#30340; <code>write</code> &#20989;&#25968;&#26159; QTcpSocket &#25552;&#20379;&#30340;&#12290;&#20854;&#23454; <code>ba.append( data )</code> &#21487;&#20197;&#26356;&#26041;&#20415;&#22320;&#20889;&#25104; <code>ba &lt;&lt; data</code>&#65292;&#20294;&#26159;&#25105;&#20889;&#20064;&#24815;&#20102;&#65292;&#25152;&#20197;&#20960;&#20046;&#27809;&#26377;&#29992;&#36807; <code>operator&lt;&lt;</code>==&#12290;</p>
<p>&#36824;&#26377;&#22914;&#19979;&#30340;&#19968;&#20123;&#20989;&#25968;&#65292;&#23384;&#22312;&#26377;&#24847;&#20041;&#65292;&#20294;&#26159;&#20960;&#20046;&#22312;&#25105;&#20889;&#23436;&#21518;&#65292;&#21482;&#35774;&#32622;&#20102;&#19968;&#36941;&#65292;&#23601;&#19981;&#38656;&#35201;&#20877;&#20351;&#29992;&#20102;==&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#22240;&#20026;&#25105;&#20204;&#21482;&#35201; authorize &#19968;&#27425;&#65292;&#23601;&#33021;&#35774;&#23450; LMS &#30340;&#36215;&#22987;&#25195;&#25551;&#35282;&#24230;&#12289;&#25195;&#25551;&#30340;&#35282;&#24230;&#20998;&#36776;&#29575;&#12289;&#39057;&#29575;</span>
<span class="co">// &#28982;&#21518;&#23427;&#23601;&#22266;&#23450;&#19979;&#26469;&#20102;</span>
<span class="dt">void</span> LMSReader::authorize( )
{
    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;</span><span class="ch">%s</span><span class="st"> </span><span class="ch">%2d</span><span class="st"> </span><span class="ch">%s</span><span class="st">&quot;</span>,
                 <span class="fu">qPrintable</span>(actions.value( AUTHORIZE )),
                 AUTH_AUTHEDCLIENT,
                 <span class="fu">qPrintable</span>(auths.value( AUTH_AUTHEDCLIENT )) );
    writeLMS( str );

    Logger::log( BCD::LMS::AUTHORIZE );
}

<span class="co">// &#20063;&#27809;&#26377;&#24517;&#35201;&#20877;&#27425;&#33719;&#21462;&#36215;&#22987;&#25195;&#25551;&#35282;&#24230;&#65292;&#35282;&#24230;&#20998;&#36776;&#29575;&#31561;&#20102;</span>
<span class="dt">void</span> LMSReader::getAngleStartEnd( )
{
    writeLMS( actions[ GET_ANGBEG_ANGEND ] );

    Logger::log( BCD::LMS::ASK_SCANNING_ANGLE_START_END );
}

<span class="dt">void</span> LMSReader::getFrequencyAngleresolution( ) { ... }
<span class="dt">void</span> LMSReader::setFrequencyAngleresolution( <span class="dt">const</span> <span class="dt">int</span> &amp;freq,
                                             <span class="dt">const</span> <span class="dt">double</span> &amp;angres )
{
    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;</span><span class="ch">%s</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%d</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st">&quot;</span>,
                 <span class="fu">qPrintable</span>( actions[ SET_FREQ_ANGRES ] ),
                 FREQUENCY_SCALE_FACTOR * (freq),         <span class="co">// 25 or 50 Hz</span>
                 <span class="dv">1</span>,                                       <span class="co">// reserved</span>
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * (angres)),   <span class="co">// 0.25 or 0.5 degree</span>
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * (<span class="dv">-45</span> + <span class="dv">0</span>)),  <span class="co">// place holder</span>
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * (<span class="dv">225</span> - <span class="dv">0</span>))   <span class="co">// place holder</span>
               );
    writeLMS( str );

    Logger::log ( BCD::LMS::SET_SCANNING_FREQ_ANGRES,
                  <span class="ot">QString</span>( <span class="st">&quot;freq: %1, angres: %2&quot;</span> ).arg( freq ).arg( angres ) );
}

<span class="dt">void</span> LMSReader::setAngleStartEnd( <span class="dt">double</span> start, <span class="dt">double</span> end )
{
    <span class="kw">if</span> ( start  &gt; end )         { <span class="kw">return</span>; }
    <span class="kw">if</span> ( start  &lt; lmsAngleMin ) { start = lmsAngleMin; }
    <span class="kw">if</span> ( end    &gt; lmsAngleMax ) { end = lmsAngleMax; }

    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;</span><span class="ch">%s</span><span class="st"> </span><span class="ch">%d</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st">&quot;</span>,
                 <span class="fu">qPrintable</span>( actions[ SET_ANGBEG_ANGEND ] ),
                 <span class="dv">1</span>,                                  <span class="co">// status code</span>
                 FREQUENCY_SCALE_FACTOR * (<span class="dv">25</span>),      <span class="co">// place holder</span>
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * start),
                 (<span class="dt">int</span>) (ANGLE_SCALE_FACTOR * end) );
    writeLMS( str );

    Logger::log ( BCD::LMS::SET_SCANNING_ANGLE_START_END,
                  <span class="ot">QString</span>( <span class="st">&quot;start: %1, end: %2&quot;</span> ).arg( start ).arg( end ) );
}


<span class="dt">void</span> LMSReader::setTimestamp( <span class="dt">quint16</span> year        <span class="co">/* = 2015 */</span>
                            , <span class="dt">quint8</span> month        <span class="co">/* =    1 */</span>
                            , <span class="dt">quint8</span> day          <span class="co">/* =    1 */</span>
                            , <span class="dt">quint8</span> hour         <span class="co">/* =    0 */</span>
                            , <span class="dt">quint8</span> minute       <span class="co">/* =    0 */</span>
                            , <span class="dt">quint8</span> second       <span class="co">/* =    0 */</span>
                            , <span class="dt">quint8</span> microsecond  <span class="co">/* =    0 */</span> )
{
    <span class="ot">QString</span> str;
    <span class="co">//               Y  M  D  H  M  S MS</span>
    str.sprintf( <span class="st">&quot;</span><span class="ch">%s</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st"> </span><span class="ch">%X</span><span class="st">&quot;</span>,
                 <span class="fu">qPrintable</span>( actions[SET_TIMESTAMP] ),
                 year, month, day,
                 hour, minute, second,
                 microsecond );
    writeLMS( str );

    Logger::log( BCD::LMS::SET_TIMESTAMP,
                 <span class="ot">QString</span>( <span class="st">&quot;</span><span class="ch">%1/%</span><span class="st">2/</span><span class="ch">%3-%</span><span class="st">4:</span><span class="ch">%5:%</span><span class="st">6.%7&quot;</span> )
                 .arg( year )
                 .arg( month )
                 .arg( day )
                 .arg( hour )
                 .arg( minute )
                 .arg( second )
                 .arg( microsecond ) );
}

<span class="co">// &#36824;&#26377;&#19968;&#20123;&#31867;&#20284;&#30340;&#20195;&#30721;&#65292;&#23601;&#19981;&#19968;&#19968;&#36148;&#22312;&#36825;&#37324;&#20102;</span>
<span class="dt">void</span> LMSReader::setFactoryDefault( ) { ... }
<span class="dt">void</span> LMSReader::setFactoryDefault( ) { ... }
<span class="dt">void</span> LMSReader::getTimestamp( ) { ... }
<span class="dt">void</span> LMSReader::logout( ) { ... }
<span class="dt">void</span> LMSReader::startMeasure( ) { ... }
<span class="dt">void</span> LMSReader::stopMeasure( ) { ... }
<span class="dt">void</span> LMSReader::reboot( ) { ... }
<span class="dt">void</span> LMSReader::pollingOne( ) { ... }
<span class="dt">void</span> LMSReader::connectToLMS( ) { ... }
<span class="dt">void</span> LMSReader::connectToLMS( <span class="ot">QString</span> addr, <span class="dt">quint16</span> port ) { ... }</code></pre></div>
<p>LMS &#30340;&#25968;&#25454;&#24212;&#35813;&#20445;&#23384;&#20986;&#26469;&#65292;&#20294;&#26159;&#27809;&#24517;&#35201;&#23384;&#21040; log &#37324;&#65292;&#25152;&#20197;&#23427;&#27599;&#27425; start&#12289;stop &#36816;&#34892;&#21518;&#65292;&#23601;&#20250;&#20445;&#23384;&#20986;&#19968;&#20010;&#28857;&#20113;&#25968;&#25454;&#65292;&#21487;&#20197;&#29992; CloudStudio &#30452;&#25509;&#25171;&#24320;&#65288;&#31532;&#20108;&#21015;&#21363; y &#36724;&#30340;&#25289;&#20280;&#35201;&#25226;&#25569;&#22909;&#25165;&#22909;&#30475;&#65289;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::genNewPath( )
{
    <span class="dt">quint64</span> dt = <span class="ot">QDateTime::</span>currentMSecsSinceEpoch();
    lmsOutputPath.sprintf( <span class="st">&quot;</span><span class="ch">%lld</span><span class="st">-LMS-XYZ.txt&quot;</span>, dt );

    Logger::log( BCD::LMS::GEN_NEW_PATH, lmsOutputPath );
}
<span class="co">/*</span>
<span class="co"> * &#20445;&#23384;&#20986;&#26469;&#30340;&#25991;&#20214;&#22823;&#27010;&#26159;&#36825;&#26679;&#65306;</span>

<span class="co">      124.4507934888                  1437721968720      -124.4507934888</span>
<span class="co">      116.2598232121                  1437721968720      -114.2482100809</span>
<span class="co">      145.3066396684                  1437721968720      -140.3209908327</span>
<span class="co">      155.2301153966                  1437721968720      -147.3078791985</span>
<span class="co">      139.6885570093                  1437721968720      -130.2616867719</span>
<span class="co">      134.9217526363                  1437721968720      -123.6330079937</span>
<span class="co">      163.4918616050                  1437721968720      -147.2087333989</span>
<span class="co">      232.1762734446                  1437721968720      -205.4122149469</span>

<span class="co">**/</span></code></pre></div>
<p>&#26368;&#21518;&#65292;LMS &#26368;&#26680;&#24515;&#30340;&#19968;&#37096;&#20998;&#65292;&#26159;&#23545;&#25910;&#21040;&#30340; LMS &#25968;&#25454;&#36827;&#34892;&#35299;&#26512;&#65292;&#19979;&#38754;&#25105;&#20204;&#19968;&#28857;&#28857;&#20998;&#26512;&#36825;&#20010;&#20989;&#25968;&#12290;</p>
<p>&#39318;&#20808;&#65292;&#24403;&#32593;&#32476;&#20013;&#26377;&#25968;&#25454;&#26102;&#65292;&#20449;&#21495; <code>readyRead</code> &#23601;&#34987; emit&#65292;&#23601;&#20250;&#35843;&#29992; <code>readLMS()</code> &#20989;&#25968;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">//  connect( this, SIGNAL(readyRead() ),</span>
<span class="co">//           this, SLOT(readLMS()) );</span>
<span class="dt">void</span> LMSReader::readLMS( )
{
    ...
}</code></pre></div>
<p>&#22312; <code>readLMS</code> &#20989;&#25968;&#37324;&#65292;&#23427;&#20808;&#25226;&#25152;&#26377;&#30340;&#25968;&#25454;&#35835;&#21462;&#21040;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">QByteArray</span> ba = readAll();
lmsBA.append( ba );

<span class="co">// read until &lt;ETX&gt; (end of one scan)</span>
<span class="kw">if</span> ( ba.at(ba.length() <span class="dv">-1</span>) != ETX ) {
    <span class="kw">return</span>;
}</code></pre></div>
<p>&#19978;&#38754;&#30340; <code>ba.at(ba.length()-1 != ETX)</code> &#26159;&#19968;&#20010;&#20445;&#25252;&#24615;&#36136;&#30340;&#25805;&#20316;&#65292;&#20063;&#26159;&#25105;&#20204;&#22312;&#23454;&#38469;&#20889;&#20195;&#30721;&#21518;&#21457;&#29616;&#20102;&#38382;&#39064;&#65292;&#25165;&#25913;&#36827;&#30340;&#12290;&#22240;&#20026; LMS &#19968;&#20010; profile &#30340;&#32593;&#32476;&#25968;&#25454;&#21487;&#33021;&#20250;&#20998;&#25104;&#22810;&#27425;&#20256;&#32473;&#30005;&#33041;&#65292;&#30005;&#33041;&#19981;&#24212;&#35813;&#22312;&#25910;&#21040;&#25968;&#25454;&#23601;&#36827;&#34892;&#22788;&#29702;&#65292;&#23427;&#35201;&#20808;&#21028;&#26029;&#65292;&#36825;&#20010; profile &#26159;&#21542;&#23436;&#25972;&#65292;&#22914;&#26524;&#23436;&#25972;&#20102;&#65288;&#25910;&#21040;&#20102; <code>ETX</code>&#65289;&#65292;&#25165;&#22788;&#29702;&#20043;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">    <span class="ot">QString</span> bufstr( lmsBA );

<span class="ot">#ifdef LMS_PRINT_PROFILE_SAMPLE</span>
    zgBA = lmsBA;
<span class="ot">#endif</span>

    lmsBA.clear();</code></pre></div>
<p>LMS &#27599;&#25910;&#21040;&#19968;&#32452;&#25968;&#25454;&#65292;&#23601; emit &#19968;&#20010;&#20449;&#21495;&#65292;&#35753;&#30028;&#38754;&#26174;&#31034;&#36827;&#24230;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// emit progress, 1/50 ~ 50/50 or 1/25 ~ 25/25</span>
<span class="dt">static</span> <span class="dt">int</span> f = <span class="dv">0</span>;
f = (++f) % lmsFrequency;
<span class="kw">emit</span> scanning( f<span class="dv">+1</span>, lmsFrequency );</code></pre></div>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// not run, so no need to parse</span>
<span class="co">// &#22914;&#26524;&#27809;&#26377;&#25171;&#24320;&#35835;&#21462;&#65288;turnOnReading&#65289;&#65292;&#23601;&#19981;&#22788;&#29702;&#25910;&#21040;&#30340;&#25968;&#25454;</span>
<span class="kw">if</span> ( !isRun ) {
    <span class="co">// qDebug() &lt;&lt; &quot;Hit! But drop it.&quot;;</span>
    <span class="kw">return</span>;
}

<span class="co">// &#36825;&#26159; debug &#30340;&#26102;&#20505;&#29992;&#21040;&#30340;&#65292;&#21487;&#20197;&#25226;&#25910;&#21040;&#30340;&#20869;&#23481;&#25171;&#21360;&#22312;&#25511;&#21046;&#21488;</span>
<span class="kw">if</span>( LMS_PRINT_SCAN_BUF ) {
    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Bufstr: &quot;</span> &lt;&lt; bufstr;
}

<span class="co">// do it now!</span>
<span class="ot">QStringList</span> bufstrlist = bufstr.split(<span class="st">&quot; &quot;</span>);</code></pre></div>
<p>&#28982;&#21518;&#23545;&#25910;&#21040;&#30340;&#25968;&#25454;&#36827;&#34892;&#20998;&#21457;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">    <span class="co">// dispatch</span>
    <span class="kw">if</span>( <span class="kw">false</span> ) {
        <span class="co">// &#25105;&#36890;&#24120;&#37117;&#21916;&#27426;&#20808;&#20889;&#19968;&#20010; if(false)&#65292;&#20320;&#36896;&#20026;&#20160;&#20040;&#21527;&#65311;</span>
    } <span class="kw">else</span> <span class="kw">if</span>( bufstrlist.at(<span class="dv">1</span>) == actions[TURN_ON].split(<span class="st">&quot; &quot;</span>).at(<span class="dv">1</span>) ) {
        <span class="kw">if</span> ( LMS_PARSE_SCAN ) {
            <span class="co">// &#36825;&#37324;&#26159;&#26368;&#32456;&#30340;&#19968;&#37096;&#20998;&#65281;&#65281;</span>
            parse( bufstrlist );
            <span class="kw">return</span>;
        }
    } <span class="kw">else</span> <span class="kw">if</span>( bufstrlist.at(<span class="dv">1</span>) == actions[GET_ANGBEG_ANGEND].split(<span class="st">&quot; &quot;</span>).at(<span class="dv">1</span>) ) {
        <span class="co">// &#36825;&#26159;&#35774;&#32622; LMS &#25110;&#32773;&#33719;&#21462; LMS &#21442;&#25968;&#30340;&#26102;&#20505;&#65292;LMS &#30340;&#36820;&#22238;&#24773;&#20917;&#65306;</span>
        <span class="co">// sRA LMPoutputRange 1 1388 FFF92230 225510</span>
        <span class="co">// &#25105;&#20204;&#35201;&#25226;&#25343;&#21040;&#30340;&#25968;&#25454;&#35299;&#26512;&#20986;&#26469;&#65292;&#28982;&#21518;&#35774;&#32622;&#21040;&#33258;&#24049;&#30340;&#21464;&#37327;&#37324;</span>
        <span class="dt">int</span> angbeg, angend;
        sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">4</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;angbeg );
        sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">5</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;angend );
        lmsAngleBeg = angbeg / ANGLE_SCALE_FACTOR;
        lmsAngleEnd = angend / ANGLE_SCALE_FACTOR;
        <span class="kw">emit</span> angle_begin_end( lmsAngleBeg, lmsAngleEnd );
        Logger::log (  BCD::LMS::GOT_SCANNING_ANGLE_START_END,
                       <span class="ot">QString</span>(<span class="st">&quot;[</span><span class="ch">%1-%</span><span class="st">2]&quot;</span>).arg(lmsAngleBeg).arg(lmsAngleEnd) );
        <span class="kw">return</span>;
    } <span class="kw">else</span> <span class="kw">if</span>( bufstrlist.at(<span class="dv">1</span>) == actions[GET_FREQ_ANGRES].split(<span class="st">&quot; &quot;</span>).at(<span class="dv">1</span>) ) {
        <span class="co">// &#21644;&#19978;&#38754;&#31867;&#20284;&#65292;&#23601;&#19981;&#36148;&#20195;&#30721;&#20102;</span>
        <span class="co">// ...</span>
        <span class="kw">return</span>;
    } <span class="kw">else</span> <span class="kw">if</span>( bufstrlist.at(<span class="dv">1</span>) == actions[AUTHORIZE].split(<span class="st">&quot; &quot;</span>).at(<span class="dv">1</span>) ) {
        <span class="co">// ...</span>
    } <span class="kw">else</span> {
        <span class="co">// &#26368;&#21518;&#25105;&#36824;&#35201;&#20889;&#19968;&#20010; else&#65292;&#34429;&#28982;&#24456;&#21487;&#33021;&#36825;&#37324;&#20174;&#26469;&#27809;&#26377;&#19996;&#35199;&#65292;&#20320;&#36896;&#20026;&#20160;&#20040;&#21527;&#65311;</span>
    }
}</code></pre></div>
<p>&#29616;&#22312;&#23601;&#24046;&#37027;&#20010; <code>parse( bufstrlist )</code> &#19981;&#30693;&#36947;&#26159;&#21861;&#20102;&#12290;&#20808;&#21028;&#26029;&#26159;&#21542;&#26159;&#25968;&#25454;&#24103;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::parse( <span class="dt">const</span> <span class="ot">QStringList</span> &amp;bufstrlist )
{
    <span class="co">// &#39318;&#20808;&#21028;&#26029;&#20102;&#26159;&#21542;&#26159; LMS &#30340;&#25968;&#25454;&#24103;</span>
    <span class="co">// already &quot;LMDscandata&quot; data</span>
    <span class="co">// No: &quot;sEA LMDscandata 0&quot;, Yes: &quot;sSN LMDscandata 1&quot; or &quot;sRA LMDscandata&quot;</span>
    string ct = bufstrlist.at(<span class="dv">0</span>).toStdString().erase(<span class="dv">0</span>, <span class="dv">1</span>); <span class="co">// command type</span>
    <span class="kw">if</span> ( <span class="st">&quot;sSN&quot;</span> != ct &amp;&amp; <span class="st">&quot;sRA&quot;</span> != ct ) {
        <span class="co">// cerr &lt;&lt; &quot;sEA data, not LMS scan.\n&quot;;</span>
        <span class="kw">return</span>;
    }</code></pre></div>
<p>&#38656;&#35201;&#25171;&#21360;&#65311;&#28982;&#21518;&#23601;&#25171;&#21360;&#19968;&#20010;&#24103;&#30340;&#21407;&#22987;&#25968;&#25454;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#ifdef LMS_PRINT_PROFILE_SAMPLE</span>
    <span class="dt">static</span> <span class="dt">bool</span> first = <span class="kw">true</span>;
    <span class="kw">if</span> ( first ) {
        Logger::log( BCD::LMS::LMS, <span class="ot">QString</span>( <span class="st">&quot;LMS data (%1 bytes): %2&quot;</span> ).arg( zgBA.length() )
                                                                        .arg( ba2hexstr( zgBA ) ) );
        first = <span class="kw">false</span>;
    }
<span class="ot">#endif</span></code></pre></div>
<p>&#20854;&#23454;&#19978;&#25991;&#37027;&#20010;&#12304;LMS &#25968;&#25454;&#37327;&#12305;&#37324;&#38754;&#30340; &#8220;LMS data (6429 bytes): 0x02 0x73 0x53 0x4e&#8230;&#8221;&#23601;&#26159;&#22312;&#36825;&#37324;&#25171;&#21360;&#20986;&#26469;&#30340;&#12290;&#27809;&#24819;&#21040;&#25105;&#25171;&#21360;&#23436;&#36825;&#20010;&#26085;&#24535;&#23621;&#28982;&#25226;&#20195;&#30721;&#36824;&#30041;&#30528;&#20102;&#65292;&#36825;&#31181;&#19968;&#27425;&#24615;&#20195;&#30721;&#29702;&#24212;&#21024;&#25481;&#30340;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">    <span class="co">// parse data</span>
    profiles_raw.push_back( bufstrlist );               <span class="co">// &#20445;&#23384;&#20102;&#21407;&#22987;&#25968;&#25454;&#65292;&#22914;&#26524;&#19981;&#22312;&#32447;&#22788;&#29702;</span>
                                                        <span class="co">// profiles_raw &#23601;&#20250;&#22312;&#31163;&#32447;&#22788;&#29702;&#30340;&#26102;&#20505;&#34987;&#29992;&#21040;</span>
    <span class="co">// &#27599;&#20010;&#25968;&#25454;&#24103;&#65292;&#26377; 550 &#24038;&#21491;&#20010;&#28857;&#65292;&#26102;&#38388;&#25139;&#37117;&#25171;&#25104;&#19968;&#26679;&#30340;&#65288;&#34429;&#28982;&#25195;&#25551;&#26377;&#20808;&#21518;&#65289;</span>
    profilesX[profileCur].timestamp =  <span class="ot">QDateTime::</span>currentMSecsSinceEpoch();

    <span class="kw">if</span> ( !LMS_PARSE_ON_THE_FLY ) { <span class="co">// do not process, just return</span>
        {
        <span class="co">// &#25105;&#31361;&#28982;&#22312;&#24819;&#36825;&#20010; scope &#37324;&#30340; lock &#20160;&#20040;&#26102;&#20505;&#26512;&#26500;&#8230;&#8230;&#24212;&#35813;&#22312;&#36825;&#20010;&#20013;&#25324;&#21495;&#21518;&#23601;&#26512;</span>
        <span class="co">// &#26500;&#65292;&#20294;&#24635;&#24863;&#35273;&#23427;&#8220;&#27515;&#30340;&#8221;&#20063;&#22826;&#26089;&#20102;&#65292;&#21738;&#22825;&#26377;&#31354;&#27979;&#35797;&#19968;&#20123;</span>
            boost::mutex::scoped_lock lock( mutex );
            ++profileCur;
        }
        <span class="kw">return</span>;
    }

    <span class="co">// Parse it on the fly</span>
    postparse( profiles_raw.at( profiles_raw.size()<span class="dv">-1</span> ),
               profilesX[profileCur] );
    {
        boost::mutex::scoped_lock lock( mutex );
        ++profileCur;
    }
}</code></pre></div>
<p>&#19978;&#38754;&#30340; postpares &#22788;&#29702;&#20102;&#24403;&#21069;&#24103;&#65292;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::postparse( <span class="ot">QStringList</span> &amp;bufstrlist, profile_t &amp;profile )
{
    <span class="co">// emit progress, 1/50 ~ 50/50 or 1/25 ~ 25/25</span>
    <span class="co">// &#39318;&#20808;&#23450;&#20041;&#19968;&#20123;&#21464;&#37327;</span>
    <span class="dt">int</span> scannednum = <span class="dv">0</span>;
    <span class="dt">int</span> distance = <span class="dv">0</span>;
    <span class="dt">double</span> anglebeg = <span class="fl">0.0</span>, angleres = <span class="fl">0.0</span>, anglecur = <span class="fl">0.0</span>;
    <span class="dt">double</span> x = <span class="fl">0.0</span>, z = <span class="fl">0.0</span>;
    <span class="dt">int</span> tmp = <span class="dv">0</span>;

    <span class="co">// start angle&#65292;&#36215;&#22987;&#25195;&#25551;&#35282;</span>
    sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">23</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;tmp );
    anglebeg = (<span class="dt">double</span>) tmp / ANGLE_SCALE_FACTOR;

    <span class="co">// angle resolution&#65292;&#35282;&#24230;&#20998;&#36776;&#29575;</span>
    sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">24</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;tmp );
    angleres = (<span class="dt">double</span>) tmp / ANGLE_SCALE_FACTOR;

    <span class="co">// num of points in this scan&#65292;&#24403;&#21069;&#24103;&#30340;&#28857;&#25968;&#65292;&#22823;&#27010; 550 &#20010;</span>
    sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(<span class="dv">25</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;scannednum );

    <span class="dt">int</span> cnt = <span class="dv">0</span>; <span class="co">// check for possible lost of points</span>
    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; scannednum; ++i ) {
        ++cnt;
        <span class="co">// scan distance, metric: mm&#65292;&#21333;&#20301;&#26159;&#27627;&#31186;</span>
        <span class="co">// &#20808;&#20174;&#23383;&#31526;&#20013;&#25195;&#25551;&#20986;&#36317;&#31163;&#20540;</span>
        sscanf_s( <span class="fu">qPrintable</span>( bufstrlist.at(i + <span class="dv">26</span>) ), <span class="st">&quot;</span><span class="ch">%x</span><span class="st">&quot;</span>, &amp;distance );
        <span class="co">// &#28982;&#21518;&#26681;&#25454;&#28857;&#30340; index&#65292;&#35745;&#31639;&#28857;&#30340;&#35282;&#24230;</span>
        anglecur = (anglebeg + i * angleres) / <span class="fl">180.0</span> * M_PI;
        <span class="co">// &#26368;&#21518;&#65292;&#26681;&#25454;&#35282;&#24230;&#21644;&#36317;&#31163;&#65292;&#25226;&#28857;&#30340;&#20301;&#32622;&#35745;&#31639;&#20986;&#26469;</span>
        profile.pts[i].x = cos(anglecur) * distance;
        profile.pts[i].z = sin(anglecur) * distance;
        <span class="co">// pt.x &#21644; pt.z &#20998;&#21035;&#23384;&#20102;&#20004;&#20010;&#22352;&#26631;&#65292;pt.y &#23384;&#20102;&#26102;&#38388;&#25139;&#65288;&#20294;&#23454;&#38469;&#19978;&#25105;&#20204;&#21482;&#35201;&#22312;&#19968;</span>
        <span class="co">// &#20010; profile &#37324;&#23384;&#19968;&#20010;&#26102;&#38388;&#25139;&#23601;&#21487;&#20197;&#20102;&#65289;</span>
    }

    Logger::log( BCD::LMS::PARSE_PROFILE );
}</code></pre></div>
<p>&#24403;&#20851;&#38381;&#35835;&#25968;&#21518;&#65292;LMS &#20250;&#33258;&#21160;&#20445;&#23384;&#25968;&#25454;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::saveprofiles( )
{
    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Save LMS data(&quot;</span> &lt;&lt; profiles_raw.size() &lt;&lt; <span class="st">&quot; profiles) ... to &quot;</span>;
    <span class="kw">if</span> ( !LMS_PARSE_ON_THE_FLY ) { <span class="co">// if not on the fly, we need to parse it now</span>
        <span class="co">// &#22914;&#26524;&#27809;&#26377;&#22312;&#32447;&#22788;&#29702;&#65292;&#37027;&#23601;&#29992; profiles_raw &#30340;&#25968;&#25454;&#65292;&#26469; parse &#20986;&#21508;&#20010;&#25968;&#25454;&#28857;</span>
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Save Profiles, Parsing...&quot;</span>;
        <span class="co">// parse</span>
        <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; profiles_raw.size(); ++i ) {
            postparse( profiles_raw[i], profilesX[i] );
        }
        {
            boost::mutex::scoped_lock lock( mutex );
            profileCur = profiles_raw.size();
        }
    } <span class="kw">else</span> {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Save Profiles, no need to parse.&quot;</span>;
    }

    <span class="kw">if</span> ( lmsOutputPath.isEmpty() ) { genNewPath(); }
    FILE *fp = fopen( <span class="fu">qPrintable</span>( <span class="ot">QString</span>( <span class="st">&quot;</span><span class="ch">%1/%</span><span class="st">2&quot;</span> ).arg( basedir )
                                                    .arg( lmsOutputPath ) ), <span class="st">&quot;a+&quot;</span> );
    <span class="kw">if</span> ( NULL == fp ) {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;err, cant open file.&quot;</span>;
        <span class="kw">return</span>;
    }

    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Save Profiles, saving...&quot;</span>;
    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; profiles_raw.size(); ++i ) {
        <span class="kw">for</span> ( <span class="dt">int</span> j = <span class="dv">0</span>; j &lt; LMS_PROFILE_POINTS_NUM; ++j ) {
            fprintf( fp, <span class="st">&quot;</span><span class="ch">%20.10f</span><span class="st"> </span><span class="ch">%30lld</span><span class="st"> </span><span class="ch">%20.10f\n</span><span class="st">&quot;</span>
                    , profilesX[i].pts[j].x
                    , profilesX[i].timestamp
                    , profilesX[i].pts[j].z );
        }
    }
    fclose( fp );

    Logger::log( BCD::LMS::SAVE_PROFILES );
}</code></pre></div>
<p>&#19978;&#38754;&#24050;&#32463;&#25552;&#36807;&#65292;&#20445;&#23384;&#20986;&#26469;&#30340;&#25968;&#25454;&#22823;&#27010;&#36825;&#26679;&#65306;</p>
<pre><code>      145.3066396684                  1437721968720      -140.3209908327
      155.2301153966                  1437721968720      -147.3078791985
      139.6885570093                  1437721968720      -130.2616867719</code></pre>
<p>&#25171;&#24320;&#12289;&#20851;&#38381; LMS &#25968;&#25454;&#30340;&#35835;&#21462;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> LMSReader::turnOnReading( )
{
    isRun = <span class="kw">true</span>;
    {
        boost::mutex::scoped_lock lock( mutex );
        profileCur = <span class="dv">0</span>;
    }
    profiles_raw.clear();
}

<span class="dt">void</span> LMSReader::turnOffReading( )
{
    isRun = <span class="kw">false</span>;
    <span class="co">// parse &amp; save</span>
    saveprofiles();
}

<span class="dt">void</span> LMSReader::start( <span class="dt">qint64</span> ts <span class="co">/* = 0 */</span> )
{
    <span class="dt">qint64</span> dt = (ts == <span class="dv">0</span>)
              ? <span class="ot">QDateTime::</span>currentMSecsSinceEpoch()
              : (<span class="dt">qint64</span>)ts;
    <span class="co">// &#27599;&#27425; start &#37117;&#35201;&#20135;&#29983;&#26032;&#30340;&#36755;&#20986;&#36335;&#24452;&#65292;&#36825;&#26679;&#23601;&#19981;&#20250;&#35206;&#30422;&#21407;&#26469;&#20445;&#23384;&#19979;&#26469;&#30340;&#25968;&#25454;&#20102;</span>
    genNewPath( dt );
    turnOnReading();
}

<span class="dt">void</span> LMSReader::stop( )
{
    turnOffReading();
}</code></pre></div>
<p>&#22312;&#25105;&#30475; LMS &#20195;&#30721;&#30340;&#26102;&#20505;&#65292;&#25105;&#30475;&#21040;&#20102;&#33258;&#24049;&#26368;&#24320;&#22987;&#30340;&#27880;&#37322;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">/*</span>
<span class="co"> *</span>
<span class="co"> *   // Fog Filter</span>
<span class="co"> *   // &lt;-- &quot;sWN MSsuppmode 1&quot;; // 0: glitch, 1: fog</span>
<span class="co"> *   // --&gt; &quot;sWA MSsuppmode&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // n-Pulse to 1-Pulse Filter</span>
<span class="co"> *   // &lt;-- &quot;sWN LFPnto1filter 1&quot;; // 1: active, 0: inactive</span>
<span class="co"> *   // --&gt; &quot;sWA LFPnto1filter&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Mean Filter</span>
<span class="co"> *   // &lt;-- &quot;sWN LFPmeanfilter 1 +10 0&quot;; // 0: inactive, 1: active. number of scans: +2..+100. 0</span>
<span class="co"> *   // --&gt; &quot;sWA LFPmeanfilter&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Configure the data content for the scan</span>
<span class="co"> *   // QString str = &quot;sWN LMDscandatacfg&quot;;</span>
<span class="co"> *   // channel: c1: 1, c2: 2, c1+c2: 3</span>
<span class="co"> *   // Remission data output: 0: no, 1: yes</span>
<span class="co"> *   // Resolution of Remission Data: 0: 8bit, 1: 16bit</span>
<span class="co"> *   // Unit of Remission Data:</span>
<span class="co"> *   // double AngRes = 2.0 / round(2.0 / GivenAngRes);</span>
<span class="co"> *</span>
<span class="co"> *   // Function Front Panel</span>
<span class="co"> *   // &lt;-- &quot;sWN LMLfpFcn 1 0 1&quot;; // 1: reserved, 0-2: Q1/Q2, 0-2: Okay/Stop, 0-1: display function</span>
<span class="co"> *   // 0: no function, 1: application, 2: command</span>
<span class="co"> *   // 0: application, 1: command</span>
<span class="co"> *   // --&gt; &quot;sFA 8&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Synchronization Phase</span>
<span class="co"> *   // &lt;-- &quot;sWN SYPhase +90&quot;;</span>
<span class="co"> *   // --&gt; &quot;sWA SYPhase&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Set factory defaults</span>
<span class="co"> *   // &lt;-- &quot;sMN mSCloadfacdef&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Set IP-Address</span>
<span class="co"> *   // &lt;-- &quot;sWN EIIpAddr C0 A8 0 1&quot;;</span>
<span class="co"> *   // --&gt; &quot;sWA EIIpAddr&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Power On Counter</span>
<span class="co"> *   // &lt;-- &quot;sRN ODpwrc&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA ODpwrc A7&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Operating hours</span>
<span class="co"> *   // &lt;-- &quot;sRN ODoprh&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA ODoprh 4F4&quot;, 4F4 * 1/10h = 126.8 hours</span>
<span class="co"> *</span>
<span class="co"> *   // Ask Device Name</span>
<span class="co"> *   // &lt;-- &quot;sRN LocationName&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA LocationName B not defined&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Device State</span>
<span class="co"> *   // &lt;-- &quot;sRN SCdevicestate&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA SCdevicestate 1&quot;, 0: busy, 1: ready, 2: error</span>
<span class="co"> *</span>
<span class="co"> *   // Device Ident</span>
<span class="co"> *   // &lt;-- &quot;sRN DeviceIdent/sRI 0&quot;;</span>
<span class="co"> *   // --&gt; &quot;sFA 3&quot;?</span>
<span class="co"> *</span>
<span class="co"> *   // Reset output counter</span>
<span class="co"> *   // &lt;-- &quot;sMN LIDrstoutpcnt&quot;;</span>
<span class="co"> *   // --&gt; &quot;sAN LIDrstoutpcnt 0&quot;, 0: success</span>
<span class="co"> *</span>
<span class="co"> *   // Set output state</span>
<span class="co"> *   // &lt;-- &quot;sMN mDOSetOutput 1 1&quot;; // output number: 1-3, output state: 0:inactive / 1:active</span>
<span class="co"> *   // &quot;sAN mDOSetOutput 0&quot;, 0: err, 1: success</span>
<span class="co"> *</span>
<span class="co"> *   // Ask state of the outputs</span>
<span class="co"> *   // &lt;-- &quot;sRN LIDoutputstate&quot;;</span>
<span class="co"> *   // --&gt; &quot;sRA LIDoutputstate 1 E88CDA0F 1 A 1 A 1 A 2 0 2 0 2 0 2 0 2 0 2 0 2 0 2 0 1 7DD 1 1 0 1D 3B 5B8D8&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Ask speed threshold</span>
<span class="co"> *   // &quot;sRN LICSpTh&quot;;</span>
<span class="co"> *   // &quot;sRA LICSpTh 5&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Fixed speed</span>
<span class="co"> *   // &lt;-- &quot;sWN LICFixVel +5&quot;; // +0.001..+10</span>
<span class="co"> *   // --&gt; &quot;sWA LICFixVel&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Encoder resolution</span>
<span class="co"> *   // QString str = &quot;sWN LICencres +1000&quot;; // +0.001..+2000</span>
<span class="co"> *   // &quot;sWA LICencres&quot;</span>
<span class="co"> *</span>
<span class="co"> *   // Encoder Settings</span>
<span class="co"> *      0 = Off</span>
<span class="co"> *      1 = single Increment/INC1</span>
<span class="co"> *      2 = Direction recognition (phase)</span>
<span class="co"> *      3 = Direction recognition (level)</span>
<span class="co"> *</span>
<span class="co"> *   // &lt;-- &quot;sWN LICencset 2&quot;</span>
<span class="co"> *   // --&gt; &quot;sWA LICencset&quot;</span>

<span class="co"> *   // Increment source</span>
<span class="co"> *   // &lt;-- &quot;sWN LICsrc 1&quot;); // 0: fixed speed, 1: encoder</span>
<span class="co"> *   // --&gt; &quot;sWA LICsrc&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN LMCstartmeas&quot;;</span>
<span class="co"> *   // &quot;sAN LMCstartmeas 0&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN LMCstandby&quot;; // cant turn on, but can poll one</span>
<span class="co"> *   // &quot;sAN LMCstandby 0&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN LMCstopmeas&quot;;</span>
<span class="co"> *   // &quot;&quot;sAN LMCstopmeas 0&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN mSCreboot&quot;;</span>
<span class="co"> *   // &quot;sAN mSCreboot&quot;</span>

<span class="co"> *   // &lt;-- &quot;sRN STlms&quot;;</span>
<span class="co"> *   // &quot;sRA STlms 7 0 8 00:34:19 A 01.01.1970 0 0 0&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN LSPsetdatetime&quot;;</span>
<span class="co"> *   // &quot;sAN LSPsetdatetime 1&quot;</span>

<span class="co"> *   // &lt;-- &quot;sMN mEEwriteall&quot;;</span>
<span class="co"> *   // &quot;sAN mEEwriteall 1&quot;</span>
<span class="co"> *</span>
<span class="co">**/</span></code></pre></div>
<p>&#21487;&#20197;&#30475;&#21040; LMS &#36824;&#25552;&#20379;&#24456;&#22810;&#21151;&#33021;&#65292;&#21482;&#19981;&#36807;&#25105;&#20204;&#27809;&#29992;&#29992;&#36807;&#65292;&#32780;&#24050;&#12290;</p>
<p><code>lmsreaderconfig{.h, .cpp, .ui}</code> &#20869;&#23481;&#27809;&#26377;&#22810;&#23569;&#65292;&#23427;&#21482;&#26159;&#19968;&#20010;&#23553;&#35013;&#12290;&#25152;&#26377;&#30340;&#20195;&#30721;&#22823;&#27010;&#37117;&#26159;&#36825;&#26679;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> on_pushButton_ip_port_clicked( ) {

    <span class="ot">QString</span> address   = ui-&gt;lineEdit_ip-&gt;text().simplified();
    <span class="dt">quint16</span> port      = ui-&gt;lineEdit_port-&gt;text().toInt();
    lmsReader-&gt;setAddressPort( address, port );

}</code></pre></div>
<p>.ui &#20854;&#23454;&#26159;&#19968;&#20010; xml &#25991;&#20214;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;<span class="kw">?&gt;</span>
<span class="kw">&lt;ui</span><span class="ot"> version=</span><span class="st">&quot;4.0&quot;</span><span class="kw">&gt;</span>
 <span class="kw">&lt;class&gt;</span>lmsreaderconfig<span class="kw">&lt;/class&gt;</span>
 <span class="kw">&lt;widget</span><span class="ot"> class=</span><span class="st">&quot;QWidget&quot;</span><span class="ot"> name=</span><span class="st">&quot;lmsreaderconfig&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;geometry&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;rect&gt;</span>
    <span class="kw">&lt;x&gt;</span>0<span class="kw">&lt;/x&gt;</span>
    <span class="kw">&lt;y&gt;</span>0<span class="kw">&lt;/y&gt;</span>
    <span class="kw">&lt;width&gt;</span>901<span class="kw">&lt;/width&gt;</span>
    <span class="kw">&lt;height&gt;</span>429<span class="kw">&lt;/height&gt;</span>
   <span class="kw">&lt;/rect&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;windowTitle&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;string&gt;</span>lmsreaderconfig<span class="kw">&lt;/string&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
  <span class="kw">&lt;layout</span><span class="ot"> class=</span><span class="st">&quot;QGridLayout&quot;</span><span class="ot"> name=</span><span class="st">&quot;gridLayout&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;item</span><span class="ot"> row=</span><span class="st">&quot;0&quot;</span><span class="ot"> column=</span><span class="st">&quot;0&quot;</span><span class="kw">&gt;</span>
   ...</code></pre></div>
<p>&#29992; Qt &#30340; <code class="sourceCode bash"><span class="kw">uic</span></code> &#36716;&#20026; cpp &#25991;&#20214;&#19968;&#36215;&#32534;&#35793;&#65292;&#23601;&#29983;&#25104;&#25104;&#20102;&#30028;&#38754;&#31243;&#24207;&#12290;</p>
<p>LMS &#23601;&#36825;&#26679;&#35762;&#23436;&#20102;&#12290;&#35762;&#24471;&#27604;&#36739;&#32454;&#33268;&#65292;&#22240;&#20026;&#23427;&#26159;&#25105;&#20889;&#30340;&#31532;&#19968;&#20010;&#20256;&#24863;&#22120;&#31243;&#24207;&#65292;&#21518;&#38754;&#30340; IMU &#21644; UR &#23601;&#35201;&#35762;&#24471;&#31961;&#19968;&#28857;&#65292;&#24555;&#19968;&#28857;&#20102;&#12290;</p>
<h2 id="imu">IMU</h2>
<p>IMU&#65288;Inertial measurement unit&#65292;&#24815;&#24615;&#27979;&#37327;&#21333;&#20803;&#65292;&#20439;&#31216;&#20439;&#31216;&#24815;&#23548;&#65292;&#25110;&#24815;&#24615;&#23548;&#33322;&#65289;&#26159;&#27979;&#37327;&#29289;&#20307;&#19977;&#36724;&#23039;&#24577;&#35282;&#65288;&#25110;&#35282;&#36895;&#29575;&#65289;&#20197;&#21450;&#21152;&#36895;&#24230;&#30340;&#35013;&#32622;&#12290;IMU &#35013;&#22312; MCU&#65288;Micro Controller Unit&#65292;&#24494;&#25511;&#21046;&#22120;&#65289;&#19978;&#65292;&#21644;&#30005;&#33041;&#36890;&#36807;&#20018;&#21475;&#65288;COM&#65289;&#36830;&#25509;&#65288;&#29992; Modbus &#20018;&#21475;&#21327;&#35758;&#65289;&#12290;</p>
<p>&#20351;&#29992;&#21040;&#20102;&#31532;&#19977;&#26041;&#24211; <a href="https://github.com/qextserialport/qextserialport">QExtSerialPort</a>&#65292;&#36825;&#20010;&#24211;&#32473; Qt4 &#25552;&#20379;&#20102;&#20018;&#21475;&#36890;&#20449;&#30340;&#21151;&#33021;&#65288;Qt5 &#20013;&#24050;&#32463;&#38598;&#25104;&#20102;&#36825;&#20010;&#21151;&#33021;&#65289;&#12290;&#25105;&#20204;&#30896;&#21040;&#30340;&#31532;&#19968;&#20010;&#38382;&#39064;&#26159;&#65292;&#24590;&#20040;&#25226; Qt &#31243;&#24207;&#65292;&#31227;&#26893;&#21040; VS &#37324;&#65311;</p>
<p>&#20854;&#23454;&#25105;&#20204;&#30340; Qt &#20063;&#26159;&#29992;&#30340; VS &#30340;&#32534;&#35793;&#22120;&#12290;&#25152;&#20197;&#26174;&#31034;&#25226;&#21407;&#26469; Qt &#24037;&#31243;&#30340;&#37027;&#20123; dll &#21644; lib &#25991;&#20214;&#24324;&#21040; CMake &#24037;&#31243;&#26159;&#21487;&#34892;&#30340;&#12290;&#24223;&#20102;&#22909;&#20960;&#22825;&#30340;&#21151;&#22827;&#65288;&#37027;&#26102;&#20505;&#25105;&#20204; CMake &#20063;&#19981;&#29087;&#65289;&#65292;&#25105;&#32456;&#20110;&#25630;&#23450;&#20102;&#65292;&#22823;&#27010;&#30340; CMakeLists.txt &#25991;&#20214;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span class="co"># &#39318;&#20808;&#21152;&#19978; include &#36335;&#24452;</span>
<span class="kw">include_directories</span>( <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle )

<span class="co"># &#28304;&#30721;&#35201;&#19968;&#36215;&#32534;&#35793;</span>
<span class="kw">set</span>( QEXTSERIALPORT_SOURCES
     <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/qextserialport.cpp
     <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/qextserialenumerator.cpp
     <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/qextserialenumerator_win.cpp
     <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/qextserialport_win.cpp )

<span class="co"># link &#30340;&#30446;&#24405;&#21644; link &#30340; lib &#25991;&#20214;</span>
<span class="kw">link_directories</span>( <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/lib )
<span class="kw">set</span>( QEXTSERIALPORT_LIBS <span class="st">&quot;setupapi;advapi32;user32;qextserialport1;qextserialportd1;&quot;</span> )

<span class="kw">file</span>( <span class="ot">GLOB</span> QEXTSERIALPORT_HEADERS <span class="dv">${CMAKE_SOURCE_DIR}</span>/GeneralLibs/imulib/bundle/*.h )
<span class="kw">add_library</span>( <span class="dv">${PROJECT_NAME}</span> <span class="ot">STATIC</span>
    <span class="dv">${SRCS_FILES}</span>
    <span class="dv">${UI_FILES}</span> <span class="dv">${HDRS_FILES}</span> <span class="dv">${MOC_SRCS}</span> <span class="dv">${UI_HDRS}</span> <span class="dv">${RSC_SRCS}</span> <span class="dv">${CD_FILES}</span>
    <span class="dv">${QEXTSERIALPORT_HEADERS}</span> <span class="dv">${QEXTSERIALPORT_SOURCES}</span> )
<span class="kw">target_link_libraries</span>( <span class="dv">${PROJECT_NAME}</span> <span class="dv">${QT_LIBRARIES}</span> <span class="dv">${QEXTSERIALPORT_LIBS}</span> Utils )</code></pre></div>
<p>IMU &#27809;&#26377;&#20687; LMS &#19968;&#26679;&#32487;&#25215;&#21035;&#20154;&#65292;&#32780;&#26159;&#25226;&#25552;&#20379;&#20102;&#20018;&#21475;&#21151;&#33021;&#30340; QextSerialPort &#20316;&#20026;&#33258;&#24049;&#30340;&#19968;&#20010;&#25104;&#21592;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">private</span>:
    QextSerialPort *imuCom;
    QextSerialEnumerator *imuSerialeEnumerator;</code></pre></div>
<p>&#37027;&#20010; QextSerialEnumerator &#21487;&#20197;&#26174;&#31034;&#30005;&#33041;&#24320;&#21551;&#30340; COM &#25509;&#21475;&#65292;&#22312; Qt creator &#37324;&#21487;&#20197;&#27491;&#24120;&#24037;&#20316;&#65292;&#20294;&#22312; VS &#37324;&#21364;&#27809;&#29992;&#12290;&#25152;&#20197;&#36825;&#26679;&#30340;&#20195;&#30721;&#26159;&#26080;&#25928;&#30340;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">foreach</span> ( <span class="dt">const</span> QextPortInfo &amp;info, QextSerialEnumerator::getPorts() ) {
    ports &lt;&lt; info.portName; <span class="co">// &quot;COM1&quot;, &quot;COM3&quot;, ...</span>
    portsInfo &lt;&lt; info;
}</code></pre></div>
<p>&#30524;&#23574;&#30340;&#20320;&#65292;&#21487;&#33021;&#21457;&#29616;&#20102; <code>getPorts</code> &#20989;&#25968;&#26159;&#38745;&#24577;&#30340;&#65292;&#35273;&#24471;&#27809;&#24517;&#35201;&#24324;&#19968;&#20010;&#25104;&#21592;&#12290;&#20294;&#20854;&#23454;&#25105;&#20204;&#21482;&#26159;&#35201;&#22312;&#20018;&#21475;&#21495;&#26377;&#26356;&#26032;&#30340;&#26102;&#20505;&#33021;&#22815;&#33258;&#21160;&#21453;&#39304;&#19968;&#19979;&#32780;&#24050;&#65292;&#25152;&#20197;&#25165;&#38656;&#35201;&#19968;&#20010;&#25104;&#21592;&#26469;&#36830;&#25509;&#27133;&#20989;&#25968;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="fu">connect</span>(imuSerialeEnumerator, <span class="kw">SIGNAL</span>(deviceDiscovered(QextPortInfo)),
        <span class="kw">this</span>, <span class="kw">SLOT</span>(onPortAddedOrRemoved()));
<span class="fu">connect</span>(imuSerialeEnumerator, <span class="kw">SIGNAL</span>(deviceRemoved(QextPortInfo)),
        <span class="kw">this</span>, <span class="kw">SLOT</span>(onPortAddedOrRemoved()));</code></pre></div>
<p>Anyway&#65292;&#22240;&#20026; enumerate &#20018;&#21475;&#21495;&#30340;&#21151;&#33021;&#30340;&#22833;&#25928;&#65292;&#25105;&#20204;&#26159;&#22312;&#30028;&#38754;&#37324;&#33258;&#21160;&#29983;&#25104; 20 &#20010;&#20018;&#21475;&#30340;&#36873;&#39033;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> IMUReaderConfig::loadPorts( <span class="ot">QStringList</span> ports )
{
    <span class="co">// &#22914;&#26524;&#19981;&#26159; VS &#37324;&#65292;&#23601;&#21487;&#20197;&#29992; loadPorts( ports ) &#30452;&#25509;&#21152;&#36733;&#12290;</span>
    <span class="co">// &#20854;&#20013;&#30340; ports &#23601;&#26159;&#20174;&#19978;&#38754;&#30340;&#8220;ports &lt;&lt; info.portName; // &quot;COM1&quot;, &quot;COM3&quot;, ...&#8221;&#32780;&#26469;&#12290;</span>
<span class="ot">#ifndef _WIN64</span>
    ui-&gt;comboBox_port-&gt;clear();
    <span class="kw">if</span> ( ports.length() == <span class="dv">0</span> ) { <span class="kw">return</span>; }

    <span class="dt">int</span> i = <span class="dv">0</span>;
    <span class="dt">int</span> ci = <span class="dv">0</span>;
    <span class="dt">bool</span> newPort = <span class="kw">true</span>;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;port, ports ) {
        ui-&gt;comboBox_port-&gt;addItem( port );
        <span class="kw">if</span> ( port == arm-&gt;getCurPort() ) {
            ci = i;
            newPort = <span class="kw">false</span>;
        }
        ++i;
    }

    <span class="kw">if</span> ( newPort ) {
        ui-&gt;comboBox_port-&gt;setCurrentIndex( <span class="dv">0</span> );
        arm-&gt;setCurPort( ports.at(<span class="dv">0</span>) );
    } <span class="kw">else</span> {
        ui-&gt;comboBox_port-&gt;setCurrentIndex( ci );
    }
<span class="ot">#else</span>
    <span class="co">// VS &#30340;&#35805;&#65292;&#23601;&#30452;&#25509;&#29983;&#25104; 20 &#20010; COM &#21475;&#12290;</span>
    <span class="kw">for</span> ( <span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">20</span>; ++i ) {
        <span class="dt">static</span> <span class="ot">QString</span> str;
        str.sprintf( <span class="st">&quot;COM</span><span class="ch">%d</span><span class="st">&quot;</span>, i<span class="dv">+1</span> );
        ui-&gt;comboBox_port-&gt;addItem( str );
    }
<span class="ot">#endif</span>
}</code></pre></div>
<p>&#37197;&#32622;&#30028;&#38754;&#24377;&#20986;&#30340;&#26102;&#20505;&#65292;&#25105;&#20204;&#36824;&#35201;&#36733;&#20837;&#21407;&#26469;&#30340;&#35774;&#32622;&#65292;&#36825;&#37324;&#36824;&#20250;&#33258;&#21160;&#30340;&#25226; combo box &#30340;&#36873;&#20013;&#33258;&#21160;&#20999;&#25442;&#21040;&#30456;&#24212;&#30340; index&#65288;&#22914;&#26524;&#22312;&#36873;&#39033;&#20013;&#30340;&#35805;&#65288;&#22914;&#26524;&#19981;&#22312;&#65292;&#23601;&#28155;&#21152;&#19968;&#20010;&#65292;&#28982;&#21518;&#20999;&#25442;&#36807;&#21435;&#65289;&#65289;&#65292;&#20195;&#30721;&#30053;&#22797;&#26434;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> IMUReaderConfig::loadConfigs( )
{
    <span class="co">// load ports</span>
    loadPorts( arm-&gt;getPorts() );

    <span class="co">// baud rate, etc</span>
    <span class="co">// clear</span>
    ui-&gt;comboBox_baudrate-&gt;clear();
    ui-&gt;comboBox_databits-&gt;clear();
    ui-&gt;comboBox_parity-&gt;clear();
    ui-&gt;comboBox_stopbits-&gt;clear();

    <span class="co">// load and select</span>
    <span class="dt">int</span> i = <span class="dv">0</span>; <span class="co">// index</span>
    <span class="dt">int</span> ci = <span class="dv">0</span>; <span class="co">// current index</span>
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;brt, arm-&gt;getBRTs().keys() ) {
        ui-&gt;comboBox_baudrate-&gt;addItem( brt );
        <span class="kw">if</span> ( brt == arm-&gt;getBRTs().key(arm-&gt;getBRT()) ) {
            ci = i;
        }
        ++i;
    }
    ui-&gt;comboBox_baudrate-&gt;setCurrentIndex( ci );

    i = ci = <span class="dv">0</span>;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;dbt, arm-&gt;getDBTs().keys() ) {
        ui-&gt;comboBox_databits-&gt;addItem( dbt );
        <span class="kw">if</span> ( dbt == arm-&gt;getDBTs().key(arm-&gt;getDBT()) ) {
            ci = i;
        }
        ++i;
    }
    ui-&gt;comboBox_databits-&gt;setCurrentIndex( ci );

    i = ci = <span class="dv">0</span>;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;pt, arm-&gt;getPTs().keys() ) {
        ui-&gt;comboBox_parity-&gt;addItem( pt );
        <span class="kw">if</span> ( pt == arm-&gt;getPTs().key(arm-&gt;getPT()) ) {
            ci = i;
        }
        ++i;
    }
    ui-&gt;comboBox_parity-&gt;setCurrentIndex( ci );

    i = ci = <span class="dv">0</span>;
    <span class="kw">foreach</span> ( <span class="dt">const</span> <span class="ot">QString</span> &amp;sbt, arm-&gt;getSBTs().keys() ) {
        ui-&gt;comboBox_stopbits-&gt;addItem( sbt );
        <span class="kw">if</span> ( sbt == arm-&gt;getSBTs().key(arm-&gt;getSBT()) ) {
            ci = i;
        }
        ++i;
    }
    ui-&gt;comboBox_stopbits-&gt;setCurrentIndex( ci );

    <span class="co">// disable set buttons</span>
    ui-&gt;pushButton_set-&gt;setEnabled( <span class="kw">false</span> );
    ui-&gt;pushButton_wheel_fb-&gt;setEnabled( <span class="kw">false</span> );
    ui-&gt;pushButton_arm3_fb-&gt;setEnabled( <span class="kw">false</span> );
    ui-&gt;pushButton_arm3_fb_2-&gt;setEnabled( <span class="kw">false</span> );
}</code></pre></div>
<p>&#36825;&#37324;&#30340; SBT&#65292;DBT &#20043;&#31867;&#65292;&#29087;&#24713;&#20018;&#21475;&#30340;&#26379;&#21451;&#24212;&#35813;&#37117;&#30693;&#36947;&#65292;&#36825;&#37324;&#31616;&#35201;&#35828;&#26126;&#19968;&#19979;&#12290;&#27604;&#22914; BRT&#65292;&#20854;&#23454;&#23601;&#26159; baud rate&#65288;&#27874;&#29305;&#29575;&#65289;&#65292;&#26377;&#20851;&#25968;&#25454;&#20256;&#36755;&#30340;&#36895;&#29575;&#12290;&#24120;&#29992;&#30340;&#27874;&#29305;&#29575;&#26377; 9600, 19200, 38400 &#31561;&#31561;&#65292;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">const</span> IMUReader::BRT IMUReader::brts = IMUReader::initBRTs();
<span class="co">//  IMUReader::BRT IMUReader::initBRTs( )</span>
<span class="co">//  {</span>
<span class="co">//      BRT brts;</span>
<span class="co">//      brts[    &quot;9600&quot;  ] = BAUD9600;</span>
<span class="co">//      brts[   &quot;19200&quot;  ] = BAUD19200;</span>
<span class="co">//      brts[   &quot;38400&quot;  ] = BAUD38400;</span>
<span class="co">//      brts[  &quot;115200&quot;  ] = BAUD115200;</span>
<span class="co">//      brts[  &quot;256000&quot;  ] = BAUD256000;</span>
<span class="co">//      return brts;</span>
<span class="co">//  }</span></code></pre></div>
<p>DBT &#25351;&#30340;&#26159; data bits&#65288;&#25968;&#25454;&#20301;&#65289;&#65292;&#20505;&#36873;&#39033;&#26377; <code>DATA_7</code>&#65292;<code>DATA_8</code>&#12290; SBT &#25351;&#30340;&#26159; stop bits&#65288;&#20572;&#27490;&#20301;&#65289;&#65292;&#20505;&#36873;&#39033;&#26377; <code>STOP_1</code>&#65292;<code>STOP_2</code>&#12290; PT &#25351;&#30340;&#26159; parity type&#65288;&#26657;&#39564;&#20301;&#31867;&#22411;&#65289;&#65292;&#20505;&#36873;&#39033;&#26377; <code>PAR_NONE</code>&#65288;&#26080;&#26657;&#39564;&#65289;&#65292; <code>PAR_ODD</code>&#65288;&#22855;&#26657;&#39564;&#65289;&#65292;<code>PAR_EVEN</code>&#65288;&#20598;&#26657;&#39564;&#65289;&#65292;&#21487;&#33021;&#36824;&#35201;&#35774;&#32622; FlowControl&#65292;&#23427;&#30340;&#20505;&#36873;&#39033;&#26377; <code>FLOW_ON</code>&#65292;<code>FLOW_OFF</code>&#12290;</p>
<p>IMU &#22312;&#26500;&#36896;&#30340;&#26102;&#20505;&#65292;&#23601;&#35201;&#25226;&#40664;&#35748;&#24471;&#37197;&#32622;&#35774;&#32622;&#22909;&#65288;&#21542;&#21017;&#36830;&#25509;&#20102;&#65292;&#25968;&#25454;&#35835;&#21040;&#30340;&#20063;&#26159;&#26377;&#38382;&#39064;&#30340;&#65289;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// default configs</span>
imuBRT  = BAUD256000;
imuDBT  = DATA_8;
imuPT   = PAR_NONE;
imuSBT  = STOP_1;</code></pre></div>
<p>&#36830;&#25509;&#20018;&#21475;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> IMUReader::openIMU(<span class="ot">QString</span> com <span class="co">/*=QString()*/</span>) <span class="co">// com &#30340;&#20540;&#21487;&#33021;&#26159; &quot;COM1&quot;&#65292;&quot;COM2&quot;&#65292;&#31561;&#31561;</span>
{
    <span class="co">// &#22914;&#26524;&#25552;&#20379;&#20102;&#20018;&#21475;&#21495;&#65292;&#23601;&#23581;&#35797;&#25171;&#24320;</span>
    <span class="kw">if</span> (!com.isEmpty()) {
        imuCom = <span class="kw">new</span> QextSerialPort(com, QextSerialPort::EventDriven);
        imuCom -&gt;open(<span class="ot">QIODevice::</span>ReadWrite);
    } <span class="kw">else</span> {
    <span class="co">// &#22914;&#26524;&#27809;&#26377;&#25552;&#20379;&#20018;&#21475;&#21495;&#65292;&#23601;&#19968;&#20010;&#20010;&#35797;&#65292;&#30452;&#21040;&#25171;&#24320;&#19968;&#20010;</span>
        <span class="ot">QString</span> str;
        <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; <span class="dv">10</span>; ++i) {
            com = str.sprintf(<span class="st">&quot;COM</span><span class="ch">%d</span><span class="st">&quot;</span>, i<span class="dv">+1</span>);
            imuCom = <span class="kw">new</span> QextSerialPort(com, QextSerialPort::EventDriven);
            imuCom -&gt;open(<span class="ot">QIODevice::</span>ReadWrite);
            <span class="kw">if</span> (imuCom-&gt;isOpen()) {
                <span class="kw">break</span>;
            }
        }
    }

    <span class="kw">if</span> (!imuCom-&gt;isOpen()) {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Not open&quot;</span>;
        <span class="kw">emit</span> comState(<span class="kw">false</span>);
        <span class="kw">return</span>;
    }

    <span class="kw">emit</span> comState(<span class="kw">true</span>);
    <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;Connected to &quot;</span> &lt;&lt; com;

    imuCom-&gt;setBaudRate(imuBRT);
    imuCom-&gt;setDataBits(imuDBT);
    imuCom-&gt;setParity(imuPT);
    imuCom-&gt;setStopBits(imuSBT);
    imuCom-&gt;setFlowControl(FLOW_OFF);
    imuCom-&gt;setTimeout(<span class="dv">10</span>);

    <span class="co">// imu</span>
    <span class="fu">connect</span>(imuCom, <span class="kw">SIGNAL</span>(readyRead()),
                  <span class="kw">this</span>, <span class="kw">SLOT</span>(readIMU()));
}</code></pre></div>
<p>&#26377;&#25968;&#25454;&#26469;&#30340;&#26102;&#20505;&#65292;&#23601;&#35835;&#21462;&#20043;&#65292;&#36825;&#37324;&#21482;&#26159;&#31616;&#21333;&#22320;&#25226;&#25968;&#25454; dump &#20986;&#26469;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> IMUReader::readIMU()
{
    <span class="ot">QByteArray</span> ba = imuCom-&gt;readAll();
    <span class="ot">QString</span> str(ba);
    <span class="kw">emit</span> imuData(str);

    <span class="kw">if</span> (imuOutputPath.isEmpty()) { genNewOutputPath(); }
    FILE *fp = fopen(imuOutputPath.toAscii().data(), <span class="st">&quot;a+&quot;</span>);
    <span class="kw">if</span> (NULL == fp) {
        <span class="kw">return</span>;
    }
    fprintf(fp, <span class="st">&quot;</span><span class="ch">%s</span><span class="st">&quot;</span>, str.toAscii().data());
    fclose(fp);
}</code></pre></div>
<p>IMU &#21644; LMS &#22823;&#22823;&#19981;&#21516;&#30340;&#22320;&#26041;&#26159;&#65292;IMU &#26159;&#34987;&#21160;&#30340;&#38656;&#35201;&#20320;&#20027;&#21160;&#21435;&#35831;&#27714;&#25968;&#25454;&#12290;&#32780; LMS &#26159;&#20027;&#21160;&#22320;&#65292;&#20320;&#35831;&#27714;&#19968;&#27425;&#21518;&#65292;&#25968;&#25454;&#23601;&#20250;&#25345;&#32493;&#20256;&#36807;&#26469;&#12290;&#30001;&#20110; IMU &#30340;&#34987;&#21160;&#24615;&#36136;&#65292;&#25105;&#20204;&#21482;&#33021;&#23450;&#26102;&#21435;&#35831;&#27714; IMU &#30340;&#23039;&#24577;&#65292;&#38656;&#35201;&#20351;&#29992;&#19968;&#20010;&#23450;&#26102;&#22120;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// QTimer t;</span>
t.setInterval(<span class="dv">100</span>);
<span class="fu">connect</span>( &amp;t, <span class="kw">SIGNAL</span>(timeout() ),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(printPorts()) );</code></pre></div>
<p>IMU &#23601;&#35762;&#21040;&#36825;&#37324;&#12290;&#20854;&#23454; IMU &#26159;&#26368;&#38590;&#26368;&#22797;&#26434;&#30340;&#19968;&#20010;&#20256;&#24863;&#22120;&#27169;&#22359;&#65292;&#36825;&#37324;&#35762;&#24471;&#22914;&#27492;&#31616;&#21333;&#65292;&#26159;&#22240;&#20026;&#36825;&#26159;&#26089;&#26399;&#30340;&#19968;&#20010; IMU &#23454;&#29616;&#12290;&#21518;&#26469;&#25105;&#20204;&#25152;&#26377;&#30340;&#20018;&#21475;&#65292;&#37117;&#38598;&#20013;&#21040;&#20102; MCU &#27169;&#22359;&#65292;<code>class MCUController</code> &#19981;&#20165;&#21487;&#20197;&#29983;&#25104;&#19968;&#20010; IMU &#23454;&#20363;&#65292;&#36824;&#21487;&#20197;&#26159;&#35302;&#21457;&#22120;&#65288;&#21487;&#20197;&#35302;&#21457;&#28608;&#20809;&#22120;&#21644;&#38754;&#20809;&#28304;&#65289;&#65292;&#32534;&#30721;&#22120;&#65288;&#29992;&#26469;&#27979;&#37327;&#34892;&#36208;&#36718;&#34892;&#36208;&#30340;&#36317;&#31163;&#65289;&#12290;&#21482;&#35201;&#22312;&#26500;&#36896;&#30340;&#26102;&#20505;&#20256;&#20837;&#30456;&#24212;&#30340;&#21442;&#25968;&#21363;&#21487;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">namespace</span> DeviceType {
<span class="kw">enum</span> DeviceAddress {
    TRIGGER = <span class="bn">0x01</span>,     <span class="co">// COM1&#65292;&#24403;&#26102;&#65292;&#25105;&#20204;&#30340;&#35302;&#21457;&#22120;&#40664;&#35748;&#25509;&#32447;&#22312; COM1&#65292;&#29992;&#26469;&#35302;&#21457; C2</span>
                        <span class="co">// &#21644; SP20000C &#30456;&#26426;&#30340;&#37319;&#38598;&#39057;&#29575;&#65292;&#20197;&#21450;&#28608;&#20809;&#22120;&#21644;&#38754;&#20809;&#28304;&#30340;&#25171;&#24320;&#21644;&#20851;&#38381;</span>
    LMS_IMU = <span class="bn">0x02</span>,     <span class="co">// COM2</span>
    ENCODER = <span class="bn">0x03</span>,     <span class="co">// COM3</span>
    ENCODER2 = <span class="bn">0x04</span>,    <span class="co">// COM4</span>
};
}

<span class="kw">class</span> MCUController : <span class="kw">public</span> <span class="ot">QObject</span>
{
    <span class="kw">Q_OBJECT</span></code></pre></div>
<p>&#36825;&#37096;&#20998;&#35762; IMU&#65292;&#20294;&#26159;&#24182;&#27809;&#26377;&#28041;&#21450; IMU &#25968;&#25454;&#30340;&#35299;&#26512;&#65292;&#22240;&#20026;&#23427;&#22826;&#22797;&#26434;&#12290;&#22312;&#35299;&#26512;&#25968;&#25454;&#20043;&#21069;&#35201;&#35762;&#20018;&#21475;&#36890;&#20449;&#30340;&#23492;&#23384;&#22120;&#30340;&#35835;&#21644;&#20889;&#65292;&#35201;&#35762;&#20160;&#20040;&#26159; holding registers&#65292;&#20160;&#20040;&#26159; coils &#31561;&#31561;&#27010;&#24565;&#12290;&#32780; IMU &#21518;&#26469;&#25972;&#21512;&#21040; MCU &#21518;&#65292;&#21464;&#24471;&#26356;&#21152;&#22797;&#26434;&#65292; mcu.h &#21644; mcu.cpp &#30340;&#28304;&#30721;&#21152;&#36215;&#26469;&#23558;&#36817; 2500 &#34892;&#12290;&#36825;&#37324;&#36148;&#19968;&#20123;&#22836;&#25991;&#20214;&#65292;&#24863;&#21463;&#19979;&#20854;&#20013;&#36923;&#36753;&#30340;&#22797;&#26434;&#24615;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#24213;&#23618;&#30340;&#25968;&#25454;&#35835;&#21462;&#65292;&#21313;&#20998;&#24863;&#35874;&#38271;&#27801;&#26426;&#26800;&#22242;&#38431;&#27809;&#26377;&#35774;&#32622; coils&#65292;&#20840;&#37096;&#29992;&#20102; resgisters &#26469;&#23384;&#37197;&#32622;</span>
<span class="kw">enum</span> MCUFunctionCodes {
    READ_HOLDING_REGISTERS    = <span class="bn">0x03</span>,  <span class="co">// read output registers</span>
    WRITE_MULTIPLE_REGISTERS  = <span class="bn">0x10</span>,  <span class="co">// write multiple output registers</span>
};
<span class="dt">void</span> readHoldingRegisters( <span class="dt">const</span> <span class="dt">quint16</span> &amp;addr,
                           <span class="dt">const</span> <span class="dt">quint16</span> &amp;length );
<span class="dt">void</span> writeMultipleRegisters( <span class="dt">const</span> <span class="dt">quint16</span> &amp;addr,
                             <span class="dt">const</span> <span class="dt">quint16</span> &amp;length,
                             <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );

<span class="co">// &#32534;&#30721;&#22120;</span>
<span class="dt">void</span> mcuEncoders( <span class="dt">double</span> e1, <span class="dt">double</span> e2 );

<span class="co">// C2 &#30456;&#26426;&#21644; SP20000C &#30340;&#35302;&#21457;&#39057;&#29575;&#20063;&#26377;&#29992;&#25105;&#20204;&#30340;&#31243;&#24207;&#26469;&#25511;&#21046;</span>
<span class="dt">void</span> mcuC2Frequency( <span class="dt">quint16</span> c2f );
<span class="dt">void</span> mcuSP20000CFrequency( <span class="dt">quint16</span> sp20000cf );

<span class="co">// &#36710;&#20307;&#21608;&#22260;&#26377;&#20116;&#20010;&#36229;&#22768;&#27874;&#65292;&#20182;&#20204;&#30340;&#27979;&#36317;&#20063;&#35201;&#23454;&#26102;&#35299;&#26512;&#20986;&#26469;</span>
<span class="dt">void</span> mcuRange1to5( <span class="dt">quint16</span> r1,
                   <span class="dt">quint16</span> r2,
                   <span class="dt">quint16</span> r3,
                   <span class="dt">quint16</span> r4,
                   <span class="dt">quint16</span> r5 );

<span class="co">// &#26368;&#22797;&#26434;&#30340;&#65292;&#36824;&#26159;&#32534;&#30721;&#22120;&#65292;&#26377;&#24456;&#22810;&#21464;&#37327;&#26377;&#20132;&#26367;&#33719;&#21462;</span>
<span class="co">// &#20063;&#26377;&#24456;&#22810;&#35745;&#31639;&#65288;&#35745;&#31639;&#30001;&#31639;&#27861;&#27169;&#22359;&#25552;&#20379;&#65289;</span>
<span class="dt">void</span>   getQuaternion( );
<span class="dt">void</span> parseQuaternion( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="co">// &#23454;&#29616;&#20195;&#30721;&#65306;</span>
<span class="co">//              void MCUController::parseQuaternion( const QByteArray &amp;ba )</span>
<span class="co">//              {</span>
<span class="co">//                  // 0: devAddr, 1: fc, 2: num</span>
<span class="co">//                  if ( ba.length() != 3+8+2 || ba.at(2) != 8 ) {</span>
<span class="co">//                      return;</span>
<span class="co">//                  }</span>
<span class="co">//</span>
<span class="co">//                  quint8 c = 3; // cursor</span>
<span class="co">//                  mcuInfo.quaternion[0] = us2s( parse2BytesToUInt16( ba, c ) ); c += 2;</span>
<span class="co">//                  mcuInfo.quaternion[1] = us2s( parse2BytesToUInt16( ba, c ) ); c += 2;</span>
<span class="co">//                  mcuInfo.quaternion[2] = us2s( parse2BytesToUInt16( ba, c ) ); c += 2;</span>
<span class="co">//                  mcuInfo.quaternion[3] = us2s( parse2BytesToUInt16( ba, c ) ); c += 2;</span>
<span class="co">//</span>
<span class="co">//                  emit mcuQuaternion( mcuInfo.quaternion[0],</span>
<span class="co">//                                      mcuInfo.quaternion[1],</span>
<span class="co">//                                      mcuInfo.quaternion[2],</span>
<span class="co">//                                      mcuInfo.quaternion[3] );</span>
<span class="co">//                  Logger::log( BCD::MCU::GOT_QUATERNION,</span>
<span class="co">//                               QString( &quot;[ %1, %2, %3, %4 ]&quot; ).arg( mcuInfo.quaternion[0] )</span>
<span class="co">//                                                              .arg( mcuInfo.quaternion[1] )</span>
<span class="co">//                                                              .arg( mcuInfo.quaternion[2] )</span>
<span class="co">//                                                              .arg( mcuInfo.quaternion[3] ) );</span>
<span class="co">//              }</span>
<span class="co">//</span>
<span class="dt">void</span>   getRollPitchYaw( );
<span class="dt">void</span> parseRollPitchYaw( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getAcceleration( );
<span class="dt">void</span> parseAcceleration( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getGyroScope( );
<span class="dt">void</span> parseGyroScope( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getMagnetometer( );
<span class="dt">void</span> parseMagnetometer( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getRotation( );
<span class="dt">void</span> parseRotation( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="dt">void</span>   getEkf( );
<span class="dt">void</span> parseEkf( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba );
<span class="co">// &#22788;&#29702;&#22909;&#30340;&#25968;&#25454;&#65292;&#20063;&#35201;&#20445;&#23384;&#36215;&#26469;&#65288;&#30452;&#25509;&#29992; Logger::log &#23384;&#26085;&#24535;&#37324;&#23601;&#21487;&#20197;&#65289;</span>
<span class="dt">void</span> savedata( <span class="dt">const</span> <span class="dt">qint64</span> &amp;dt, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d0
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;d1, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d2, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d3
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;d4, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d5, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d6
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;d7, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d8, <span class="dt">const</span> <span class="dt">qint16</span> &amp;d9
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;da, <span class="dt">const</span> <span class="dt">qint16</span> &amp;db, <span class="dt">const</span> <span class="dt">qint16</span> &amp;dc
             , <span class="dt">const</span> <span class="dt">qint16</span> &amp;dx, <span class="dt">const</span> <span class="dt">qint16</span> &amp;dy, <span class="dt">const</span> <span class="dt">qint16</span> &amp;dz);
<span class="co">// &#20027;&#30028;&#38754;&#36824;&#35201;&#26174;&#31034;&#20986;&#26469;&#65292;&#36825;&#26159;&#19968;&#20123;&#20449;&#21495;</span>
<span class="dt">void</span> mcuQuaternion( <span class="dt">qint16</span> q0,
                    <span class="dt">qint16</span> q1,
                    <span class="dt">qint16</span> q2,
                    <span class="dt">qint16</span> q3 );
<span class="dt">void</span> mcuAdisRequireData( <span class="dt">qint16</span> d1, <span class="dt">qint16</span> d2, <span class="dt">qint16</span> d3,
                         <span class="dt">qint16</span> d4, <span class="dt">qint16</span> d5, <span class="dt">qint16</span> d6,
                         <span class="dt">qint16</span> d7, <span class="dt">qint16</span> d8, <span class="dt">qint16</span> d9,
                         <span class="dt">qint16</span> da, <span class="dt">qint16</span> db, <span class="dt">qint16</span> dc );
<span class="dt">void</span> mcuRollPitchYaw( <span class="dt">qint16</span> r,
                      <span class="dt">qint16</span> p,
                      <span class="dt">qint16</span> y );
<span class="dt">void</span> mcuAcc( <span class="dt">qint16</span> x,
             <span class="dt">qint16</span> y,
             <span class="dt">qint16</span> z );
<span class="dt">void</span> mcuGyro( <span class="dt">qint16</span> gyro_x,
              <span class="dt">qint16</span> gyro_y,
              <span class="dt">qint16</span> gyro_z );
<span class="dt">void</span> mcuMag( <span class="dt">qint16</span> mag_x,
             <span class="dt">qint16</span> mag_y,
             <span class="dt">qint16</span> mag_z );
<span class="dt">void</span> mcuRefMatrix( <span class="dt">qint16</span> r1, <span class="dt">qint16</span> r2, <span class="dt">qint16</span> r3,
                   <span class="dt">qint16</span> r4, <span class="dt">qint16</span> r5, <span class="dt">qint16</span> r6,
                   <span class="dt">qint16</span> r7, <span class="dt">qint16</span> r8, <span class="dt">qint16</span> r9 );</code></pre></div>
<p>&#35835;&#21462; MCU &#25968;&#25454;&#21518;&#65292;&#20063;&#35201; dispatch&#65292;&#32780;&#19988;&#36824;&#35201;&#21028;&#26029;&#35835;&#21462;&#26159;&#21542;&#26377;&#8220;&#20132;&#38169;&#8221;&#65292;&#22240;&#20026;&#25968;&#25454;&#35835;&#21462;&#24448;&#24448;&#26159;&#21521;&#22810;&#20010;&#23492;&#23384;&#22120;&#36827;&#34892;&#30340;&#65292;&#24182;&#19981;&#33021;&#20551;&#23450;&#35831;&#27714;&#21644;&#25910;&#21040;&#30340;&#25968;&#25454;&#23601;&#26159;&#19968;&#19968;&#21305;&#37197;&#30340;&#65292;MCU &#30340;&#35835;&#21462;&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> MCUController::readMCU( )
{
    <span class="ot">QByteArray</span> ba = mcuCom-&gt;readAll();

    <span class="co">// chop garbage values</span>
    <span class="dt">int</span> i = <span class="dv">0</span>;
    <span class="kw">while</span> ( i &lt; ba.length() &amp;&amp; ba.at(i) != devAddr ) {
        ++i;
    }
    ba.remove( <span class="dv">0</span>, i );

    <span class="kw">if</span> ( ba.length() &lt; <span class="dv">2</span> ) {      <span class="co">// at least 2 bytes: devAddr, function code</span>
        <span class="kw">return</span>;
    }

    <span class="ot">QString</span> str( ba );
    <span class="ot">QString</span> hexstr = ba2hexstr( ba );
    <span class="kw">emit</span> mcuData( str );
   <span class="co">// emit mcuHexData( hexstr );</span>
    <span class="kw">if</span> ( SHOW_READ ) {
        Logger::log( BCD::MCU::MCU, <span class="ot">QString</span>( <span class="st">&quot;MCU%1 Received %2 bytes: %3&quot;</span> ).arg( id ).arg( ba.length() ).arg( hexstr ) );
    }

    <span class="dt">quint8</span> fc = ba.at( <span class="dv">1</span> ); <span class="co">// function code</span>
    <span class="kw">if</span> ( fc != functionCode ) {
        <span class="co">// function code is the &lt;write data&gt;&#39;s status,</span>
        <span class="co">// it must equal the &lt;received data&gt;&#39;s status</span>
        Logger::log( BCD::MCU::CONVOLUTED_TX_RX );
        <span class="kw">return</span>;
    }

    <span class="co">// dispatch</span>
    <span class="kw">if</span> ( <span class="kw">false</span> ) {
    } <span class="kw">else</span> <span class="kw">if</span> ( READ_HOLDING_REGISTERS == fc ) {
        <span class="co">// &#37324;&#38754;&#36824;&#35201;&#21028;&#26029;&#35835;&#21040;&#30340;&#22320;&#22336;&#21644;&#33258;&#24049;&#19978;&#27425;&#35831;&#27714;&#30340;&#22320;&#22336;&#26159;&#21542;&#19968;&#33268;&#12290;</span>
        onReadHoldingRegisters( ba );
    }

    <span class="kw">if</span> ( !crc16Passed( ba ) ) {
        Logger::log( BCD::MCU::MCU, <span class="st">&quot;err crc16 failed&quot;</span> );
        <span class="kw">return</span>;
    }
}

<span class="dt">void</span> MCUController::onReadHoldingRegisters( <span class="ot">QByteArray</span> &amp;ba )
{
    <span class="kw">switch</span> ( currentMode ) {
    <span class="kw">case</span> GET_TIME_STAMP:                 parseTimestamp( ba );              <span class="kw">break</span>;
    <span class="kw">case</span> GET_RANGE_1_TO_5:               parseRange1to5( ba );              <span class="kw">break</span>;
<span class="co">/*  case GET_ADIS_REQUIRE_DATA:          parseADISRequiredata( ba );        break; // only one scan */</span>
    <span class="kw">case</span> GET_ADIS_REQUIRE_DATA:          parseADISScans( ba );              <span class="kw">break</span>; <span class="co">// multiple scans</span>
<span class="co">/*  case GET_ADIS_REQUIRE_DATA:          threadParseADIS( ba );             break; */</span>
    <span class="kw">case</span> GET_QUATERNION:                 parseQuaternion( ba );             <span class="kw">break</span>;
    <span class="kw">case</span> GET_ROLL_PITCH_YALL:            parseRollPitchYaw( ba );           <span class="kw">break</span>;
    <span class="kw">case</span> GET_ACCEL_XYZ:                   parseAcceleration( ba );          <span class="kw">break</span>;
    <span class="kw">case</span> GET_GYRO_XYZ:                   parseGyroScope( ba );              <span class="kw">break</span>;
    <span class="kw">case</span> GET_MAG_XYZ:                    parseMagnetometer( ba );           <span class="kw">break</span>;
<span class="co">/*  case GET_H_MOTOR_NUM:                parseHMotorNum( ba );              break; */</span>
    <span class="kw">case</span> GET_HORIZONTAL_MOTORNUM:        parseHorizontalMotornum( ba );     <span class="kw">break</span>;
    <span class="kw">case</span> GET_ROTATION_XYZ:               parseRotation( ba );               <span class="kw">break</span>;
    <span class="kw">case</span> GET_ENCODERS:                   parseEncoders( ba );               <span class="kw">break</span>;
    <span class="kw">case</span> GET_EKF:                        parseEkf( ba );                    <span class="kw">break</span>;
    <span class="kw">default</span>:                             Logger::log( BCD::MCU::MCU, <span class="st">&quot;mcuFC not match.&quot;</span> );
    }
}</code></pre></div>
<p>IMU &#29992;&#26469;&#27979;&#37327;&#23039;&#24577;&#21644;&#21152;&#36895;&#24230;&#65292;&#22914;&#26524;&#19968;&#30452;&#20351;&#29992;&#31934;&#24230;&#23601;&#20250;&#24456;&#24046;&#65292;&#25152;&#20197;&#38656;&#35201;&#19981;&#26102;&#22320; tare&#65288;&#32622;&#38646;&#65289;&#19968;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> MCUController::doTare( )
{
    <span class="ot">QByteArray</span> tx;
    tx.append( <span class="st">&#39;</span><span class="ch">\0</span><span class="st">&#39;</span> );
    tx.append(  <span class="dv">13</span>  );
    writeMultipleRegisters( mcuAddr.value( ON_OFF_ADDR ), <span class="dv">1</span>, tx );
    Logger::log( BCD::MCU::TARE );
}</code></pre></div>
<p>&#20174; <code>writeMultipleRegisters( mcuAddr.value( ON_OFF_ADDR ), 1, tx )</code> &#21487;&#20197;&#30475;&#20986;&#65292;&#25105;&#20381;&#26087;&#26159;&#25226;&#25152;&#26377;&#30340;&#20989;&#25968;&#22320;&#22336;&#23384;&#22312;&#20102;&#19968;&#20010; map &#37324;&#12290;&#36825;&#26679;&#29992;&#36215;&#26469;&#27604;&#36739;&#26041;&#20415;&#65288;&#34429;&#28982;&#26377;&#36807;&#24230;&#24037;&#31243;&#30340;&#23244;&#30097;&#65289;&#12290;</p>
<p>&#37027;&#20010; <code>tx.append( '\0' )</code> &#21017;&#26159;&#26080;&#22856;&#20043;&#20030;&#65292;&#22240;&#20026;&#25105;&#35797;&#20102; <code>tx.append( 0 )</code> &#21644; <code>tx.append( char(0) )</code>&#65292;&#37117;&#19981;&#21487;&#20197;&#12290;&#36824;&#22909;&#32456;&#20110;&#25104;&#21151;&#20102;==&#12290;</p>
<p>&#65288;By the way&#65292;&#36825;&#21487;&#33021;&#26159;&#26089;&#26399;&#30340;&#20195;&#30721;&#65292;&#22240;&#20026;&#29616;&#22312;&#19968;&#30475;&#23601;&#24212;&#35813;&#29992; <code>quint16 highlow( const quint8 &amp;high, const quint8 &amp;low )</code> &#21834;&#12290;&#65289;</p>
<p>IMU &#27169;&#22359;&#23601;&#21040;&#36825;&#37324;&#12290;&#19979;&#38754;&#35762; UR &#27169;&#22359;&#12290;</p>
<h2 id="ur">UR</h2>
<p>&#22312;&#25105;&#36824;&#22312;&#32769;&#24072;&#30340;&#20844;&#21496;&#20570;&#26412;&#31185;&#27605;&#35774;&#30340;&#26102;&#20505;&#65292;&#25105;&#23601;&#30475;&#21040;&#20102; UR10&#12290;&#27809;&#24819;&#21040;&#21518;&#26469;&#23427;&#30340;&#25511;&#21046;&#31243;&#24207;&#36824;&#26159;&#25105;&#20889;&#30340;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/2016-07-26_10-20-05.png" alt="&#25918;&#22312;&#20844;&#21496;&#20108;&#27004;&#30340; UR10 &#26426;&#26800;&#33218;" align="right" />
<p class="caption">&#25918;&#22312;&#20844;&#21496;&#20108;&#27004;&#30340; UR10 &#26426;&#26800;&#33218;</p>
</div>
<p>&#20808;&#31616;&#35201;&#20171;&#32461;&#19968;&#19979;&#23427;&#65306;</p>
<blockquote>
<p>UR&#65288;Universal Robot&#65289;&#26159;&#19968;&#20010;&#26426;&#26800;&#33218;&#65292;&#20301;&#20110;&#36710;&#26426;&#26800;&#33218;&#26411;&#31471;&#65292;&#25645;&#36733;&#20102;&#20840;&#37096;&#20256;&#24863;&#22120;&#12290; &#20849; 6 &#20010;&#20851;&#33410;&#65292;&#22343;&#21487; 360 &#24230;&#26059;&#36716;&#65292;&#21487;&#23450;&#28857;&#31227;&#21160;&#12290;</p>
</blockquote>
<p>&#30456;&#27604; LMS &#20351;&#29992; TCP&#65292;IMU &#20351;&#29992;&#20018;&#21475; Modbus &#21327;&#35758;&#65292;UR10 &#25552;&#20379;&#20102;&#26356;&#20840;&#38754;&#20415;&#25463;&#30340;&#20132;&#20114;&#25509;&#21475;&#65306;&#20320;&#21487;&#20197;&#20351;&#29992; TCP&#65292;&#20063;&#21487;&#20197;&#26159;&#29992; Modbus&#65288;&#32780;&#19988;&#26159; Modbus TCP&#65292;&#27604; IMU &#30340;&#20018;&#21475; Modbus &#22909;&#29992;&#24471;&#22810;&#65289;&#12290;</p>
<p>&#22240;&#20026; TCP &#20351;&#29992;&#36215;&#26469;&#26041;&#20415;&#24471;&#22810;&#65292;&#25105;&#20204;&#20351;&#29992;&#20102; TCP<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a>&#65292;&#23427;&#25552;&#20379;&#22235;&#20010;&#31471;&#21475;&#65292;&#25152;&#20197;&#25105;&#20204;&#30340; URController &#31867;&#37324;&#26377;&#22235;&#20010;&#25104;&#21592;&#21464;&#37327;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">QTcpSocket</span> urDashboardAgent;
<span class="ot">QTcpSocket</span> urClient1;
<span class="ot">QTcpSocket</span> urClient2;
<span class="ot">QTcpSocket</span> urStatusAgent;</code></pre></div>
<p>&#36825;&#26159;&#19968;&#20123;&#26377;&#29992;&#30340;&#21464;&#37327;&#12290;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">enum</span> {
    UR_ModbusTCPPort          = <span class="dv">502</span>,    <span class="co">// UR &#25552;&#20379;&#30340; ModbusTCP &#31471;&#21475;&#65292;&#19981;&#22909;&#29992;&#65292;&#25152;&#20197;&#27809;&#29992;&#20102;</span>
    UR_DashboardPort          = <span class="dv">29999</span>,
    UR_Client1Port            = <span class="dv">30001</span>,  <span class="co">// controller</span>
    UR_Client2Port            = <span class="dv">30002</span>,
    UR_StatusPort             = <span class="dv">30003</span>,  <span class="co">// UR status, 100Hz</span>
};</code></pre></div>
<p>&#22914;&#19979;&#22270;&#65292;urClient1 &#36830;&#25509;&#21040;&#31471;&#21475; 30001&#65292;&#29992;&#26469;&#25511;&#21046; UR &#30340;&#31227;&#21160;&#65292;&#20351;&#29992;&#30340;&#26159; UR &#25991;&#26723;&#20013;&#35828;&#21040;&#30340; UScript &#33050;&#26412;&#12290; urStatusAgent &#36830;&#25509;&#21040;&#31471;&#21475; 30003&#65292;&#29992;&#26469;&#33719;&#21462; UR &#24403;&#21069;&#30340;&#20301;&#23039;&#21644;&#29366;&#24577;&#65292;&#25968;&#25454;&#39057;&#29575;&#26159; 100 Hz&#65292;&#27599;&#27425; 1440 &#20010;&#23383;&#33410;&#30340;&#25968;&#25454;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/ur-conn-UR.png" />

</div>
<p>&#19978;&#22270;&#21407;&#26159;&#25105;&#30011;&#22312; processingon &#19978;&#30340;&#65292;&#38142;&#25509;&#22312;&#36825;&#37324;&#65306;<a href="https://www.processon.com/view/link/56ee186de4b0881f9ac2e009" class="uri">https://www.processon.com/view/link/56ee186de4b0881f9ac2e009</a>&#12290;</p>
<p>UR &#26368;&#37325;&#35201;&#30340;&#65292;&#26159;&#23427;&#30340;&#24403;&#21069;&#23039;&#24577;&#65292;&#25105;&#20204;&#25226;&#23427;&#23384;&#22312;&#20102;&#19968;&#36215;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">struct</span> URStatus {
    <span class="dt">quint32</span> size;
    <span class="dt">double</span> time;
    <span class="dt">double</span> q_target[<span class="dv">6</span>];                 <span class="co">// joint target, rad</span>
    <span class="dt">double</span> qd_target[<span class="dv">6</span>];                <span class="co">// rad/s</span>
    <span class="dt">double</span> qdd_target[<span class="dv">6</span>];               <span class="co">// rad/s^2</span>
    <span class="dt">double</span> i_target[<span class="dv">6</span>];                 <span class="co">// target current, A</span>
    <span class="dt">double</span> m_target[<span class="dv">6</span>];                 <span class="co">// torque, in Nm</span>

    <span class="dt">double</span> q_actual[<span class="dv">6</span>];                 <span class="co">// rad</span>
    <span class="dt">double</span> qd_actual[<span class="dv">6</span>];                <span class="co">// rad/s</span>
    <span class="dt">double</span> i_actual[<span class="dv">6</span>];                 <span class="co">// needed current, A</span>
    <span class="dt">double</span> i_control[<span class="dv">6</span>];                <span class="co">// supplied current, A</span>

    <span class="dt">double</span> tcp_vector_actual[<span class="dv">6</span>];        <span class="co">// m, rad</span>
    <span class="dt">double</span> tcp_speed_actual[<span class="dv">6</span>];         <span class="co">// m/s, rad/s</span>
    <span class="dt">double</span> tcp_force_actual[<span class="dv">6</span>];         <span class="co">// N, Nm</span>
    <span class="dt">double</span> tcp_vector_target[<span class="dv">6</span>];        <span class="co">// m, rad</span>
    <span class="dt">double</span> tcp_speed_target[<span class="dv">6</span>];         <span class="co">// m/s, rad/s</span>

    <span class="dt">double</span> digital_input_bits;
    <span class="dt">double</span> motor_temperatures[<span class="dv">6</span>];       <span class="co">// temperature(&#176;C) of six joints</span>

    <span class="dt">double</span> controller_timer;
    <span class="dt">double</span> reverved_value;
    <span class="dt">double</span> robot_mode;
    <span class="dt">double</span> joint_modes[<span class="dv">6</span>];
    <span class="dt">double</span> safety_mode;

    <span class="dt">double</span> ur_only1[<span class="dv">6</span>];
    <span class="dt">double</span> tool_accelerometer_values[<span class="dv">3</span>];
    <span class="dt">double</span> ur_only2[<span class="dv">6</span>];

    <span class="dt">double</span> speed_scaling;
    <span class="dt">double</span> linear_momentum_norm;
    <span class="dt">double</span> ur_only3;
    <span class="dt">double</span> ur_only4;

    <span class="dt">double</span> v_main;                      <span class="co">// V</span>
    <span class="dt">double</span> v_robot;                     <span class="co">// V</span>
    <span class="dt">double</span> i_robot;                     <span class="co">// A</span>
    <span class="dt">double</span> v_actual[<span class="dv">6</span>];
} ust;</code></pre></div>
<p>&#37324;&#38754;&#30340; tcp &#21487;&#19981;&#26159;&#32593;&#32476;&#36890;&#20449;&#30340; tcp&#65292;&#32780;&#26159; tool center point&#65292;&#20063;&#23601;&#26159; UR10 &#26411;&#31471;&#65288;&#26368;&#36828;&#31471;&#65289;&#12290;</p>
<p>&#22312; UR &#30340;&#26500;&#36896;&#20989;&#25968;&#37324;&#65292;&#38656;&#35201;&#36830;&#25509;&#20960;&#20010;&#27133;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#26377;&#25968;&#25454;&#23601;&#35835;&#25968;&#25454;</span>
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(readUR()) );
<span class="fu">connect</span>( &amp;urClient1, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(parseURAgent1()) );
<span class="fu">connect</span>( &amp;urClient2, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(parseURAgent2()) );
<span class="fu">connect</span>( &amp;urDashboardAgent, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(parseURDashboard()) );
<span class="fu">connect</span>( &amp;urStatusAgent, <span class="kw">SIGNAL</span>(readyRead()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(parseURStatus()) );

<span class="co">// &#25481;&#32447;&#23601;&#33258;&#21160;&#37325;&#36830;</span>
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectUR()) );
<span class="fu">connect</span>( &amp;urDashboardAgent, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectDashboard()) );
<span class="fu">connect</span>( &amp;urClient1, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectClient1()) );
<span class="fu">connect</span>( &amp;urClient2, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectClient2()) );
<span class="fu">connect</span>( &amp;urStatusAgent, <span class="kw">SIGNAL</span>(disconnected()),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(connectStatusAgent()) );
<span class="fu">connect</span>( <span class="kw">this</span>, <span class="kw">SIGNAL</span>(stateChanged(<span class="ot">QAbstractSocket::</span>SocketState)),
         <span class="kw">this</span>, <span class="kw">SLOT</span>(urStateChanged(<span class="ot">QAbstractSocket::</span>SocketState)) );</code></pre></div>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> URController::dashboardWrite( <span class="ot">QByteArray</span> &amp;ba )
{
    ba.append( <span class="st">&quot;</span><span class="ch">\r\n</span><span class="st">&quot;</span> );
    urDashboardAgent.write( ba, ba.length() );
    Logger::log( BCD::UR::DASHBOARD_WRITE );
}

<span class="dt">void</span> URController::client1Write( <span class="ot">QByteArray</span> &amp;ba ) { ... }
<span class="dt">void</span> URController::client2Write( <span class="ot">QByteArray</span> &amp;ba ) { ... }</code></pre></div>
<p>UR &#26368;&#37325;&#35201;&#30340;&#26159;&#33719;&#21462; UR &#30340;&#24403;&#21069;&#23039;&#24577;&#65292;&#32780;&#19988;&#25105;&#20204;&#21482; parse &#25105;&#20204;&#38656;&#35201;&#30340;&#25968;&#25454;&#65306;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/ur-decode-status.png" />

</div>
<p>&#20195;&#30721;&#22914;&#19979;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> URController::parseURStatus( <span class="dt">const</span> <span class="ot">QByteArray</span> &amp;ba )
{
    <span class="kw">if</span> ( ba.length() != <span class="dv">2</span> * UR_STATUS_BUF_LENGTH ) { <span class="kw">return</span>; }

    <span class="co">// then we parse the 1044 bytes</span>
    <span class="dt">bool</span> t = <span class="kw">true</span>, f = <span class="kw">false</span>;     <span class="co">// flag to determine Parsing or Not</span>
    <span class="dt">quint16</span> c = <span class="dv">0</span>;                <span class="co">// cursor</span>

    ust.size                         = parse4Bytes2Int4UR( ba, c ); c += <span class="dv">4</span>;
    <span class="kw">if</span> (ust.size != UR_STATUS_BUF_LENGTH) {
        <span class="fu">qDebug</span>() &lt;&lt; <span class="st">&quot;oops: &quot;</span> &lt;&lt; ust.size;
        <span class="kw">return</span>;
    }

<span class="ot">#define PARSE_TO_DOUBLE parse8BytesToDouble</span>
<span class="co">// #define PARSE_TO_DOUBLE parse8Bytes2Double4UR</span>
    ust.time                         = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// q target&#65292;&#36825;&#20123;&#19996;&#35199;&#19981;&#37325;&#35201;&#65292;&#25152;&#20197;&#20256;&#20837;&#8220;f&#8221;&#65292;&#21363;&#65306;&#12304;&#19981;&#22788;&#29702;&#12305;</span>
    ust.q_target[<span class="dv">0</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.q_target[<span class="dv">5</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// q target differential</span>
    ust.qd_target[<span class="dv">0</span>]                 = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.qd_target[<span class="dv">5</span>]                 = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// qdd</span>
    ust.qdd_target[<span class="dv">0</span>]                = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.qdd_target[<span class="dv">5</span>]                = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// I</span>
    ust.i_target[<span class="dv">0</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.i_target[<span class="dv">5</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// M</span>
    ust.m_target[<span class="dv">0</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.m_target[<span class="dv">5</span>]                  = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    <span class="co">// q actual&#65292;&#20851;&#33410;&#30340;&#35282;&#24230;&#12290;&#36825;&#26159;&#25105;&#20204;&#20851;&#24515;&#30340;&#20869;&#23481;&#65292;&#25152;&#20197;&#20256;&#20837;&#8220;t&#8221;&#65292;&#34920;&#31034;&#12304;&#38656;&#35201; parse&#12305;</span>
    ust.q_actual[<span class="dv">0</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">1</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">2</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">3</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">4</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.q_actual[<span class="dv">5</span>]                  = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    <span class="co">// &#35299;&#26512;&#24471;&#21040;&#30340;&#25968;&#25454;&#31435;&#39532; emit &#20986;&#21435;&#65292;&#20027;&#30028;&#38754;&#33719;&#24471;&#20102;&#65292;&#21487;&#20197;&#23454;&#26102;&#26174;&#31034;&#20986;&#26469;</span>
    <span class="kw">emit</span> ustJ0toJ5( rad2deg( ust.q_actual[<span class="dv">0</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">1</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">2</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">3</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">4</span>] ),
                    rad2deg( ust.q_actual[<span class="dv">5</span>] ) );
    <span class="co">// qd&#65292;&#36825;&#26159;&#21152;&#36895;&#24230;&#12290;</span>
    ust.qd_actual[<span class="dv">0</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">1</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">2</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">3</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">4</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    ust.qd_actual[<span class="dv">5</span>]                    = PARSE_TO_DOUBLE(ba, c, t); c += <span class="dv">8</span>;
    <span class="kw">emit</span> ustJ0toJ5d( rad2deg( ust.qd_actual[<span class="dv">0</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">1</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">2</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">3</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">4</span>] ),
                     rad2deg( ust.qd_actual[<span class="dv">5</span>] ) );
    ...

    <span class="co">// TCP&#65292;&#26411;&#31471;&#24471;&#20301;&#32622;</span>
    ust.tcp_vector_actual[<span class="dv">0</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">1</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">2</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">3</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">4</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    ust.tcp_vector_actual[<span class="dv">5</span>]         = PARSE_TO_DOUBLE( ba, c, t ); c += <span class="dv">8</span>;
    <span class="kw">emit</span> ustXYZRxRyRz( ust.tcp_vector_actual[<span class="dv">0</span>],
                       ust.tcp_vector_actual[<span class="dv">1</span>],
                       ust.tcp_vector_actual[<span class="dv">2</span>],
                       ust.tcp_vector_actual[<span class="dv">3</span>],
                       ust.tcp_vector_actual[<span class="dv">4</span>],
                       ust.tcp_vector_actual[<span class="dv">5</span>] );

    <span class="co">// tcp speed actual</span>
    ust.tcp_speed_actual[<span class="dv">0</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.tcp_speed_actual[<span class="dv">5</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;

    <span class="co">// tcp force</span>
    ust.tcp_force_actual[<span class="dv">0</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.tcp_force_actual[<span class="dv">5</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;

    <span class="co">// tcp target</span>
    ust.tcp_vector_target[<span class="dv">0</span>]         = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.tcp_vector_target[<span class="dv">5</span>]         = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;

    <span class="co">// tcp speed target</span>
    ust.tcp_speed_target[<span class="dv">0</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...
    ust.tcp_speed_target[<span class="dv">5</span>]          = PARSE_TO_DOUBLE( ba, c, f ); c += <span class="dv">8</span>;
    ...

<span class="ot">#undef PARSE_TO_DOUBLE</span>
    <span class="co">// parsed c=1044 bytes now.</span>
}</code></pre></div>
<p>UR &#27169;&#22359;&#36824;&#21487;&#20197;&#25511;&#21046; UR &#20845;&#20010;&#26426;&#26800;&#33218;&#30340;&#31227;&#21160;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// &#31227;&#21160;&#21040;&#26576;&#20010;&#35282;&#24230;</span>
<span class="dt">void</span> URController::moveJ( <span class="dt">const</span> <span class="dt">double</span> &amp;x1,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x2,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x3,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x4,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x5,
                          <span class="dt">const</span> <span class="dt">double</span> &amp;x6 )
{
    <span class="ot">QString</span> str;
    str.sprintf( <span class="st">&quot;movej([</span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">, </span><span class="ch">%lf</span><span class="st">]&quot;</span>
                 <span class="st">&quot;,a=</span><span class="ch">%.2lf</span><span class="st">, v=</span><span class="ch">%.2lf</span><span class="st">, t=</span><span class="ch">%.2lf</span><span class="st">, r=</span><span class="ch">%.2lf</span><span class="st">)&quot;</span>,
                  x1, x2, x3, x4, x5, x6,
                  urConf.qAcceleration,
                  urConf.qVelocity,          <span class="co">// velocity</span>
                  urConf.time,               <span class="co">// time</span>
                  urConf.blendRadius );      <span class="co">// blend radius</span>
    <span class="ot">QByteArray</span> ba;
    ba.append( str );
    client1Write( ba );
    Logger::log( BCD::UR::UR, <span class="ot">QString</span>( <span class="st">&quot;UR moveJ&#65306; %1&quot;</span>).arg( str ) );
}

<span class="co">// &#31227;&#21160;&#26576;&#20010;&#35282;&#24230;</span>
<span class="dt">void</span> URController::moveJDiff( <span class="dt">const</span> <span class="dt">double</span> &amp;x1,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x2,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x3,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x4,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x5,
                              <span class="dt">const</span> <span class="dt">double</span> &amp;x6 )
{
    <span class="dt">double</span> j[<span class="dv">6</span>] = { ust.q_actual[<span class="dv">0</span>],
                    ust.q_actual[<span class="dv">1</span>],
                    ust.q_actual[<span class="dv">2</span>],
                    ust.q_actual[<span class="dv">3</span>],
                    ust.q_actual[<span class="dv">4</span>],
                    ust.q_actual[<span class="dv">5</span>] };
    Logger::log( BCD::UR::UR,
        <span class="ot">QString</span>( <span class="st">&quot;UR moveJDiff&#65306; delta=[%1, %2, %3, %4, %5, %6]&quot;</span>).arg( x1 ).arg( x2 ).arg( x3 ).arg( x4 ).arg( x5 ).arg( x6 ) );
    moveJ( j[<span class="dv">0</span>] + x1
         , j[<span class="dv">1</span>] + x2
         , j[<span class="dv">2</span>] + x3
         , j[<span class="dv">3</span>] + x4
         , j[<span class="dv">4</span>] + x5
         , j[<span class="dv">5</span>] + x6 );
}</code></pre></div>
<p>&#37324;&#38754;&#29992;&#30340;&#26159; UR &#25552;&#20379;&#30340;&#33050;&#26412;&#12290;UR10 &#30340;&#35828;&#26126;&#25991;&#26723;&#37324;&#26377;&#19968;&#26412; UScript 1.0&#65292;&#37324;&#38754;&#23545;&#27492;&#26377;&#25152;&#35828;&#26126;&#12290;&#25105;&#20204;&#38656;&#35201;&#30340;&#21482;&#26159;&#31227;&#21160;&#20851;&#33410;&#12289;&#31227;&#21160;&#21040;&#26576;&#19968;&#20010;&#20301;&#32622;&#12290;&#25152;&#20197;&#36824;&#19981;&#31639;&#22826;&#22797;&#26434;&#12290;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/ur-process.png" />

</div>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/ur-old.png" alt="&#36825;&#26159;&#26089;&#26399;&#30340;&#19968;&#20010;&#25130;&#22270;" />
<p class="caption">&#36825;&#26159;&#26089;&#26399;&#30340;&#19968;&#20010;&#25130;&#22270;</p>
</div>
<p>UR &#23601;&#35762;&#21040;&#36825;&#12290;</p>
<p>&#20256;&#24863;&#22120;&#27169;&#22359;&#20063;&#23601;&#21040;&#24213;&#20026;&#27490;&#20102;&#12290;</p>
<h1 id="&#36890;&#20449;&#27169;&#22359;wrappers-&#21644;-moderator">5. &#36890;&#20449;&#27169;&#22359;&#65306;Wrappers &#21644; Moderator</h1>
<blockquote>
<p>&#31616;&#20171;&#36328;&#30005;&#33041; IPC&#65292;&#36827;&#34892;&#20989;&#25968;&#35843;&#29992;&#65307;</p>
</blockquote>
<p>&#65288;&#36825;&#37096;&#20998;&#24456;&#20869;&#23481;&#20063;&#24456;&#22810;&#12290;&#26242;&#26102;&#27809;&#26102;&#38388;&#20889;&#23436;&#12290;&#65289;</p>
<p>&#30005;&#33041;/&#36827;&#31243;&#20043;&#38388;&#30340;&#36890;&#20449;&#65292;&#21487;&#20197;&#20351;&#29992; TCP&#65292;&#21487;&#20197;&#35828; TCP &#26159;&#26368;&#22909;&#30340; IPC&#65288;&#27809;&#26377;&#20043;&#19968;&#65289;&#65292;&#22240;&#20026;&#23427;&#65306;</p>
<ul>
<li>&#36328;&#24179;&#21488;&#12289;&#36328;&#20027;&#26426;</li>
<li>&#36328;&#35821;&#35328;</li>
<li>&#25928;&#29575;&#39640;</li>
<li>&#21487;&#38752;&#20256;&#36755;</li>
</ul>
<p>&#21807;&#19968;&#30340;&#19981;&#22909;&#22312;&#20110;&#23427;&#19981;&#33021;&#20351;&#29992;&#20849;&#20139;&#20869;&#23384;&#65292;&#20063;&#23601;&#26159;&#35828;&#19981;&#33021;&#20351;&#29992;&#21516;&#19968;&#20010;&#21464;&#37327;&#12290;&#21487;&#33021;&#23384;&#22312;&#21464;&#37327;&#30340;&#26356;&#26032;&#38382;&#39064;&#12290;But&#65292;anyway&#65292;&#29992; TCP &#26469;&#36890;&#20449;&#24635;&#26159;&#19981;&#38169;&#30340;&#12290;</p>
<p>&#65288;&#24635;&#26377;&#20123;&#20154;&#65292;&#35201; UDP &#26469;&#23454;&#29616;&#19968;&#20010;&#25417;&#24613;&#30340; TCP&#65292;&#25928;&#29575;&#20302;&#12289;&#25928;&#26524;&#24046;&#65292;&#26089;&#35813;&#19968;&#21171;&#27704;&#36920;&#30452;&#25509;&#19978; TCP&#12290;&#65289;</p>
<p>&#20854;&#23454;&#20197;&#21069;&#30340;&#19968;&#31687; post &#24050;&#32463;&#25552;&#21040;&#36807;&#65306;<a href="http://tangzx.qiniudn.com/post-0059-exe-wrapper.html">&#23553;&#35013;&#35828;&#26126;</a>&#65292;&#21487;&#20197;&#20808;&#30475;&#36825;&#36793;&#12290;&#36825;&#20010; post &#35762;&#24471;&#26159;&#26550;&#26500;&#65292;&#20063;&#23601;&#26159;&#35828;&#12304;&#22914;&#20309;&#23631;&#34109;&#31243;&#24207;&#35843;&#29992;&#65311;&#19981;&#31649;&#23427;&#26469;&#33258;&#26412;&#26426;&#65292;&#36824;&#26159;&#24322;&#22320;&#12305;&#12290;&#23545;&#24212;&#30340;&#20195;&#30721;&#22312; <a href="https://github.com/district10/CrossOS">district10/CrossOS: Cross OS Communication</a>&#65292;&#24050;&#32463;&#22312; Linux &#21644; Windows &#19978;&#27979;&#35797;&#36890;&#36807;&#12290;</p>
<p>&#22312;&#19978;&#38754; repo &#30340; README.txt &#37324;&#65292;&#20889;&#21040;&#65306;</p>
<blockquote>
<p>&#36824;&#38656;&#35201;&#23450;&#20041;&#19968;&#20010;&#21327;&#35758;&#65292;&#35268;&#23450;&#30456;&#20114;&#20256;&#36882;&#25968;&#25454;&#30340;&#26684;&#24335;&#12290;&#22914;&#65306;&#31532;&#19968;&#20010;&#23383;&#33410;&#20195;&#34920;&#20256;&#36755;&#31867;&#22411;&#65292;&#25991;&#26412;&#65311;buf&#65311;&#38656;&#35201;&#20445;&#23384;&#65311;&#25968;&#25454;&#24320;&#22987;&#65311;&#25968;&#25454;&#32467;&#26463;&#65311;&#31561;&#31561;&#12290;</p>
<p>&#20551;&#35774;&#36825;&#20010;&#35268;&#21017;&#20026; moderator&#65292;moderator &#38656;&#35201;&#22312;&#21457;&#36865;&#21069;&#23545;&#25968;&#25454;&#36827;&#34892;&#23553;&#35013;&#65292;&#22312;&#25910;&#21040;&#25968;&#25454;&#26102;&#36827;&#34892;&#35299;&#26512;&#21644;&#20998;&#21457;&#12290;&#23601;&#22909;&#35937;&#36825;&#20010; moderator &#26159;&#25105;&#20204;&#30340; PDU &#35299;&#26512;&#24037;&#20855;&#12290;</p>
</blockquote>
<p>&#22522;&#20110;&#36825;&#20010; Wrapper&#65292;&#25105;&#35774;&#35745;&#20102; Moderator&#65288;&#20013;&#20171;&#65289;&#27169;&#22359;&#65292;&#19987;&#38376;&#36127;&#36131;&#24207;&#21015;&#21270;&#21644;&#21453;&#24207;&#21015;&#21270;&#21518;&#20989;&#25968;&#35843;&#29992;&#12290;</p>
<p>&#23427;&#30340;&#20316;&#29992;&#22914;&#19979;&#22270;&#65306;</p>
<div class="figure">
<img src="http://whudoc.qiniudn.com/2016/system-flow.png" />

</div>
<dl>
<dt>P.S. &#20013;&#20171;&#36890;&#24120;&#32763;&#35793;&#25104; intermediary agent&#65292;&#20026;&#20160;&#20040;&#25105;&#35201;&#29992; moderator &#26469;&#20570;&#36825;&#20010;&#27169;&#22359;&#21517;&#65311;</dt>
<dd><p>&#22240;&#20026;&#25105;&#26366;&#19978;&#36807;&#30340;&#19968;&#38376;&#33258;&#24049;&#21916;&#27426;&#30340;&#36873;&#20462;&#35838;&#65306;<a href="http://tangzx.qiniudn.com/post-0027-ai-will-kill-us.html">&#33521;&#35821;&#28436;&#35762;&#19982;&#36777;&#35770;</a>&#65292;&#37324;&#27599;&#27425;&#35752;&#35770;&#23567;&#32452;&#37324;&#37117;&#35201;&#26377;&#19968;&#20010; moderator &#20316;&#20026;&#21327;&#35843;&#32773;&#12290;&#20182;&#26469;&#32479;&#39046;&#35752;&#35770;&#30340;&#36827;&#34892;&#12290;</p>
<p>&#25105;&#35273;&#24471;&#36825;&#20010;&#27010;&#24565;&#21644;&#36825;&#37324;&#23436;&#20840;&#22865;&#21512;&#12290;&#25152;&#20197;&#25226;&#36825;&#20010;&#27169;&#22359;&#21483; moderator&#12290;</p>
</dd>
</dl>
<p>Moderator &#20027;&#35201;&#21033;&#29992;&#20102; Qt &#25552;&#20379;&#30340;&#24207;&#21015;&#21270;&#21151;&#33021;&#65292;&#23454;&#29616;&#20102;&#20989;&#25968;&#35843;&#29992;&#65288;&#20197;&#21450;&#35843;&#29992;&#21442;&#25968;&#65289;&#30340;&#30340;&#24207;&#21015;&#21270;&#12290;</p>
<p>&#39318;&#20808;&#35201;&#26126;&#30830;&#65292;&#25105;&#20204;&#30340;&#20195;&#30721;&#21482;&#26377;&#19968;&#20221;&#65292;&#21482;&#19981;&#36807;&#39640;&#24615;&#33021;&#35745;&#31639;&#26426;&#19978;&#20250;&#36816;&#34892; Master &#31243;&#24207;&#65292;&#24037;&#25511;&#26426;&#19978;&#20250;&#36816;&#34892; Slave &#31243;&#24207;&#65292;&#20004;&#32773;&#37117;&#26377;&#21508;&#20010;&#20256;&#24863;&#22120;&#27169;&#22359;&#65292;&#21482;&#19981;&#36807;&#20256;&#24863;&#22120;&#21482;&#26377;&#19968;&#36793;&#26159;&#30495;&#30340;&#26377;&#65292;&#21478;&#19968;&#36793;&#21482;&#26159;&#26377;&#19968;&#20010;&#31354;&#22771;&#65292;&#23427;&#21807;&#19968;&#30340;&#20316;&#29992;&#26159;&#35831;&#27714;&#21478;&#19968;&#36793;&#30340;&#20256;&#24863;&#22120;&#65292;&#24182;&#20551;&#35013;&#33258;&#24049;&#36825;&#36793;&#30495;&#30340;&#26377;&#20256;&#24863;&#22120;&#12290; Moderator &#22312;&#20004;&#36793;&#37117;&#26377;&#65292;&#19979;&#38754;&#26159;&#20195;&#30721;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">class</span> Moderator
{
<span class="kw">public</span>:
    Moderator( );
    <span class="dt">static</span> <span class="dt">bool</span> doItYourself( BCD::TypeID tid );

<span class="kw">public</span>:
    <span class="dt">static</span> <span class="dt">void</span> dispatch( <span class="ot">QByteArray</span> &amp;msg );

    <span class="kw">typedef</span> <span class="ot">QHash</span>&lt;BCD::TypeID, MasterSlaveType&gt; WhichSide;
    <span class="dt">const</span> <span class="dt">static</span> WhichSide wss;
    <span class="kw">enum</span> CrossType {
        <span class="co">// -- G E N E S I S - L M S --</span>
        GEN_LMS__START__QINT64,
        GEN_LMS__STOP__VOID,
        ...
        <span class="co">// -- G E N E S I S - U R --</span>
        GEN_UNIT__SET_UR_POSE__DOUBLE_DOUBLE_DOUBLE_DOUBLE_DOUBLE_DOUBLE
    };
    <span class="co">// -- G E N E S I S --</span>
    <span class="dt">static</span> <span class="ot">QByteArray</span> genLMS_start( <span class="dt">const</span> <span class="dt">qint64</span> &amp;dt = <span class="dv">0</span> );
    <span class="dt">static</span> <span class="ot">QByteArray</span> genLMS_stop( );
    <span class="dt">static</span> <span class="ot">QByteArray</span> genUnit_setUrPose( <span class="dt">double</span> x, <span class="dt">double</span> y, <span class="dt">double</span> z,
                                         <span class="dt">double</span> rx, <span class="dt">double</span> ry, <span class="dt">double</span> rz );
    ...

<span class="kw">private</span>:
    <span class="dt">static</span> WhichSide initWhichSides( );
};</code></pre></div>
<p>&#38656;&#35201;&#30041;&#24847;&#30340;&#22320;&#26041;&#26377;&#65306;</p>
<ol style="list-style-type: decimal">
<li><p><code>static bool doItYourself( BCD::TypeID tid )</code> &#36825;&#20010;&#20989;&#25968;&#22312;&#19968;&#20391;&#36820;&#22238;&#20102; true&#65292;&#22312;&#21478;&#19968;&#20391;&#23601;&#35201;&#36820;&#22238; false&#65292;&#22240;&#20026;&#19968;&#20010;&#20989;&#25968;&#35201;&#25226;&#22312; master &#19978;&#25191;&#34892;&#65292;&#35201;&#19981;&#20877;&#24037;&#25511;&#26426;&#19978;&#25191;&#34892;&#65292;&#19981;&#33021;&#21516;&#26102;&#20026; true&#65288;&#25110;&#32773; false&#65289;&#12290;&#23427;&#30340;&#23454;&#29616;&#20195;&#30721;&#20063;&#39047;&#20026;&#31616;&#21333;&#65306;<code class="sourceCode cpp"><span class="kw">return</span> Bundle::whoAmI() == wss.value( tid );</code>&#65292;&#20854;&#20013; wss &#23384;&#20648;&#20102;&#27880;&#20876;&#20449;&#24687;&#65292;&#20063;&#23601;&#26159;&#19968;&#20010;&#27169;&#22359;&#21040;&#24213;&#26159;&#35201;&#22312;&#24037;&#25511;&#26426;&#65292;&#36824;&#26159;&#39640;&#24615;&#33021;&#19978;&#36816;&#34892;&#12290;doItYourself &#30340;&#21442;&#25968;&#26159; BCD::TypeId tid&#65292;&#23601;&#26159;&#19968;&#20010;&#27169;&#22359;&#30340;&#32534;&#21495;&#12290;&#36825;&#20010;&#22312;&#26085;&#24535;&#27169;&#22359;&#37027;&#19968;&#37096;&#20998;&#35762;&#36807;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">namespace</span> BCD {
<span class="co">// types</span>
<span class="kw">enum</span> TypeID {
    TYPE_ARM,       <span class="co">// &#23545;&#24212; BCD::ARM::...</span>
    TYPE_IMU,       <span class="co">// &#23545;&#24212; BCD::IUM::...</span>
    TYPE_LMS,       <span class="co">// ...</span>
    TYPE_MCU,
    TYPE_UR,
    ...
};
...
}</code></pre></div>
<p>&#19968;&#20010;&#20256;&#24863;&#22120;&#35201;&#27880;&#20876;&#21040; Master &#25110;&#32773; Slave&#65292;&#22312; moderator.cpp &#37324;&#26377;&#23454;&#29616;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">const</span> Moderator::WhichSide Moderator::wss = Moderator::initWhichSides( );
Moderator::WhichSide Moderator::initWhichSides( )
{
    WhichSide wss;
    <span class="co">// Master: &#39640;&#24615;&#33021;&#24179;&#21488;</span>
    <span class="co">// Slave : &#24037;&#25511;&#26426;</span>
    wss.insert(  BCD::TYPE_SERVER,                  SLAVE           );
    wss.insert(  BCD::TYPE_CLIENT,                          MASTER  );
    wss.insert(  BCD::TYPE_LMS,                             MASTER  );
    wss.insert(  BCD::TYPE_MCU,                             MASTER  );
    wss.insert(  BCD::TYPE_UR,                      SLAVE           );
    wss.insert(  BCD::TYPE_ARM,                     SLAVE           );
    wss.insert(  BCD::TYPE_SP20000C,                        MASTER  );
    wss.insert(  BCD::TYPE_MULTIPLICATION_ON_SLAVE, SLAVE           );
    wss.insert(  BCD::TYPE_ADDITION_ON_MASTER,              MASTER  );

    <span class="kw">return</span> wss;
}</code></pre></div></li>
<li><p>&#20989;&#25968;&#30340;&#24207;&#21015;&#21270;&#65292;&#38656;&#35201;&#23558;&#20989;&#25968;&#21517;&#27880;&#20876;&#65292;&#24182;&#21644;&#26412;&#22320;&#20989;&#25968;&#32465;&#23450;&#65292;<code>enum CrossType { ... }</code> &#20570;&#30340;&#23601;&#26159;&#20989;&#25968;&#21517;&#27880;&#20876;&#30340;&#24037;&#20316;&#65292;&#23427;&#37324;&#38754;&#30340;&#27599;&#19968;&#20010;&#26631;&#24535;&#37117;&#23545;&#24212;&#19968;&#20010;&#20989;&#25968;&#65292;&#27604;&#22914; <code>GEN_LMS__START__QINT64</code> &#23601;&#23545;&#24212; <code>static QByteArray genLMS_start( const qint64 &amp;dt = 0 )</code>&#65292;<code>GEN_LMS__STOP__VOID</code> &#23601;&#23545;&#24212; <code>static QByteArray genLMS_stop( )</code>&#12290;</p>
<p>&#36825;&#19977;&#20010;&#20989;&#25968;&#30340;&#23454;&#29616;&#25918;&#22312;&#36825;&#37324;&#65292;&#20197;&#20570;&#21442;&#32771;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">&#20026;&#20102;&#20943;&#23569;&#36755;&#20837;&#37327;&#65292;TX_OUT &#26159;&#19968;&#20010;&#23439;&#65288;&#22312;&#36890;&#20449;&#39046;&#22495;&#65292;TX &#36890;&#24120;&#25351;&#30340;&#26159; transmission&#65289;
<span class="ot">#define TX_OUT </span>\
<span class="ot">    QByteArray tx; </span>\
<span class="ot">    QDataStream out( &amp;tx, QIODevice::WriteOnly ); </span>\
<span class="ot">    out.setVersion( QDataStream::Qt_4_8 ); </span>\
<span class="ot">    out</span>

<span class="ot">QByteArray</span> Moderator::genLMS_start( <span class="dt">const</span> <span class="dt">qint64</span> &amp;dt <span class="co">/*= 0 */</span> )
{
    TX_OUT &lt;&lt; (<span class="dt">int</span>)GEN_LMS__START__QINT64 &lt;&lt; dt;
    <span class="kw">return</span> tx;
}

<span class="ot">QByteArray</span> Moderator::genLMS_stop( )
{
    TX_OUT &lt;&lt; (<span class="dt">int</span>)GEN_LMS__STOP__VOID;
    <span class="kw">return</span> tx;
}

<span class="ot">QByteArray</span> Moderator::genUnit_setUrPose( <span class="dt">double</span> x, <span class="dt">double</span> y, <span class="dt">double</span> z, <span class="dt">double</span> rx, <span class="dt">double</span> ry, <span class="dt">double</span> rz )
{
    TX_OUT &lt;&lt; (<span class="dt">int</span>) GEN_UNIT__SET_UR_POSE__DOUBLE_DOUBLE_DOUBLE_DOUBLE_DOUBLE_DOUBLE
           &lt;&lt; x &lt;&lt; y &lt;&lt; z &lt;&lt; rx &lt;&lt; ry &lt;&lt; rz;
    <span class="kw">return</span> tx;
}</code></pre></div>
<p>&#20854;&#23454;&#23601;&#26159;&#25226;&#20989;&#25968;&#30340;&#26631;&#24535;&#21495;&#21644;&#21442;&#25968;&#19968;&#19968;&#24207;&#21015;&#21270;&#12290;</p></li>
<li><p>dispatch &#20989;&#25968;&#65292;&#23601;&#26159;&#25910;&#21040;&#21453;&#24207;&#21015;&#21270;&#20026;&#19968;&#20010;&#25805;&#20316;&#65292;&#28982;&#21518;&#22914;&#20309;&#35843;&#29992;&#20855;&#20307;&#30340;&#27169;&#22359;&#65306;</p>
<p>```cpp void Moderator::dispatch( QByteArray &amp;msg ) { int flag( -1 );</p>
<pre><code>QDataStream in( &amp;msg, QIODevice::ReadOnly );
in.setVersion ( QDataStream::Qt_4_8 );

while ( !in.atEnd() ) {
    in &gt;&gt; flag;

    if ( false ) {
    }
    ...
    else if ( GEN_LMS__START__QINT64 == flag )
    {
        qint64 ts;
        in &gt;&gt; ts;
        if ( Bundle::activated() &amp;&amp; Bundle::whoAmI() == SLAVE ) {
            Bundle::getInstance()-&gt;m_LMSReader-&gt;start( ts );
        }
    }
    else if ( GEN_LMS__STOP__VOID == flag )
    {
        if ( Bundle::activated() &amp;&amp; Bundle::whoAmI() == SLAVE ) {
            Bundle::getInstance()-&gt;m_LMSReader-&gt;stop();
        }
    }
    ...
    else if ( GEN_UNIT__SET_UR_POSE__DOUBLE_DOUBLE_DOUBLE_DOUBLE_DOUBLE_DOUBLE == flag )
    {
        double x, y, z, rx, ry, rz;
        in &gt;&gt; x &gt;&gt; y &gt;&gt; z &gt;&gt; rx &gt;&gt; ry &gt;&gt; rz;
        if ( Bundle::activated() &amp;&amp; Bundle::whoAmI() == SLAVE ) {
            // config ur pose
            if ( Bundle::getInstance() &amp;&amp; Bundle::getInstance()-&gt;collectionUnit ) {
                Bundle::getInstance()-&gt;setURPose( x, y, z, rx, ry, rz );
            }
        }
    }
    else
    {
    }
}
```</code></pre></li>
</ol>
<p>&#33267;&#27492;&#65292;&#38382;&#39064;&#37117;&#35299;&#20915;&#20102;&#12290;</p>
<h1 id="&#24635;&#32467;&#25910;&#33719;&#19982;&#19981;&#36275;">6. &#24635;&#32467;&#65306;&#25910;&#33719;&#19982;&#19981;&#36275;</h1>
<p>&#19968;&#26465;&#26465;&#35828;&#21543;&#12290;</p>
<p>&#25910;&#33719;&#65306;</p>
<ul>
<li>&#20174;&#22823;&#19977;&#35748;&#35782;&#23002;&#32769;&#24072;&#65292;&#25105;&#23601;&#22312;&#23581;&#35797;&#20351;&#29992; Qt&#65292;&#20294;&#32463;&#36807;&#36825;&#20010;&#39033;&#30446;&#65292;Qt &#25165;&#31639;&#30495;&#27491;&#20837;&#20102;&#38376;&#65307;</li>
<li>CMake &#21407;&#26412;&#20063;&#26159;&#30053;&#30693;&#19968;&#20108;&#65307;&#20294;&#25343;&#21040;&#21035;&#20154;&#30340; CMake &#24037;&#31243;&#65292;&#36305;&#36215;&#26469;&#23481;&#26131;&#65307;&#20294;&#33258;&#24049;&#29992; CMake &#26469;&#32452;&#32455;&#23601;&#19981;&#31616;&#21333;&#20102;&#65292;&#32463;&#36807;&#36825;&#19968;&#30058;&#39033;&#30446;&#30952;&#30778;&#65292;&#33258;&#24049;&#23545; CMake &#21644; C++ &#30340;&#32534;&#35793;&#38142;&#25509;&#20063;&#26377;&#20102;&#26356;&#22810;&#30340;&#20102;&#35299;&#65307;</li>
<li>&#20570;&#20102;&#19968;&#20010;&#22823;&#39033;&#30446;&#65292;&#33258;&#24049;&#30340;&#20195;&#30721;&#37327;&#26159;&#26368;&#22823;&#30340;&#65292;&#36127;&#36131;&#20102;&#20960;&#20046;&#25152;&#26377;&#30340;&#20256;&#24863;&#22120;&#65292;&#20063;&#23398;&#21040;&#19968;&#20123;&#30456;&#20851;&#30828;&#20214;&#30693;&#35782;&#12289;&#36890;&#20449;&#30693;&#35782;&#65307;</li>
<li>&#35748;&#35782;&#20102;&#38271;&#27801;&#22242;&#38431;&#20986;&#33394;&#30340;&#20225;&#19994;&#23478;&#65288;&#31185;&#23398;&#23478;&#65289;&#12289;&#24037;&#31243;&#24072;&#65292;&#35748;&#35782;&#21040;&#30693;&#35782;&#30495;&#30340;&#26159;&#31532;&#19968;&#29983;&#20135;&#21147;&#65307;</li>
</ul>
<p>&#19981;&#36275;&#65306;</p>
<ul>
<li>&#22522;&#30784;&#19981;&#29282;&#65292;&#20889;&#20195;&#30721;&#30340;&#36807;&#31243;&#20013;&#21508;&#31181;&#30933;&#30933;&#32458;&#32458;&#65292;&#27604;&#22914;&#22312;&#31867;&#20013; static &#25104;&#21592;&#30340;&#22768;&#26126;&#12289;&#23450;&#20041;&#12289;&#21021;&#22987;&#21270;&#19978;&#65292;&#23601;&#30896;&#21040;&#20102;&#19981;&#23569;&#40635;&#28902;&#65307;</li>
<li>&#22522;&#30784;&#19981;&#29282;&#65292;&#27809;&#26377;&#21512;&#29702;&#20351;&#29992;&#31867;&#30340;&#32487;&#25215;&#65292;&#23548;&#33268;&#37325;&#22797;&#20195;&#30721;&#20986;&#29616;&#24471;&#24456;&#22810;&#65307;&#65288;&#20294;&#20063;&#19981;&#33021;&#35828;&#20840;&#24618;&#33258;&#24049;&#22522;&#30784;&#19981;&#25166;&#23454;&#65292;&#22240;&#20026;&#39033;&#30446;&#25512;&#36827;&#36807;&#31243;&#20013;&#30495;&#30340;&#24456;&#38590;&#20572;&#19979;&#26469;&#37325;&#26500;&#65292;&#30495;&#30340;&#20687;&#26159;&#32473;&#39640;&#36895;&#19978;&#24320;&#30528;&#30340;&#36710;&#25442;&#36718;&#32974;&#65289;</li>
<li>&#22522;&#30784;&#19981;&#29282;&#65292;friend &#20989;&#25968;&#30340;&#20351;&#29992;&#21487;&#20197;&#22823;&#24133;&#36991;&#20813; public &#25104;&#21592;&#30340;&#20986;&#29616;&#65292;&#21364;&#27809;&#26377;&#20351;&#29992;&#65307;</li>
<li>&#36807;&#24230;&#24037;&#31243;&#65292;&#27604;&#22914;&#35774;&#32622;&#20102;&#36807;&#22810;&#30340;&#26631;&#24535;&#20301;&#65292;&#20026;&#20102;&#31243;&#24207;&#20013;&#27809;&#26377; magic number&#65292;&#20351;&#29992;&#20102;&#22826;&#22810;&#30340;&#23439;&#23450;&#20041;&#65307;</li>
<li>&#33457;&#26679;&#32534;&#30721;&#65292;&#27604;&#22914;&#22823;&#37327;&#20351;&#29992;&#23439;&#26469;&#25340;&#25509;&#20989;&#25968;&#65288;&#20294;&#36825;&#26377;&#22909;&#26377;&#19981;&#22909;&#65292;&#20063;&#19981;&#31639;&#38169;&#65292;&#21482;&#26159;&#26085;&#21518;&#35753;&#21035;&#20154;&#32500;&#25252;&#36215;&#26469;&#20250;&#26377;&#38590;&#24230;&#65289;</li>
<li>&#22312;&#38271;&#27801;&#21507;&#32982;&#20102;==</li>
</ul>
<hr />
<p>&#21442;&#32771;&#38142;&#25509;&#65306;</p>
<ul>
<li><a href="https://github.com/district10/changsha">district10/changsha: &#38271;&#27801;&#26725;&#24247;&#39033;&#30446;&#32452;&#25991;&#26723;</a></li>
<li>&#36328;&#30005;&#33041;&#20989;&#25968;&#35843;&#29992;&#65306;<a href="https://github.com/district10/CrossOS">district10/CrossOS: Cross OS Communication</a></li>
<li><a href="http://tangzx.qiniudn.com/post-0025-doc-bridge-texture.html">&#26725;&#26753;&#27169;&#22411;&#36148;&#32441;&#29702;&#25991;&#26723;</a></li>
<li><a href="http://cvrs.whu.edu.cn/index.php?m=content&amp;c=index&amp;a=show&amp;catid=99&amp;id=50">CVRS &#21442;&#21152;&#31532;&#20108;&#23626;&#26477;&#24030;&#26426;&#22120;&#20154;&#35199;&#28246;&#35770;&#22363; - &#20844;&#21578; - &#27494;&#27721;&#22823;&#23398;&#35745;&#31639;&#26426;&#35270;&#35273;&#19982;&#36965;&#24863;&#23454;&#39564;&#23460;&#65288;CVRS Lab&#65289;</a></li>
<li>&#33258;&#24049;&#20043;&#21069;&#30011;&#30340;&#19968;&#20123;&#26550;&#26500;&#22270;&#65292;&#31561;
<ul>
<li>&#26550;&#26500;&#22270;&#65306;<a href="https://www.processon.com/view/link/56ea64a6e4b010c6fe7d1ead" class="uri">https://www.processon.com/view/link/56ea64a6e4b010c6fe7d1ead</a></li>
<li>&#31995;&#32479;&#21021;&#22987;&#21270;&#65306;<a href="https://www.processon.com/view/link/56ea640be4b00ac2e7a17fb2" class="uri">https://www.processon.com/view/link/56ea640be4b00ac2e7a17fb2</a></li>
<li>TCP &#36830;&#25509;&#30340;&#24314;&#31435;&#65306;<a href="https://www.processon.com/view/link/56ea673be4b00ac2e7a1c344" class="uri">https://www.processon.com/view/link/56ea673be4b00ac2e7a1c344</a></li>
<li>Wrappers &#21644; Moderator &#30340;&#20316;&#29992;&#65306;<a href="https://www.processon.com/view/link/56ea6c21e4b010c6fe7db713" class="uri">https://www.processon.com/view/link/56ea6c21e4b010c6fe7db713</a></li>
<li>UR &#30340;&#23039;&#24577;&#25511;&#21046;&#21644;&#29366;&#24577;&#35835;&#21462;&#65306;<a href="https://www.processon.com/view/link/56ee186de4b0881f9ac2e009" class="uri">https://www.processon.com/view/link/56ee186de4b0881f9ac2e009</a></li>
<li>UR &#29366;&#24577;&#25968;&#25454;&#30340;&#35299;&#26512;&#65306;<a href="https://www.processon.com/view/link/57986275e4b0636f3aa3bf2d" class="uri">https://www.processon.com/view/link/57986275e4b0636f3aa3bf2d</a></li>
<li>UR &#23039;&#24577;&#25511;&#21046;&#65306;<a href="https://www.processon.com/view/link/56ee1abfe4b0881f9ac2ea0a" class="uri">https://www.processon.com/view/link/56ee1abfe4b0881f9ac2ea0a</a></li>
</ul></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>&#23454;&#38469;&#19978;&#37027;&#26102;&#20505;&#25105;&#26412;&#31185;&#36824;&#27809;&#26377;&#27605;&#19994;&#12290;&#20063;&#22240;&#20026;&#36825;&#20010;&#39033;&#30446;&#25105;&#27809;&#26377;&#21442;&#21152;&#27605;&#19994;&#20856;&#31036;&#65288;&#25152;&#20197;&#38169;&#36807;&#38647;&#20891;&#22312;&#27605;&#19994;&#20856;&#31036;&#19978;&#30340;&#28436;&#35762;&#65289;&#12290;<a href="#fnref1">&#8617;</a></p></li>
<li id="fn2"><p>&#35265; <a href="http://dvorak4tzx.lofter.com/post/1d4021c8_7911622">clock_t &#19981;&#26159;&#26102;&#38388; - dvorak4tzx</a>&#12290;<a href="#fnref2">&#8617;</a></p></li>
<li id="fn3"><p>&#24320;&#22987;&#25105;&#24182;&#19981;&#30693;&#36947;&#21487;&#20197;&#29992; TCP&#65292;&#36824;&#22312;&#23581;&#35797;&#29992; Modbus &#35831;&#27714;&#30340;&#26041;&#24335;&#19968;&#20010;&#20010;&#35835;&#21462; register&#65292;&#21518;&#26469;&#24778;&#29616;&#21407;&#26469;&#21487;&#20197;&#29992; TCP&#65292;&#20110;&#26159;&#36825;&#20123;&#19996;&#35199;&#32479;&#32479;&#37117;&#29992;&#19981;&#30528;&#20102;&#65306;</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="kw">enum</span> URFunctionCodes {
    READ_COILS                = <span class="bn">0x01</span>,  <span class="co">// read output bits</span>
    READ_DISCRETE_INPUTS      = <span class="bn">0x02</span>,  <span class="co">// read input bits</span>
    READ_HOLDING_REGISTERS    = <span class="bn">0x03</span>,  <span class="co">// read output registers</span>
    READ_INPUT_REGISTERS      = <span class="bn">0x04</span>,  <span class="co">// read input registers</span>
    WRITE_SINGLE_COIL         = <span class="bn">0x05</span>,  <span class="co">// write output bit, turn ON/OFF</span>
    WRITE_SINGLE_REGISTER     = <span class="bn">0x06</span>,  <span class="co">// write output register</span>
    WRITE_MULTIPLE_COILS      = <span class="bn">0x0f</span>,  <span class="co">// write multiple output bits</span>
    WRITE_MULTIPLE_REGISTERS  = <span class="bn">0x10</span>,  <span class="co">// write multiple output registers</span>
};</code></pre></div>
<a href="#fnref3">&#8617;</a></li>
</ol>
</div>
</div>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="blur-svg">
    <defs>
        <filter id="blur-filter">
            <feGaussianBlur stdDeviation="3"></feGaussianBlur>
        </filter>
    </defs>
</svg>
<script src="../lazyload.min.js"></script>
<script src="../jquery-3.0.0.min.js"></script>
<script src="../jquery.idTabs.min.js"></script>
<script src="../egg.min.js"></script>
<script src="../clipboard.min.js"></script>
<script src="../notes.js"></script>
</body>
</html>
